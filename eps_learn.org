identification of mme and mobile subscriber
** MSISDN(Mobile Station International Subscriber Directory Number):  phone number
the real phone number, it is stored with other information in HLR indexed by imsi of each entry
MSISDN = CC + NDC + SN
CC = Country Code
NDC = National Destination Code
SN = Subscriber Number

** STN-SR
 STN-SR follows the E.164 telecommunications number format, and is used by the MSC server for session transfer of the media
 path from the PS domain to the CS Domain.
 it provided by HSS to MME during its attach procedure



** IMSI: unique international mobile sbuscriber identity that burned into a sim card

TMSI(Temporary Mobile subscriber indenties)
 In order to support the subscriber identity confidentiality service the VLRs, SGSNs and MMEs may allocate Temporary Mobile Subscriber Identities (TIMSI) to 
 visiting mobile subscribers. The VLR, SGSN, and MME must be capable of correlating an allocated TIMSI with the IMSI of the Mobile Station (MS) to which it is allocated.

An MS may be allocated three TMSIs, one for services provided through the MSC, one for services provided through the SGSN (P-TIMSI for short) and i
one for the services provided via the MME (M-TIMSI which is part of GUTI).


*** composition of IMSI
|     IMSI   |
 MCC MNC MSIN
    | NMSI   |
MSIN: Moblie subscriber identification number
    Mobile Country Code (MCC) consisting of three digits. The MSS identifies uniquely the country of domicile of mobile subscriber. 
    Mobile Network Code (MNC) consisting of two or three digits for GSM/UMTS applications.  That's why, if you are close to your country border UE is still using eNodeBs 
    that belongs/are controled by Mobile Operator from your country. In other words .. the MNC identifies the home PLMN of the mobile subscriber. The length of the MNC 
    (two or three digits) depends on the value of the MCC. A mixture of two and three digit MNC codes within a single MCC area is not recommended according to 3GPP specification.
    Mobile Subscriber Identification Number (MSIN) identifying the mobile subscriber within a PLMN.

In Fig. 1. there is also shown NMSI entity. The National Mobile Subscriber Identity (NMSI) consists of the MNC and the NMSI.

this will be allocated to each mobile subsriber in every (GSM, UMTS and EPS)sytem.

** IMEI: a number which is burned into a mobile phone
IMEI (International Mobile Equipment Identity) it is a unique number given to every single mobile phone.
(When a phone is reported stolen or is not type approved, the number is marked invalid).

The IMEI (International Mobile Station Equipment Identity) is a 15-digit number to uniquely identify a mobile phone device.i
IMEISV (IMEI Software Version) is a 16-digit number with the IMEI and an additional software version number.


** Globally Unique MME id(GUMMEI)
-----    MCC: 244 ---finland
         MNC: 123  ---LTE4U
gummei   MMEGID: 1
______   MMEC :1
Globally Unique MME Identifier (GUMMEI)
The format and size of the GUTI is:
GUTI = GUMMEI + M-TMSI, where
GUMMEI = MCC + MNC + MME Identifier and
MME Identifier = MME Group ID + MME Code
MCC and MNC shall have the same field size as in earlier 3GPP systems.
M-TMSI shall be of 32 bits length.
MME Group ID shall be of 16 bits length.
MME Code shall be of 8 bits length.




** Globally Unique Temporary UE Identity (GUTI )
The purporse of the GUTI is to provife an unambiguous identification of the UE that does not reveal the UE or the user's permanent identity in the Evolved Packet System
(EPS). It also allows the identification of the MME and network. It can be used by network and the UE to establish UE's identity during signaling between them in EPS.
On GUTI consist two main components:

    GUMMEI - that uniquely identifies the MME which has allocated the GUTI
    M-TMSI - other that uniquely identifies the UE within the MME because of allocated the GUTI

Because of that when UE is contacting the network it sends the GUTI to the eNodeB which then uses the GUTI number to identify to which MME re-establish request will be send.
If the UE has moved from UMTS cell to LTE cell, a TAU procedure is made (because UE does not have its GUTI) and P-TMSI is send. By this way MME, which is in control of
area to which UE moved to, can contact SGSN, which controlled area where UE was previously, to request the subscribers current profile like IP address and PDP contexts.
Situation is similiar when UE has moved from LTE to UMTS cell. GUTI is sent as the P-TMSI parameter and the procedure is reffered as Routing Area Update (RAU).
If there is a situation where eNodeB from new LTE cell is not associated with MME on which GUMMEI is pointing eNodeB simply will select new MME. The new MME 
could get context information from old MME using same GUTI.


-       GUTI=<GUMMEI><M-TMSI>
Fig. 2. GUTI structure

-       GUTI=<GUMMEI><M-TMSI>
-	GUMMEI=<MCC><MNC><MME group Id><MME Code>
-	Mapped GUMMEI=<MCC><MNC><MME group Id=LAC><MME Code=8 MSB of NRI>


** ECGI
ECGI     E-UTRAN Cell Global Identifier  To identify a Cell in global (Globally   Unique), EPC can know UE location based of ECGI  ECGI (not more than 52 bits) = PLMN I D+ ECI    
ECI     E-UTRAN Cell Identifier     To identify a Cell within a PLMN    ECI (28 Bits) = eNB ID + Cell ID    
eNB_ID  eNodeB Identifier   To identify an eNB within a PLMN    20 bits

Global_eNB_ID   Global eNodeB Identifier    To identify an eNB in global (Globally   Unique)    Global eNB ID (not more than 44 bits) = PLMN ID + eNB ID    

* PDN, bearer and APN
** PDN concept
In that home, the APN comes into play inside the Home Subscriber Server (HSS) node of the core network.

Where You’ll See LTE APN

The HSS contains users’ SAE subscription data such as the EPS-subscribed Quality of Service (QoS) profile and any access restrictions for roaming. HSS also contains
information about the (Pocket Data Networks) PDNs to which the user can connect, as reported by Alcatel-Lucent. “This could be in the form of an access point name (APN) (which is a label according to DNS naming conventions describing thei
access point to the PDN) or a PDN address (indicating subscribed IP address(es)). In addition the HSS holds dynamic information such as the identity of the MME to which the user
is currently attached or registered. The HSS may also integrate the authentication center (AUC), which generates the vectors for authentication and security keys.” [1]

 What LTE APN Does

 To break it down, the APN identifies a Gateway GPRS Support Node (GGSN) or Packet Data Network GateWay (P-GW). It includes an APN network identifier which defines the Packet Data 
 Network (PDN) to which the UE requests connectivity, and may also include an APN operator identifier which defines in which Public Land Mobile Network (PLMN) the P-GW or
 GGSN is located, according to LTE World. [2] To accomplish this, the APN structure is comprised into two parts: a network identifier and an operator identifier.

  How to identify?

  There are also steps for identifying a PDN IP network that the mobile data user wants to communicate with. The NMC Consulting Group notes that the PDN Identity (APN) is used to
  determine the P-GW and point of interconnection with a PDN. With APN as query parameter to the DNS procedures, the MME will receive a list of candidate P-GWs, and then a P-GW is 
  selected by MME with policy. [3]

  3GPP Views

  The board who sets the standards for 3GPP, however, sees things a little differently. According to the new standards puts in place, the UE shall not include APN and PCO in the 
  PDN connectivity request when the same is sent along with attach request. 3GPP has said that the UE shall send the PDN connectivity request with a flag “ESM Information transfer”
  on and no APN or PCO shall be included. Once the MME receives the Attach Request+PDN connectivity request, it can move ahead and accept the attach but it still cannot establish
  the EPS bearers just yet.
  Next, MME goes ahead with establishing security context. After the security context is established MME will send a NAS message “ESM Information Request” asking UE for APN and PCO. 
  Then, the UE will send an “ESM Information Response” with APN and PCO, encrypted. Finally, once MME receives this response it will go ahed with establishing the EPS bearers.
  If the response doesn’t include APN then default APN shall be used by MME.
  
  "ESM Information Request" will be sent by MME when attach request's 
       eSMInformationTransferFlag { eIT e_esm_information_transfer_required(1) }   #### when this flag is not omitted.

*** EPS Session

IP connection between a UE and a PDN is called PDN connection or EPS session. Each PDN connection (or EPS session) is represented by an IP address of the UE and a PDN ID (in other words,
 Access Point Name (APN)). It has more than one EPS bearer to deliver user traffic (IP packets), and applies the service quality (QoS) policy obtained from a PCRF to the EPS bearers.
 The minimum fundamental bearer that an EPS session has for a PDN is called a default EPS bearer.

 
Having an EPS session established means 
i) a PDN through which a user is to use services has been selected (by the user’s input or based on the subscription information provisioned by an HSS), 
ii) an IP address to be used in the PDN has been assigned to the user, 
iii) policy rules to be applied to the user IP packets (QoS and charging rules) have been selected,
iv) a default EPS bearer for delivering IP packets over the LTE network has been established. 
Through this EPS session established, IP packets can be exchanged between the user and the PDN according to the rules set by the operator.

Management and operation of sessions, including PCRF, will be explained in other document, and a PDN ID (APN) will be discussed as an ID relating to the EPS session in this document.


*** EPS Bearer

An EPS session is in charge of delivering and handling flows of the IP packets that are labeled with UE IP addresses and travel between a UE and a PDN (UE – P-GW – PDN).
 On the other hand, an EPS bearer is a pipe through which IP packets are delivered over the LTE network, i.e., between a UE and a P-GW (UE – eNB – S-GW - P-GW).
 A UE can have multiple EPS bearers concurrently. So, different EPS bearers are identified by their EPS bearer ID, which is allocated by an MME.

As seen in Figure 1, an EPS bearer actually is a concatenation of the following three bearers (DRB, S1 bearer and S5 bearer):

    [UE] - [eNB]: Data Radio Bearer (DRB)

EPS bearer established over LTE-Uu interface. User traffic (IP packet) is delivered through a DRB. Different DRBs are identified by their DRB ID, which is allocated by an eNB.

    [eNB] - [S-GW]: S1 bearer

EPS bearer established over S1-U interface. User traffic is delivered through a GTP tunnel. Different S1 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (eNB and S-GW) of the GTP tunnel. 

    [S-GW] - [P-GW]: S5 bearer

EPS bearer established over S5 interface. User traffic is delivered through a GTP tunnel. Different S5 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (S-GW and P-GW) of the GTP tunnel.

*** Types of EPS Bearers
Before we go ahead and describe EPS bearer-related IDs, we will look at different types of EPS bearers and how they work. Figure 2 shows two different types of EPS bearers:
default and dedicated. Each PDN must have one default EPS bearer, but may have none to many dedicated EPS bearers.

Despite the similarities in the processes among GSM, UMTS and LTE, there is nevertheles one major difference between LTE and earlier technologies./
the attach process already includes the assignment of an IP address. This is unlike in GSM and UMTS where the device could attach to packet-switched network and only later request for the 
assignment of and IP address with a separate procedure which often referred to aas "packet call" to compare the estbablishment of an INternet session with the voice call.
So if 4g attached ue(with a dedicated bearer for voip) handover to a 3g network, voip bearer will be 
handover to MSC, and default bearer will be released, not handover to RNC, for 3g attachment not request a default bearer.

The LTE network is an all-IP network, and provides its users with always-on IP connectivity. This means, once a UE connects to a PDN using the IP address assigned at its initial attach 
to the network, the IP connection remains connected after a default EPS bearer is established over the LTE network and until the UE detaches from the LTE network 
(i.e., the PDN connection is terminated). Even when there is no user traffic to send, the default EPS bearer always stays activated and ready for possible incoming user traffic.

Additional EPS bearer can be established if the default EPS bearer itself is not sufficient enough to obtain QoS (see LTE QoS document). The additional EPS bearer established 
is called a dedicated EPS bearer and multiple dedicated bearers can be created if required by the user or the network. When there is no user traffic, these dedicated EPS bearers 
can be removed, whereas the default one is never removed and keeps the user staying connected to the network unless the user detaches from the network. Dedicated EPS bearers are linked to
a default EPS bearer. The linked bearers are represented by a Linked EPS Bearer Identity (LBI), indicating they are all associated with the same default EPS bearer.


*** ID to identify PDN: PDN ID (APN)
PDNs are identified by PDN IDs (or Access Point Names (APNs)). An APN, as can be easily inferred, refers to an access point to a PDN where a user wishes to connect for services/applications.
APNs and their format are illustrated. An APN is a combination of a network ID and an operator ID. The network ID is used when identifying PDNs such as Internet or Corporate VPNs or 
identifying services like IMS that the PDN provides.
An APN is provisioned to an HSS as subscription information at the time of a user’s subscription (as in case 1 of Figure 3)2. Upon a UE’s initial attach, a default APN is 
downloaded from the HSS to an MME. The MME selects a PDN to connect the UE based on the APN first, and then a P-GW through which the UE is connected to the PDN . 
the MME selected PDN 1 based on APN 1, and then P-GW 1 for connection to PDN 1.  

 
http://www.netmanias.com/en/post/techdocs/5907/identification-identifier-lte/lte-identification-iii-eps-session-bearer-identifiers


* EPS mobility/session management
** EPS mobility management(EMM)
informing the network of its present location 
providing user identity confidentiality.
to provide connection management services to the session management(SM) sublayer and the short message service(SMS) of the connection management(CM) sublayer.

*** Types of EMM procedures
**** EMM common procedures (can be initiated whilst a NAS signalling connetion exists)
initiated by network:
GUTI reallocation;  authentication;  security mode control;  identification;     EMM information;

**** EMM specific procedures(at any time only one UE initiated EMM specific procedures can be running)
attach; detach; normal TAU; periodic TAU

**** EMMM connection management procedures
service request;   paging procedure;   trasnport of NAS messages.

** EPS session management(ESM)
An EPS bearer context can be either a default bearer context or a dedicated bearer context.
The ESM comprises procedures for:
- the activation, deactivation and modification of EPS bearer contexts; and
- the request for resources (IP connectivity to a PDN or dedicated bearer resources) by the UE.

Each EPS bearer context represents an EPS bearer between the UE and a PDN. EPS bearer contexts can remain activated even if the radio and S1 bearers constituting the corresponding EPS bearers between UE and MME are
temporarily released.
A default EPS bearer context is activated when the UE requests a connection to a PDN.

Once the UE is successfully attached, the UE can request the MME to set up connections to additional PDNs. For each additional connection, the MME will activate a separate default EPS bearer context. A default EPS
bearer context remains activated throughout the lifetime of the connection to the PDN.

A dedicated EPS bearer context is always linked to a default EPS bearer context and represents additional EPS bearer resources between the UE and the PDN. 
The network can initiate the activation of dedicated EPS bearer contexts together with the activation of the default EPS bearer context or at any time later, as long as the default EPS bearer
context remains activated.

Default and dedicated EPS bearer contexts can be modified.
Dedicated EPS bearer contexts can be released without affecting the default EPS bearer context. When the default EPS bearer context is released, then all dedicated EPS bearer
contexts linked to it are released, too.
The UE can request the network to allocate, modify or release additional EPS bearer resources. The network decides whether to fulfil a request for additional 
resources by activating a new dedicated EPS bearer context or modifying an existing dedicated or default EPS bearer context.

*** types of ESM procedure
**** procedures related to EPS bearer contexts(initiated by the network):
default/dedicated EPS bearer context activation;
EPS bearer context modification/deactivation;

**** Transaction related procedures(initiated by the UE to request/release  resources):
PDN connectivity/disconnect procedure;
bearer resource allocation/modification procedure
ESM information request procedure



* basic procedures
\\10.140.0.65\data\EPC MME\01. Architecture\Basic LTE procedures
state of UE
 ECM=idle/connected       (means UE is not connected to radio network's ENB)
 EMM=registered/deregistered       (means UE is registered in core network's MME)

** S1 Setup
this procedure triggered when network element in core network first bootup
*** network element configuration(enb1, enb2, one mme)
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     MCC: 244                       MCC: 244                  MCC: 244   
     MNC: 123                       MNC: 123                  MNC: 123
     enB ID:2                       enB ID:2                  mmegid:mmecode 2:0
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 

when all system boot up, enb1 and enb2 will send a S1 Setup message to mme tell it's enbid and Tal
and mme will store the global enb id and taList to it's database
then response them with its own gummei and  capacity

tracking area not allowed: if the enb not sending s1 setup to update the tac, plmn to mme, then when this enb send attachrequest using the tac, it will be rejected with this cause 

*** s1 setup request procedure
enb will establish a sctp connection to mme, and notify mme that its Tracking area

enb1:TA1     S1 setup request( enbid, TA1,TA2)
     TA2    ------------------------------------>   MME [enbid, Talist]
           
              S1 setup response(gummei,capacity)
	    <------------------------------------

** S1 Release (S1 release it not the opposit operation of S1 Setup, S1 release is related to UE, but s1 setup has nothing to do with UE)
when enb found  ue lose rrc connection(radio connect) to it, there will be s1 release procedure, started by enb.
ue  ECM = idle

enb detected that ue is lost, it will send a ue context release rquest(enb_s1ap_id, mme_s1ap_id, cause of release) to mme

sgw will remove enb related info, enb will remove all the info related to the attach()
mme will remove ue-associated info ims1 and enb_s1ap_id


S1 release procedure will make all s1ap related id removed in mme, sgw, but UE keep GUTI,TAI.(for if UE move to another ENB, the info not related to the older enb is also useful).

enb: enb-s1-id, mme-s1-id,      mme:imsi,guti(TMSI),enb-s1-id,mme-s1-id,          sgw:imsi, mme-teid,sgw-teid-c
enb-teid, sgw-teid-u                guti, mme-teid, sgw-teid-c,sgw-teid-u         sgw-teid-u,enb-teid
|                                    |                                            |
|ue context release request(enb-s1-id|                                            |
|mme-s1ap-id, casue of release)      |                                            |
|----------------------------------->|                                            |
|                                    |                                            |
|                                    |                                            |
|                                    |release access bearers request(SGW TEID-C)  |  
|                                    |------------------------------------------->|(enb-teid)Remove
|                                    |                                            |---------
|                                    |                                            |
|                                    |release aceess bearers response             |
|                                    |<-------------------------------------------|
|                                    |                                            |
|ue context release command(         |
| enb-s1-id,mme-s1-id)               |
|<-----------------------------------|
|                                    |
|(all the filed above)Remove         |
|                                    |
|ue context release complete         |
|(enb-s1-id, mme-s1-id)              |
|----------------------------------->|(enb-s1ap-id,mme-s1ap-id) Remove
                                  EMM=registered,ECM=idle


** Service Request (this is the opposite operation of S1 release)

when after s1 release, ue ecm=idle emm=registered
ue want to send some message, it will establish RRC connection to enb and sending Service Request NAS Message

ue                     enb                              mme                                      sgw
guti,talist            none                  imsi,guti,mme-teid,sgw-teid(u/c)          imsi,mme-teid,sgw-teid(u/c)
|                        |                                       |                                      |
| service requst(S-TMSI) |                                       |                                      |
|----------------------->|                                       |                                      |
|                        | [enb-s1ap-id]                         |                                      |
|                        |                                       |                                      |
|                        | initial ue message(enb-s1ap-id,       |                                      |
|                        | S-TMSI,<servic request>)              |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       | [mme-s1ap-id]                        |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | initial context setup req             |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id, sgw-teid-u) |                                      |
|                        | <----------------------------------   |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | [enb-teid]                            |                                      |
|                        | <mme-s1ap-id,sgw-teid-u>              |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | first uplink data packet              |                                      |
|------------------------+---------------------------------------+------------------------------------->|
|                        |                                       |                                      |
|                        | initial context respose               |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id,enb-teid)    |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       |                                      |
|                        |                                       | modify bearer req(mme-teid,enb-teid  |
|                        |                                       | -----------------------------------> |
|                        |                                       |                                      |<enb-teid>
|                        |                                       |                                      |
|                        |   first donwlink data packet          |                                      |
|<---------------------- |<-----------------------------------------------------------------------------|
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        |                                       |modify bearer resp(sgw-teid-u)        |
|                        |                                       |<-----------------------------------  | 



** Paging
Paging is from s1-release scenario
 ue: ECM=idle EMM=registered(guti,TAlist(TA1,TA2) in UE)

SGW get some data from the Internet, incoming donwlink data, sgw start to buffer them and request mme to estalbishment of E-RAB

SGW sent Downlink Data Notification(MME-TEID) to  mme
mme find subscirber with MME-TEID 

S-TMSI=MMEC+MTMSI 
S_TMSI is used to identify the subscirber

MME send Paging() to all the enbs(when s1-setup, enbs notify mme that its TAs) in the ta list(which is send to ue when attach accept).
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 


paging(S-TMSI,TA1+TA2)
-------------------------> enb1

paing(S-TMSI, TA2)
-------------------------> enb2
when ue recevied paing message from enb, it will send a service request nas messaeg to eNB


** detach procedure
detach procedure triggered by SIM card removed or cell phone is switched off.
The difference between detatch and s1-release is that detach will make SGW, MME, ENB delete all the ids it maintained for that SIM card.
while s1-release procedure is from enb(that lost connection with UE), so UE related info in ENB will be all removed, but SGW and MME may keep some info related only to UE 
other than related to enb.

(enb-teid,s1ap-enb/mme-id,sgw-teid)     (s1ap-enb/mme-id,sgw-teid-c,mme-teid)        (enb-teid,sgw-teid-c/u,mme-teid,imsi)
                                        EMM=registered, ECM=connected
ENB                                           MME                                           SGW                                           
|                                              |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - Uplink NAS Transport (Detach Request)      |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|                                              |--------------------------------------------->|delete all the teid for this bearer (enb,sgw,mme),imsi
|                                              | - Delete Session Request                     |
|                                              |                                              |                                              
|                                              |<---------------------------------------------|
|                                              | - Delete Session Response                    |
|                                              |<---------------------------------------------|
|                                              |A: mme  EMM=unregistered                      |                                              
|<---------------------------------------------|                                              |
| - Downlink NAS Transport (Detach Accept)     |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|<---------------------------------------------|                                              |
| - UE Context Release Command                 |                                              |
|A:enb delet all id list above                 |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - UE Context Release Complete                |                                              |
|A:mme delete all id list above(keep guti,imsi)|                                              |
|                                 ECM=idle     |                                              |                                              
|                                              |                                              |                                              
no ids left                         guti=null,imsi,EMM=unregistered,ECM=idle                      no ids left

** 4g Cancel location
mme_net1 <--- CLR ---- hss01
mme_net1 ---- CLA ---> hss01
after this, subscriber imsi will be deleted in MME from db.

 

** basic attach with imsi
triggered by a ue press a power button to switch on the phone

UE                               ENB                              MME                              HSS                              DNS                              SGW                              
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|A: RFC connection established   |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: NAS attach request(imsi,)    |                                |                                |                                |                                |
|A: [enb_s1_id]                  |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: initial ue message(enb_s1ap_ |                                |                                |                                |
|                                |id,TAI(tracking area identifica |                                |                                |                                |
|                                |tion in ue),NAS_attach_request( |                                |                                |                                |
|                                |imsi))                          |                                |                                |                                |
|                                |A: <imsi,enb_s1ap_id> [mme_s1ap |                                |                                |                                |
|                                |_id,GUTI, MME-TEID]             |                                |                                |                                |
|                                |                                | if sub in db,no authreq to hss |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M: authentication info request( |                                |                                |
|                                |                                |imsi)                           |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: allocation info answer(authe |                                |                                |
|                                |                                |ntication&security parameters)  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: Downlink nas trasport(enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,authenticatio |                                |                                |                                |
|                                |n request)                      |                                |                                |                                |
|                                |A: <mme_s1ap_id>                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: authentication Request       |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M; authentication response      |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: uplink nas trasnport(enb_s1a |                                |                                |                                |
|                                |p_id,mme_s1ap_id, authenticatio |                                |                                |                                |
|                                |n response)                     |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: DownlinkNASTransport (enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,[securityMode |                                |                                |                                |
|                                |Command(cypher alg)])           |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                | tester calculate (cypher/inte) |                                |                                |                                |
|                                |key using kasme                 |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [securityModeCommand]        |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: [{securityModeComplete}]     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: UplinkNASTransport (enb_s1ap |                                |                                |                                |
|                                |_id,mme_s1ap_id,[{securityModeC |                                |                                |                                |
|                                |omplete}]                       |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M; Update Location Request(IMSI)|                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: Update Location answer(Qos p |                                |                                |
|                                |                                |rofile,APN)                     |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |---------------------------------------------------------------->|                                |
|                                |                                |M: APN                          |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<----------------------------------------------------------------|                                |
|                                |                                |M: PGW IP                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |M: create session request(MME-T |                                |                                |sgw restore imsi,mme-teid
|                                |                                |EID,IMSI)                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <mme-teid,imsi>  [sgw-teid-c |                                |                                |
|                                |                                |,sgw-teid-u] c:control, u:user  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: create session response(     |                                |                                |sgw-teid-c:senderFTEIDforctrlplane    
|                                |                                | sgw-teid-c,sgw-teid-u)         |                                |                                |sgw-teid-u:s1_U_SGW_FTEID in bearecontext
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |A: <SGW_TEID-u,SGW_TEID-c>      |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: initial context setup reques |                                |                                |                                |
|                                |t(enb_s1ap_id,mme_s1_id,SGW_TEI |                                |                                |                                |
|                                | SGW_TEID-u,                    |                                |                                |                                |
|                                |[{NAS_attach accept(GUTI,TALIST}|                                |                                |                                |
|                                |]))                             |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|enb-TEID-u:transportLayerAddress|                                |                                |
|                                |A: <sgw_teid-u> [enb-TEID-u]    |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [{attach accept(guti,talist) |                                |                                |                                |                                |
|}]                              |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|A: <guti,talist>                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: InitialContextSetupResponse  |                                |                                |                                |
|                                |(enb_s1ap_id,mme_s1_id,         |                                |                                |                                |
|                                |enb-TEID-U))                    |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |A: <enb TEID-U>                 |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: Attach complete              |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: S1AP.UplinkNASTransport(enb_ |                                |                                |                                |
|                                |s1ap_id,mme_s1_id,[{at          |                                |                                |                                |
|                                |tach complete}])                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------->|
|M: first uplink data packet     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|bearer context
|                                |                                |M: modify bearer request(mme-te |                                |                                |s1_eNodeB_FTEID
|                                |                                 id,enb-teid-u(to sgw))          |                                |                                |is enb-teid-u
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <enb-teid,ipaddr>            |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: ModifyBearerResponse(sgw-teid-u)                                                               |
|                                |                                |                                |                                |                                |
|<-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|M: first downlink data packet   |                                |                                |                                |                                |


Note sgw-teid have two kinds of user and control plane, but for enb-teid is just a enb-teid-u,no ebn-teid-c
after attach the ids in enb,mme,sgw
enb: enb-s1-id, mme-s1-id,      mme:imsi,enb-s1-id,mme-s1-id,                 sgw:imsi, mme-teid,
enb-teid, sgw-teid-u                 guti, mme-teid, sgw-teid-u/c                  sgw-teid-u/c,enb-teid

picture example: 
M means message() means parameter in message,[] means inteigiry protected message,{}means cyphered message 
A means Action. <> means stored [] means allocated

so after the attach, there are some value in the network element accordingly

ue: guti, tailist
enb: enb-s1-id, mme-s1-id, enb-teid, sgw-teid-u
sgw: imsi, mme-teid, sgw-teid-u/c, enb-teid
mme: imsi,enb-s1-id,mme-s1-id, guti, mme-teid, sgw-teid-u/c

note all the data packet won't pass mme, data only in sgw and enb(enb talk wih  ue via radio network)
other components are connected via real nettwork(core net work?) 
mme will only control the ue's guti and talist.
talist is the tas which not needed to do TAU for ue, if ue entered another tas not in talist, ue will perform TAU to mme,
mme will get updated where ue is

** combined attach
4gAttachImsi -imsi ${IOTA.IMSI4} -eNB ${IOTA.ENB41} -tac ${IOTA.TAC1} -imeisv ${IOTA.IMEISV} -mobileidentity 0xF400000000 -epsattachtype 2
epsattachtype in nas attach request message 2 means combined attach, 1 means eps attach.
---------------------
mme_net1 <--- INITIALUEMESSAGE(ATTACHREQ(PDNCONNECTIVITYREQ)) ---- enb41
## combined attach in attach request

mme_net1 ---- AIR ---> hss01
mme_net1 <--- AIA ---- hss01
mme_net1 ---- DOWNLINKNASTRANSPORT(AUTHREQ) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(AUTHRSP) ---- enb41
mme_net1 ---- DOWNLINKNASTRANSPORT(#SECURITYMODECMD) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(#SECURITYMODECMP) ---- enb41


mme_net1 ---- ULR ---> hss01
mme_net1 <--- ULA ---- hss01


mme_net1 ---- CREATESESSIONREQ ---> s11sgw01

mme_net1 <--- CREATESESSIONRSP ---- s11sgw01


mme_net1 ---- SGSAPLOCATIONUPDATEREQ ---> vlr10

mme_net1 <--- SGSAPLOCATIONUPDATEACC ---- vlr10

mme_net1 ---- INITIALCONTEXTSETUPREQUEST(#ATTACHACC) ---> enb41

mme_net1 <--- INITIALCONTEXTSETUPRESPONSE ---- enb41

mme_net1 <--- UPLINKNASTRANSPORT(#ATTACHCMP(ACTIVATEDEFAULTEBCACC)) ---- enb41
### attach complete

mme_net1 ---- SGSAPTMSIREALLOCATIONCMP ---> vlr10

mme_net1 ---- MODIFYBEARERREQ ---> s11sgw01
mme_net1 <--- MODIFYBEARERRSP ---- s11sgw01


mme_net1 ---- NOR ---> hss01
mme_net1 <--- NOA ---- hss01

-0-------------------------------------------------



** Tracking Area Update
this procedure and be initiated by UE or just periodic.

*** intra mme TAU
**** ue initiated TAU 
When an UE detects it has entered a new Tracking Area(that is not in the list of TAIS when attach Accept),
it initiates a standalone tracking area update procedure.
epsupdatetype will be e-tau-updating in taurequest nas message

***** ECM=IDLE ACTIVE FLAG = OFF
If the UE(in idle mode)has no UpLink data pending, it will initiate TAU with active_flag off


UE(ECM=idle,EMM=registered)                            ENB(no-ids)                                         MME (ECM=idle,EMM=registered)                                                     
                                                                                                               (imsi,guti,sgw-teid,mme-teid)
|                                                          |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|
| M TAU Request(TAI,guti,activeflag=off)                   |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|check if ths sub exists in cache/db using guti
| A [ebn-s1ap-id]                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti   |
|                                                          | vef=off))                                                |
|                                                          | A [mme-s1ap-id] <enb-s1ap-id>                            |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M Downlink NAS transport(enb-s1ap-id,mme-s1ap-id,TAU a   |
|                                                          | ccept((newtalist),GUTI))                                 |
|                                                          | A  <mme-s1ap-id>                                         |
|                                                          |                                                          |
|                                                          |                                                          |
| <------------------------------------------------------- |                                                          |
| M TAU Accept(TAI,GUTI)                                   |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|                                                          |
| M TAU complete                                           |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Uplink NAS transport(enb-s1ap-id,mme-s1ap-id,TAUComp   |
|                                                          | lete)                                                    |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M UE Context release command(enb-s1ap-id,mme-s1ap-id)    |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M UE Context release complete(enb-s1ap-id,mme-s1ap-id)   |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |


***** ECM=IDLE ACTIVE FLAG = ON
If the UE (in idle mode) has UpLink data pending (or UpLink signalling not related to TAU), the MME re-establish the radio and S1 bearers for all i
active EPS bearer contexts. The UE indicates this request to establish the User Plane (and to keep NAS signalling connection after TAU completion) by setting an "active" flag. 

UE                                                      ENB                                                     MME(ECM=idle,EMM=registered)                            SGW                                                     
 (ECM=idle,EMM=registered)                              (no-ids)                                (imsi,guti,sgw-teid,mme-teid)                           (imsi,sgw-teid,mme-teid)
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Request(TAI,activeflag=on)                      |                                                        |                                                        |
|  A [ebn-s1ap-id] ECM(idle ---> connected)              |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti|                                                        |
|                                                        |vef=on))                                                |                                                        |
|                                                        |  A [mme-s1ap-id] <enb-s1ap-id> ECM(indle-->connected)  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |<-------------------------------------------------------|                                                        |
|                                                        |  M Initial ContextSetup Request(enb-s1ap-id,mme-s1ap-i |                                                        |
|                                                        |d,sgw-teid,TAU accept((newtalist),GUTI))                |                                                        |
|                                                        |  A  [enb-teid] <mme-s1ap-id,sgw-teid>                  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|got enb-teid and                                        |
|                                                        |M Context Setup Response(enb-s1-id,mme-s1-id,enb-teid,  |send to SGW                                             |
|                                                        |          TAU Accept(TAList,GUTI)                       |using modifybearerrequest                               |
|                                                        |  A  <enb-teid>                                         |                                                        |
|                                                        |                                                        |                                                        |                                                        
|<-------------------------------------------------------|                                                        |                                                        |
|  M TAU Accept(TAI,GUTI)                                |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Complete                                        |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M TAU Complete in UL NAS Transport                    |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |------------------------------------------------------->|
|                                                        |                                                        |  M ModifybearerRequest(mme-teid-id,enb-teid-id)        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |<-------------------------------------------------------|   
|                                                        |                                                        | M ModifybearerResponse(mme-s1ap-id)                    |


***** ECM=CONNECTED
only update the TA List, all enb-s1ap-id, enb-teid, mme-s1ap=id, sgw-teid, mme-teid no need to update at all.

***** DNSquery with tac to see if sgw need relocated 
when attach from 0x0164, the sgw been selected 
    Create Dns Naptr Record            tac-lb01.tac-hb64.tac.epc.mnc002.mcc460.3gppnetwork.org.  x-3gpp-sgw:x-s11  topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc${PADDEDMNC}.mcc${MCC}.3gppnetwork.org.
    Create Dns Naptr Record            tac-lb01.tac-hb64.tac.epc.mnc002.mcc460.3gppnetwork.org.  x-3gpp-sgw:x-s5-gtp:x-s8-gtp  topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc${PADDEDMNC}.mcc${MCC}.3gppnetwork.org.  100  65530

when tau from 0x0464, the same sgw been selected, that means dns response with the service x-s11, x-s5-gtp, x-s8-gtp  of the same replacement topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc....
    Create Dns Naptr Record            tac-lb04.tac-hb64.tac.epc.mnc002.mcc460.3gppnetwork.org.  x-3gpp-sgw:x-s11  topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc${PADDEDMNC}.mcc${MCC}.3gppnetwork.org.
    Create Dns Naptr Record            tac-lb04.tac-hb64.tac.epc.mnc002.mcc460.3gppnetwork.org.  x-3gpp-sgw:x-s5-gtp:x-s8-gtp  topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc${PADDEDMNC}.mcc${MCC}.3gppnetwork.org.  100  65530
tau will continue without createsessionreq    


***** intra MME TAU with SGW relocation ECM=CONNECTED
case id:  NS_130_4_0001

ENB                                             MME                                                tSGW                                             sSGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Req|                                                 |                                                 |
|uest(GUTI,TAI,))                                 |                                                 |                                                 |
|                                                 |DNSquery with tac to see if sgw need relocated   |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Create Session Request                        |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Create Session Response                       |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session Request                                                                          |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Delete Session Response                                                                         |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Initial Context Setup Request (Tracking Area U|                                                 |                                                 |
|pdate Accept)                                    |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Initial Context Setup Response                |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Com|                                                 |                                                 |
|plete)                                           |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Modify Bearer Request                         |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Modify Bearer Response                        |                                                 |
|                                                 |                                                 |                                                 |


**** periodic TAU
In addition, an EMM-REGISTERED and ECM-IDLE state UE performs periodic Tracking Area Update with the network after the expiry of the periodic TAU timer (T3412).
The     value of timer is sent by the network to the UE in the ATTACH ACCEPT message (and can be sent in the TRACKING AREA UPDATE ACCEPT message). Periodic tracking area 
updateing is used to periodically notify the availability of the EMM-IDLE state UE to the network. 
epsupdatetype will be e-periodic-updating in taurequest nas message




*** inter mme TAU with ACTIVE FLAG= OFF
case id:NS_129_31_0001
Purpose of this test case is to ensure UE makes inter MME TAU (S_MME --> T_MME) successfully. Active flag is OFF in TAU request. After successfull TAU, UE makes S1 release.

ENB                                     tMME                                    sMME                                     HSS                                     SGW
|                                         |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|-----------------------------------------+---------------------------------------------------------------------------------+-----------------------+---|
| - Uplink NAS Transport (Tracking Area   |                                                                                 |                       |   |
| Update Request)                         |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | -------------------------------------->                                         |                       |   |
|                                         | - Context Request                                                               |                       |   |
|                                         | <--------------------------------------                                         | (mmcontext,smcontext) |   |
|                                         | - Context Response                                                              |                       |   |
|                                         |                                                                                 |                       |   |
| <-------------------------------------- |                                                                                 |                       |   |
| - Downlink NAS Transport (Identity Req  |                                                                                 |                       |   |
| uest)                                   |                                                                                 |                       |   |
|-----------------------------------------+---------------------------------------------------------------------------------+-----------------------+---|
| - Uplink NAS Transport (Identity Respo  |                                                                                 |                       |   |
| nse)                                    |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | ------------------------------------------------------------------------------> |                       |   |
|                                         | - Identity Check Request                                                        |                       |   |
|                                         | <------------------------------------------------------------------------------ |                       |   |
|                                         | - Identity Check Answer                                                         |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | -------------------------------------->                                         |                       |   |
|                                         | - Context Acknowledge                                                           |                       |   |
|                                         |                                                                                 |                       |   |
|                                       |---------------------------------------------------------------------------------------------------------------------->|store mme-teid
|                                       | - Modify Bearer Request(Update the target mme-teid in [senderfteid] to replace the old one)                           |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Modify Bearer Response(enb-teid){enb-teid is allocated when with sMME signallin}                                    |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |since mme has been changed, so Loacation update procedure needed               |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Update Location Request                                                     |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Update Location Answer                                                      |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Downlink NAS Transport (Tracking Are|                                       |                                       |                                       |
|a Update Accept)                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Complete)                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |

Ater this, TAU procedure is complete. Due to active flag=off, so ue context realease needed
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Insert Subscriber Data Request                                              |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Insert Subscriber Data Answer                                               |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |



*** inter mme TAU with ACTIVE FLAG= ON
case id:NS_129_31_0002
Purpose of this test case is to ensure UE makes inter MME TAU (S_MME --> T_MME) successfully. Active flag is ON in TAU request. 

ENB                                    tMME                                   sMME                                     SGW                                     HSS
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Request)                        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Context Request                     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Context Response                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Context Acknowledge                 |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Update Location Request                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Update Location Answer                                                                                              |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Initial Context Setup Request (Track|                                       |                                       |                                       |
|ing Area Update Accept)                |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Initial Context Setup Response      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Complete)                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |



*** intersystem TAU
intersystem s3_based Handover(ISHO) from 3G to LTE(TA) 
case id:NS_001505_01_0001
in TAU procedure no interaction with SGSN
SGSN                                    MME                                     ENB                                     SGW                                     HSS
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Tracking Area |                                       |                                       |
|                                       |Update Request)                        |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Authentication Information Request                                                                                  |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Authentication Information Answer                                                                                   |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Authenticati|                                       |                                       |
|                                       |on Request)                            |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Authentication|                                       |                                       |
|                                       | Response)                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Security Mod|                                       |                                       |
|                                       |e Command)                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Security Mode |                                       |                                       |
|                                       |Complete)                              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Update Location Request                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Update Location Answer                                                                                              |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - UE Context Modification Request     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - UE Context Modification Response    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Tracking Are|                                       |                                       |
|                                       |a Update Accept)                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Tracking Area |                                       |                                       |
|                                       |Update Complete)                       |                                       |                                       |
|                                       |                                       |                                       |                                       |



*** intersystem RAU
RAU is a routing area update procedure in 3G which is similar to TAU procedure in 4G, inter RAU happend between two SGSNs
intersystem RAU from 4G to 3G 
caseid: NS_48_24_0004
the Routing Area Update takes place when a UE that is registered with an MME selects a UTRAN cell.
in this case, the US changes to a Routing Area that the UE has not yet registered with the network.

UE will start a new register to UTRAN to SGSN, and SGSN will ask mme about the contexts

      SGSN-Context-Request(RAI,P-TMSI,RAT Type)
SGSN------------------------> MME                  

    Context Response
   <-------------------------

    Context Acknowlege
   -------------------------->


*** gn based interoperation (MME----SGSN)
gn interface 4g tac tau from 3g to 4g
Gn/Gp SGSN to MME Tracking Area Update(23401)

mme_net1 <--- INITIALUEMESSAGE(TAUREQ) ---- enb41
mme_net1 ---- AIR ---> hss01
mme_net1 <--- AIA ---- hss01
mme_net1 ---- DOWNLINKNASTRANSPORT(AUTHREQ) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(AUTHRSP) ---- enb41
mme_net1 ---- DOWNLINKNASTRANSPORT(#SECURITYMODECMD) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(#SECURITYMODECMP) ---- enb41
mme_net1 ---- CREATESESSIONREQ ---> s11sgw01
mme_net1 <--- CREATESESSIONRSP ---- s11sgw01
mme_net1 ---- ULR ---> hss01
mme_net1 <--- ULA ---- hss01
mme_net1 ---- DOWNLINKNASTRANSPORT(#TAUACC) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(#TAUCMP) ---- enb41
mme_net1 ---- UECONTEXTRELEASECOMMAND ---> enb41
mme_net1 <--- UECONTEXTRELEASECOMPLETE ---- enb41


if qci/arp/apn-ambr has been modified and the related active PDN with the modified Qos profile
mme send Modify Bearer Command to SGW.
mme_net1 ---- MODIFYBEARERCMD ---> s11sgw01  (modify bearer command)
mme_net1 <--- UPDATEBEARERREQ ---- s11sgw01

### since tau's active flag false above, so connect s1 context, if flag is true, this not neccesary
mme_net1 ---- PAGING ---> enb41
mme_net1 <--- INITIALUEMESSAGE(SERVICEREQ) ---- enb41
mme_net1 ---- AIR ---> hss01
mme_net1 <--- AIA ---- hss01
mme_net1 ---- DOWNLINKNASTRANSPORT(#AUTHREQ) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(#AUTHRSP) ---- enb41
mme_net1 ---- DOWNLINKNASTRANSPORT(#SECURITYMODECMD) ---> enb41
mme_net1 <--- UPLINKNASTRANSPORT(#SECURITYMODECMP) ---- enb41
mme_net1 ---- INITIALCONTEXTSETUPREQUEST ---> enb41
mme_net1 <--- INITIALCONTEXTSETUPRESPONSE ---- enb41
mme_net1 ---- MODIFYBEARERREQ ---> s11sgw01
mme_net1 <--- MODIFYBEARERRSP ---- s11sgw01
#######

mme_net1 ---- ERABMODIFYREQUEST ---> enb41
mme_net1 <--- ERABMODIFYRESPONSE ---- enb41
mme_net1 <--- UPLINKNASTRANSPORT(#MODIFYEBCACC) ---- enb41
mme_net1 ---- UPDATEBEARERRSP ---> s11sgw01
mme_net1 ---- MODIFYBEARERCMD ---> s11sgw01
##ending of 5.4.2.2






*** 
** Handover procedure
When a UE has connection to an eNB(through some cell), it is constantly measuring the signal strenths of all the
cell around it.
UE  EMM=registered ECM=connected
while UE is moving, it notices that a new cell is having a significantly stronger signal
than the current cell,then UE will send a Measurement Report to the source eNB
about the event
When source eNB receives the Measurment report it'll make a decision about performing a handover

overview of all handover scenario including intra/inter MME

SENB                                sMME          tMME                                   tSGW                             targetENB                                    sSGW
|                                   |             |                                        |                                       |                                       |
|<-----------------------------------------------------------DL------------------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|---------------------------------->|             |                                        |                                       |                                       |
| - Handover Required               |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Relocation Req                                |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |  - Create Session Request/Resp         |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | ------------------------------------------------------------------------------>|                                       |
|                                   |             |  - Handover Request/  Acknowledge(tenb-teid,enb-dl-teid)                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             | CreateIDFT Req(tenb-dl-teid)/Resp(tSGW-dlteid) |                               |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |<------------|                                        |                                       |                                       |
|                                   |Forward Relocation Res                                |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |               - Create IDFT Request(tSGW-dlteid)/Resp(sSGW-dlteid)                                                                   |<tSGW-dlteid>
|                                   |             |                                        |                                       |                                       |
|<----------------------------------|             |                                        |                                       |                                       |
| - Handover Command(sSGW-dlteid)   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|---------------------------------->|             |                                        |                                       |                                       |
| - ENB Status Transfer             |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Access Context Notification/Ackownledge       |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | ------------------------------------------------------------------------------>|                                       |
|                                   |             |  - MME Status Transfer                                                         |                                       |
|                                   |             |                                        |                                       |                                       |
|enb-teid                           |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |PGW still send DL data to sSGW here
|<------------------------------------------------------------------------------------DL-----------------------------------------------------------------------------------|
|-------------------------------------------------------------------------------------DL---------------------------------------------------------------------------------->|sSGW-dl-teid
|                                                                                tSGW-dltid|<---------------------DL-------------------------------------------------------|
|                                                                                          |----------------DL-------------------->|tenb-dl-teid                           |
|
|------------------------------------ UE detach from old cell and sync to new cell-----------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |<---------------UL-------------------- |for ue know it's time to send UL data    
|                                   |             |                                        |                                       |                                       |
|                                   |             | <------------------------------------------------------------------------------|                                       |
|                                   |             |  - Handover Notify                                                             |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Relocation Complete Notification/Ackownledge  |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |Modify Bearer Request(tenb-teid)/Resp   |<tenb-teid>                            |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |---------------DL--------------------> |for PGW know it's time to send DL to tSGW   
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|------------------------------------    -Tracking area update procedure  .------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|------------------------------------ -Resource release for whole handover.------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |             |  - Delete Session Request                                                                                              |
|<----------------------------------|             |                                        |                                       |                                       |
|UE Context Release Command/Complete|             |                                        |                                       |                                       |
|                                   |<-------------------------------------------------------------------------------------------------------------------------------------|
|                                   |             |  - Delete Session Response                                                                                             |
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |             |  - Delete Indirect Data Forwarding Tunnel Request/Response                                                             |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |  - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                   |             | el Request/Response                    |                                       |                                       |
|



precondition: ATTACH and default bearer setup

*** intra mme handover through s1 interface     without SGW relocation
when ue handover from source enb to target enb, the downlink data will lost it destination for a short time.
So in S1 handover, SGW will play as a route, it forward downlink data to target enb, when SGW send downlink
data to source eNB, eNB will forward it to SGW, and SGW forward it to Target eNB, and target eNB will buffer
these data till ue handover to target ENB complete.
case id:NS_70_7_0001 without SGW relocation
SGW indirect data forwarding tunnel usage: when tenb hasn't a formal tenb-teid id, sgw and teb both allocate temprory teid for this indrect data forwarding
 sgw---------------- ->senb----------------------->sgw----------------------->tenb 
sgw-DL-teid          former-senb-teid            sgw-teid             tenb-DL-teid


so above only sgw-teid remain the same in the whole handover procedure, all the DL-teid will be removed and senb former-senb-teid will be removed also

Source eNB                          MME                                 Target eNB                            SGW                                 UE                                  
enb-teid                           mme-teid                                                               sgw-teid-c/u
mme-s1ap-id                        sgw-teid-c/u                                                           mme-teid
enb-s1ap-id                        mme/enb-s1ap-id                                                        enb-tid
sgw-teid-u
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|                                    |
|                                    |                                    |                                    |                                    |                                    
|------------------------------------------------------------------UL----------------------------------------->|                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|HandoverRequired(mme-s1apid,tenb-id)|                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    | Handover Request(mme-s1ap-id-tenb, |                                    |                                    |
|                                    |sgw-teid-u,uecontext)               |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |A:[tenb-s1id,tebTEID,tebDLTEID]     |                                    |                                    |
|                                    | <sgw-teid-u,mme-s1ap-id>           |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverRequestAck(tenb-s1id,tenbDLTEID)|                                |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Create IndirectDataForwardingTunnel Request(tenbDLTEID)                  |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |A:<tenbDLTEID>,[SGW-DL-TEID]        |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Create Indirect Data Forwarding Tunnel Response(SGW-DL-TEID)           |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  Handover command(SGW-DL-TEID)     |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  A:<SGW-DL-TEID>                   |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|                                    |
|enb-TEID                            |                                    |                                    |                                    |                                    
|-----------------------------------------------------------------DL------------------------------------------>|      now a dl data will from       |
|                                    |                                    |                         sgw-dl-teid|    sgw---->senb---->sgw----->tenb  |                                    
|                                    |                                    |<---------------DL------------------|                                    |                                    
|                                    |                                    |tebDLTEID                           |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  eNB STATUS TRANSFER               |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |  Mme STATUS Tansfer                |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                          sgw-teid  |                                    |                                    
|                                    |                                    |-----------UL---------------------->|   now targe enb establish with ue  |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |<------------------------------------------------------------------------|
|                                    |                                    |   Handover confirmed                                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |  Handover NOTIFY                   |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(mme-teid,tenb-teid)                              |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(sgw-teid-u)                                     |                                    |
|                                    |                                    | teb-teid                           |                                    |                                    
|                                    |                                    |<----------DL-----------------------|    now DL using tenb-teid instead  |                                    
|                                    |                                    |                                    |    of  forward tunnel              |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Request                         |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Response                        |                                    |


*** intra mme s1 handover with SGW relocation
The differce between with/without SGW relocation is that
SGW relocation means that new sgw-teid-c/u are needed, so extra Create Session Req/Resp are needed for target SGW.
and the IDFT is different
DL data flow is :  sSGW-> sENB-> sSGW ->  (tSGW) -> tENB

tSGW is an extra one compared to without SGW relocation

So there are two IDFT, 
one is 
case id: NS_130_2_0001 with SGW relocation

SENB                                     MME                                    tSGW                             targetENB                                    sSGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required                   |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Session Request              |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | A:[sgw-teid-c,sgw-teid-u]             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | Create Session Response(sgw-teid-c/u) |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Handover Request                                                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Request Acknowledge(tenb-teid,enb-dl-teid)                          |                                       |
|                                       |<tenb-teid>                            |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request(tenb-dl-teid)               |tenb-dl-teid                           |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response(tSGW-dlteid)               |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(tSGW-dlteid)                                                         |<tSGW-dlteid>
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sSGW-dlteid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sSGW-dlteid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|enb-teid                               |                                       |                                       |                                       |
|<-------------------------------------------------------------------------DL-----------------------------------------------------------------------------------|
|--------------------------------------------------------------------------DL---------------------------------------------------------------------------------->|sSGW-dl-teid
|                                                                     tSGW-dltid|<---------------------DL-------------------------------------------------------|
|                                       |                                       |----------------DL-------------------->|tenb-dl-teid                           |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - MME Status Transfer                                                         |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Notify                                                             |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Modify Bearer Request(tenb-teid)    |<tenb-teid>                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Modify Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |----------------DL-------------------->|tenb-teid                           |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-----------------------------------------Resource release for whole handover.----------------------------------------------------------------------------------|                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Session Request                                                                                              |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response                            |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Session Response                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Indirect Data Forwarding Tunnel Response                                                                     |
|                                       |                                       |                                       |                                       |

*** intra mme partially handover
As an operator I want that MME is able to handle the case that the target eNB does not accept one or more default bearers during a otherwise successful S1 based handover procedure in order to releases resources that are not needed any i
longer and terminate the procedure properly.
If all default bearer is in the failedsetuplist in HandvoerRequetAck message, then no continuing handover procedure IDFT creating and MBR message flow.
case id: NS_70_28_0001 partially handover

precondition: PDN1: default bearer 5; PDN2: default bearer 6 ,dedicated bearer 8; PDN3: default bearer 7
Source eNB                          MME                                 Target eNB                            SGW                                 UE                                  
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|HandoverRequired(mme-s1apid,tenb-id)|                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    | Handover Request(e-rabs to be setup|                                    |                                    |
|                                    |item ie for 5,6,7&8)                |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |A:default bearer 5&8 is accepted    |                                    |                                    |
|                                    | while 6&7 not accepted>            |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverRequestAck(bearer 5,8 in e-rab|                                  |                                    |
|                                    |admittedlist,6,7 in failedsetuplist|                                     |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Create IndirectDataForwardingTunnel Request(bearer context for bearer5)  |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Create Indirect Data Forwarding Tunnel Response(SGW-DL-TEID)           |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  Handover command(e-rabs forwarding|                                    |                                    |                                    |
|items  5,e-rab releaselist 6,7,&8   |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  eNB STATUS TRANSFER               |                                    |                                    |                                    |
|                                    |----------------------------------->|                                    |                                    |
|                                    |  Mme STATUS Tansfer                |                                    |                                    |
|                                    |                                    |<------------------------------------------------------------------------|
|                                    |                                    |   Handover confirmed                                                    |
|                                    |<-----------------------------------|                                    |                                    |
|                                    |  Handover NOTIFY                   |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |-------------------------------------------------------------------------|                                    |
|                                    |for every pdn connection, there's one MBR message sent                   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-1,bearercontextstobemodified 5)   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-3,bearercontextstoberemoved 7)    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(pdn connection-1,bearercontextstobemodified 5)  |                                    |
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer reponse(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(pdn connection-3,bearercontextstoberemoved 7)   |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |-------------------------------------------------------------------------|                                    |
|                                    |for pdn connection failed to be forwarded, there's DSR message sent      |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Delete Session  request(pdn connection-1,bearercontextstobemodified 5)   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Request                         |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Response                        |                                    |


*** x2 handover without SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_13_2_0002  
Target eNB                              MME                                   SGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | Modify bearer request(teb-teid)      |
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | Modify bearer response               |
|                                       |                                      |
| <-----------------------------------  |                                      |
| Path Switch Request Ack               |                                      |



*** x2 handover with SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_130_3_0001
Target eNB                              MME                                   tSGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | create session request(teb-teid)     |<teb-teid>[sgw-teid-c/u]
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | create session response(sgw-teid-c/u)|
|                                       |                                      |
|                                       |                                      |
| <-----------------------------------  |                                      |
| Path Switch Request Ack(sgw-teid-u)   |                                      |


**** How MME know this handover need SGW relocation?
when MME received target-enb tai is different with the source-enb ta list, it will trigger DNS check state, if sgw is as the same hostname and ip, then, no sgw relocation.



*** inter mme(s10) s1 handover without SGW relocation        
source mme sut case id:NS_129_11_0002
target mme sut case id:  NS_129_22_0001

sENB                                    sMME                                    tMME                                    tENB                                    SGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required(tenb-id)          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Forward Relocation Request(sgw-teid-u, |<sgw-teid-u>[sgw-teid-c]               |                                       |
|                                       |  imsi,tenbid)                         |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       |  -Handover Request(sgw-teid-u)        |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       |HandoverRequestAck(enb-dl-teid,enb-teid)|                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       |Forward Relocation Response(enb-dl-teid)|                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(enb-dl-teid)                                                         |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sgw-dl-teid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sgw-dl-teid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Access Context Notification |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Access Context Acknowledge  |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       | - MME status transfer                 |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       | - Handover Notify                     |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Relocation Complete Notifica|                                       |                                       |
|                                       |tion                                   |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Relocation Complete Acknowle|                                       |                                       |
|                                       |dge                                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |------------------------------------------------------------------------------>|
|                                       |                                       |  - Modify Bearer Request (tenb-teid)                                          |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<------------------------------------------------------------------------------|
|                                       |                                       |  - Modify Bearer Response                                                     |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |


*** intersystem  Gn_based Handover (ISHO) from LTE to 3G 
MME act like 3g SGSN
The source eNB sends a Handover Required message to the MME to inform that the UE has changed cell. The message contains target RNC ID. The MME determines
the target SGSN from the target RNC ID with S-NAPTR DNS inquiry (if the feature SNAPTR (Rel 8) DNS query for Gn SGSN is enabled. Otherwise, the MME uses pre-
Rel 8 DNS query). The MME maps EPS bearer(s) to PDP context(s) and provides the Release 99 parameters of the bearer QoS profile to the SGSN

Gn Based 3G LTE pic:

     Gr
HLR--------\
            \    Gn
RNC--------SGSN-------PGW
            |          | 
          Gn|          |s5
            |  s11     |
ENB--------MME-------SGW
          /    
         /
HSS-----/
Gn: Gtpv1


case: NS_131_10_0001 
Similar IDFT established, but all the default  bearer related resource both in ENB and SGW will be released(sgw-teid-c/u,enb-teid-u), all ids in MME also be removed
ENB                                              MME                                               SGSN                                              SGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Handover Required                             |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Request                    |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Forward Relocation Response                   |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Create Indirect Data Forwarding Tunnel Request                                                  |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Create Indirect Data Forwarding Tunnel Response                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Handover Command                              |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Forward Relocation Complete Notification      |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Complete Acknowledge       |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - UE Context Release Command                    |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session Request                                                                          |
|------------------------------------------------>|                                                 |                                                 |
| - UE Context Release Complete                   |                                                 |                                                 |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Delete Session Response                                                                         |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Indirect Data Forwarding Tunnel Request                                                  |


**** inersystem Gn_based Handover(ISHO) from LTE to 3G multiple bearers
when there are multiple bearer, for example, two pdn default bearer, and two dedicated bearer linked to those two default bearers.
when handover, ForwardRelocationRequest will send 4 pdp contexts, ebi corresponding to nSAPI
and another field in this message:
selectionModewithNSAPI two dedicated bearer will be in that.

                 
                   
                  
*** intersystem  S3_based Handover (ISHO) from LTE to 3G using S4-SGSN
LTE to 3G S3-based handover procedure with or without S-GW relocation
When the S3-based inter-system handover feature is enabled, the MME uses the SNAPTR DNS query and requests both S3 and Gn addresses. The feature DNS query
type in S3-based inter-system handover is used to decide which is used, RAI or RNC ID, to make the DNS query.If there is a result after the S-NAPTR DNS query, the MME sends the Forward
Relocation Request message (MM context and PDN connections) to the target SGSN over the S3 interface.

S3 interface in the LTE system(S4-SGSN)
      Gb                   S4                S5
BSC-----------S4-SGSN--------------SGW-------------PGW
               /  |  \s6d           /
              /   |   \            / 
RNC----------/    |   HSS         /
                S3|  /s6a        /
                  | /           /s11
ENB--------------MME-----------/
 

As we can see here, SGSN connected directly to PGW, so teid of SGW is not necessary, when handover from 3G to LTE, mme will send creatsessionrequest to SGW
and when from LTE to 3G, mme will send deletesessionrequest to SGW for it's not useful in Gn based SGSN.

But in S3 interface, SGSN-S4 connected direct to SGW, so teid of SGW is necessary, when handover from LTE to 3G,mme won't release the sgw-teid resource(unless SGW relocated)
and when form 3G to LTE,mme won't send createsessionrequest to SGW(unless SGW relocated).


case id:NS_001288_01_0001
ENB                                               SUT                                               SGSN                                              SGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Handover Required                             |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Request                    |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - ForwardRelocationResponse(SGSN_F_TEID_for_dl_data_forwarding |                                  |
|                                                 | rNC_F_TEID_for_dl_data_forwarding )             |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Create Indirect Data Forwarding Tunnel Request(SGSN_F_TEID_dl)                                  |
|                                                 | rNC_F_TEID_for_dl_data_forwarding )             |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Create Indirect Data Forwarding Tunnel Response(SGW_FTEID_DL)                                   |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Handover Command                              |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Complete Acknowledge       |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - UE Context Release Command                    |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Indirect Data Forwarding Tunnel Request                                                  |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - UE Context Release Complete                   |                                                 |                                                 |

this is only valid , when SGW is relocated(indication flag<sGWChangeIndication e_true(1)>)in FowardRelocationResp, then MME will send delete session request. 
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session  Request                                                                         |




*** intersystem s3_based Handover(ISHO) from 3G to LTE  without SGW relocation
case id:NS_001505_01_0001
SGSN                                    MME                                     ENB                                     SGW                                     HSS
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Forward Relocation Request          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Handover Request                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Handover Request Acknowledge        |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Forward Relocation Response         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Handover Notify                     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Forward Relocation Complete Acknowle|                                       |                                       |                                       |
|dge                                    |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |
|                                       |                                       |                                       |                                       |



*** SRVCC handover to GERAN/UTRAN with PS HO in Gn interface.(also sv interface[MME, MSC] configured)
The core network needs to support VoIP capable LTE handsets to continue onging voice call when the user move outside of LTE coverage and the voice call is moved
to CS domain usgin 2G/3G access. This functionality is called single radio voice call continuity(SRVCC)
This functionality enables operators to reuse exsiting CS voice infrastructure in areas where LTE is not yet deployed.
The call is anchored in IMS and the UE is capable of transmitting and receiving in only one of those acess networks at a time.
The MME makes handover for the PS voice bearer towards the MSC server over the sv interface and for non-voice bearer towards SGSN over Gn interface.

network as: voice bearer was transfered through MSC, and not using SGW/PGW anymore.


             CS    Voice              |----------------------|
BSC/RNC----SGSN-----MSC------------------IMS                 |
                   /                  |                      |
                  /Sv        PS voice |                      |
ENB-----------MME/-----SGW/PGW---------------internet         |
                                      |   corporate services |
                                      |______________________|

PS service was transfered as follow through Gn interface:

BSC/RNC------SGSN-------\        
             |           \      
             |Gn          PGW------internet corporateive service
             |           /
ENB--------MME--------SGW

So after SRVCC PS handover, all LTE network element will release all the bearer realted resources.
ENB: ue context release command
SGW: delete session request
  

case id: NS_1279_5_0001
one default bearer established in  attach,
mSNetworkCapability: sRVCC_to_GERAN_UTRAN_capability(1) in attachRequest
S1AP.SRVCCO
perationPossible possible(0) in  Ue context setup message  
one dedicated bearer established later
Now travel from LTE to 3g 


ENB                                     MME                                     MSC                                     SGSN                                    SGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required                   |                                       |                                       |                                       |
|(S1AP.SRVCCHOIndication pSandCS        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |MME seprate voice bearer(qci=1)        |                                       |                                       |
|                                       |-------------------------------------->|(dedicated bearer handover to MSC)     |                                       |
|                                       | - SRVCC PS to CS Request(mme-teid)    |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - SRVCC PS to CS Response             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Forward Relocation Request                                                  |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Forward Relocation Response                                                 |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response                                                                     |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command                    |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|(default bearer handover complete)     |
|                                       | - Forward Relocation Complete                                                 |                                       |
|                                       |                                       |                                       |                                       |

|                                       |<--------------------------------------|                                       |                                       |
|                                       | - SRVCC PS to CS Complete Notification|                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - SRVCC PS to CS Complete Acknowlege  |(dedicated bearer to MSC complete)     |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|release dedicated bearer
|                                       | - Delete Bearer Command                                                                                               |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Bearer Request                                                                                               |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Bearer Response                                                                                              |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Forward Relocation Complete Acknowledge                                     |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Session Request                                                                                              |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Session Response                                                                                             |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |


**** SRVCC handover with multiple bearers
case id: NS_001344_04_1015
when there are multiple bearer, for example, two pdn default bearer, and two dedicated bearer linked to those two dedicated bearers.
one of dedicated bearer is voice call bearer(qci 1)
when handover, ForwardRelocationRequest will send 3 pdp contexts, ebi corresponding to nSAPI
voice bearer  will be in SRVCC PS to CS Request




*** SRVCC from E-UTRAN to UTRAN/GERAN without packet-switched handover(PS HO)
SRVCC HO Indication:CSOnly
The UE sends measurement reports to the E-UTRAN. Based on the UE measurement reports the source E-UTRAN triggers an SRVCC handover to the UTRAN/GERAN. The
eNB sends the Handover Required message, indicating that the target is UTRAN/GERAN with only CS HO support, to the source MME, so the data service will be 
transfered to SGSN via IS RAU instead of handover.


This procedure is after attach procedure:
TestScenrio1:

| Attach (DefBR) | HO Required (SRVCC HO Indication - CSOnly) | SRVCC PS To CS  Req & Res (MSC) | HO Cmd |
| SRVCC PS To CS Complete Notification & Ack | DedBR Deact Delete Bearer Cmd & Res (SGW) | IS RAU SGSN Cntx Req, Res & Ack |
| UE Cntx Rel Cmd & Cmpl | Delete Session Req & Res (SGW) |


ENB                                     MME                                     SGW                                     HSS                                     SGSN
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Bearer Resourc|                                       |                                       |                                       |
|e Allocation Request)                  |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Bearer Resource Command             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Create Bearer Request               |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - E-RAB Setup Request (Activate Dedica|                                       |                                       |                                       |
|ted EPS Bearer Context Request)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - E-RAB Setup Response                |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Activate Dedic|                                       |                                       |                                       |
|ated EPS Bearer Context Accept)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
-----------------------------------------above is create a dedicated bearer procedure after a imsi attach procedure---------------------------------------------|                                       |                                       |                                       |
|                                       |

ENB                                    MME                                     SGW                                     MSC                                     SGSN 
|-------------------------------------->|                                       |                                       |                                       |
|Handover Required(SRVCC HO ind-CSOnly) |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|
|                                       | -  SRVCC PS To CS Req/Res                                                     |
|                                       |<------------------------------------------------------------------------------|
|                                       | -  SRVCC PS To CS Req/Res                                                     |
|<--------------------------------------|                                       |
|- Handover Command                     |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|
|                                       | -  SRVCC PS To CS Complete Notification                                       |
|                                       |------------------------------------------------------------------------------>|
|                                       | -  SRVCC PS To CS Complete Acknowledge                                        |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Bearer Command               |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Delete Bearer Request               |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                      UE switched to UTRAN/GERAN all 3g stuff
                            MS-----------------------------Routing area update request------------------------------------------------------------------------->|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|(RAU
|                                       | - SGSN Context Request                                                                                                | 
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - SGSN Context Response                                                                                               |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - SGSN Context Acknowledge                                                                                            |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Release Access Bearer Request       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Release Access Bearer Response      |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Session Request              |                                       |                                       |





* NACC (Network Assisted Cell Change) from UTRAN to GERAN

In today's GPRS networks (without NACC), cell re-selection can causes a service interruption in the region of 4–8 seconds, which obviously has an impact on the user experience.
Similar interruption times can be expected in mixed UMTS and GPRS networks, during UE cell re-selection from UTRAN to GERAN.
Consequences of this: e.g. TCP applications may time-out at cell change and suffer from the slow-start mechanism, streaming applications may stop at cell change due to client
buffer depletion. All such problems will lead to an unacceptable user experience.
This "Network Assisted Cell Change" feature has already been introduced in the GERAN specifications and the appropriate changes have been to the RLC/MAC protocol [TS 44.060]

** customer senario
NA05868027: RIM-messages from shared radio-network

Msg.nr 99719    S1-eNBDirectInformationTransfer from eNodeB ID=111125, tac=2AFE to lac=2AFC
Msg.nr 99763 DNS-query from AVKC-MME-Gn, rac0000.lac2AFC.mnc024.mcc240.gprs
Msg.nr 99780 DNS-reponse with a list of IPs
Msg.nr 99807 Gn-RAN Information Relay, from AVKC-MME-Gn to AVKC-SGSN-Gn.
Msg.nr 99817 BSSGP-RAN Information Request, from AVKC-SGSN-Gb to BSC110
Msg.nr 100454 BSSGP-RAN Information, from BSC110 to AVKC-SGSN-Gb
Msg.nr 100470 DNS-query from AVKC-SGSN-Gn, tac2AFE.mnc007.mcc240.gprs.
Msg.nr 100484 DNS-response with a list of IPs
Msg.nr 100495 Gn-RAN Information Relay, from AVKC-SGSN-Gn to AVKC-MME-Gn.
No message on S1 from AVKC-MME-Gn ???
 

SGSN                                              BSC                                               MME                                               ENB
|                                                 |                                                 |                                                 |4G-->2G
|                                                 |                                                 |<------------------------------------------------|
|                                                 |                                                 | - ENB Direct Info Transfer(S1AP)                |
|                                                 |                                                 |                                                 |
|<--------------------------------------------------------------------------------------------------|DNS-query for rac0000.lac2AFC.mnc024.mcc240.gprs |
| -  RAN Information Relay(GTP)                                                                     |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - RAN Information Request(BSSGP)                |                                                 |                                                 |

|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|2G-->4G                                          |                                                 |
| - RAN Information                               |                                                 |                                                 |
|DNS-query tac2AFE.mnc007.mcc249.gprs             |                                                 |                                                 |
|-------------------------------------------------------------------------------------------------->|                                                 |
| - RAN Information Relay(Gtp)                                                                      |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |------------------------------------------------>|
|                                                 |                                                 | - MME Direct Information Transfer(S1AP)         |



* EPS session management related
Default bearer:   with new PDN addr(APN), QCI to create, with a ebi(allocated from mme side), sending (create session req) to SGW from MME to get s1-u-sgw-fteid from CSResp.
                  Then E-RAB setup procedure: sending (E-RAB setup) to ENB containing ebi, s1-u-sgw-fteid as transportlayeraddr, and Qos,APN,PDNAddr(ip).
                                              ENB response if the setup successful(with allocated s1-u-enb-fteid by ENB). if fail(no teid).
                  then seding Modify Bearer Req to SGW containing s1-u-enb-fteid. 


         
dedicated bearer: without APN, but new QCI, tft, LinkedBearIdentity(ebi of default bearer), s1-u-sgw-fteid sending (create bearer req) from SGW.(ebi of dedicated bearer will be omit)
                  multiple dedicated bearer could be established with only one LBI(LinkedBearerId) on the same default bearer for different qos level(qci), same PDN addr/ip, APN.
                  Then E-RAB setup procedure: seding (E-RAB setup) to ENB containing s1-u-sgw-fteid as transportlayeraddr, Qos, tft and ebi;
                                              ENB response(E-RAB response) if the setup successful(with s1-u-enb-fteid as transportlayeraddr).
                  then sending CreateBearerResponse to SGW containing s1-u-enb-fteid.               


For operator-based applications such as VOIP, special Qos requirements such as a constant delay and minimum bandwidth can be ensured for a particular traffica flow by 
                  establishing a dedicated bearer. IP packets flowing over a dedicated bearer use the same source IP address as packets flowing through the bearer, but destination ip
                  address(SGW_TEID) is different from defualt bearer.



** Bearer, PDN and payload
ip packet on s1-u and s5/s8/u
------------------------------------------------------------------------------|
| GTP-U service-IP  | UDP packet | GTP-U header | GTP-U palyload             |                     |
|                   |            |              | IP packet in real internet |                     |
|                   |            |              | ----------                 | ------------------- |
| S: s1-u-enb-fteid | sport      |              | S:PDN-IP                   | real ip-payload     |
| D: s1-u-sgw-fteid | dport      |              | D:Host-IP                  |                     |
|-------------------+------------+--------------+----------------------------+---------------------|

There are two ip headers in a s1-u ip packet
one is ip header for udp trasport layer of GTP(all the s1-u fteid allocated in signalling with MME SM procedure)
other one is the real internet ip packet in that PDN.(PDN-IP is the real source addr and Host-IP is the real application host)
*** default Bearer concept
for one apn wap.nokia.com, only one default bearer could be established.

|first default bearer Act in Attach procedure      
|---------------------------------------------
HSS -> MME|get APN from HSS through ula's IE APN-Configuration[PDN-Type(ipv4), service-Selection(wap1.nokia.com),pgw-allocation-type(dynamic)]
MME -> DNS|DNS query for (sgw[using tai]/pgw ip[using apn and mnc,mcc] wap1.nokia.com.mnc002.mcc460.gprs) [do the pairing of SGW&PGW], get sgw-fteid-c-ip and pgw-fteid-c-ip
#### send this sgw-fteid-c-ip CreateSessionRequest
MME -> SGW|CSeReq(fteid-mme,PGWip[pgw-c ip from DNS query],apn[wap1.nokia.com.mnc002.mcc460.gprs],bearertobecreated[ebi])
#### send pgw-c-fteid to SGW to get paa from PGW 
SGW -> PGW|SGW get (fteid-pgw-gtp-c, paa[pgw allocation ip addr]) from PGW via PGWip addr
##### send paa and fteid-s1-sgw-u, fteid-pgw-u to MME
MME <- SGW|CSeResp(fteid-sgw-gtp-c,fteid-pgw-gtp-c,paa[pgw allocation ipaddr],bearertobecreated res[fteid-s1-sgw-gtp-u,e_s5_or_s8_pgw_gtp_u])
#### send paa, fteid-s1-sgw-u ip, to ENB
MME -> ENB|InitialContextSetupReq(fteid-s1-sgw-gtp-u,apn,pdnaddr[paa],E_RABToBeSetupItemCtxtSUReq[erab-id same with ebi]) ---for real dst ip addr is:paa(PDN-ip)
MME <- ENB|InitialContextSetupRes(E_RABToBeSetupItemCtxtSUReq(erabid,transportLayerAddress[ftied-s1-enb-gtp-u]))
===Now UE could send a uplink ip packet to APN via GTP-U message to www.google.com
===GTP-U ipsrc: fteid-s1-enb-gtp-u      GTP-U-PalyLoad   realipsrc:PDN-ip
===      ipdst: fteid-s1-sgw-gtp-u                       realipdst:www.google.com
MME -> SGW|ModifyBearerReq(fteid-s1-enb-gtp-u)
===Now UE could receive a downlink ip packet from PGW, 
===GTP-U ipsrc: fteid-s1-sgw-gtp-u      GTP-U-PalyLoad   realipsrc:www.google.com
===      ipdst: fteid-s1-enb-gtp-u                       realipdst:PDN-ip [paa]


****  default bearer establishment
MME will request create session to SGW for one apn
for one apn wap.nokia.com, only one default bearer could be established.

==============
 Assert Rest Response    Rest Show Subscribers    ${IOTA.IMSI2}
for enb, enbS1uTeids will be the same, when attach to mme, when create session request, sgw allocate different teid-ip for different ebi;
$ grep "S1uTeid\|ebi\|serviceSel\|qci" /tmp/afdfa
4gAttachimsi: 
              ULR
              ULA, get  pdn[wap1.nokia.com] from HSS 
              Create Session Request, ebi:5,qci: 9,PAA(ip) APN:wap1.nokia.com.mnc002.mcc460.gprs, FTEID:PGW-c ipaddr
              Create Session Response,   PGW-u ipaddr and SGW-u ipaddr
              InitialContextSetupReq, activate default eps bearer context request
              InitialContextSetupRsp 
 ### create a default eps bearer 
------------------------------------------------------------
                  u'bearerId (ebi)': 5,
                  u'enbS1uTeids': {u'addrIpv4': u'172.16.49.41',
                                 u'qci': 9,
                  u'linkedBearerId (lbi)': 5,
                  u'serviceSelection': u'wap1.nokia.com',
                  u'sgwS1uTeid': {u'addrIpv4': u'172.16.49.211',
--------------------------------------------------------------------------------

4gPdnConnect:  for default eps session with another apn wap2.nokia.com
              Uplink,pdn connectivity request[apn:wap2.nokia.com](enb-->mme)
              create sesson request:  ebi:6,qci: 9, PAA(ip), APN(wap2.nokia.com.mnc002.mcc460.gprs), FTEID:PGW-c ipaddr
              create sesson response:  PGW-u ipaddr and SGW-u ipaddr
              ERAB-SetupReq, activate default eps bearer context request (MME-->ENB)
              ERAB-SetupRsp, Uplink, activate default eps bearer context accept(ENB-->MME)
InitialContextSetupRsp 

 ### create a default eps bearer, enbS1uTeids different from previous default eps session 
-------------------------------------------------------------------------
                  u'bearerId (ebi)': 6,
                  u'enbS1uTeids': {u'addrIpv4': u'172.16.49.41',
                                 u'qci': 9,
                  u'linkedBearerId (lbi)': 6,
                  u'serviceSelection': u'wap2.nokia.com',
                  u'sgwS1uTeid': {u'addrIpv4': u'172.16.49.111',
-----------------------------------------------------------------------------------

*** dedicated bearer establishment
PGW will request create bearer to MME for a dedicated bearer establishment, such as skeype these GBR service
dedeciated bearer should be linked to default bearer's ebi as lbi, one default bearer could be linked with multiple 
dedicated bearers

4gPgwDedicatedBearerActivation:  -lbi 6 -qci 7

create bearer request[FTEID:sgw-u ipaddr,172.16.49.7,{ qci:7,8}  ebi:6](SGW-->MME) 

ERAB-SetupReq, activate dedicated eps bearer context request(ebi7,8 two erab bearer contest list[E-rab id7, qci7],[E-rab id8, qci8]) (MME-->ENB)
ERAB-SetupRsp (MME<---ENB) 
Uplink, activate dedicated eps bearer context accept(ENB-->MME) ebi7
Uplink, activate dedicated eps bearer context accept(ENB-->MME) ebi8

create bearer response[FTEID:sgw-u ipaddr,172.16.49.7,{ebi:7, qci:7},{ebi:8,qci: 8}](SGW<---MME)



linked bearerId  not the same as itself, s
###EPS bearers are linked to a default EPS bearer. The linked bearers are represented by a Linked EPS Bearer Identity (LBI), indicating they are all associated with the same default EPS bearer.
----------------------------------------------------------------------
                  u'bearerId (ebi)': 7,
                  u'enbS1uTeids': {u'addrIpv4': u'172.16.49.41',
                                 u'qci': 7,
                  u'serviceSelection': u'',
                  u'sgwS1uTeid': {u'addrIpv4': u'172.16.49.7',
+++++++++++++++++++++++++++++++++++++++++++++++++++++++
                  u'linkedBearerId (lbi)': 5, 
                  u'bearerId (ebi)': 8,
                  u'enbS1uTeids': {u'addrIpv4': u'172.16.49.41',
                                 u'qci': 8,
                  u'linkedBearerId (lbi)': 5, 
                  u'serviceSelection': u'',
                  u'sgwS1uTeid': {u'addrIpv4': u'172.16.49.7',


==========================================================================
|        


**** dedicated bearer delete
    IOTA Procedure    4gPgwDedicatedBearerActivationOneBearer -verbose 1 -lbi 5 ## ebi6 is dedicated bearer created to link 
##to default bearer ebi 5 which in attach procedure
  IOTA Procedure       4gPgwDedicatedBearerDeactivation -verbose 1 -ebi 6

------------------------
GTP {{BODY {@DELETEBEARERREQ {{CAUSE EMPTY} {EBIS {+_list 6}} {INDICATIONFLAGS EMPTY} {LBI EMPTY} {PCO EMPTY} {PGWFQCSID EMPTY} {PTI EMPTY} {SGWFQCSID $0000}}}} {SEQNUM 9} {TEID $0200002A} {localName s11sgw01} {remoteName mme_net1}}
S1AP::ERABRELEASECOMMAND {{CRITICALITY $00} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 0} {VALUE {MMEUES1APIDOBJ {{MMEUES1APID 187}}}}} {{CRITICALITY 0} {ID 8} {VALUE {ENBUES1APIDOBJ {{ENBUES1APID 101}}}}} {{CRITICALITY 1} {ID 33} {VALUE {ERABLISTOBJ {{ERABLISTLIST {+ERABLISTLISTFLD {{CRITICALITY 1} {ID 35} {VALUE {ERABITEMOBJ {{CAUSE {@NAS 0}} {ERABID 6}}}}}}}}}}} {{CRITICALITY 1} {ID 26} {VALUE {NASPDUOBJ {{NASPDU {NAS::SECURITYPROTECTEDNASMSG {{MAC $EFD66BEF} {NASMSG {NAS::DEACTIVATEEBCREQ {{EPSBEARERID $6} {ESMCAUSE $24} {PD $2} {PTI $00}}}} {PD $7} {SECURITYHDRTYPE $2} {SEQUENCENUM $03} {XMAC $EFD66BEF} {_ISDECODED EMPTY} {_RAWNASPDU $27EFD66BEF036200CD24}}}}}}}}}} {localName enb41} {remoteName mme_net1}}

mme_net1 <--- ERABRELEASERESPONSE ---- enb41
S1AP::ERABRELEASERESPONSE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{ID 0} {VALUE {MMEUES1APIDOBJ {{MMEUES1APID 187}}}}} {{VALUE {ENBUES1APIDOBJ {{ENBUES1APID 101}}}}} {{ID 69} {VALUE {ERABRELEASELISTBEARERRELCOMPOBJ {{ERABRELEASELISTBEARERRELCOMPLIST {+ERABRELEASELISTBEARERRELCOMPLISTFLD {{ID 15} {VALUE {ERABRELEASEITEMBEARERRELCOMPOBJ {{ERABID 6}}}}}}}}}}}}} {localName enb41} {remoteName mme_net1} {streamId 1}}

mme_net1 <--- UPLINKNASTRANSPORT(#DEACTIVATEEBCACC) ---- enb41

GTP {{BODY {@DELETEBEARERRSP {{BCLIST {+ {{CAUSE $1000} {EPSBEARERID $06}}}} {CAUSE $1000} {UETIMEZONE $0A01} {ULI $1064F02000414101} {ULITIMESTAMP $E2A5668C}}}} {MSGPRIORITY EMPTY} {PBMSG EMPTY} {SEQNUM $000009} {TEID $00000107} {localName s11sgw01} {remoteName mme_net1}}

** EPS bearer Qos parameter

***  Resource Type: GBR or Non-GBR
**** Resource Type = GBR (Guaranteed Bit Rate)
For an EPS bearer, having a GBR resource type means the bandwidth of the bearer is guaranteed. Obviously, a GBR type EPS bearer has a "guaranteed bit rate" associated
(GBR will be further explained below) as one of its QoS parameters. Only a dedicated EPS bearer can be a GBR type bearer and no default EPS bearer can be GBR type. 
The QCI of a GBR type EPS bearer can range from 1 to 4.


**** Resource Type = Non-GBR
For an EPS bearer, having a non-GBR resource type means that the bearer is a best effort type bearer and its bandwidth is not guaranteed. A default EPS bearer
 is always a Non-GBR bearer, whereas a dedicated EPS bearer can be either GBR or non-GBR. The QCI of a non-GBR type EPS bearer can range from 5 to 9.


***  QoS Parameters
Every EPS bearer must have QI and ARP defined. The QCI is particularly important because it serves as reference in determining QoS level for each EPS bearer.
 In case of bandwidth (bit rate), GBR and MBR are defined only in GBR type EPS bearers, whereas AMBR (APN-AMBR and UE-AMBR) is defined only in Non-GBR type EPS bearers. 

6 qos parameters
    QCI
    ARP
    GBR
    MBR
    APN-AMBR
    UE-AMBR

 
**** QCI (QoS Class Identifier)
QCI, in an integer from 1 to 9, indicates nine different QoS performance characteristics of each IP packet. QCI values are standardized to reference specific QoS characteristics, and each QCI contains standardized performance characteristics (values), such as resource type (GBR or non-GBR), priority (1~9), Packet Delay Budget (allowed packet delay shown in values ranging from 50 ms to 300 ms), Packet Error Loss Rate (allowed packet loss shown in values from 10-2 to 10-6. For more specific values, search on Google for "3GPP TS 23.203" and see Table 6.1.7 in the document. For example, QCI 1 and 9 are defined as follows:
 
QCI = 1
: Resource Type = GBR, Priority = 2, Packet Delay Budget = 100ms, Packet Error Loss Rate = 10-2 , Example Service = Voice
QCI = 9
: Resource Type = Non-GBR, Priority = 9, Packet Delay Budget = 300ms, Packet Error Loss Rate = 10-6, Example Service = Internet
 
QoS to be guaranteed for an EPS bearer or SDF varies depending on the QCI values specified.
QCI, though a single integer, represents node-specific parameters that give the details of how an LTE node handles packet forwarding (e.g. scheduling weights, admission thresholds, queue thresholds, link layer protocol configuration, etc). Network operators have their LTE nodes pre-configured to handle packet forwarding according to the QCI value.
 
By pre-defining the performance characteristics of each QCI value and having them standardized, the network operators can ensure the same minimum level QoS required by the LTE standards is provided to different services/applications used in an LTE network consisting of various nodes from multi-vendors.    
 
QCI values seem to be mostly used by eNBs in controlling the priority of packets delivered over radio links. That's because practically it is not easy for S-GW or P-GW, in a wired link, to process packets and also forward them based on the QCI characteristics all at the same time (As you may know, a Cisco or Juniper router would not care about delay or error loss rate when it processes QoS of packets. It would merely decide which packet to send first through scheduling (WFQ, DWRR, SPQ, etc.) based on the priority of the packets (802.1p/DSCP/MPLS EXP)). 


**** ARP (Allocation and Retention Priority)
When a new EPS bearer is needed in an LTE network with insufficient resources, an LTE entity (e.g. P-GW, S-GW or eNB) decides, based on ARP (an integer ranging 
from 1 to 15, with 1 being the highest level of priority), whether to:
    remove the existing EPS bearer and create a new one (e.g. removing an EPS bearer with low priority ARP to create one with high priority ARP); or
    refuse to create a new one. 

So, the ARP is considered only when deciding whether to create a new EPS bearer or not. Once a new bearer is created and packets are delivered through it, the i
ARP does not affect the priority of the delivered packet, and thus the network node/entity forwards the packets regardless of their ARP values.
One of the most representative examples of using the ARP is an emergency VoIP call. So, an existing EPS bearer can be removed if a new one is required for a emergency
 119 (911 in US, 112 in EC, etc) VoIP call. 

**** GBR (UL/DL)
This parameter is used for a GBR type bearer, and indicates the bandwidth (bit rate) to be guaranteed by the LTE network. It is
 not applied to a non-GBR bearer with no guaranteed bandwidth (UL is for uplink traffic and DL is for downlink traffic).

****  MBR (UL/DL)
MBR is used for a GBR type bearer, and indicates the maximum bit rate allowed in the LTE network. Any packets 
arriving at the bearer after the specified MBR is exceeded will be discarded.

**** APN-AMBR (UL/DL)
As you read the foregoing paragraph, you may wonder why a non-GBR type bearer does not have a "bandwidth limit"? In case of non-GBR bearers,
 it is the total bandwidth of all the non-GBR EPS bearers in a PDN that is limited, not the individual bandwidth of each bearer. And this restriction is controlled by APN-AMBR (UL/DL). As seen in the figure above, there are two non-GBR EPS bearers, and their maximum bandwidths are specified by the APN-AMBR (UL/DL)
. This parameter is applied at UE (for UL traffic only) and P-GW (for both DL and UL traffic).

**** UE-AMBR (UL/DL)
A UE can be connected to more than one PDN (e.g. PDN 1 for Internet, PDN 2 for VoIP using IMS, etc.) and it has one unique IP address for each of its all PDN connections. Here, UE-AMBR (UL/DL) indicates the maximum bandwidth allowed for all the non-GBR EPS 
bearers associated to the UE no matter how many PDN connections the UE has.
**** TFT(EPS bearer traffic flow template)
TFT is a set of all packet filters associated with that EPS bearer.
A default bearer may or may not be assocaited with a TFT.
Every dedicated EPS bearer is assocatied with a TFT.

 Other PDNs are connected through other P-GWs, this parameter is applied by eNBs only.

*** Non-Qos Parameter 
**** TFT(for default bearer)
**** 
The P-GW initiated bearer modification without QoS update is used to update the TFT
for an active default bearer, or to modify the APN-AMBR value



** Ue-initiated EPS bearer activation 

*** Default EPS bearer context activation procedure
eg. ue want a voip call, it will initiate a IMS  default bearer 
ENB:  ------>  MME - Uplink NAS Transport (PDN Connectivity Request[apn])
===DNS query using ims apn:         QNAME     = ims.apn.epc.mnc124.mcc262.atca124.common.3gppnetwork.org.
===                                 QTYPE     = NAPTR
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response(sgw-teid-c[senderfteid],sgw-teid-u[s1_U-sgw_fteid])
(in attach procedure these E-RAB Setup mesage will be replaced with InitialContextSetupRequest )
ENB:  <------  SUT - E-RAB Setup Request (Activate Default EPS Bearer Context Request)(sgw-teid-u in [transportLayerAdress]
ENB:  ------>  SUT - E-RAB Setup Response (enb-teid-u in [transportLayerAddress])
ENB:  ------>  SUT - Uplink NAS Transport (Activate Default EPS Bearer Context Accept)
SGW:  <------  SUT - Modify Bearer Request(mme-teid-c in [senderfteid],enb-teid-u in [s1_eNodeB_FTEID ])
SGW:  ------>  SUT - Modify Bearer Response(sgw-teid-c in [senderfteid],enb-teid-u in [s1_eNodeB_FTEID ])

the difference between  initial context setup request and activate eps bearer context is the former is for establishing the first default bearer,
and later for none-first default bearer; and in Dedicated EPS bearer context activation procedure, no sgw-teid-u will be allocated for it is linked with defaultbearid,
only enb-teid-u and sgw-teid-u allocated, but in Default bearer activation, there will be sgw-teid-c, sgw-teid-u and sgw-teid-c allocated.

*** Dedicated EPS bearer context activation procedure
then ue create the dedicated bearer on that default bearer with different qci
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  SUT - Bearer Resource Command{linkedBearerid,tft, but without senderfteid,for senderfteid is related to linkedBearerid}

*** PGWDedicatedBearerActivationProcedure
SGW:  ------>  SUT - Create Bearer Request(linked-ebi,bearercontexts[tft(filtered ipaddr),s1_u_sgw_fteid,s5ors8_u_pwg_fteid,qos] 
ENB:  <------  SUT - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request) {sgw-teid-u in [transportlayeraddress],erabSUReq[tft]) }
=====ENB got tftaddr as sourceip when send UL packet in realipaddr instead of paa
ENB:  ------>  SUT - E-RAB Setup Response{enb-teid-u in [transportlayeraddress],
ENB:  ------>  SUT - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response {enb-teid-u in [s1-eNodeB-Fteid]}

ENB                                     MME                                     SGW                                     HSS                                     SGSN
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Bearer Resourc|                                       |                                       |                                       |
|e Allocation Request)                  |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Bearer Resource Command(linkedbearerId, tft)                                   |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       |  Create Bearer Request (sgw-teid-u)   |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - E-RAB Setup Request (Activate Dedica|                                       |                                       |                                       |
|ted EPS Bearer Context Request)        |                                       |                                       |                                       |
|transportLayerAddress(sgw-teid-u)      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - E-RAB Setup Response                |                                       |                                       |                                       |
|transportLayerAddress(enb-teid-u)      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Activate Dedic|                                       |                                       |                                       |
|ated EPS Bearer Context Accept)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Create Bearer Response(s1_U_eNodeB_FTEI|                                       |                                       |
|                                       |D field of enb-teid-u)                 |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
-----------------------------------------above is create a dedicated bearer procedure after a imsi attach procedure---------------------------------------------|                                       |                                       |                                       |
|                                       |




** Ue-initiated EPS bearer deactivation
*** EPS default bearer deactivation procedure
ENB:  ------>  SUT - Uplink NAS Transport(PDN Disconnect Request)
SGW:  <------  SUT - Delete Session Request
SGW:  ------>  SUT - Delete Session Response
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)


*** EPS dedicated bearer context deactivation procedure
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Delete Bearer Request
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)
SGW:  <------  SUT - Delete Bearer Response


if a Default bearer is deleted with (delete session req), then the dedicated bearer linked to it also be removed.
SGW:  <------  SUT - Delete Session Request
SGW:  ------>  SUT - Delete Session Response
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)

the difference between ue context release and E-RAB Release Command is the former ENB will remove all the bearers context and the s1ap-id, and later ENB only remove bearers context only.

if a dedicated bearer is deleted with (delete bearer req), then the default bearer will still exist till using(delete session req) to it.
ue stop the voip call:
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Delete Bearer Request
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)
SGW:  <------  SUT - Delete Bearer Response


** UE initiated bearer resource modification procedure.
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW ------> MME  - Update Bearer Request
ENB <------ MME  - E-RAB Modify Request(Modify EPS Bearer Context Request)
ENB ------> MME  - E-RAB Modify Response
ENB <------ MME  - Modify EPS Bearer Context Accept
PGW <------ MME  - Update Bearer Response




*** EPS default bearer context modification procedure
**** PGW-initiated default bearer modification(QOS)
MME supports P-GW-initiated default bearer modificatin to change parameters such as QCI,ARP,APN-AMBR, and traffic flow template(TFT).
SGW ------> MME  - Update Bearer Request
ENB <------ MME  - E-RAB Modify Request(Modify EPS Bearer Context Request)
ENB ------> MME  - E-RAB Modify Response
ENB <------ MME  - Modify EPS Bearer Context Accept
PGW <------ MME  - Update Bearer Response

**** PGW-initiated default bearer modification(non-QoS), UE in ECM-CONNECTED state
S/PGW ------> MME - Update Bearer Request
ENB   <------ ENB - Downlink NAS Transport(Modify EPS Bearer Context Request)
ENB   ------> MME - Uplink NAS Transport(Modify EPS Bearer Context Accept)
ENB   <------ MME - UE Context Modification Request   (UE AMBR change)
ENB   ------> MME - UE Context Modification Response
S/PGW <------ MME - Update Bearer Response


*** EPS dedicated bearer modification (the same with PGW-initiated default bearer modification(non-QoS).


* LTE network Voice Service
** vocie service based on circuit-switched technology

Radio network-------------------MSC server--------------------
|                singalling      |                           |
|                                |                           |
|                                |                         PSTN/ss7 voice network
|                                |                           |
|                                |                           |
|------------------------------Media gateway-----------------
  Media flow(voice call)


** voice services with IMS technology

--------------------P-CSCF--------S-CSCF-----I-CSCF
|  sip singalling                              |
|                                             SBC-----------external ip network
ip access network
|
|           
-------------------------Media GW-------------External circuit-switched networks
Media flow(eg.voice call)          voice call           

with IMS, voice call can either go via MediaGW---->MSC or a SIP-based call handled by the IMS( circuit-switched call.)
and also, IMS an supoort MMTel which is voip call.this is the LTE voice service mostly used.(ps call)

** voice call continuous between LTE coverage and not coveraged area
There are three different use cases that need to be considered:
1. A voice call is established when in LTE coverage (dark area), and the user is not moving outside LTE coverage during the duration of the call. For this use
case, MMTel would be used to provide the voice service over LTE.

2. A voice call is established when outside LTE coverage (light area). The call would then instead be established using circuit-switched access over, for example, GSM.
Depending on the solution, the call could be converted into a SIP-based call and handled by the IMS system, or it can be handled as a traditional circuit-switched call by the MSC.

3. A voice call is established when in LTE coverage (dark area) and during the voice call, the user moves outside LTE coverage. If the system depicted as
a light area can support IMS/MMTel voice services, this would be handled through a ‘Packet Handover’ between LTE and the other system (e.g. WCDMA/
HSPA or eHRPD) and the voice service would continuously be served as an IP-based service and handled by the IMS infrastructure. If this is not the
case, specific measures are needed to secure service continuity when LTE coverage is lost. The 3GPP solution for this is called Single-Radio Voice Call Continuity (SRVCC).

From above, we can see convergence between LTE and 3g/2g network, when ue leave the LTE, voip call(IMS/MMTel) could be continued if the cell supoorted voip even if the cell is not
E-utran. if the cell not E-utran not support the voip, then srvcc is a way to handover the voice call to MSC.


** EPS SRVCC and CSFB
CSFB x SRVCC:

    It is not necessary to implement both solutions (CSFB and SRVCC) at the same time, if the network has a wide LTE coverage and a complete IMS backbone.
        If we implemente CSFB, it means we will not make the call setup using existing IMS Core, and that could take care of that call in LTE.
        In respect to the SRVCC: assuming the Backbone IMS is available. In this case, if the register in the IMS is successful, the user do not need to do CSFB - A voice call can be simply initiated in LTE network using IMS.
    CSFB is a service handover procedure while SRVCC is a coverage handover procedure.


LTE voice issue:
in overalll 2/3/4G network, voice call has two forms:
1. call suppported by IMS Core (this is a VOLTE/VOIP feature, and when ue swith from 4g to 3g, srvcc handover occured)
in LTE env(EUTRAN), the voice call is from ENB--->SGW-----PGW---->IMS Core
in UTRAN, the voice call is from UTRAN----->MSC--------->IMS Core
So as long as svrcc handover from MME to MSC, 

2. tranditional circuit call  (UE anchored both in LTE and 3G, when mo/to(mobile originate/mobile terminal) call, ue will fall back to 3g network)
tranditoinal circuit call is from UTAN------>MSC (no IMS core)

So when UE move between those 2/3/4g network the cell not supported voip, there are 2 different mechanism to support voice call.
SRVCC is for handing over from S/PGW----->IMS  to MSC----->IMS
CSFB  is not handover,it just fallback to CS domain whenever it need a voice call which means even in LTE coverage area, ue just fallback to CS domain to call.
so CSFB need cell phone support dual mode, update Location also in CS domain when UE moved around, also update tracking area also.



** SRVCC (Single Radio Voice Call Coninuity)
widely supported in the industry and has been recommended by the LTE OneVoice Initiative.
if mobile only single Mode, SRVCC capable
while it is able to transmit or receive on only one of these access networks at a given time.  

    |----------------UTRAN---------------------MSC-------------
    |                 |                         |             |
    |                 |--------SGSN             |             |
(Single Mode)                    |Gn          Sv|             |
    |                  |         |              |             |
   UE                  --------MME--------------|           IMS Core  
    |                  |         |                            |
    |                  |         |                            |
    |                  |         |______________              |
    |                  |                       |              |
    |---------------EUTRAN---------------------SGW------------|

voice bearer before handover
UE----->EUTAN_------->SGW-------->IMS Core

voice bearer after handover
UE------>UTRAN---------->MSC------>IMS Core

there is option  SRVCCHOIndication is 'cSonly' in HandoverRequired Message.
if so, no ps handover required, if is 'PSandCS', then PS handover required.

*** SRVCC from E-UTRAN to GERAN/UTRAN precondition (how SRVCC will happen when ue moved)
E-UTRAN may determine the NCL, as well as the need to signal a SRVCC indication, as follows:

 If the “SRVCC operation possible” indication is set to “true” (i.e. both EPC and UE are SRVCC capable),then VoIP-incapable cells 
 may be included as candidate target cells in the NCL, regardless of the presence of an established QCI=1 bearer for this UE. Moreover:

 If there is an established QCI=1 bearer for this UE and the selected target cell is VoIP-capable,then  EUTRAN does not include a 
 SRVCC indication in the Handover Required message;

 If there is an established QCI=1 bearer for this UE and the selected target cell is VoIP-incapable, then EUTRAN includes a SRVCC indication in the Handover Required message;

 If there is no established QCI=1 bearer for this UE, then E-UTRAN does not include a SRVCC indication in the Handover Required  message;

 If the “SRVCC operation possible” indication is set to “false” (i.e.either EPC or UE is not SRVCC capable), then E-UTRAN does not include a SRVCC indication
 in the Handover Required message.

 If there is an established QCI=1 bearer for this UE, then VoIP-incapable cell are not be included in the NCL;

 If there is no established QCI=1 bearer for this UE, then VoIP-incapable cells may be included in the NCL.


** CSFB  (Circuit Swithed Fall Back)
ue anchored both in LTE and CS domain, using combined attach both to MME and MSC.
3gpp doc 23272
The main idea behind CS fallback is to allow UEs to camp on LTE and utilize the LTE for data services but resuse the GSM,WCDMA,CDMA network for circuit-switched voice services.
So CSFB's precondition is ue combined attach to both MME and MSC: this also required mobile support dual mode

*** combined attach procedure
Normal attach procedure with AttachReq(Attach Type=Combined Attach), attatch to MSC also.
After Create Session Req/Res,

      SGsAP-update-Location-Req    
MME   -------------------------------------->MSC
         SGSAP-update-location-Accept
So mme has a link with MSC

Normal imis attach, and after createsessionresponse from SGW, mme send sgsap-location-update-request to MSC/VLR,
If the UE includes TMSI status in the Attach Request, the MME delivers it to the MSC/VLR in the Location Update Request. If the MME receives TMSI in the Location Update Accept
from the MSC/VLR, the MME includes the TMSI in the Attach Accept message to the UE. If new TMSI was allocated, the UE confirms the received TMSI by sending the Attach Complete message 
to the MME. If the MME receives the Attach Complete message before attach/TAU request response timer (T3450)
 

case id:NS_111_3_0001 CombinedAttach SuccessfullCSFB InterSytemRAU IntersystemTAU
*** network toplogy picture
this required mobile support dual mode

____________UTRAN_____________SGSN____________
|              |               |             |        
|              |               |             |
(Dual Mode)    |_______________|_____________|
UE                             |             MSC  
|                              |             |
|_________E-UTRAN____________MME_____________|


CSFB over SGs as follow:                      
E-UTRAN packet is from ENB----SGW---PGW------net
CSFB to UTRAN:
UTRAN  is from RNC----MSC----------PSTN/ISDN
CSFB to GERAN:
GERAN is from BSC-----SGSN-----MSC----PSTN/ISDN       
                                                     ________________
    GERAN--------BSC-------------SGSN-----PGW--------|internetnetwork|
   /                           /  |        |         |               |
  /                           /   |        |         |               |
UE---UTRAN-------RNC---MSC/VLR-----------------------|PSTN/ISDN(CS)  |  
 \                          \     |        |         |_______________|
  \                       Sgs\    |        | 
   \                          \   |Gn      |
   E-UTRAN----------------------MME------SGW 

ue combined attach with MME and MSC, The combined EPS attach procedure is used by a CSFB enabled UE to attach both EPS and non-EPS services and associate itself in SGs-Interface. 
The pre-condition is that the UE should send Combined-IMSI AttachRequest to MME. And a physical connection between the MSC/VLR and MME should exist. 
in CS domain,voice bearer path:
ue---------UTRAN---------MSC
and at the same time
in PS domain, data bearer path:
ue-------e_UTRAN--------SGSN


caseid:NS_111_3_0001     

--------------------------------------------
|combined attach                           |
--------------------------------------------
|inter system RAU for cs fall back to call |
--------------------------------------------
|UE to MSC with CS MO call                 |
--------------------------------------------
|inter system TAU when call end            |
--------------------------------------------


 ...  === Message flow ===
ENB:  ------>  MME - Initial UE Message (Attach Request)
HSS:  <------  MME - Authentication Information Request
HSS:  ------>  MME - Authentication Information Answer
ENB:  <------  MME - Downlink NAS Transport (Authentication Request)
ENB:  ------>  MME - Uplink NAS Transport (Authentication Response)
ENB:  <------  MME - Downlink NAS Transport (Security Mode Command)
ENB:  ------>  MME - Uplink NAS Transport (Security Mode Complete)
HSS:  <------  MME - Update Location Request
HSS:  ------>  MME - Update Location Answer
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response
SGS:  <------  MME - SGsAP Location Update Request
SGS:  ------>  MME - SGsAP Location Update Accept
ENB:  <------  MME - Initial Context Setup Request (Attach Accept)
ENB:  ------>  MME - Initial Context Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Attach Complete)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
--------------------------------------------------------------------------------------------------
combined attach
mav0313
-------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (PDN Connectivity Request)
SGW:  <------  MME - Create Session Request   ### create a default bearer, ebi 6
SGW:  ------>  MME - Create Session Response
ENB:  <------  MME - E-RAB Setup Request (Activate Default EPS Bearer Context Request) 
## followed by the CSR to active default bearer context
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Default EPS Bearer Context Accept)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
ENB:  ------>  MME - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  MME - Bearer Resource Command

SGW:  ------>  MME - Create Bearer Request    #### create a dedicated bearer, ebi7 which on default beaer ebi 6
ENB:  <------  MME - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request)
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response
ENB:  ------>  MME - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  MME - Bearer Resource Command
SGW:  ------>  MME - Create Bearer Request
ENB:  <------  MME - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request)
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response
-----------------------------------------------------------------------------------------------------
another default bearer and two dedicated bearer created
---------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Extended Service Request)
ENB:  <------  MME - UE Context Modification Request
ENB:  ------>  MME - UE Context Modification Response
ENB:  ------>  MME - UE Context Release Request
SGW:  <------  MME - Release Access Bearer Request
SGW:  ------>  MME - Release Access Bearer Response
ENB:  <------  MME - UE Context Release Command
ENB:  ------>  MME - UE Context Release Complete
SGSN: ------>  MME - SGSN Context Request
SGSN: <------  MME - SGSN Context Response
SGSN: ------>  MME - SGSN Context Acknowledge
SGW:  <------  MME - Delete Session Request
SGW:  ------>  MME - Delete Session Response
------------------------------------------------------------------------------------------------------------------------------------------------------------
extended service request for cs fallback, transfer all data bearer to SGSN via ISRAU, release ue context, delete all sessions in SGW since all bearer transfered to 3G
------------------------------------------------------------------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Tracking Area Update Request)
SGSN: <------  MME - SGSN Context Request
SGSN: ------>  MME - SGSN Context Response
HSS:  <------  MME - Authentication Information Request
HSS:  ------>  MME - Authentication Information Answer
ENB:  <------  MME - Downlink NAS Transport (Authentication Request)
ENB:  ------>  MME - Uplink NAS Transport (Authentication Response)
ENB:  <------  MME - Downlink NAS Transport (Security Mode Command)
ENB:  ------>  MME - Uplink NAS Transport (Security Mode Complete)
SGSN: <------  MME - SGSN Context Acknowledge
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response
HSS:  <------  MME - Update Location Request
HSS:  ------>  MME - Update Location Answer
ENB:  <------  MME - Initial Context Setup Request (Tracking Area Update Accept)
ENB:  ------>  MME - Initial Context Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Tracking Area Update Complete)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
----------------------------------------------------------------------------------------------------------------------------------------------
ISTAU without handover using verse ISTAU(SGSN---MME) to transfer all bearer. then create session, initial context, modify bearer req
---------------------------------------------------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Detach Request)
SGW:  <------  MME - Delete Session Request
SGW:  ------>  MME - Delete Session Response
ENB:  <------  MME - Downlink NAS Transport (Detach Accept)
ENB:  <------  MME - UE Context Release Command




*** inter-system RAU procedure
the Routing Area Update takes place when a UE that is registered with an MME selects a UTRAN cell.
in this case, the US changes to a Routing Area that the UE has not yet registered with the network.

UE will start a new register to UTRAN to SGSN, and SGSN will ask mme about the contexts

      SGSN-Context-Request(RAI,P-TMSI,RAT Type)
SGSN------------------------> MME                  
    Context Response
   <-------------------------
    Context Acknowlege
   -------------------------->



*** inter-system TAU procedure involve SGSN
 ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Request)
| SGSN: <------  SUT - SGSN Context Request
| SGSN: ------>  SUT - SGSN Context Response
| HSS:  <------  SUT - Authentication Information Request
| HSS:  ------>  SUT - Authentication Information Answer
| ENB:  <------  SUT - Downlink NAS Transport (Authentication Request)
| ENB:  ------>  SUT - Uplink NAS Transport (Authentication Response)
| ENB:  <------  SUT - Downlink NAS Transport (Security Mode Command)
| ENB:  ------>  SUT - Uplink NAS Transport (Security Mode Complete)
| SGSN: <------  SUT - SGSN Context Acknowledge
| SGW:  <------  SUT - Create Session Request
| SGW:  ------>  SUT - Create Session Response
| HSS:  <------  SUT - Update Location Request
| HSS:  ------>  SUT - Update Location Answer
| SGS:  <------  SUT - SGsAP Location Update Request
| SGS:  ------>  SUT - SGsAP Location Update Accept
| ENB:  <------  SUT - Initial Context Setup Request (Tracking Area Update Accept)
| ENB:  ------>  SUT - Initial Context Setup Response
| ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Complete)
| SGW:  <------  SUT - Modify Bearer Request
| SGW:  ------>  SUT - Modify Bearer Response




* DNS in LTE
** principle in 3GPP
*** Identification of canonical node names
There are many use cases where it is desirable to select a collocated node in preference to a non-collocated node, or a
topologically closer (with respect to the network topology) node in preference to a less topologically closer node. To
easily do this action a "canonical" node name shall be employed so that the "canonical" node names from two or more
sets of records can be compared to see if nodes are actually the same nodes, or topologically closer nodes.

The host names shall have form:
<"topon" | "topoff"> . <single-label-interface-name> . <canonical-node-name>
Where the first label is "topon" or "topoff" to indicate whether or not collocated and topologically close node selection
shall be preferred, "single-label-interface-name" is a single label used to name a specific interface on a node (e.g. Eth-0,
S8, vip, board3), "canonical-node-name" is a the canonical node name of a specific node. A node shall have exactly one
canonical node name so a host name always includes the unique canonical node name of the node.Hence, when
comparing the host name FQDNs to find out

The following list contains examples of domain names where canonical node names are in bold:
topon.Eth-0.gw32.california.west. example.com
topon.S8.gw32.california.west. example.com    ## this is collocated with eth-0.gw32.california.west.example.com
topon.vip.sgw3.oregon.west. example.com m
topon.board3.pgw1.cluster1.net27. example.net
topon.S5.gw4.cluster1.net27. example.net
topon.board3.pgw1.cluster2.net27. example.net ### this is topologically closer to board3.pgw1.cluster.net27 thatn others 

Specifically, a NAPTR with flag "a" will have a replacement target pointing to the A/AAAA record directly, thus the topologically aware naming restriction on the host name applies to the replacement in the NAPTR record with a flag "a". For the NAPTR flag "s" case the topologically aware naming restriction on the host name applies to the target in the SRV record, and not the NAPTR record replacement. For the NAPTR empty flag "" case the topologically aware naming does not apply any restriction since this is not a host name. Other flags are not used in S-NAPTR. 


*** NAPTR or S-NAPTR
S-NAPTR
The S-NAPTR also simplifies the use of NAPTR by limiting the NAPTR flags only to "a", "s" and "". Furthermore, only NAPTR "replacement" expressions are allowed

**** a flag in S-NAPTR response
S-NAPTR query with FQDN response with flag a,service and replacement -------------------> A/AAAA query with target and response with ipv4/6 addr

topon.s11lb.smgt01.sitc.epc.mnc097.mcc466.3gppnetwork.org: type A, class IN, addr 192.168.232.48
    Name: topon.s11lb.smgt01.sitc.epc.mnc097.mcc466.3gppnetwork.org
    Type: A (Host Address) (1)
    Class: IN (0x0001)
    Time to live: 60 (1 minute)
    Data length: 4
    Address: 192.168.232.48

tac-lb04.tac-hb64.tac.epc.mnc002.mcc460.3gppnetwork.org: type NAPTR, class IN, order 100, preference 25536, flags a
 servie: x-3gpp-sgw:x-s11:x-s5-gtp:x-s8-gtp
 replacement: topon.sgw-pool-4g1.sitc.epc.mnc097.mcc466.3gppnetwork.org

topologically awareness apply to the replacement since it is a flag

***** A query for ipv4 addr
Standard query response 0xee91 A topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc002.mcc460.3gppnetwork.org A 172.16.49.111 NS localhost A 127.0.0.1 AAAA ::1 OPT

***** AAAA query for ipv6 addr
Standard query response 0x416c AAAA topon.eth1.s11sgw01.mme100.pool1.nodes.epc.mnc002.mcc460.3gppnetwork.org SOA localhost OPT

**** s or empty flag in S-NAPTR response
S-NAPTR query with FQDN response with flag s,service and replacement------------->SRV query with replacement response with protocol, type and target
-------------------> A/AAAA query with target and response with ipv4/6 addr

tac-lb7c.tac-hb00.tac.epc.mnc097.mcc466.3gppnetwork.org: type NAPTR, class IN, order 200, preference 999, flags S
    Name: tac-lb7c.tac-hb00.tac.epc.mnc097.mcc466.3gppnetwork.org
    Type: NAPTR (Naming Authority Pointer) (35)
    Class: IN (0x0001)
    Time to live: 60 (1 minute)
    Data length: 105
    Order: 200
    Preference: 999
    Flags Length: 1
    Flags: S
    Service Length: 37
    Service: x-3gpp-sgw:x-s11+nc-nr:x-s5-gtp+nc-nr
    Regex Length: 0
    Regex: 
    [Replacement Length: 58]
    Replacement: topon.sgw-pool-endc.sitc.epc.mnc097.mcc466.3gppnetwork.org


The NAPTR resource record flags "s" and "" allow another layer of indirection in the DNS configuration.
The "" flag causes the S-NAPTR procedure to query for new NAPTR resource records from the DNS infrastructure. 
The "s" flag causes the S-NAPTR procedure to query for an intermediary SRV resource record pointing to A/AAAA resource records. This additional query provides a selection mechanism by which the operator is able to assign different weights to different A/AAAA resource records while larger weights are given a proportionately higher probability of being 

***** SRV 
The SRV resource record allows DNS administrators to use pool of servers for a single domain with static load balancing to each
server, to move services from host to host, and to designate some hosts as primary servers for a service from a pool of hosts.
A resolver can ask for a specific service/protocol combination for a specific domain name and get back a Fully Qualified Domain Names (FQDN) of any available servers.

topon.sgw-pool-5g.sitc.epc.mnc097.mcc466.3gppnetwork.org: type SRV, class IN, priority 10, weight 10, port 2123, target topon.s11lb.smgt01.sitc.epc.mnc097.mcc466.3gppnetwork.org
    Service: topon
    Protocol: sgw-pool-5g
    Name: sitc.epc.mnc097.mcc466.3gppnetwork.org
    Type: SRV (Server Selection) (33)
    Class: IN (0x0001)
    Time to live: 60 (1 minute)
    Data length: 65
    Priority: 10
    Weight: 10
    Port: 2123
    Target: topon.s11lb.smgt01.sitc.epc.mnc097.mcc466.3gppnetwork.org


topologically awareness apply to the Target in SRV response instead of Replacement in NAPTR response

** DNS query in different procedures
*** attach procedure of DNS query
when ula(Update Loccation Answer) received
servicename in serviceselection in ula message.
this servicename is the "apn" name.

**** precondition to do dns query
TITLE : GWCreateSession state started
  DATA : -

** DNS query in different procedures
*** attach procedure of DNS query
when ula(Update Loccation Answer) received
servicename in serviceselection in ula message.
this servicename is the "apn" name.

**** precondition to do dns query
TITLE : GWCreateSession state started
  DATA : -

 TITLE : PDN Allocation type is DYNAMIC
 TITLE : isPdnConnectionTypeHandover()false

 TITLE : invalidPgwDetailsFromHsstrue

 TITLE : PDN Request type is Initial Attach, hence setting the PGW address as null in DNS PDP context.

 TITLE : Conditions for using CC on DNS query for PGW selection are fulfilled

 TITLE : This APN (sgw.nsn.com) is either not configured or has cclength = 0 configured

 TITLE : Conditions for using intelligent PGW selection are fulfilled

----------------------------------------------
 TITLE : isMmeHomePgwEnabled(): false
isPdnConnectionTypeInitialAttach(): true
isRoamerSubscriber(): false
pdnAllocType: 1
--------------------------------------------------
 TITLE : Intelligent PGW selection based on request PDN type for APN sgw.nsn.com and PDN type IPV4

 TITLE : Msisdn not found in msisdnImsiMap
  DATA : msisdn = FFFFFFFFFFFFFFFFFF

  DATA : msisdn = 00 00 FF FF FF FF FF FF FF FF FF 

 TITLE : Is non-IP PDN supported : false

 TITLE : DMX PDN type : 0

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.345
  TYPE : TRACE (CPPU-0)    CATEGORY : DNS
  CODE : GWCreateSession 
 TRACE : N/A
 TITLE : Before calling ResolveGateways
  DATA : TAI              = 62 42 71 00 01 
         TAI-MCC          = 62 02 
         TAI-MNC          = 71 04 
         TAC              = 00 01 
         IMSI             = 62 12 47 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 71 04 
         SGW-PROTO-DESIRE = 
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         APN              = 73 67 77 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO

**** query  sgw ip addr through dns using tac 
FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : TRACE (CPPU-0)    CATEGORY : DNS
  CODE : DNSResolver 
 TRACE : N/A
 TITLE : preparing the candidate List for dns query
  DATA : FQDN :  = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.number of Candidates 2147483647

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : TRACE (CPPU-0)    CATEGORY : DNS
  CODE : DNSResolver 
 TRACE : N/A
 TITLE : preparing the candidate List for dns query
  DATA : FQDN :  = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.number of Candidates 2147483647

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : DEBUG (CPPU-0)    CATEGORY : DNS
  CODE : NaptrQryProcessor 
 TRACE : N/A
 TITLE : Sending DNS query(NAPTR Record) to QueryManager
  DATA : FQDN :  = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : DEBUG (CPPU-0)    CATEGORY : DNS
  CODE : DnsL2Cache 
 TRACE : N/A
 TITLE : L2 Cache Miss for NAPTR. Now looking error records in cache
  DATA : QNAME = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.
         QTYPE = NAPTR

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : DEBUG (CPPU-0)    CATEGORY : DNS
  CODE : DnsL2Cache 
 TRACE : N/A
 TITLE : L2 Cache Miss.
  DATA : QNAME = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.
         QTYPE = UNKNOWN

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : TRACE (CPPU-0)    CATEGORY : DNS
  CODE : DnsQryManager 
 TRACE : N/A
 TITLE : Added  query to list. New size: 1
  DATA : Make JNDI call = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : TRACE (CPPU-0)    CATEGORY : DNS
  CODE : DnsQryManager:runQuery 
 TRACE : N/A
 TITLE : OngoingDnsQry size: 1
  DATA : FQDN =               = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.
         CallbackList size =  = 1

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.349
  TYPE : TRACE (CPPU-0)    CATEGORY : PROCEDURE - DMX Message
  CODE : com.nsn.mme.subtrace.processor.TraceHandler
 TRACE : N/A
 TITLE : No Subscriber in imsi trace cache
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2019-06-11 12:16:02.348
  TYPE : DEBUG (CPPU-0)    CATEGORY : DNS
  CODE : DnsContext 
 TRACE : N/A
 TITLE : Sending Query to DNS Transceiver
  DATA : QID       = 140
         QNAME     = tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.
         QTYPE     = NAPTR
         QTNCOUNT  = 1
         ANSCOUNT  = 0
         NSCOUNT   = 0
         ADDCOUNT  = 0
         TRUNCATED = false

***** query response getting from NAPTR

TITLE : RR added:tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862355	1	1	a	X_3GPP_SGW	[X_S5_GTP, X_S8_GTP, X_S11]		topoff.eth0.sgw174.nsn.com.common.3gppnetwork.org.
 TITLE : RR added:tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862355	1	1	a	X_3GPP_SGSN	[X_S3, X_GN, X_S11]		topoff.eth0.sgsn174.nsn.com.common.3gppnetwork.org.
 TITLE : RR added:tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862355	1	1	a	X_3GPP_PGW	[X_S5_GTP, X_S8_GTP, X_S11]		topoff.eth0.pgw.nsn.com.common.3gppnetwork.org.
 TITLE : RR added:tac-lb01.tac-hb00.tac.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862355	1	1	a	X_3GPP_MME	[X_S10, X_S11]		topoff.eth0.mme174.nsn.com.common.3gppnetwork.org.
only X_3GPP_SGW is useful since we want sgw ip addr.

dns query command dig with naptr
=============================================================================
[root@localhost ~]# dig @10.56.244.22 -t naptr tac-lb01.tac-hb00.tac.epc.mnc101.mcc262.3gppnetwork.org

; <<>> DiG 9.3.6-P1-RedHat-9.3.6-20.P1.el5_8.6 <<>> @10.56.244.22 -t naptr tac-lb01.tac-hb00.tac.epc.mnc101.mcc262.3gppnetwork.org
; (1 server found)
;; global options:  printcmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 23256
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 1, ADDITIONAL: 4

;; QUESTION SECTION:
;; ANSWER SECTION:
tac-lb01.tac-hb00.tac.epc.mnc101.mcc262.3gppnetwork.org. 1 IN NAPTR 1 1 "a" "x-3gpp-sgw:x-s8-gtp:x-s5-gtp:x-s11" "" topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org.
tac-lb01.tac-hb00.tac.epc.mnc101.mcc262.3gppnetwork.org. 1 IN NAPTR 10 1 "a" "x-3gpp-mme:x-s10" "" topoff.s10.mmec33.mmegic3b5.mme.3gppnetwork.org.
tac-lb01.tac-hb00.tac.epc.mnc101.mcc262.3gppnetwork.org. 1 IN NAPTR 10 1 "s" "x-3gpp-sgw:x-s5-gtp:x-s8-gtp:x-s11" "" sgw13.xipu.cd.net.3gppnetwork.org.

;; AUTHORITY SECTION:
3gppnetwork.org.	1	IN	NS	cdlabdns01.cq.dns.epc.3gppnetwork.org.

;; ADDITIONAL SECTION:
topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org. 1	IN A 10.100.100.3
topoff.s10.mmec33.mmegic3b5.mme.3gppnetwork.org. 1 IN A	10.100.100.11
topon.naptr.sgw13.xipu.cd.net.3gppnetwork.org. 1 IN A 10.100.100.1
sgw13.xipu.cd.net.3gppnetwork.org. 1 IN	SRV	10 30 2123 topon.naptr.sgw13.xipu.cd.net.3gppnetwork.org.
=========================

***** query real sgw host ip from previous naptr result to get A 
TITLE : Sending Query to DNS Transceiver
  DATA : QID       = 141
         QNAME     = topoff.eth0.sgw174.nsn.com.common.3gppnetwork.org.
         QTYPE     = A
         QTNCOUNT  = 1
         ANSCOUNT  = 0
         NSCOUNT   = 0
         ADDCOUNT  = 0
         TRUNCATED = false
==========================================================================
[root@localhost ~]# dig @10.56.244.22 topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org

; <<>> DiG 9.3.6-P1-RedHat-9.3.6-20.P1.el5_8.6 <<>> @10.56.244.22 topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org
; (1 server found)
;; global options:  printcmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61461
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org. IN A

;; ANSWER SECTION:
topoff.eth0.sgwcd101.nsn.com.3gppnetwork.org. 1	IN A 10.100.100.3

;; AUTHORITY SECTION:
3gppnetwork.org.	1	IN	NS	cdlabdns01.cq.dns.epc.3gppnetwork.org.
=========================================

**** dns query pgw ip addr using apn
 TITLE : Resolving PGW.
  DATA : TAI              = 62 42 71 00 01 
         TAI-MCC          = 62 02 
         TAI-MNC          = 71 04 
         TAC              = 00 01 
         IMSI             = 62 12 47 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 71 04 
         SGW-PROTO-DESIRE = [X_S5_GTP, X_S11], [X_S5_PMIP, X_S11], [X_S5_GTP], [X_S5_PMIP]
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = [X_S5_GTP], [X_S5_PMIP]
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP]
         APN              = 73 67 77 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO
TITLE : APN after decode: sgw.nsn.com

TITLE : APN FQDN: sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.


TITLE : Sending Query to DNS Transceiver
  DATA : QID       = 142
         QNAME     = sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.
         QTYPE     = NAPTR
         QTNCOUNT  = 1
         ANSCOUNT  = 0
         NSCOUNT   = 0
         ADDCOUNT  = 0
         TRUNCATED = false

***** dns response for naptr
TITLE : QueryResult for NAPTR Resource Records for the FQDN 
  DATA : RR1 = sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862367	1	1	a	X_3GPP_SGSN	[X_S3, X_GN, X_S11]		topoff.eth0.sgsn174.nsn.com.common.3gppnetwork.org.
         RR2 = sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862367	1	1	a	X_3GPP_MME	[X_S10, X_S11]		topoff.eth0.mme174.nsn.com.common.3gppnetwork.org.
         RR3 = sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862367	1	1	a	X_3GPP_PGW	[X_S5_GTP, X_S8_GTP, X_S11]		topoff.eth0.pgw.nsn.com.common.3gppnetwork.org.
         RR4 = sgw.nsn.com.apn.epc.mnc174.mcc262.atca174.common.3gppnetwork.org.	1	1560244862367	1	1	a	X_3GPP_SGW	[X_S5_GTP, X_S8_GTP, X_S11]		topoff.eth0.sgw174.nsn.com.common.3gppnetwork.org.



***** dns query for  X_3GPP_PGW  [X_S5_GTP, X_S8_GTP, X_S11]     
 TITLE : Sending Query to DNS Transceiver
  DATA : QID       = 143
         QNAME     = topoff.eth0.pgw.nsn.com.common.3gppnetwork.org.
         QTYPE     = A
         QTNCOUNT  = 1
         ANSCOUNT  = 0
         NSCOUNT   = 0
         ADDCOUNT  = 0
         TRUNCATED = false





**** dns query with apn name(apn:sgw0001.nsn.com) for PGW Candidate
QNAME     = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.
<servicename>.apn.epc.mnc*.mcc*.<hn>.3gppnetwork.org
--------------------------------
 TITLE : Added Additional records to L2 Cache.
  DATA : QNAME = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.
         QTYPE = NAPTR
         COUNT = 16
         RR1   = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.  A   
         RR2   = topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.  A   
         RR3   = topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.  A   
         RR4   = topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.  A   
         RR5   = topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.  A   
         RR6   = topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.  A   
         RR7   = topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.  A   
         RR8   = topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.  A   
         RR9   = ns5101._s8._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR10  = ns5101._s7._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR11  = ns5101._s6._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR12  = ns5101._s5._udp.pgw02.atca52.3gppnetwork.org.  SRV   
         RR13  = ns5101._s4._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR14  = ns5101._s3._udp.pgw02.atca52.3gppnetwork.org.  SRV   
         RR15  = ns5101._s2._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR16  = ns5101._s1._udp.pgw02.atca52.3gppnetwork.org.  SRV   
----------------------------------------------------
RR1 is with RR9, RR2 is with RR11

 TITLE : QueryResult for NAPTR Resource Records for the FQDN 
  DATA : RR1 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   4   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s4._udp.pgw01.atca52.3gppnetwork.org.
         RR2 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   3   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s3._udp.pgw02.atca52.3gppnetwork.org.
         RR3 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   5   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s5._udp.pgw02.atca52.3gppnetwork.org.
         RR4 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   8   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s8._udp.pgw01.atca52.3gppnetwork.org.
         RR5 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   6   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s6._udp.pgw01.atca52.3gppnetwork.org.
         RR6 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   2   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s2._udp.pgw01.atca52.3gppnetwork.org.
         RR7 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   7   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s7._udp.pgw01.atca52.3gppnetwork.org.
         RR8 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   1   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s1._udp.pgw02.atca52.3gppnetwork.org.
-------------------------------------------
**** SGW Tentative Candidates
this is result from both tac and apn query, sgw top name in both two apn and tac query result type X_3GPP_SGW will be in the candidate
TITLE : SGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.ham.nc.us. null [10, -1, 72, 76]   0  0 0 0 0 2123

**** PGW Tentative Candidates
all with X_3GPP_PGW entries
 TITLE : PGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.bos.ny.us. X_3GPP_PGW [10, 125, 99, 96]   0  1 1 1 50 2123
         CANDT2 =  topon.eth0.ns5101.gw01.har.ny.us. X_3GPP_PGW [10, 125, 99, 96]   1  2 1 1 50 2123
         CANDT3 =  topon.eth0.ns5101.gw02.dal.nc.us. X_3GPP_PGW [10, 125, 99, 96]   2  3 1 1 50 2123
         CANDT4 =  topon.eth0.ns5101.gw02.cam.ny.us. X_3GPP_PGW [10, 125, 99, 96]   3  4 1 1 50 2123
         CANDT5 =  topon.eth0.ns5101.gw02.ede.nc.us. X_3GPP_PGW [10, 125, 99, 96]   4  5 1 1 50 2123
         CANDT6 =  topon.eth0.ns5106.gw01.liv.ny.us. X_3GPP_PGW [10, 125, 99, 96]   5  6 1 1 50 2123
         CANDT7 =  topon.eth0.ns5101.gw01.mor.nc.us. X_3GPP_PGW [10, 125, 99, 96]   6  7 1 1 50 2123
         CANDT8 =  topon.eth0.ns5101.gw02.ham.nc.us. X_3GPP_PGW [10, -1, 72, 76]   7  8 1 1 50 2123

**** pairing the SGW and PGW 
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Is S5 Interface
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Cartesian Product of SGW & PGW pairs.
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.
         PAIR 4 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.
         PAIR 5 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.
         PAIR 6 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.
         PAIR 7 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.
         PAIR 8 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : SGW & PGW pairs with Collocation and Topological matching
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.
twork.org., topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.
         PAIR 5 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.
         PAIR 6 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.
         PAIR 7 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.
         PAIR 8 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : isCollocationCheckEnabled:true; isTopoClosenessCheckNeeded:true
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : SGW and PGW are collocated or Topologically Close
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : ShortListed Candidate pairs saved.
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.: topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., 

*** handover procedure with DNSquery 
using target tai as a keyword to query

**** SGW resolved
---------------------------------------------------
FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : PROCEDURE - S1_HANDOVER_REQUIRED
  CODE : s1HandoverProcedure 
 TRACE : N/A
 TITLE : Updating target tai value "62F2250507" in subscriber cache.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Resolving SGW & PGW
  DATA : TAI              = 62 F2 25 07 05 
         TAI-MCC          = 62 02 
         TAI-MNC          = 25 FF 
         TAC              = 07 05 
         IMSI             = 62 52 02 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 25 0F 
         SGW-PROTO-DESIRE = 
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = 
         PDN-CTX-IP       = 0A FF 48 4C 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         APN              = 73 67 77 30 30 30 31 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : DNSResolver 
 TRACE : N/A
 TITLE : preparing the candidate List for dns query
  DATA : FQDN :  = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.number of Candidates 2147483647  


TITLE : QueryResult for NAPTR Resource Records for the FQDN 
  DATA : RR1 = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.  1   1454817637191   2   1   s   X_3GPP_SGW  [X_S5_GTP, X_S11]       ns1304._s2._udp.sgw01.atca52.3gppnetwork.org.
         RR2 = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.  1   1454817637191   1   1   s   X_3GPP_SGW  [X_S5_GTP, X_S11]       ns1302._s2._udp.sgw01.atca52.3gppnetwork.org.

**** PGW resolved
==============================================================
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.PgwResolver 
 TRACE : N/A
 TITLE : Resolving PGW.
  DATA : TAI              = 62 F2 25 07 05 
         TAI-MCC          = 62 02 
         TAI-MNC          = 25 FF 
         TAC              = 07 05 
         IMSI             = 62 52 02 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 25 0F 
         SGW-PROTO-DESIRE = [X_S5_GTP, X_S11], [X_S5_PMIP, X_S11], [X_S5_GTP], [X_S5_PMIP]
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = [X_S5_GTP], [X_S5_PMIP]
         PDN-CTX-IP       = 0A FF 48 4C 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP]
         PDN-CTX-PROTO    = [X_S5_GTP]
         APN              = 73 67 77 30 30 30 31 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.PgwResolver 
 TRACE : N/A
 TITLE : Calling getPgwCandidatesByPdnIp method.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : Doing reverse lookup to find out the host name of PGW candidate item //using PDN ip above PDN-CTX-IP to reverse lookup
  DATA : IpAddress :  = 10.255.72.76


**** pairing SGW and PGW
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : SGW Tentative Candidates
  DATA : CANDT1 =  topoff.eth0.ns1302.gw01.cam.ny.us. X_3GPP_SGW [10, -1, 72, 77]   0  1 1 1 50 2123
         CANDT2 =  topon.eth0.ns1302.gw01.cam.ny.us. X_3GPP_SGW [10, -1, 72, 77]   1  1 1 1 50 2123
         CANDT3 =  topon.eth0.ns1302.gw01.def.ny.us. X_3GPP_SGW [10, -1, 72, 78]   2  2 1 1 50 2123

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : PGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.ham.nc.us. null [10, -1, 72, 76]   0  0 0 0 0 2123

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Old SGW host name:topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Old SGW canonical name:ns5101.gw02.ham.nc.us
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Is S5 Interface
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Cartesian Product of SGW & PGW pairs.
  DATA : PAIR 1 = topoff.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns1302.gw01.def.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : SGW & PGW pairs with Collocation and Topological matching
  DATA : PAIR 1 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns1302.gw01.def.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topoff.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : isCollocationCheckEnabled:true; isTopoClosenessCheckNeeded:true
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : SGW and PGW are collocated or Topologically Close
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : ShortListed Candidate pairs saved.
  DATA : PAIR 1 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org.: topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., 


* Abbreviation
AKA Authentication and Key Agreement
AMBR Aggregate Maximum Bit Rate
APN Access Point Name
APN-AMBR APN Aggregate Maximum Bit Rate
ARP Allocation Retention Priority
BCM Bearer Control Mode
CSG Closed Subscriber Group
E-UTRA Evolved Universal Terrestrial Radio Access
E-UTRAN Evolved Universal Terrestrial Radio Access Network
EAB Extended Access Barring
ECM EPS Connection Management
eKSI Key Set Identifier for E-UTRAN
EMM EPS Mobility Management
eNode B Evolved Node B
EPC Evolved Packet Core Network
EPS Evolved Packet System
ESM EPS Session Management
GBR Guaranteed Bit Rate
GUMMEI Globally Unique MME Identifier
GUTI Globally Unique Temporary Identifier
HeNB Home eNode B
HRPD High Rate Packet Data
IP-CAN IP-Connectivity Access Network
ISR Idle mode Signalling Reduction
kbps Kilobits per second
KSI Key Set Identifier
L-GW Local PDN Gateway
LHN-ID Local Home Network Identifier
LIPA Local IP Access
M-TMSI M-Temporary Mobile Subscriber Identity
Mbps Megabits per second
MBR Maximum Bit Rate
MME Mobility Management Entity
MMEC MME Code
PD Protocol Discriminator
PDN GW Packet Data Network Gateway
ProSe Proximity-based Services
PSM Power Saving Mode
PTI Procedure Transaction Identity
QCI QoS Class Identifier
QoS Quality of Service
RRC Radio Resource Control
S-TMSI S-Temporary Mobile Subscriber Identity
S101-AP S101 Application Protocol
S1AP S1 Application Protocol
SAE System Architecture Evolution
SIPTO Selected IP Traffic Offload
TA Tracking Area
TAC Tracking Area Code
TAI Tracking Area Identity
TFT Traffic Flow Template
TI Transaction Identifier
TIN Temporary Identity used in Next

* 3GPP specification numbering
** procedure specification
LTE  23.401  
3G   23.060


** interface/protocol specification
 interface         protocol        specication numbering
 --------------------------------------------------------
 Gn                gtpv1            29060
 bssgp             bssgp            48018
 s1ap              s1ap             36413


* EPS AKA(Authentication Key agreement) procedure
In EPS key agreement is very easy, since imsi know its own K, and HSS know the imsi's K also(MME could get from authentication info requst).
So in fact, they already had a common private key.
** The whole other key derivation is complicated

 MME                              HSS                                     
|                                |  retrieve SQN and K based on imsi
| if sub in db,no authreq to hss |  input    SQN K  RAND(generated randomly)
|------------------------------->|  funtion for Crypto     
|M: authentication info request( |  output XRES, AUTN, CK, IK
|                                |
|imsi)                           |  input IMSI ,SQN, SN-ID, CK,IK, RAND          
|                                |  function KDF        
|<-------------------------------|  output KASME        
| M: allocation info answer(authe |
| ntication&security parameters)  |
| (AUTN,RAND,XRES,KASME)          |
|                                 |
|                                 |                                      UE
|                                                                         |                               
|------------------------------------------------------------------------>| input:  RAND,AUTN, K          
|  Authentication Req(AUTN,RAND)                                          |  USIM
                                                                          | output: CK,IK,RES
|                                                                         |                               
|                                                                         |input:RAND,CK,IK,SN-ID, IMSI   
|<------------------------------------------------------------------------|function KDF                   
| Authentication Resp(RES)                                                | output: KASME                 
|check if RES is equal to XRES to ensure if they use the same K           |                               
|                                                                         |                               
KDF described in 33220
if RES equal to XRES,then, MME and UE has the same KASME key for other integrity/encryption key. and authentication has been done also.

** integrity/encryption key generated from KASME
3gpp 33401 is about the key derivation and algrithom
A.7 Algorithm key derivation functions(Introduce how to generate the integrity/cypher key using KASME when received SecurityModeCommand message
 unsigned char iS[7] = { 0x15, 0x02, 0x00, 0x01, 0x00, 0x00, 0x01};
 unsigned char cS[7] = { 0x15, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01};
 iS[4] = sec_pars->integrityAlgorithm_fld;(from SMC msg)
 cS[4] = sec_pars->cipheringAlgorithm_fld;(from SMC msg)
 hmac_sha256_codec(sec_pars->kASME, iS, 7, digest);

** mme tester simpfy the whole process
testser will provide KASME for a initiating value in ENB, and provide a KASME also in HSS component


* bearer and session
session--> PDN ---> DNN
bearer--->Qos 

* 5G Identification
[suci=SUPI_TYPE:MCC:MNC:RTI:PSI:HNPKI:SO]                                                              - Subscription Concealed
                                                                                                           Identifier (Max of 11 digits)
    SUPI_TYPE = SUPI Format (1 digit)
    MCC = Mobile Country Code (3 digits)
    MNC = Mobile Network Code (2-3 digits)
    RTI = Routing Indicator (4 digits)
    PSI = Protection Scheme ID (1 digit)
    HNPKI = Home Network Public Key ID (2 digits)
    SO = Scheme Output (9 digits)


  [imsi=MCC:MNC:MSIN]                                                                                    - International Mobile Subscriber
                                                                                                           Identity (Max of 15 digits)
    MCC  = Mobile Country Code (3 digits)
    MNC  = Mobile Network Code (2-3 digits)
    MSIN = Mobile Subscription ID Number (9-10 digits)


  
* 5G http2
** udm http2 for registraion
+++ amf_net1_N8 ----> udm1_s

HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $04} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.71:8080"} {CONTENTLEN "354"} {CONTENTTYPE application/json} {METHOD PUT} {PATH /nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000001}}}} {localName udm1_s} {remoteName amf_net1}}^M^M
...
HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONREQ {{AMFINSTANCEID "1F6F413E-9F38-4B04-9243-69A95D578F27"} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {INITIALREGISTRATIONIND true} {PEI imeisv-9876543219876510} {RATTYPE NR}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName udm1_s} {remoteName amf_net1}}^M^M


+++ amf_net1_N8 <----- udm1_s
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $04} {HDRBLKFRAGMENT {{CONTENTID EMPTY} {CONTENTLEN EMPTY} {CONTENTTYPE EMPTY} {DATE EMPTY} {HDRTABLESZ EMPTY} {LOCATION EMPTY} {RETRYAFTER EMPTY} {STATUS "201"}}} {STREAMDEP EMPTY} {STREAMID $00000001} {WEIGHT EMPTY}}}} {localName udm1_s} {remoteName amf_net1}}^M^M
...
HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONRSP {{AMFINSTANCEID "1F6F413E-9F38-4B04-9243-69A95D578F27"} {AMFSERVICENAMEDEREG EMPTY} {BACKUPAMFINFO {+_list {{BACKUPAMF EMPTY} {GUAMILIST {+_list {{AMFID EMPTY} {PLMNID {{MCC EMPTY} {MNC EMPTY}}}}}}}}} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {DRFLAG EMPTY} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {INITIALREGISTRATIONIND true} {PCSCFRESTORATIONCALLBACKURI EMPTY} {PEI imeisv-9876543219876510} {PURGEFLAG EMPTY} {RATTYPE NR} {SUPPORTEDFEATURES EMPTY}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName udm1_s} {remoteName amf_net1}}^M^M



####after ue deregistraion
udm1_c---->amf_net1_NfyUDM        | 172.16.46.224 | : notify the amf deregistraion
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $04} {HDRBLKFRAGMENT {{ACCEPT EMPTY} {AUTHORITY "172.16.46.224:8080"} {CONTENTID EMPTY} {CONTENTLEN EMPTY} {CONTENTTYPE application/json} {HDRTABLESZ EMPTY} {LOCATION EMPTY} {METHOD POST} {PATH /nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {SCHEME http} {USERAGENT EMPTY}}} {STREAMDEP EMPTY} {STREAMID 3} {WEIGHT EMPTY}}}} {localName udm1_c} {remoteName amf_net1}}

udm1_c  ------> amf_net1_NfyUDM
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{METHOD EMPTY} {STATUS "204"}}} {STREAMID $00000003}}}} {localName udm1_c} {remoteName amf_net1}}

udm1_s  <----- amf_net1_N8
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.71:8080"} {METHOD DELETE} {PATH /nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/delete} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000005}}}} {localName udm1_s} {remoteName amf_net1_1}}

udm1_s -----> amf_net1_N8
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{CONTENTID EMPTY} {CONTENTLEN EMPTY} {CONTENTTYPE EMPTY} {DATE EMPTY} {HDRTABLESZ EMPTY} {LOCATION EMPTY} {RETRYAFTER EMPTY} {STATUS 204}}} {STREAMDEP EMPTY} {STREAMID $00000005} {WEIGHT EMPTY}}}} {localName udm1_s} {remoteName amf_net1_1}}


* 5G procedures
CmState: IDLE  / CONNECTED
RmState: REGISTERED / DEREGISTGERED

** UE registration 
1.Configured NSSAI provisioned to UE and NS Selection Policy (NSSP): Rules associating an App with an S-NSSAI and DNN linked to the App
2.UE sends Registration Request including Requested NSSAI. RAN selects AMF based on Requested NSSAI (assumption 5G-GUTI is not provided)
3.AMF fetches Authentication Vectors from AUSF and subscription data from UDM. UDM returns (Sub data+ Subscribed NSSAI)
4.AMF interrogates NSSF for Slice Selection if it cannot serve the UE: NSSF returns set of NSI ID, Allowed S-NSSAI, target AMF set. A target AMF is selected by the AMF initially received the request and rerouting to the target AMF applies
5.AMF sends Registration Accept/Complete (Allowed S-NSSAIs, 5G-GUTI, Registration area. Mobility restrictions, …) to both RAN and UE (NAS)
6.Subsequently UE uses updated NSSAI providing list of Allowed S-NSSAIs




All other values are unused and shall be interpreted as "initial registration", if received by the network.
Bits
3	2	1
0	0	1		initial registration
0	1	0		mobility registration updating
0	1	1		periodic registration updating
1	0	0		emergency registration
1	1	1		reserved


** Registration with imsi
*** registration request with follow-on bit as 1
in 5G network, registration could be done without a single pdu session establishement, all the resources allocated between AMF and GNB
SUCI: se
iota> 5gRegistrationSuci -for false -mmcap 01 -postinitproc {vfy_IE_SecModeCmd -imeireq \$01}
### when ue send registraionRequest(Requested NSSAI) to gnb, gnb(RAN) selects AMF based on Requested NSSAI (assumption 5G-GUTI is not provided)

amf_net1 <--- INITIALUEMESSAGE(NGREGISTRATIONREQUEST) ---- gnb01
NGAP::INITIALUEMESSAGE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGREGISTRATIONREQUEST {{EPD $7E} {NGKSI $7} {NGMMCAPABILITY $01} {NGMOBILEIDENTITY $0164F020214300003010000110} {NGREGISTRATIONTYPE $1} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A5} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00} {UESECURITYCAPABILITY $80408080}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}} {{CRITICALITY 1} {ID 90} {VALUE {RRCESTABLISHMENTCAUSEOBJ {{RRCESTABLISHMENTCAUSE 3}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}

####AMF fetches Authentication Vectors from AUSF 
       amf_net1_1 ---- DATAFRAME(UEAUTHENTICATIONSREQ) ---> ausf1_s
       amf_net1_1 <--- DATAFRAME(UEAUTHENTICATIONSRSP) ---- ausf1_s
       NGAP::DOWNLINKNASTRANSPORT {{CRITICALITY $01} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 16807}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGAUTHREQ {{ABBA $0000} {AUTHENTICATIONPARAMETERAUTN $C0B3E6467DAF825D03121A0CCBC5A1BF} {AUTHENTICATIONPARAMETERRAND $40FF6535BE8BC051BE8BC051BE8BC051} {EPD $7E} {NGKSI $00} {SECURITYHDRTYPE $0} {SPAREHALFOCTET $00} {_ISDECODED EMPTY} {_RAWNASPDU $7E0056000200002140FF6535BE8BC051BE8BC051BE8BC0512010C0B3E6467DAF825D03121A0CCBC5A1BF}}}}}}}}}} {localName gnb01} {remoteName amf_net1}}
       amf_net1 ---- DOWNLINKNASTRANSPORT(NGAUTHREQ) ---> gnb01
A       amf_net1 <--- UPLINKNASTRANSPORT(NGAUTHRSP) ---- gnb01
K       NGAP::UPLINKNASTRANSPORT {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 16807}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGAUTHRSP {{AUTHENTICATIONRESPONSEPARAMETER $6C84B32FAC4740CDD8D21849259E857E} {EPD $7E} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}
A       amf_net1 ---- DATAFRAME(AKACONFIRMATIONREQ) ---> ausf1_s
       amf_net1 <--- DATAFRAME(AKACONFIRMATIONRSP) ---- ausf1_s
       NGSECURITYMODECOMMAND
       amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01
       amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
{NASMSG {NAS::NGSECURITYMODECOMPLETE {{EPD $7E} {NASMESSAGECONTAINER EMPTY} {NGIMEISV $9578563412896715F0} 


####AMF fetches Authentication Vectors from AUSF and subscription data from UDM. UDM returns (Sub data+ Subscribed NSSAI)

      amf_net1 ---- DATAFRAME(UECMREGISTRATIONREQ) ---> udm1_s
## PUT /nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access: amfInstanceId,pei(imsi-v),guami, deregCallbackUri[String value: http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification]     
## udm could initiate a purge imsi in AMF(delete imsi related info in db) with this deregcallbackUri

HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONREQ {{AMFINSTANCEID "47ff6da3-c6a2-49d3-86c6-52bf9274d59a"} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {INITIALREGISTRATIONIND true} {PEI imeisv-9876543219876510} {RATTYPE NR}}}}}}} {FLAGS $01} {STREAMID $00000007}}}} {localName udm1_s} {remoteName amf_net1}}


      amf_net1 <--- DATAFRAME(UECMREGISTRATIONRSP) ---- udm1_s
      amf_net1_1 <--- DATAFRAME(SUPIMULTIPLEDATASETSRSP) ---- udm1_s
      amf_net1_1 ---- DATAFRAME(SDMSUBSCRIBEREQ) ---> udm1_s
      amf_net1_1 <--- DATAFRAME(SDMSUBSCRIBERSP) ---- udm1_s
     
###AMF sends Registration Accept/Complete (Allowed S-NSSAIs, 5G-GUTI, Registration area. Mobility restrictions, …) to both RAN and UE (NAS)
amf_net1 ---- DOWNLINKNASTRANSPORT(NGREGISTRATIONACCEPT) ---> gnb01 
## since no pdu session need to be established, no initialuecontextrequest message.

amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
NGREGISTRATIONCOMPLETE
NGCONFIGURATIONUPDATECOMMAND

####Subsequently UE uses updated NSSAI providing list of Allowed S-NSSAIs

## cmm subscriber show --imsi 460020301001001 |head
##  amfCmState: CONNECTED     |   amfRmState: REGISTERED


***  registration request (follow-on is 0)
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01  Configuration update command

amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01

## cmm subscriber show --imsi 460020301001001 |head
##  amfCmState: IDLE     |   amfRmState: REGISTERED

Follow-on request bit (FOR) (octet 1, bit 4)
Bit
4
0				No follow-on request pending
1				Follow-on request pending

amf will send UEContextextReleasecommand to gnb01 to release ue context after reply with registration accept.

*** follow-on timer
there's a timer after SMC, if follow-on bit is on, no pduestablishement request after timer expire,
then UE context release will be triggerd.

mau0945 IT_8 Initial Registration with GUTI, FOR True, no request from UE AMF timeout, NG release
    [Tags]    tidnum_mau0945     regression
    [Documentation] 	Initial attach with SUCI and follow-on flag, verify NG release occurs if UE does not respond within follow-on timer.
    ...               Ue Context Release during Registration SUCI, Registration Mobility, Deregistration.
    IOTA Procedure    5gRegistrationSuci -for true_timeout -postinitproc {::registration_FOR_timer_expire}
####SUCCESS:
####                                registrationacc_time            : 1573031126  ### record in iota tester
####                                ngrelease_time                  : 1573031141
####                                AMF release N2 connection after : 15 sec
#### this iota procedure will wait about 15s to receive uecontext release command message from AMF
amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
####amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01

    IOTA Procedure    5gRegistrationMobility -for true_timeout -postinitproc {::registration_FOR_timer_expire}
#### when amfCmState:IDLE , 5gRegistrationMbility also wait for timer 15m expire to receive AMF's uecontext release command 
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration
    PMOnDemand.report_request    yes    200
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeCxtRelAtt 
    Should Be Equal As Integers    ${cnts}    3
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeCxtRelSucc
    Should Be Equal As Integers    ${cnts}    3

*** ueidentityreq/rep
normally, pei/imeisv is returned in SecurityModeComplete, when the imesv request bit in SecurityModeCommand is set to 1
For AMF, if the gParam peiRetrievalMethod is idr, then AMF will send identity request after smc message to retrieve imeisv/pei
For AMF, if the gParam peiRetrievalMethod is sec, then AMF will send smcommand with  imeisv request bit set to 1


**** iota case
mau0983 5G Initial Registration with SUCI, Prov set to request IMEI with Identity Req, IDRsp with IMEISV
    [Tags]   tidnum_mau0983      regression
    [Documentation]    Verify AMF requests PEI in Identity request when peiRetrievalMethod is set to "Retrieve PEI via Identity Request".
    ...                UDM initiated deregistration in connected mode and with PDU
    Update peiRetrievalMethod idr  ### this gParam could be idr or smc(security mode complete)
    sleep    5
    IOTA Procedure    5gRegistrationSuci -idreq_pei mandatory
### this will verify if AMF send the identity request to get pei/imeisv 
    IOTA Procedure    5gPduEstablishment
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gRegistrationGuti -for false -mmcap 01
    IOTA Procedure    5gUdmDeRegistration -pcf true -page false
    PMOnDemand.report_request    yes    200
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeIdentityAtt
    Should Be Equal As Integers    ${cnts}    2
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeIdentitySucc
    Should Be Equal As Integers    ${cnts}    2

mau1266 IT_6 5G Initial Registration with SUCI, FOR false, SMCmp with no IMEISV, IDRsp with IMEISV
    [Tags]   tidnum_mau1266     regression    release_cmm19.5_m3
    [Documentation]    Initial attach with SUCI, PEI/IMEI requested in Identity Request received in Identity Resposne
    IOTA Procedure    5gRegistrationSuci -idreq_pei mandatory -postinitproc {SecModeCmp_without_imeisv;vfy_IE_IdReq_imeireq -ie ngidentityrequest_idtype -value \\$05}
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration

** 5g UeDeregistration
iota> 5gUeDeRegistration
amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb01 NGDEREGISTRATIONREQ_UEORIG
#### if any pdu not release
amf_net1----------> smf
{HDRBLKFRAGMENT {{AUTHORITY "172.16.59.61:8080"} {CONTENTLEN "2"} {CONTENTTYPE application/json} {METHOD POST} {PATH /nsmf-pdusession/v1/sm-contexts/imsi-460020301001006_1/release} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000005}}}} {localName smf1_s} {remoteName amf_net1
HTTP2 {{BODY {@DATAFRAME {{DATA {NSMF {{BODY {@RELEASESMCONTEXTREQ {}}}}}} {FLAGS $01} {STREAMID $00000005}}}} {localName smf1_s} {remoteName amf_net1}}

amf_net1 <--- HEADERSFRAME ---- smf1_s
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{CONTENTID EMPTY} {CONTENTLEN EMPTY} {CONTENTTYPE EMPTY} {DATE EMPTY} {HDRTABLESZ EMPTY} {LOCATION EMPTY} {RETRYAFTER EMPTY} {STATUS "204"}}} {STREAMDEP EMPTY} {STREAMID $00000005} {WEIGHT EMPTY}}}} {localName smf1_s} {remoteName amf_net1}}
#### if any pdu not release
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01NGDEREGISTRATIONACCEPT_UEORIG
amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01

## cmm subscriber show --imsi 460020301001001 |head
##  amfCmState: CONNECTED     |   amfRmState: DEREGISTERED


** 5g guti registration
after 5gUe Deregistration, ue could use guti to send registration request with inital registration type
the same singnalling as 5g supi/imsi resgistration, only use guti insead of supi

*** scenario of guit registration    
IOTA Procedure    5gRegistrationSuci -for false -mmcap 01 ...                -postinitproc {vfy_IE_SecModeCmd -imeireq \\$01}
    Sleep    2
    Assert Rest Response    Rest Show Subscribers    ${IOTA.IMSI1} ...    RESPONSE ...    AMFSXN.amf5gmmUeCapability=0x01
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gRegistrationGuti -for false -mmcap 03 ...                -postinitproc {vfy_IE_SecModeCmd -imeireq \\$01}
    Sleep    2
    Assert Rest Response    Rest Show Subscribers    ${IOTA.IMSI1} ...    RESPONSE ...    AMFSXN.amf5gmmUeCapability=0x03
    IOTA Procedure    5gServiceReqSignalling
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration  ### delete subscriber in database of AMF


** 5g udm deregistration: Network-initiated Deregistration
###when callback of amf_net1 was notified by udm, then amf will delete the db about this imsi
iota> 5gUdmDeRegistration
with type  -deregist_reason withdrawsubscribe
amf_net1 <--- DATAFRAME(DEREGISTRATIONNOTIFY) ---- udm1_c
### with  deregCallbackUri header not notify MME send subscripion delete request to udm itself

amf_net1_1 ---- HEADERSFRAME ---> udm1_s
###   DELETE /nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/delete
amf_net1_1 <--- HEADERSFRAME ---- udm1_s
amf_net1 ---- HEADERSFRAME ---> udm1_c

#### no subscriber info show, it will be deleted
#### cmm subscriber show --imsi 460020301001001 |head
|-------+-------|
| Field | Value |
|-------+-------|
|       |       |
|-------+-------|

** 5g SMS over NAS procedures
*** Registration procedures for SMS over NAS
iota>5gRegistrationSuci    -sms_over_nas true  -smsfsim_s smsf2_s
### when ue send registraionRequest(Requested NSSAI) to gnb, gnb(RAN) selects AMF based on Requested NSSAI (assumption 5G-GUTI is not provided)

amf_net1 <--- INITIALUEMESSAGE(NGREGISTRATIONREQUEST) ---- gnb01
NGAP::INITIALUEMESSAGE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGREGISTRATIONREQUEST {{EPD $7E} {NGKSI $7} {NGMMCAPABILITY $01} {NGMOBILEIDENTITY $0164F020214300003010000110} {NGREGISTRATIONTYPE $1} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A5} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00} {UESECURITYCAPABILITY $80408080}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}} {{CRITICALITY 1} {ID 90} {VALUE {RRCESTABLISHMENTCAUSEOBJ {{RRCESTABLISHMENTCAUSE 3}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}

####AMF fetches Authentication Vectors from AUSF 
       amf_net1_1 ---- DATAFRAME(UEAUTHENTICATIONSREQ) ---> ausf1_s
       amf_net1_1 <--- DATAFRAME(UEAUTHENTICATIONSRSP) ---- ausf1_s
       NGAP::DOWNLINKNASTRANSPORT {{CRITICALITY $01} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 16807}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGAUTHREQ {{ABBA $0000} {AUTHENTICATIONPARAMETERAUTN $C0B3E6467DAF825D03121A0CCBC5A1BF} {AUTHENTICATIONPARAMETERRAND $40FF6535BE8BC051BE8BC051BE8BC051} {EPD $7E} {NGKSI $00} {SECURITYHDRTYPE $0} {SPAREHALFOCTET $00} {_ISDECODED EMPTY} {_RAWNASPDU $7E0056000200002140FF6535BE8BC051BE8BC051BE8BC0512010C0B3E6467DAF825D03121A0CCBC5A1BF}}}}}}}}}} {localName gnb01} {remoteName amf_net1}}
       amf_net1 ---- DOWNLINKNASTRANSPORT(NGAUTHREQ) ---> gnb01
A       amf_net1 <--- UPLINKNASTRANSPORT(NGAUTHRSP) ---- gnb01
K       NGAP::UPLINKNASTRANSPORT {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 16807}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 1}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGAUTHRSP {{AUTHENTICATIONRESPONSEPARAMETER $6C84B32FAC4740CDD8D21849259E857E} {EPD $7E} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}
A       amf_net1 ---- DATAFRAME(AKACONFIRMATIONREQ) ---> ausf1_s
       amf_net1 <--- DATAFRAME(AKACONFIRMATIONRSP) ---- ausf1_s
       NGSECURITYMODECOMMAND
       amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01
       amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
{NASMSG {NAS::NGSECURITYMODECOMPLETE {{EPD $7E} {NASMESSAGECONTAINER EMPTY} {NGIMEISV $9578563412896715F0} 

####AMF fetches Authentication Vectors from AUSF and subscription data from UDM. UDM returns (Sub data+ Subscribed NSSAI)

      amf_net1 ---- DATAFRAME(UECMREGISTRATIONREQ) ---> udm1_s
## PUT /nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access: amfInstanceId,pei(imsi-v),guami, deregCallbackUri[String value: http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification]     
## udm could initiate a purge imsi in AMF(delete imsi related info in db) with this deregcallbackUri

HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONREQ {{AMFINSTANCEID "47ff6da3-c6a2-49d3-86c6-52bf9274d59a"} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {INITIALREGISTRATIONIND true} {PEI imeisv-9876543219876510} {RATTYPE NR}}}}}}} {FLAGS $01} {STREAMID $00000007}}}} {localName udm1_s} {remoteName amf_net1}}


      amf_net1 <--- DATAFRAME(UECMREGISTRATIONRSP) ---- udm1_s
      amf_net1_1 <--- DATAFRAME(SUPIMULTIPLEDATASETSRSP) ---- udm1_s
      amf_net1_1 ---- DATAFRAME(SDMSUBSCRIBEREQ) ---> udm1_s
      amf_net1_1 <--- DATAFRAME(SDMSUBSCRIBERSP) ---- udm1_s


###********** Extra steps for sms over nas ****#########
amf_net1_1 ---- DATAFRAME(SMSSERVICEACTIVATIONREQ) ---> smsf2_s PUT /nsmsf-sms/v1/ue-contexts/imsi-460020301001001
HTTP2 {{BODY {@DATAFRAME {{DATA {NSMSF {{BODY {@SMSSERVICEACTIVATIONREQ {{ACCESSTYPE "3GPP_ACCESS"} {AMFID "9f93acbc-c877-444b-850d-469c9ae56c09"} {GPSI msisdn-3587003600201} {GUAMIS {+ {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}}} {PEI imeisv-9876543219876510} {SUPI imsi-460020301001001} {UELOCATION {{NRLOCATION {{NCGI {{NRCELLID "000515101"} {PLMNID {{MCC "460"} {MNC "02"}}}}} {TAI {{PLMNID {{MCC "460"} {MNC "02"}}} {TAC $007530}}}}}}} {UETIMEZONE -06:00}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName smsf2_s} {remoteName amf_net1_1}}

amf_net1_1 <--- DATAFRAME(SMSSERVICEACTIVATIONRSP) ---- smsf2_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NSMSF {{BODY {@SMSSERVICEACTIVATIONRSP {{ACCESSTYPE "3GPP_ACCESS"} {AMFID "9f93acbc-c877-444b-850d-469c9ae56c09"} {GPSI msisdn-3587003600201} {GUAMIS {+_list {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}}} {PEI imeisv-9876543219876510} {SUPI imsi-460020301001001} {UELOCATION {{NRLOCATION {{NCGI {{NRCELLID "000515101"} {PLMNID {{MCC "460"} {MNC "02"}}}}} {TAI {{PLMNID {{MCC "460"} {MNC "02"}}} {TAC $007530}}}}}}} {UETIMEZONE -06:00}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName smsf2_s} {remoteName amf_net1_1}}
####********  sms service activation req/rsp ****##########


###AMF sends Registration Accept/Complete (Allowed S-NSSAIs, 5G-GUTI, Registration area. Mobility restrictions, …) to both RAN and UE (NAS)
amf_net1 ---- DOWNLINKNASTRANSPORT(NGREGISTRATIONACCEPT) ---> gnb01 
## since no pdu session need to be established, no initialuecontextrequest message.

amf_net1 <--- UPLINKNASTRANSPORT(REGISTRATION ACCEPT) ---- gnb01
NGREGISTRATIONCOMPLETE
NGCONFIGURATIONUPDATECOMMAND


*** MO SMS over NAS
UE(CM-CONNECTED) has a short message to send, so UE trigger the procedure to send message

amf_net1 <---- UPLINKNASTRANSPORT(UL NAS TANSPORT) --- gnb01 
amf_net1 ---- DATAFRAME(SMS BODY) ---> smsf2_s POST /nsmsf-sms/v1/ue-contexts/imsi-460020301001001/sendsms, DATA[5] (application/json)
amf_net1 <--- DATAFRAME(CPACK from SMSF) ---- smsf1_com  CPACK  POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
amf_net1 --- DOWNLINKNASTRANSPORT(CP ack from smsf) ---- gnb01

amf_net1 <--- DATAFRAME(submit Report from SMSF) ---- smsf1_com   POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
amf_net1 ---- DOWNLINKNASTRANSPORT(submit Report transport to UE) ---> gnb01
amf_net1 <--- UPLINKNASTRANSPORT(CP ack from UE) ---- gnb01
amf_net1 ---- DATAFRAME(CP ack from UE) ---> smsf2_s POST /nsmsf-sms/v1/ue-contexts/imsi-460020301001001/sendsms, DATA[5] (application/json)(RP)


*** MT SMS over NAS when ue is cm-connected
network triggered SMS service, when there's a message from SM center to a UE, then smsf will trigger a procedure to get UE and sent the message
UE is cm-connected status, no paging needed
>iota IOTA Procedure    5gSmsfMOSms   -smsfsim_s smsf2_s 
amf_net1 <--- DATAFRAME(MTENABLEUEREACHABILITYREQ) ---- smsf1_mt    POST  /namf-mt/v1/ue-contexts/imsi-460020301001001/ue-reachind   EnableUEReachabilityReq 
amf_net1 ---- DATAFRAME(MTENABLEUEREACHABILITYRSP) ---> smsf1_mt

amf_net1 <--- DATAFRAME(N1N2MESSAGETRANSFERREQ) ---- smsf1_com SMS_BODY POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
amf_net1 ---- DATAFRAME(N1N2MESSAGETRANSFERRSP) ---> smsf1_com

amf_net1 ---- DOWNLINKNASTRANSPORT(SMS BODY TANSPORT) ---> gnb01 
amf_net1 <--- UPLINKNASTRANSPORT(CP ack from GNB) ---- gnb01
amf_net1 ---- DATAFRAME(CP ack from GNB) ---> smsf2_s POST /nsmsf-sms/v1/ue-contexts/imsi-460020301001001/sendsms, DATA[5] (application/json)(RP)

amf_net1 <--- UPLINKNASTRANSPORT(Delivery Report from UE) ---- gnb01
amf_net1 --- DATAFRAME(Delivery Report from UE) ----> smsf2_s POST /nsmsf-sms/v1/ue-contexts/imsi-460020301001001/sendsms, DATA[5] (application/json)(RP) 

amf_net1 <--- DATAFRAME(CPACK from SMSF) ---- smsf1_com  CPACK  POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
amf_net1 ---- DOWNLINKNASTRANSPORT(CPACK from SMSF) ---> gnb01

**** MT SMS over NAS service request fail when ue is cm-idle
network triggerd SMS service, a short message needed to be sent to UE from SM center, and ue status is cm-idle, amf will page ue, ue send service request, 
AMF send service reject to UE, and send UE_UNREACHABLE to SMSF.  {"cause":"UE_NOT_REACHABLE"}

amf_net1 <--- DATAFRAME(MTENABLEUEREACHABILITYREQ) ---- smsf1_mt    POST  /namf-mt/v1/ue-contexts/imsi-460020301001001/ue-reachind

amf_net1 ---- PAGING ---> gnb01 
amf_net1 <---- ServiceRequest(without some mandantary IE) ---gnb01
amf_net1 ---- ServiceReject(no Mandatory IE) ---->gnb01
amf_net1 ---- UE context Release CMD --->gnb01
amf_net1 <---- UE context Release COMPLETE ---gnb01
++++++++++++++++++++++++++++++ amf return ERROR for this UE reachablitlity requestof the first message++++++++
amf_net1 --- DATAFRAME(MTENABLEUEREACHABILITYREQ) ----> smsf1_mt   504 return code, and {"cause":"UE_NOT_REACHABLE"} 

in this scenario urrpAmfFlag in cmm susscriber show will be true, and it store that now ue is not reachable, when ue change to reachable, it will send notification message if subscribed;


** 5g UE Rechablity Procedure
*** UE Reachability Notification Request Procedure
udm   ------> amf : POST /namf-evts/v1/subscriptions
{ "subscription": { "eventList": [ { "type": "REACHABILITY_REPORT" }  ],
"eventNotifyUri": "http://172.16.59.76:8080/namf-evts/v1/subscriptions/imsi-460020301001001/event-subscription-notify", 
"notifyCorrelationId": "UDMforEventExposure-460020301001001", "nfId": "bd7c4cb3-abcd-4db0-a8fc-becab18f9211", "supi": "imsi-460020301001001", "options": { "trigger": "ONE_TIME" }  }  } 

amf will store the eventNofiyUri, when ue rechability changed and urrpAmfFlag(true), AMF will send notification to udm with this notifyUri

***  UE Activity Notification procedure
when UE is cm-idle, and service Request successful(AMF send service accept) , and flag urrpAmfFlag in AMF is true, AMF will send notification to UDM
amf_net1  ------> UDM_s POST /namf-evts/v1/subscriptions/imsi-460020301001001/event-subscription-notify, DATA[1] (application/json)
{"notifyCorrelationId":"UDMforEventExposure-460020301001001","reportList":[{"type":"REACHABILITY_REPORT","state":{"active":true},"timeStamp":"1902-12-22T19:13:15Z","subscriptionId":"udm-imsi-460020301001001-reachability","supi":"imsi-460020301001001","reachability":"REACHABLE"}]}


*** the scenario of sending ue activity notification procedure ngj0631
PRE-condition1: udm subscribe the ue REACHABILITY_REPORT to AMF [5gEventExposureForUERechability]
PRE-condition2: MT SMS over NAS service request fail when ue is cm-idle(this will make flag urrpAmfFlag be true),AMF send smsf UE_NOT_REACHABLE [5gMTSmsWithServiceReject]
PRE-condition3: ue rechability changed from unrechable to rechable (succesful service request) [5gServiceReqData]

ngj0631
    [Documentation]
    ...  PreRequisite:
    ...  1. gParm smsOverNas enabled
    ...  2.UePlmnServices - smsOverNas set to allowed
    ...
    ...  Scenario:
    ...  1. Successful registration with smsOverNas allowed
    ...  2. Ng release
    ...  5. MT- enable UE reachability request from SMSF  Service Request failure, AMF respond back with UE unreachable to SMSF
    ...  8. successful ue initiated service request making AMF notify UDM
    ...  9. Deregistration
    ...
    IOTA Procedure    5gRegistrationSuci -sms_over_nas true  -postinitproc {set ::c_ue(ngregstreq_ngsupdatetype) \\$01;

    IOTA Procedure    5gEventExposureForUERechability   -udmsim_c udmEEv4_c -udmipv6 false
    IOTA Procedure    5gNgRelease

	IOTA Procedure    5gMTSmsWithServiceReject -smsfsim_s smsf2_s   {smsf send ue reachablity request to AMF,AMF paging fail return with serviceRej, AMF send smsf ue_not_rechable and set flag true}
	${subscriber_data}=     Rest Show Subscribers    imsi=${IOTA.IMSI1}
    Assert Rest Response    Rest Show Subscribers    ${IOTA.IMSI1}    RESPONSE      AMFSXN.urrpAmfFlag=True
  	IOTA Procedure    5gServiceReqData 	 -postinitproc {    add_notify_udm;}  {AMF will notify UDM the ue become reachable}
    ${subscriber_data}=     Rest Show Subscribers    imsi=${IOTA.IMSI1}


*** similar scenario ngj0632_a
    IOTA Procedure    5gEventExposureForUERechability   -udmsim_c udmEEv4_c -udmipv6 false -verbose 3
    IOTA Procedure    5gSmsfMTSmsWithUERechability -smsfsim_s smsf2_s  -page_no_rsp true  ### this will make Flag true, and AMF send ue_not_rechable to smsf
	${subscriber_data}=     Rest Show Subscribers    imsi=${IOTA.IMSI1}
    Assert Rest Response    Rest Show Subscribers    ${IOTA.IMSI1}    RESPONSE      AMFSXN.urrpAmfFlag=True

	IOTA Procedure    5gRegistrationPeriodic  -for true  -postinitproc {set ::c_ue(ngregstreq_ngsupdatetype) \\$01;
    ...               set ::c_ue(n8uecxtsmsf3gppdatarsp_smsfinstanceid) "e2961600-3447-11e9-b56e-0800200c9a66";
    ...               vfy_IE_Registration_result  -ie ngregistacc_registrationresult -value \\$09;
    ...               add_notify_udm;  ##### this successful servicereqeust will make AMF send notification, since flag is true and UDM has subscribed this .
    ...               }

** 5g TAU
5G "TAU" is mobility update, and it will not only update tac, but also update nssai, (with AKA procedure but no ue context setup request)
in 5G, tai(tac) and nssai are usally be considered combined
# proc 5gRegistrationMobility
message Registraion request [type: mobility update ] instead of initial registration 
amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb01
NGAP::INITIALUEMESSAGE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 85} {VALUE VALUE {NASPDUOBJ {{NASPDU
{NASMSG {NAS::NGREGISTRATIONREQUEST {NGMOBILEIDENTITY $F264F020010041C1800014} {NGREGISTRATIONTYPE $A} {PDUSESSIONSTATUS $0000} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A50403ABCDE3} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00} {UESECURITYCAPABILITY $80408080}}}}
registraion type 0x10 measn mobility update with guti

AKA procedure
after SMC
after udm query nssai

** 5g service request
*** network trigger service request
**** network initiated service request without NAS message, paging is composed by AMF
5gNWInitServiceRequest -numpageattempts 1

##smf trigger ue context setup request
amf_net1 <--- ---- smf1_com POST: http://172.16.59.63:20384/ue-contexts/n1-n2-messages/imsi-460020301001001_1
{SMINFO {{N2INFOCONTENT {{NGAPDATA {{CONTENTID n2ContentId}}} {NGAPIETYPE PDU_RES_SETUP_REQ} {NGAPMESSAGETYPE "29"}}} {PDUSESSIONID "1"} {SNSSAI {{SD $000000} {SST "0"}}}}}}} {PDUSESSIONID "1"} {PPI "5"} {QI "10"}}}}}}} ngapietype:PDU_RES_SETUP_REQ

##amf send paging...
amf_net1 ---paging ----> gnb01
amf_net1 <--- INITIALUEMESSAGE(service request) ---- gnb01  ###without uplink data pending service request
nas{(pdu-status,5g-tmsi) (pdu session status 1)}, userlocation{tac}, 5g-tmsi

amf_net1 --- InitialContextSetupReq(service accept) ----> gnb01 ### now ue is from idle to connected
amf_net1 <--- InitialContextSetupRsp ------> gnb01  now ue is from idle to connected


amf_net1 ---- PDUSESSIONRESOURCEMODIFYREQUEST(pdu session modification command) ---> gnb01  ### gtp tunnel addr of upf
amf_net1 <--- PDUSESSIONRESOURCEMODIFYRESPONSE ---- gnb01  ####gtp tnnnel of gnb

amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
upCnxState:"ACTIVATED" ,AMF foward N2 SM information and the User location Information received from the AN to the SMF 
amf_net1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s

amf_net1 <--- UPLINKNASTRANSPORT(PDUSESSIONRESOURCEMODIFYCOMPLETE) ---- gnb01
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
The AMF forwards the N1 SM container (PDU Session Modification Command Ack) and User Location Information received from the AN to the SMF 
amf_net1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s






**** network initiated service request with NAS(PDU session modification command)
precondition: PDU session modification during IDLE mode and Asynchronous Type communication is enabled
'cmm amfGParms modify asynchrTypeComm --amfGparmValue ATC_Enabled'
This parameter defines whether the AMF attempts to contact a CM-IDLE UE when AMF receives signalling message for the UE, e.g. SMF triggers N1/N2 message transfer for PDU session modification. When enabled, the AMF attempts to reach the UE via paging (if the UE is currently considered reachable and would be expected to respond to paging). When disabled, the AMF sends the signalling message to the UE when the UE makes the next contact towards the network.
ATC_Disabled - Asynchronous Type Communication Disabled - When AMF receives terminating signalling for a UE that is CM-IDLE, the AMF attempts to reach a CM-IDLE UE via paging (if the UE is currently considered reachable and would be expected to respond to the paging).
ATC_Enabled - Asynchronous Type Communication Enabled - For a CM-IDLE UE for which terminating signalling is received from another network element, the AMF stores the corresponding signalling message and delivers the message towards the UE when the UE makes the next contact towards the network.
DefaultATC_Disabled

   IOTA Procedure    5gNWInitServiceRequest -postinitproc {::setSMFinitMSgs;scen_common_chain removechainedsm "N2PAGING"}
##smf trigger ue context setup request
amf_net1 <--- ---- smf1_com POST: http://172.16.59.63:20384/ue-contexts/n1-n2-messages/imsi-460020301001001_1
{SMINFO, N2, NGAPTYPE:PDU_RES_SETUP_REQ,} ,{N1, PDU session modification command}

###AMF will not page the UE and waits till UE comes back to connected mode and then transfer N1N2 . UE came back with Service Request.User plane established
### amf will transfer this NAS(PDU session modification command) to GNB

*** service request with data pending 
IOTA Procedure    5gServiceReqData
service request with data
amf_net1 <--- INITIALUEMESSAGE(service request) ---- gnb01
nas{(uplink data status, uplink data pending,5g-tmsi) (pdu session status 1,2)}, userlocation{tac}, 5g-tmsi

### will triger activating pdu in nsmf sm contexts if upplink data pending
amf_net1_1 ---- HEADERSFRAME ---> smf1_s   POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s  upCnxState(ACTIVATING),n2message[service request]
amf_net1_1 <--- HEADERSFRAME ---- smf1_s
amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s

amf_net1 ---- INITIALCONTEXTSETUPREQUEST(Service accept) ---> gnb01  service accept, tell gnb the gtp-teid of SMF   
amf_net1 <--- INITIALCONTEXTSETUPRESPONSE ---- gnb01  with GNB gtpteid

amf_net1_1 ---- HEADERSFRAME ---> smf1_s   POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s  tell initialcontextresponse(gtp-teid-gnb)
{"upCnxState":"ACTIVATED","n2SmInfo":{"contentId":"n2msg"},"n2SmInfoType":"PDU_RES_SETUP_RSP","anTypeCanBeChanged":false}

amf_net1_1 <--- HEADERSFRAME ---- smf1_s

## cmm subscriber show --imsi 460020301001001 |head
##  amfCmState: CONNECTED     |   amfRmState: REGISTERED



*** service request singalling
iota> 5gServiceReqSignalling
amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb01 NGSERVICEREQUEST
###pdusessionid, snassai, upCnxState(ACTIVATING), n2SmInfoType(PDU_RES_SETUP_REQ)[ServiceRequest]
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01  NGSERVICEACCEPT


*** network initiated service request singalling (means there's downlink data, so pdu session modification needed to get the addr of gnb-teid)
##smf trigger ue context setup request
amf_net1 <--- ---- smf1_com POST: http://172.16.59.63:20384/ue-contexts/n1-n2-messages/imsi-460020301001001_1
{SMINFO, N2, NGAPTYPE:PDU_RES_SETUP_REQ,} ,{N1, PDU session modification command}


amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb01 NGSERVICEREQUEST
###pdusessionid, snassai, upCnxState(ACTIVATING), n2SmInfoType(PDU_RES_SETUP_REQ)[ServiceRequest]
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01  NGSERVICEACCEPT


amf_net1 -----	InitialContextSetupRequest, DL NAS transport, PDU session modification command---> GNB
GNB ------InitialContextSetupResponse-----------> AMF ###GNB teid to AMF 
GNB ------	UplinkNASTransport, UL NAS transport, PDU session modification complete ----->AMF

AMF ------ POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify, DATA[7] -----> SMF
AMF------ POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify, DATA[9] (application/json), PDU session modification complete --->SMF



** 5gNgRelease
iota> 5gNgRelease
amf_net1 <--- UECONTEXTRELEASEREQUEST ---- gnb01
amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01
amf_net1 ---- HEADERSFRAME ---> smf1_s
amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
amf_net1 <--- HEADERSFRAME ---- smf1_s
amf_net1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
##############################cmm subscriber show####about PDU context####
allocatedEbiCount: 0  dnnInUse: wap1.nokia.com  dnnInUseFpx: 0  isEmerPduSessFlag: false  lastSentAccessType: 3GPP  lastSentGpsi:    msisdn: 3587003600201    type: msisdn  lastSentRatType: INVALID  lastSentTimeZone:    dst: 0    hour: 6    min: 0    sign: 
-  lastSentUeLocation:    nrLocation:      nrCellId: 0x00515101      plmn: 46002  notifyId: 1  nssai:    isSdPresent: true    sd: 0x00D143A5    sst: 1
pduSessPoolIdx: 64  pduSessionId: 1  psiListIdx: 0  recoveryTime:    ntpTime: 0x00000000  smCxtRef: 0x2F6E736D662D70647573657373696F6E2F76312F736D2D636F6E74657874732F696D73692D3436303032303330313030313030315F31  smfInfo:    smfIpAddress:      addrIPv4: 172.16.59.61    smfIpPort: 8080    smfUuid: 0x20E0B0C382E144A482ABA065D80A3B93  upCnxState: state deactivated
###pdu sessionid 1's state is deactivated,if this is deactivated, amf will not send UPDATESMCONTEXTREQ to smf to deactivate the pdu session with 
POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify, DATA[1] (application/json)  Deactivated UpCtxstate




** 5gRegistraionMobility (register with guti t-msi/ with tracking area update/mobility update)
iota> 5gRegistrationMobility -gNB gnb04 -tac $::IOTACFG(AMF_TAC1)
amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb04
NGREGISTRATIONREQUEST
amf_net1 ---- HEADERSFRAME ---> ausf2_s
amf_net1 ---- DATAFRAME(UEAUTHENTICATIONSREQ) ---> ausf2_s
amf_net1 <--- HEADERSFRAME ---- ausf2_s
amf_net1 <--- DATAFRAME(UEAUTHENTICATIONSRSP) ---- ausf2_s
NGAUTHREQ
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb04
amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb04
NGAUTHRSP
amf_net1 ---- HEADERSFRAME ---> ausf2_s
amf_net1 ---- DATAFRAME(AKACONFIRMATIONREQ) ---> ausf2_s
amf_net1 <--- HEADERSFRAME ---- ausf2_s
amf_net1 <--- DATAFRAME(AKACONFIRMATIONRSP) ---- ausf2_s
NGSECURITYMODECOMMAND
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb04
amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb04
NGSECURITYMODECOMPLETE
NGREGISTRATIONACCEPT
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb04

*** periodical tracking area update
 5GS registration type: periodic registration updating (3)
**** scenario
msb0461 IT13_IDLE UE Periodic Registration with out-of-sync PDU
    [Tags]    tidnum_msb0461    regression
    [Documentation]     Update registration with PDU session, out-of-sync PDUs. Negotiation sync information send in registration accpet message.
    IOTA Procedure    5gRegistrationSuci
    IOTA Procedure    5gPduEstablishment   ### estalish a pdu with pduid 1
    IOTA Procedure    5gNgRelease
##### update the pdustatus with no pdu at all to registration, AMF will accept registration with no pdu at all
    IOTA Procedure    5gRegistrationPeriodic -pdustatus 0x0000 -postinitproc {CSM::InitAmfPduRelease -collision true -outofsyncpsi 1;
    ...                          vfy_IE_Registrationacc_pdustatus -ie ngregistacc_pdustatus -value \\$0000}
#### release pdu with smf, ue context release(cause :normal-release)[remove ipaddr for gtp tunnel in GNB] with GNB
    IOTA Procedure    5gUeDeRegistration
#### ue context release(cause:deregister) [release ue-ngap-id used to comm with AMF}
    IOTA Procedure    5gUdmDeRegistration
    PMOnDemand.report_request    yes    200
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.AmfPduSessReleaseAtt
    Should Be Equal As Integers    ${cnts}    1
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.AmfPduSessReleaseSucc
    Should Be Equal As Integers    ${cnts}    1


** UE PDU SESSION ESTABLISHEMENT
UE start APP A which is mapped to S-NSSAI-A. UE sends PDU session establishment for a given DNN and S-NSSAI
RAN sends PDU session establishment to AMF selected during Registration
AMF gets from NRF the list of SMF for given NSI and S-NSSAI
AMF selects SMF and sends Nsmf PDU Session Create Req to SMF
SMF checks subs data, polls PCF (not shown) for policy, select UPF and N4 Session establishment
SMF responds session accept with S-NSSAI to AMF and RAN
RAN sends a session accepted to UE


** 5gPduEstablishment 
service provided by SMF 
POST /nsmf-pdusession/v1/sm-contexts  ### create a new pdu session
POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify   #modify a imsi based pdusession chage upCntStatus
                                                                     ##or tell SMF the enb-teid

service provided by AMF 
/namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages    ###ue context related to service



ue triggered pdu establishment,
AMF -----> SMF POST /nsmf-pdusession/v1/sm-contexts (snssai, supi..)    ### create a new pdu session
AMF <----- SMF  ###pdusessionid, snassai, upCnxState(ACTIVATING), n2SmInfoType(PDU_RES_SETUP_REQ)

smf triggered PDU_RES_SETUP_REQ( ue context setup)
SMF -----> AMF POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages                           
n1MessageContainer, n2InforContainer(id-UL-NGU-UP-TNLInformation(transport layer address:ip) ,sminfo[pdusessionid...]),NASMESSAGE(PDU session establishmenent accept)

amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s ### POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
#### amf told smf the enb-teid


=====================================================================================
iota> 5gPduEstablishment
amf_net1 <--- UPLINKNASTRANSPORT(pdusession_establish_req) ---- gnb01 NGULNASTRANSPORT  NGPDUSESSIONESTABLISHMENTREQUEST [NAS(dnn, s-nssai,pdu-session-id),tai]
### ue initiated a pdusession established request
###   UE start APP A which is mapped to S-NSSAI-A. UE sends PDU session establishment for a given DNN and S-NSSAI


amf_net1 ---------http2-------->nrrf 
GET /nnrf-disc/v1/nf-instances?target-nf-type=SMF&requester-nf-type=AMF&service-names=nsmf-pdusession,nsmf-event-exposure&snssais=[%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D]&dnn=wap1.nokia.com&tai=%
#### get the smf with para snssais, dnn and tai

amf_net1 <---------http2--------nrrf 
## response the smf instace(id) which suite for snssais,dnn, tai and service is nsmf-pdusession:
## smfInfo: tailist(plmn+tac), sNssais,smf/pgw:( fqdn, ip) 

amf_net1 ---- HEADERSFRAME/DATAFRAME ---> smf1_s  POST /nsmf-pdusession/v1/sm-contexts 
###with NAS-5GS(PDU session establishment request)
HTTP2 {{BODY {@DATAFRAME {{DATA {NSMF {{BODY {@CREATESMCONTEXTREQ {{ANTYPE "3GPP_ACCESS"} {BINARYDATAN1SMMESSAGE {NAS::NGPDUSESSIONESTABLISHMENTREQUEST {{EPD $2E} {INTEGRITYPROTECTIONMAXIMUMDATARATE $0000} {PDUSESSIONID $01} {PDUSESSIONTYPE $01} {PTI $03} {SSCMODE $01}}}} {DNN wap1.nokia.com} {GPSI msisdn-3587003600201} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {N1SMMSG {{CONTENTID n1msg}}} {PCFID C18985BE-8028-4BF0-858A-9391C63B67B2} {PDUSESSIONID "1"} {PEI imeisv-9876543219876510} {RATTYPE NR} {REQUESTTYPE INITIAL_REQUEST} {SELMODE VERIFIED} {SERVINGNETWORK {{MCC "460"} {MNC "02"}}} {SERVINGNFID "99F88C08-524A-48F6-BBF4-2A2E7B92FC58"}
{SMCONTEXTSTATUSURI http://172.16.46.223:8080/nsmf-pdusession/v1/sm-contexts/imsi-460020301001001/ntfyId-1/status-ntf} {SNSSAI {{SD $D143A5} {SST "1"}}} {SUPI imsi-460020301001001} {UDMGROUPID {}} {UELOCATION {{NRLOCATION {{NCGI {{NRCELLID "000515101"} {PLMNID {{MCC "460"} {MNC "02"}}}}} {TAI {{PLMNID {{MCC "460"} {MNC "02"}}} {TAC $007530}}}}}}} {UETIMEZONE -05:00+1}}}}}}} {FLAGS $01} {STREAMID $00000019}}}} {localName smf1_s} {remoteName amf_net1}}

amf_net1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s
###pdusessionid, snassai, upCnxState(ACTIVATING), n2SmInfoType(PDU_RES_SETUP_REQ)


amf_net1 <--- DATAFRAME(N1N2MESSAGETRANSFERREQ) ---- smf1_com  POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
n1MessageContainer(messgetype:5GMM,NASMESSAGE(PDU session establishmenent accept),
n2InforContainer(id-UL-NGU-UP-TNLInformation(transport layer address:ip) ,sminfo[pdusessionid...],type: pdu_session_res_setup)

amf_net1 ---- DATAFRAME(N1N2MESSAGETRANSFERRSP) ---> smf1_com
## cause: N1_N2_TRANSFER_INITIATED

amf_net1 ---- INITIALCONTEXTSETUPREQUEST, PDUSESSIONESTABLISHMENTACCEPT ---> gnb01  ## for the first PDN, the message is InitialContextSetupReq, for the second PDN, 
                                                                                    ## the message will be PDUSessionResourceSetupRequest
###send the ipaddr of id-UL-NGU-UP-TNLInformation(transport layer address:ip) request gnb alloate teid of gtp tunnel


amf_net1 <--- INITIALCONTEXTSETUPRESPONSE ---- gnb01
## gnb told amf the gtp layer traport address(gtp-teid,uptransportlayerinfo) like enb-teid

amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s  POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
#### amf told smf the enb-teid

amf_net1 <--- DATAFRAME ---- smf1_s

** 5gPduModification
amf_net1 <--- UPLINKNASTRANSPORT(pdu_session_modification_req) ---- gnb01
give qos value which should be modified

amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
with qos value

amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
the SMF responds to the AMF through Nsmf_PDUSession_UpdateSMContext (N2 SM information (PDU Session ID, QFI(s), QoS Profile(s), Session-AMBR),
N1 SM container (PDU Session Modification Command (PDU Session ID, QoS rule(s), QoS rule operation, QoS Flow level QoS parameters  associated with the QoS rule(s), Session-AMBR, )). 


amf_net1 ---- PDUSESSIONRESOURCEMODIFYREQUEST (PDU Session Modification Command )---> gnb01   ### if gnb teid has been allocated, the message will be pduSessionResourceModifyReq
                                                                                              ### if not, the message will be InitialContextSetupReq
amf_net1 <--- PDUSESSIONRESOURCEMODIFYRESPONSE ---- gnb01                                     ## if no gnb teid has been allocated, it will be InitialContextSetupRsp 

amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify
AMF foward N2 SM information and the User location Information received from the AN to the SMF 
amf_net1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s


amf_net1 <--- UPLINKNASTRANSPORT(PDUSESSIONRESOURCEMODIFYCOMPLETE) ---- gnb01
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
The AMF forwards the N1 SM container (PDU Session Modification Command Ack) and User Location Information received from the AN to the SMF 
amf_net1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s


*** RAN initiated pdu modification  with multiple pdus
####RAN GNB trigger pdu session resource notify to AMF
amf_net1 <--- PDUSESSIONRESOURCENOTIFY ---- gnb01
NGAP::PDUSESSIONRESOURCENOTIFY { PDUSESSIONRESOURCENOTIFYLISTLIST {+PDUSESSIONRESOURCENOTIFYLISTLISTFLD {{PDUSESSIONID 1} {PDUSESSIONRESOURCENOTIFYTRANSFER $6007E803F8A0}}
{{PDUSESSIONID 2} {PDUSESSIONRESOURCENOTIFYTRANSFER $6007E803F8A0}}}}}}}} {NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} 

#### AMF modify pdu session resource with smf and gnb(pdu session modify command) with pdu sessionid 1
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s {PATH /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify} 
{N2SMINFO {{CONTENTID n2msg}}} {N2SMINFOTYPE PDU_RES_NTY}}
amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
{NAS::NGPDUSESSIONMODIFICATIONCOMMAND {{EPD $2E} {PDUSESSIONID 1} {PTI 3}}}} {N1SMMSG {{CONTENTID n1ContentId}}} {UPCNXSTATE ACTIVATED}}}}}}} 


NGAP::DOWNLINKNASTRANSPORT  {NAS::NGPDUSESSIONMODIFICATIONCOMMAND {{EPD $2E} {PDUSESSIONID $01} {PTI $03}}}} {PAYLOADCONTAINERTYPE $01} {PDUSESSIONID $01} {SECURITYHDRTYPE $0} 
{SPAREHALFOCTET $00}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $05} {XMAC $A5F4C327} 
amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
{NASPDU {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $00000000} {NASMSG {NAS::NGULNASTRANSPORT {{DNN $0477617031056E6F6B696103636F6D} {EPD $7E} {OLDPDUSESSIONID 0}
{PAYLOADCONTAINER {NAS::NGPDUSESSIONMODIFICATIONCOMPLETE {{EPD $2E} {PDUSESSIONID 1} {PTI 3}}}} {PAYLOADCONTAINERTYPE 1} {PDUSESSIONID 1} {SECURITYHDRTYPE 0} {SNSSAI $02D143A5} {SPAREHALFOCTET $00}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $000004} {_BEARERID $01} {_DIRECTION $00} {_ENCALG 0} {_INTALG 1} {_KNASENC $C346C87E77115C55A62022A7BAA3AF90} {_KNASINT $C81E08BFAFC23D416BB1B22916129C33} {_NASCOUNT $000004}}}}}}}} {{CRITICALITY 1} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}


amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s {PATH /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify} PDU session modification complete


#### AMF modify pdu session resource with smf and gnb(pdu session modify command) with pdu sessionid 2
amf_net1_1 ---- DATAFRAME ---> smf2_s {PATH /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_2/modify} 
{N2SMINFO {{CONTENTID n2msg}}} {N2SMINFOTYPE PDU_RES_NTY}}
amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
{NAS::NGPDUSESSIONMODIFICATIONCOMMAND {{EPD $2E} {PDUSESSIONID 1} {PTI 3}}}} {N1SMMSG {{CONTENTID n1ContentId}}} {UPCNXSTATE ACTIVATED}}}}}}} 

NGAP::DOWNLINKNASTRANSPORT  {NAS::NGPDUSESSIONMODIFICATIONCOMMAND {{EPD $2E} {PDUSESSIONID $02} {PTI $03}}}} {PAYLOADCONTAINERTYPE $01} {PDUSESSIONID $02} {SECURITYHDRTYPE $0} 
{SPAREHALFOCTET $00}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $05} {XMAC $A5F4C327} 
amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
{NASPDU {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $00000000} {NASMSG {NAS::NGULNASTRANSPORT {{DNN $0477617031056E6F6B696103636F6D} {EPD $7E} {OLDPDUSESSIONID 0}
{PAYLOADCONTAINER {NAS::NGPDUSESSIONMODIFICATIONCOMPLETE {{EPD $2E} {PDUSESSIONID 2} {PTI 3}}}} {PAYLOADCONTAINERTYPE 1} {PDUSESSIONID 2} {SECURITYHDRTYPE 0} {SNSSAI $02D143A5} {SPAREHALFOCTET $00}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $000004} {_BEARERID $01} {_DIRECTION $00} {_ENCALG 0} {_INTALG 1} {_KNASENC $C346C87E77115C55A62022A7BAA3AF90} {_KNASINT $C81E08BFAFC23D416BB1B22916129C33} {_NASCOUNT $000004}}}}}}}} {{CRITICALITY 1} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}






*** SMF initiated pdu session modification 
****  initiated pdu session modification for both N2 and N1
POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
N1 info(nas message type: 5GMM 
N2 info (SMInfo: pdusession-id, ngap Message: pdu_res_setup_req)

**** SMF initiated pdu session modification N2 only 
POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
N2 info (SMInfo: pdusession-id, ngap Message: pdu_res_modify_req)


ITE-12
    [Documentation]   SMF initiated PDU modification - ONLY N2
    [Tags]    tidnum_msc0548    regression    reg_priority
    [Setup]    Test Setup Modification
    IOTA Procedure    5gRegistrationSuci -for true
    IOTA Procedure    5gPduEstablishment -dnn wap1.nokia.com -sst 1 -sd D143A5 -psi 1 -pti 3
    IOTA Procedure    5gPduModification -smfinit true -postinitproc {::N2onlySMFReloc} -verbose 1
    IOTA Procedure    5gUeDeRegistration


**** SMF initiated pdu session modification N1 only 
POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages
N1 info(nas message type: 5GMM ,smf_relocation_indication:true)   ### the smf initiated a smf relocation, with only N1 
AMF trigger the pdu modification command procedure for N1 only.
AMF establish a new pdu session with reallocated SMF.
AMF release the pdu session with  SMF

ITE-10    (IOTA case)
    [Documentation]   SMF initiated PDU modification - ONLY N1 with smfreloc - Local Provisioning
    [Tags]    tidnum_msc0546    regression    reg_priority
    [Setup]    Test Setup Modification ITE10
    IOTA Procedure    5gRegistrationSuci -for true
    IOTA Procedure    5gPduEstablishment -dnn wap1.nokia.com -sst 1 -sd D143A5 -psi 1 -pti 3 -postinitproc {set ::c_ue(ngpdusessionestbreq_sscmode) 3 }
    #set ::CSM::TRIGGER(PRE_NRF_DISC_DATA) { set ::c_ue(nrf_nfservice_ipv4_2) $::IOTACFG(SMF2_V4) set ::c_ue(nrf_amfservice_nfInstance_ipv4_1) $::IOTACFG(SMF2_V4)} }
    IOTA Procedure    5gPduModification -smfinit true -postinitproc {::N1onlySMFReloc -smfrealloc true} -verbose 1
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gPduEstablishment -dnn wap1.nokia.com -sst 1 -sd D143A5 -psi 2 -pti 4 -opsi 1 -postinitproc {set ::c_ue(ngpdusessionestbreq_sscmode) 3}
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gSmfInitPduRelease -psi 1 -postinitproc {set ::CSM::TRIGGER(PRE_PDUSESSIONRELEASECMP_TGT_AMF_TRIGGER) { set ::c_ue(ngulnastransport_pdusessionid) 1} }
    IOTA Procedure    5gSmfInitPduRelease -psi 2 -postinitproc {set ::CSM::TRIGGER(PRE_PDUSESSIONRELEASECMP_TGT_AMF_TRIGGER) { set ::c_ue(ngulnastransport_pdusessionid) 2} }
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gUeDeRegistration
    [Teardown]    Test Teardown Modification ITE10
** 5gPduRelease
amf_net1 <--- UPLINKNASTRANSPORT(pdusession_release_req) ---- gnb01
amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ[Nas:pdusession_release_req]) ---> smf1_s

amf_net1 <--- DATAFRAME(UPDATESMCONTEXTRSP[NAS: pdusession_release_command]) ---- smf1_s

amf_net1 ---- PDUSESSIONRESOURCERELEASECOMMAND ---> gnb01


amf_net1 <---- UPLINKNASTRANSPORT(pdusession_release_complete) ----- gnb01(NAS)

amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
: POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify, DATA[9] (application/json), PDU session release complete

amf_net1 <--- PDUSESSIONRESOURCERELEASERESPONSE ---- gnb01  (no NAS)

amf_net1 <--- DATAFRAME(SMSTATUSCONTEXTNOTIFY) ---- smf1_nfy
 POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301100002/ntfyId-1/status-ntf, DATA[1] (application/json)

** Handover Procedure
    N2-based intra-AMF and inter-AMF handover (Feature f20054-02)
*** intra AMF handover  
5gN2Ho -gNB gnb01 -tac ${IOTA.AMF_TAC0} 
iota case:mbh1092

Source GNB                           AMF                            Target GNB                                SMF
|                                    |                                    |                                    |                                                        
|----------------------------------->|                                    |                                    |                     
|HandoverRequired                    |                                    |                                    |                     
|                                    | /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify           |                     
|                                    |------------------------------------------------------------------------>|                                   | 
|                                    |  UPDATESMCONTEXTREQ {N2SMINFOType HANDOVER_REQUIRED, UElocation}
|                                    |                                    |                                    |                                                        
|                                    |<------------------------------------------------------------------------|             UPF    allocate UL tunl|
|                                    |  UPDATESMCONTEXTRSP {N2SMINFOType PDU_RES_SETUP_REQ}
                                     (the N3 UPF addr ,N3 UL CN tunnel-id of UPF and the QoS parameters)
|                                    |                                    |                                    |                                                        
|                                    |----------------------------------->|                                    |                     
|                                    | Handover Request {N2 SM info(UL tid of UPF), N2 MM info)                |                                                         
|                                    |<-----------------------------------|                                    |               
|                                    |HandoverRequestAck{N2SMinfo(tgnb-addr,UL-tunnelid of RAN)}               |              
|                                    |                                    |GNB allocat UL tunl                 |                                                        
|                                    |                                    |                                    |                                                        
|                                    |                                    |                                    |                                                        
|                                    |------------------------------------------------------------------------>|restore tgnb-addr, allocate upf addr                     
|                                    | UPDATESMCONTEXTREQ(N2SMinfo of HRA)                                     |   
|                                    |                                    |                                    |                                                        
|                                    |                                    |                                    |                                                        
                                     | <-----------------------------------------------------------------------| UPF allocat DL tunl
|                                    | UPDATESMCONTEXTRSP {N2SMINFO HANDOVER_CMD}(upf addr/DL-tunnelid)        |   
| <--------------------------------  |                                                                         |   
| Handover command(HO_CMD,upfaddr/DL-tunelid)                                                                  |
|                                    |                                    |                                    |                                                        
|original S-GNB tunelid              |                                    |                                    |                                   UPF                     
|<-----------------------------------------------------------------DL------------------------------------------|----------------------------------- |origninal tunnel to S-GNB
|-----------------------------------------------------------------DL------------------------------------------ |----------------------------------->|indirect forwarding tunnel,upf/dl-tun)
|orignial S-GNB tunelid              |                                    |<---------------DL------------------|----------------------------------- |newly establied tunnel, upf/ul-tnl                                    
|                                    |                                    |Tgnb/UL-tnl                          |                                    |                    
|
|original S-GNB tunelid
|-----------------------------------------------------------------UL------------------------------------------|-----------------------------------> |origninal tunnel to UPF(ori tnlid)

|                                    |                                    |                                    |                                    |                    
                     UE synchronize to new cell, send Handover confirmed to TGNB                                                                    |            
                  the DL data from UPF through indirect fowording tunnel to TGNB will send to UE                                                    | 
|                                    |                                    |                                    |                                    |                    
|                                    |                                    |                                    |                                    |                    
|                                    |                                    |-----------------------------UL----------------------------------------->|                                                        
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverNotify{handover successfully}                                    |                                    |
|                                    |                                    |                                    |                                    |                    
|                                    |------------------------------------------------------------------------>|told UPF delete forwarding tunnel   |
|                                    |   UPDATESMCONTEXTREQ{HOSTATE COMPLETED}                                 |                                    |
|                                    |                                    |<-----------------------------DL----------------------------------------|                                                        
|                                    |<------------------------------------------------------------------------|                     
|                                    |  UPDATESMCONTEXTRSP { HOSTATE COMPLETED} 
|<-----------------------------------|                                    |                                    |                     
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                     
|----------------------------------->|                                    |                                    |                     
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                     


in whole process, UPF newly allocated two tunlid, one is a forwarding tunlid, one is a normal tunlid for later use,
                  Target GNB allocate one tnlid, a normal tunlid for later use
                  Source GNB not allocat any tnlid, it will use the orignial one
why use idft(indirect forwarding tunnel), since if S-GNB and T-GNB could communicate directy, in this setp , upf send DL data to sourceGNB, sGNB forward it to tGNB,
but if they can't communicate, UPF need to reforwarding it for them.

source gnb: gnb01
target gnb: gnb04,
when gnb01 get the measurement report that gnb04's cell had better connection than gnb01, gnb01 will triger
the HANDOVERREQUIRED(targegnb...) to AMF
amf_net1 <--- HANDOVERREQUIRED ---- gnb01
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
###this response will provide the pdu session needed resource, pdu sessionid, qosflow... to target enb to allocate teid
###the transport layer address and tunnel endpoint of the uplink termination point for the user plane data for this PDU session 
### this will make two gnb transfer data feasible, not necessarily through smfteid(normal)-->sgnb--->smf_dl_teid-->tgnb

amf_net1 ---- HANDOVERREQUEST ---> gnb04
##Handover Request (Source to Target transparent container, N2 MM Information, N2 SM Information list, Tracing Requirements).
{VALUE {SOURCETOTARGETTRANSPARENTCONTAINEROBJ {{SOURCETOTARGETTRANSPARENTCONTAINER $0265}}}}

amf_net1 <--- HANDOVERREQUESTACKNOWLEDGE ---- gnb04
##Handover Request Acknowledge(Target to Source transparent container, List of PDU Sessions to Hand-over with N2 SM information, List of PDU Sessions that failed to be established with the failure cause given in the N2 SM information element).
## N3 UP address and Tunnel ID of T-RAN for the PDU Session

amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
### Nsmf_PDUSession_UpdateSMContext Request (PDU Session ID, N2 SM response received from T-RAN in handover request ack).
### SMF stores the N3 tunnel info of T-RAN from the N2 SM response 
### The SMF/UPF allocates the N3 UP address and Tunnel IDs for indirect data forwarding corresponding to the data forwarding tunnel endpoints established by T-RAN.

amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
##this will tell the gnb04 teid to smf
##(N2 information necessary for AMF to send Handover Command to S-RAN including Target to Source transparent container, PDU Sessions failed to be setup list, 
N2 SM information (N3 DL forwarding Information, PCF ID)


amf_net1 ---- HANDOVERCOMMAND ---> gnb01
###Handover Command (Target to Source transparent container, List Of PDU Sessions to be handed-over with N2 SM information containing information received from T-RAN during the handover preparation phase, List Of PDU Sessions failed to be setup).
##	Target to Source transparent container is forwarded as received from AMF.
## 	The SM forwarding info list includes T-RAN SM N3 forwarding info list for direct forwarding or S-UPF SM N3 forwarding info list for indirect data forwarding

amf_net1 <--- HANDOVERNOTIFY ---- gnb04
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
amf_net1_1 <--- DATAFRAME(UPDATESMCONTEXTRSP) ---- smf1_s
###confirmation of handover

amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01

*** optional RAN  Status transfer in handover Procedure
source GNB sends this after receiving Handover Cmd if the sublayer of user plane is PDCP


Source GNB                          SRC-AMF                            Target AMF                             Target-GNB
|                                   |                                    |                                    |                             
|<----------------------------------|
|HandoverCommand                    |                                    |                                    |         
|---------------------------------->|
|UPLink RANSTATUS trans             |                                    |                                    |         
|                                   |                                    |                                    |                             
|                                 POST /namf-comm/v1/ue-contexts/imsi-460020301001001/n1-n2-messages          |
|                                   |----------------------------------->|                                    |
|                                         n1n2MessageTransfer                                                 |
|                                   |<---------------------------------->|                                    |
|                                                                        |----------------------------------->|
|                                                                        |DownLink RANSTATUS trans            |
|                                     




*** inter AMF handover
Source GNB                          TGT-AMF                            Target GNB                                SMF                             SRC-AMF
|                                    |                                    |                                    |                                   |                     
|------------------------------------------------------------------------------------------------------------------------------------------------->|
|HandoverRequired                    |                                    |                                    |                                   | 
|                                    |      /namf-comm/v1/ue-contexts/imsi-460020301001001                     |                                   |                     
|                                    |<----------------------------------CREATEUECONTEXTREQ(N2info,UeContextinfo)----------------------------------|
|                                    |                                    |                                    |                                   |                     
|                                    |                                    |                                    |                                   |                     
|                                    | /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify           |                                   |
|                                    |------------------------------------------------------------------------>|                                   |
|                                    |  UPDATESMCONTEXTREQ {N2SMINFOType HANDOVER_REQUIRED, UElocation}                                            |
|                                    |                                    |                                    |                                   |                     
|                                    |<------------------------------------------------------------------------|                                   |
|                                    |  UPDATESMCONTEXTRSP {N2SMINFOType PDU_RES_SETUP_REQ}                    |                                   |  
                                     (the N3 UPF addr ,N3 tunnel-id and the QoS parameters)                    |                                   |
|                                    |                                    |                                    |                                   |                     
|                                    |----------------------------------->|                                    |                                   |
|                                    | Handover Request {N2 SMinfo[UPF tunid], N2 MM info)                     |                                   |                     
|                                    |<-----------------------------------|                                    |                                   |
|                                    |HandoverRequestAck{N2SMinfo(tgnb-addr,tunnelid)}                         |                                   | 
|                                    |                                    |                                    |                                   |                    
|                                    |------------------------------------------------------------------------>|restore tgnb-addr, allocate upfaddr|                     
|                                    | UPDATESMCONTEXTREQ(N2SMinfo of HRA)|                                                                        |
|                                    |                                    |                                    |                                   |                     
|                                    |<------------------------------------------------------------------------|                                   |
|                                    |  UPDATESMCONTEXTRSP {N2SMINFO HANDOVER_CMD}(upf indirect tunnel addr/tunnelid)                              |                   
|                                    |                                    |                                    |                                   |                     
|                                    |-----------------------------------CREATEUECONTEXTRSP(N2info[for later HO_CMD],n2SMInfo[upfaddr/tunnelid]--->|
|<-------------------------------------------------------------------------------------------------------------------------------------------------|                     
|Handover command(HO_CMD,upfaddr/tunelid)                                 |                                    |                                   |
|                                    |                                    |                                    |                                   |                    
                                                          UE synchronize to new cell, send Handover confirmed to TGNB                              |            
|                                    |                                    |                                    |                                   |                    
|                                    |<-----------------------------------|                                    |                                   |
|                                    |HandoverNotify{handover successfully}                                    |                                   |
|                                    |                                    |                                    |                                   |                    
|                                    |                                    |                                    |                                   |                     
|                                    |            /namf-ntfy-amf/v1/imsi-460020301001001/n2InfoNtfy            |                                   |                     
|                                    |-----------------------------------N2InfoNotify------------------------------------------------------------->|
|                                    |                                    |                                    |                                   |                     
|                                    |<-----------------------------------N2InfoNotify_Ack---------------------------------------------------------|
|                                    |                                    |                                    |                                   |                     
|                                    |------------------------------------------------------------------------>|                                   |
|                                    |   UPDATESMCONTEXTREQ{HOSTATE COMPLETED}                                 |                                   |
|                                    |<------------------------------------------------------------------------|                     
|                                    |  UPDATESMCONTEXTRSP {HOSTATE COMPLETED} 
|                              Registration Procedure(mobility registration with foreign guti/tmsi)                                |                     
|<-----------------------------------|                                    |                                    |                     
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                     
|----------------------------------->|                                    |                                    |                     
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                     

 
**** Handover Registration
when src AMF received N2InfoNotify_Ack, it may trigger PDU release procedure
The UE initiates Mobility Registration Update procedure with guti allocated by src AMF 
The target AMF knows that it is a Handover procedure and therefore the target AMF performs only a subset of the Registration procedure, 


**** 5gN2HoToExternalAMF
amf_net1 <--- HANDOVERREQUIRED ---- gnb01
amf_net1 ---- HEADERSFRAME ---> nrf1_s
amf_net1 <--- HEADERSFRAME ---- nrf1_s
amf_net1 <--- DATAFRAME(NFDISCOVERRSP) ---- nrf1_s
amfsim2_s <<--- MAGICFRAME ---- amf_net1_1
amfsim2_s <<--- SETTINGSFRAME ---- amf_net1_1
amfsim2_s <<--- MAGICFRAME ---- amf_net1
amfsim2_s <<--- SETTINGSFRAME ---- amf_net1
amfsim2_s <<--- SETTINGSFRAME ---- amf_net1_1
amfsim2_s <<--- SETTINGSFRAME ---- amf_net1
amf_net1 ---- HEADERSFRAME ---> amfsim2_s
amf_net1 ---- DATAFRAME(CREATEUECONTEXTREQ) ---> amfsim2_s
amf_net1 <--- HEADERSFRAME ---- amfsim2_s
amf_net1 <--- DATAFRAME(CREATEUECONTEXTRSP) ---- amfsim2_s
amf_net1 ---- HANDOVERCOMMAND ---> gnb01
amf_net1 <--- HEADERSFRAME ---- amfnfy1_c
amf_net1 <--- DATAFRAME(N2INFONOTIFYREQ) ---- amfnfy1_c
amf_net1 ---- HEADERSFRAME ---> amfnfy1_c
amf_net1 ---- UECONTEXTRELEASECOMMAND ---> gnb01
amf_net1 <--- UECONTEXTRELEASECOMPLETE ---- gnb01

*** IOTA proceudre for handover pingpong scenario
mbh1095 interAMF N2 Handover without PDCP, Ping Pong scenario, 2 PDUs
   IOTA Procedure      5gRegistrationSuci -for true
    IOTA Procedure      5gPduEstablishment -dnn wap1.nokia.com -sd "D143A5" -sst "1" -psi 1
    IOTA Procedure      5gPduEstablishment -dnn wap2.nokia.com -sd "D143A5" -sst "1" -psi 2
    IOTA Procedure      5gN2HoToExternalAMF -amf_discovery true
   IOTA Procedure      5gUdmDeRegistration -deregist_reason registration_area_change -page false
    IOTA Procedure      5gN2Ho -gNB gnb01 -tac ${IOTA.AMF_TAC0} -inter_amf_ho true -kamf ${Kamf} -status_transfer true
    IOTA Procedure      5gN2HoRegistration -gNB gnb01 -tac ${IOTA.AMF_TAC0} -pdustatus 0x0600 -pcfsim_s pcf2_s -for true
    IOTA Procedure      5gUeDeRegistration   ####default deregist_reason is withdrawn
    IOTA Procedure      5gUdmDeRegistration


** N26 handover procedure (AMF<---->GNB)
*** iota procedure flow handover (AMF---->MME)
**** handover procedure in iota
case mim0849  mim0847
PreCondition:
 IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind; ...   set ::c_ue(ngregstreq_mmcapability) \\$01; set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}  set ::c_ue(ngregstreq_uestatus) \\$03}
 IOTA Procedure    5gPduEstablishment -postinitproc {5gEbiAssigmentWithPDUEstablisment_SMF; smf_parameterInitialize}
-----------------------------------------------------
 IOTA Procedure    5gHoToExternalMME -indirfwd false -postinitproc {Handover5GToEPSENBMacro;
 IOTA Procedure    5gUdmDeRegistration -deregist_reason 5g_to_eps_mobility -page false -pcf true
 
**** 5gHoToExternalMME: 
Source GNB                          MME                            eutran-RAn(ENB)                                SMF               AMF
|                                    |                                    |                                    |                    |                     
|----------------------------------------------------------------------------------------------------------------------------------->|
|HandoverRequired                    |                                    |                                    |                     | 
|                                    |                                    |                                    |                     |                     
|                                    |                                    |                                    |                     |                     
|                                    | /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/retrieve         |                     |
|                                    |------------------------------------------------------------------------>|                     |
|                                    |<------------------------------------------------------------------------|                     |
                                      all sm reltaed info                  |                                   |
|                                    |                                    |                                    |                     |                     
|                                    |<----------------------------------------------------------------------------------------------|
|                                                                                         Foward relocation request         
|                                    |                                    |                                    |                     |                    
|                                    |---------------------------------------------------------------------------------------------->|
|                                                                                         Foward relocation rsp         
|                                    |                                    |                                    |                     |                     
|                                    |                                    |                                    |                     |                     
|<-----------------------------------------------------------------------------------------------------------------------------------|                     
|Handover command(HO_CMD,upfaddr/tunelid)                                 |                                    |                     |
|                                    |                                    |                                    |                     |                    
                                                          UE synchronize to new cell, send Handover confirmed to TGNB                |            
|                                    |                                    |                                    |                     |                    
|                                    |<-----------------------------------|                                    |                     |
|                                    |HandoverNotify{handover successfully}                                    |                     |
|                                    |                                    |                                    |                     |                    
|                                    |                                    |                                    |                     |                     
|                                    |            Forward Relocation complete  Ntfy                                 
|                                    |-----------------------------------N2InfoNotify----------------------------------------------->|
|                                    |                                    |                                    |                     |                     
|                                    |<-----------------------------------N2InfoNotify_Ack-------------------------------------------|
|                                    |                                    |                                   |
|                                    |   pdu session release SM-context   |                                    |                     |                     
|                                    |------------------------------------------------------------------------>|                     |
|                                    |<------------------------------------------------------------------------|        
|                                    |                                    |                                    |                     |                    
|                                    |                                    |                                    |                     |                    
|<-----------------------------------|                                    |                                    |        
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |        
|----------------------------------->|                                    |                                    |        
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |        
5gUdmDeRegistration  -deregistr_reason 5g_to_eps_mobility  : DELETE /nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/delete


*** iota procedure flow handover (AMF<----MME)
**** iota procedure trigger
    IOTA Procedure    ForwardRelocationRequestFromExtMME -postinitproc {smf_parameterInitialize3; InitSelectSmfbasedOnNssaiDnnN26;
    IOTA Procedure    5gRegistrationMobilityFromExtMME -gNB gnb01 -tac ${IOTA.AMF_TAC1} -subscription_retrival mandatory -pcf true
POST condition:
    IOTA Procedure    5gUeDeRegistration -pcf true -postinitproc 5gReleaseSmContextReq_Deregistration_4G5GHO_1PDU_N26
    IOTA Procedure    5gUdmDeRegistration

**** ForwardRelocationRequestFromExtMME
Source ENB                          TGT-AMF                            Target GNB                                SMF                             SRC-MME
|                                    |                                    |                                    |                                   |                     
|------------------------------------------------------------------------------------------------------------------------------------------------->|
|HandoverRequired                    |                                    |                                    |                                   | 
|                                    |<----------------------------------Forward Relocation Request------------------------------------------------|
|                                    |                                    |                                    |                                   |                     
|                                    |                                    |                                    |                                   |                     
|                                    |  POST /nsmf-pdusession/v1/sm-contexts                                   |                                   |
|                                    |------------------------------------------------------------------------>|                                   |
|                                    |  create_SMCONTEXTREQ {N2SMINFOType HANDOVER_REQUIRED, UElocation}                                            |
|                                    |                                    |                                    |                                   |                     
|                                    |<------------------------------------------------------------------------|                                   |
|                                    |  create_SMCONTEXTRSP {N2SMINFOType PDU_RES_SETUP_REQ}                    |                                   |  
                                     (the N3 UPF addr ,N3 tunnel-id and the QoS parameters)                    |                                   |
|                                    |                                    |                                    |                                   |                     
|                                    |----------------------------------->|                                    |                                   |
|                                    | Handover Request {N2 SMinfo[UPF tunid], N2 MM info)                     |                                   |                     
|                                    |<-----------------------------------|                                    |                                   |
|                                    |HandoverRequestAck{N2SMinfo(tgnb-addr,tunnelid)}                         |                                   | 
|                                    |                                    |                                    |                                   |                    

|                                    | /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify           |                                   |
|                                    |------------------------------------------------------------------------>|restore tgnb-addr, allocate upfaddr|                     
|                                    | UPDATESMCONTEXTREQ(N2SMinfo of HRA)|                                                                        |
|                                    |                                    |                                    |                                   |                     
|                                    |<------------------------------------------------------------------------|                                   |
|                                    |  UPDATESMCONTEXTRSP {N2SMINFO HANDOVER_CMD}(upf indirect tunnel addr/tunnelid)                              |                   
|                                    |                                    |                                    |                                   |                     
|                                    |---------------------------------Forward Relocation Response[for later HO_CMD],n2SMInfo[upfaddr/tunnelid]-->|
|                                    |                                    |                                    |                                   |                    
|<-------------------------------------------------------------------------------------------------------------------------------------------------|                     
|Handover command(HO_CMD,upfaddr/tunelid)                                 |                                    |                                   |
|                                    |                                    |                                    |                                   |                    
                                                          UE synchronize to new cell, send Handover confirmed to TGNB                              |            
|                                    |                                    |                                    |                                   |                    
|                                    |<-----------------------------------|                                    |                                   |
|                                    |HandoverNotify{handover successfully}                                    |                                   |
|                                    |                                    |                                    |                                   |                    
|                                    |                                    |                                    |                                   |                     
|                                   |                                    |                                    |                                   |                     
|                                    |------------------------------------------------------------------------>|                                   |
|                                    |   Forward Relocation COMPLETED Notify                                 |                                   |
|                                    |<------------------------------------------------------------------------|                     
|                                    |   Forward Relocation COMPLETED Ack 
|                                    |                                    |                                    |                                   |                    
|                                    | /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify(Completed)          |                                   |
|                                    |------------------------------------------------------------------------>|                     
|                                   |                                    |                                    |                                   |                     
|                              Registration Procedure(mobility registration with foreign guti/tmsi)                                |                     


*** iota case mim0646
scenario:  5GS to EPS HO, EPS->5GS HO

 IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind; ...   set ::c_ue(ngregstreq_mmcapability) \\$01; set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}  set ::c_ue(ngregstreq_uestatus) \\$03}
    IOTA Procedure    5gPduEstablishment -postinitproc {5gEbiAssigmentWithPDUEstablisment_SMF; smf_parameterInitialize}
    IOTA Procedure    5gHoToExternalMME -indirfwd false -postinitproc {Handover5GToEPSENBMacro;
    #TODO: parmetrisoi Handover5GToEPSENBMacro PLMNIDENTITY
    IOTA Procedure    5gUdmDeRegistration -deregist_reason 5g_to_eps_mobility -page false -pcf true
    IOTA Procedure    ForwardRelocationRequestFromExtMME -postinitproc {smf_parameterInitialize3; InitSelectSmfbasedOnNssaiDnnN26;
    ...               set ::c_ue(tgt_ngtac) \\$007530;
    ...               set ::c_ue(n11createsmcontextrsp_epsbearid1) \\"5";
    ...               set ::c_ue(n11createsmcontextrsp_arppri1) \\"1";
    ...               set ::c_ue(n11createsmcontextrsp_arpprecap1) \\"NOT_PREEMPT";
    ...               set ::c_ue(n11createsmcontextrsp_arpprevul1) \\"NOT_PREEMPTABLE"}
    # TODO: check from subscriber show n11createsmcontextrsp values above, new postinitproc including above n11createsmcontextrsp values
    IOTA Procedure    5gRegistrationMobilityFromExtMME -gNB gnb01 -tac ${IOTA.AMF_TAC1} -subscription_retrival mandatory -pcf true
    ...               -config_update true
    ...               -postinitproc {set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020;
    ...               set ::c_ue(ngregstreq_uestatus) \\$03;
    ...               set ::c_ue(ngregstreq_mmcapability) \\$01;
    ...               set ::c_ue(ngregstreq_uesecuritycapability) \\$80808080;
    ...               set ::c_ue(tgt_ngtac) \\$007530;
    ...               set ::c_ue(snd_ngregistrationreq) "basic_snd_ulnas_ngregistrationreq_guti_n26_tgt_amf";
    ...               UpdateSMContext4G5GHO}
    # TODO: new postinitproc including above values
    sleep    5
    Interrogate Eps Subscriber Data    ${IOTA['IMSI1']}
    IOTA Procedure    5gUeDeRegistration -pcf true -postinitproc 5gReleaseSmContextReq_Deregistration_4G5GHO_1PDU_N26
    IOTA Procedure    5gUdmDeRegistration


** N26 TAU procedure
*** iota case mim0644
mim0644 Verify Call Trace with IMSI in 5GS to EPS Idle Mobility TAU, EPS to 5GS Idle Mobility Registration
    IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind;
    IOTA Procedure    5gPduEstablishment -postinitproc {5gEbiAssigmentWithPDUEstablisment_SMF; smf_parameterInitialize}
    IOTA Procedure    5gNgRelease
    IOTA Procedure    contextReqFromExtMmeToAMF
    IOTA Procedure    5gUdmDeRegistration -deregist_reason 5g_to_eps_mobility -page false -pcf true
    IOTA Procedure    5gRegistrationMobilityFromExtMME -uectxreq requested -uldatapendingpsi 1 -subscription_retrival mandatory -pcf true -config_update true
    IOTA Procedure    5gUeInitPduRelease
    IOTA Procedure    5gUeDeRegistration -pcf true
    IOTA Procedure    5gUdmDeRegistration

*** TAU (5G-->4G)
    IOTA Procedure    contextReqFromExtMmeToAMF
    IOTA Procedure    5gUdmDeRegistration -deregist_reason 5g_to_eps_mobility -page false -pcf true


*** TAU(4G--->5G)
    IOTA Procedure    5gRegistrationMobilityFromExtMME -uectxreq requested -uldatapendingpsi 1 -subscription_retrival mandatory -pcf true -config_update true
    IOTA Procedure    5gUeInitPduRelease
    IOTA Procedure    5gUeDeRegistration -pcf true
    IOTA Procedure    5gUdmDeRegistration

**** 5gRegistrationMobilityFromExtMME

amf_net1 <--- INITIALUEMESSAGE(NGREGISTRATIONREQUEST) ---- gnb01
mme_net1 ---- CONTEXTREQ ---> mmen26sim1
mme_net1 <--- CONTEXTRSP ---- mmen26sim1
amf_net1_1 ---- DATAFRAME(UEAUTHENTICATIONSREQ) ---> ausf2_s
amf_net1_1 <--- DATAFRAME(UEAUTHENTICATIONSRSP) ---- ausf2_s
mme_net1 ---- CONTEXTACK ---> mmen26sim1
amf_net1 ---- DOWNLINKNASTRANSPORT(AUTHREQ) ---> gnb01
amf_net1 <--- UPLINKNASTRANSPORT(NGAUTHRSP) ---- gnb01
amf_net1_1 ---- HEADERSFRAME ---> ausf2_s
amf_net1_1 ---- DATAFRAME(AKACONFIRMATIONREQ) ---> ausf2_s
amf_net1_1 <--- HEADERSFRAME ---- ausf2_s
amf_net1_1 <--- DATAFRAME(AKACONFIRMATIONRSP) ---- ausf2_s
amf_net1 ---- DOWNLINKNASTRANSPORT(SM command) ---> gnb01
amf_net1 <--- UPLINKNASTRANSPORT(SM complete) ---- gnb01
amf_net1_1 ---- DATAFRAME(UECMREGISTRATIONREQ) ---> udm2_s
amf_net1_1 <--- DATAFRAME(UECMREGISTRATIONRSP) ---- udm2_s
amf_net1_1 <--- DATAFRAME(SUPIMULTIPLEDATASETSRSP) ---- udm2_s
amf_net1_1 ---- DATAFRAME(SDMSUBSCRIBEREQ) ---> udm2_s
amf_net1_1 <--- DATAFRAME(SDMSUBSCRIBERSP) ---- udm2_s
amf_net1_1 ---- DATAFRAME(POLICYASSOCIATIONREQ) ---> pcf2_s
amf_net1_1 <--- DATAFRAME(POLICYASSOCIATIONRSP) ---- pcf2_s
amf_net1_1 <--- DATAFRAME(NFDISCOVERRSP) ---- nrf1_s
amf_net1_1 ---- DATAFRAME(CREATESMCONTEXTREQ) ---> smf1_s   ### create the pdu request
amf_net1_1 <--- DATAFRAME(CREATESMCONTEXTRSP) ---- smf1_s
amf_net1 ---- PDUSESSIONRESOURCESETUPREQUEST ---> gnb01   ### gtp tunnel info exchaged within these two messages
amf_net1 <--- PDUSESSIONRESOURCESETUPRESPONSE ---- gnb01
amf_net1_1 ---- HEADERSFRAME ---> smf1_s                   ### transfer GNB tunnel info to smf
amf_net1_1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s  
amf_net1_1 <--- HEADERSFRAME ---- smf1_s
amf_net1 ---- INITIALCONTEXTSETUPREQUEST(registration accept) ---> gnb01
amf_net1 <--- INITIALCONTEXTSETUPRESPONSE ---- gnb01
amf_net1 <--- UPLINKNASTRANSPORT(registration complete) ---- gnb01
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01



** AMF relocation procedure
*** amf_net1 is the src and external AMF request amf_net1 to transfer uecontext to it 
    IOTA Procedure    5gInitUeContextTransferReqFromExtAMF
    Cmm Command       cmm subscriber show --imsi 460020301001001
    IOTA Procedure    5gUdmDeRegistration -deregist_reason registration_area_change -page false
-----------------------------------------------------------------    
amf_net1 is the src AMF, amfsim1_c is the tgt AMF.

amf_net1 <--- HEADERSFRAME ---- amfsim1_c  POST /namf-comm/v1/ue-contexts/5g-guti-46002010041C1400032/transfer
amf_net1 <--- DATAFRAME(UECONTEXTTRANSFERREQDATA) ---- amfsim1_c   RegistrationRequest intial_registration,  mobility id: guti which allocated by amf_net1 before

amf_net1 ---- HEADERSFRAME ---> amfsim1_c   OK
amf_net1 ---- DATAFRAME(UECONTEXTTRANSFERRSPDATA) ---> amfsim1_c
UeContext: supi, gpsiList, pei, subRfsp, suedRfsp, subUeAmbr, smsSupport,seafData, pcfId, pcfAmPolicyUri, List... , mmContextList, sessionContextList
{ "ueContext": { "supi": "imsi-460020301001001", "gpsiList": [  "msisdn-3587003600201" ], "pei": "imeisv-9876543219876510", "subRfsp": 30, "usedRfsp": 30, "subUeAmbr": { "uplink": "125 Mbps", "downlink": "125 Mbps" } , "smsSupport": "NONE", "seafData": { "ngKsi": { "tsc": "NATIVE", "ksi": 0 } , "keyAmf": { "keyType": "KAMF", "keyVal": "4f7a12c1afd262222c7179eb97c76a2dfb8700d88fc5d1b1297801f812ab1e85" } , "nh": "4a6502418279a19b9b93d779aead4210ba2c7e4a3822771f55b94a7c6dc64239", "ncc": 1 } , "pcfId": "c18985be-8028-4bf0-858a-9391c63b67b2", "pcfAmPolicyUri": "http://172.16.59.58:8080/npcf-am-policy-control/v1/policies/PolAssoId22", "restrictedRatList": [  "EUTRA" ], "forbiddenAreaList": [ { "tacs": [  "008888",  "009999" ] } , { "tacs": [  "006666",  "007777" ] }  ], "serviceAreaRestriction": { "restrictionType": "NOT_ALLOWED_AREAS", "areas": [ { "tacs": [  "123456",  "234567" ] }  ], "maxNumOfTAs": 2 } , "restrictedCoreNwTypeList": [  "EPC" ], "mmContextList": [ { "accessType": "3GPP_ACCESS", "nasSecurityMode": { "integrityAlgorithm": "NIA1", "cipheringAlgorithm": "NEA0" } , "nasDownlinkCount": 5, "nasUplinkCount": 4, "ueSecurityCapability": "gECAgA==", "allowedNssai": [ { "sst": 1, "sd": "d143a5" } , { "sst": 2, "sd": "d143a5" } , { "sst": 3, "sd": "d143a5" }  ] }  ], "sessionContextList": [ { "pduSessionId": 1, "smContextRef": "http://172.16.59.61:8080/nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1", "sNssai": { "sst": 1, "sd": "d143a5" } , "dnn": "wap1.nokia.com", "accessType": "3GPP_ACCESS", "allocatedEbiList": [ { "epsBearerId": 1, "arp": { "priorityLevel": 15, "preemptCap": "NOT_PREEMPT", "preemptVuln": "NOT_PREEMPTABLE" }  }  ], "hsmfId": "20e0b0c3-82e1-44a4-82ab-a065d80a3b93" } , { "pduSessionId": 2, "smContextRef": "http://172.16.59.61:8080/nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_2", "sNssai": { "sst": 1, "sd": "d143a5" } , "dnn": "wap2.nokia.com", "accessType": "3GPP_ACCESS", "allocatedEbiList": [ { "epsBearerId": 1, "arp": { "priorityLevel": 15, "preemptCap": "NOT_PREEMPT", "preemptVuln": "NOT_PREEMPTABLE" }  }  ], "hsmfId": "20e0b0c3-82e1-44a4-82ab-a065d80a3b93" }  ] }  } 


amf_net1 <--- HEADERSFRAME ---- amfsim1_c  POST /namf-comm/v1/ue-contexts/5g-guti-46002F010041C1400032/transfer-update
amf_net1 <--- DATAFRAME(UEREGSTATUSUPDATEREQDATA) ---- amfsim1_c  {transferStatus:TRANSFERED}
amf_net1 ---- HEADERSFRAME ---> amfsim1_c
amf_net1 ---- DATAFRAME(UEREGSTATUSUPDATERSPDATA) ---> amfsim1_c  {"regStatusTransferComplete":true}
--------------------------------------------------------------------------
after this, Udm will send DELETE /nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/delete [degregist_reson:registration_area_change] to src AMF to delete imsi from its database


*** amf_net1 received forgein guti (allocated by external AMF)  registration request(mobility update)
    IOTA Procedure    5gRegistrationGutiFromExtAMF
        ...             -postinitproc {vfy_IE_ConfigUpdate -fullnwname \\$8DCEE7321904 -shortnwname
        ...                 \\$8BCEE712 -localtimezone \\$4A -universalandlocaltimezone true -nwdaylightsavingtime true}
------------------------------------------------------
amf_net1 <--- INITIALUEMESSAGE(RegistrationRequest[foreign guti]) ---- gnb01   moblity_registration_update

amf_net1 ---- HEADERSFRAME ---> nrf1_s
amf_net1 <--- HEADERSFRAME ---- nrf1_s
amf_net1 <--- DATAFRAME(NFDISCOVERRSP) ---- nrf1_s
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
amf_net1 ---- HEADERSFRAME ---> amfsim1_s                     POST /namf-comm/v1/ue-contexts/5g-guti-46002010041C1400032/transfer
amf_net1 ---- DATAFRAME(UECONTEXTTRANSFERREQDATA) ---> amfsim1_s  RegistrationRequest(guti, mobility update) 
amf_net1 <--- HEADERSFRAME ---- amfsim1_s
amf_net1 <--- DATAFRAME(UECONTEXTTRANSFERRSPDATA) ---- amfsim1_s
amf_net1 ---- HEADERSFRAME ---> amfsim1_s
amf_net1 ---- DATAFRAME(UEREGSTATUSUPDATEREQDATA) ---> amfsim1_s
amf_net1 <--- HEADERSFRAME ---- amfsim1_s
amf_net1 <--- DATAFRAME(UEREGSTATUSUPDATERSPDATA) ---- amfsim1_s
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++  ue context transfer from external AMF
amf_net1 ---- HEADERSFRAME ---> udm2_s
amf_net1 ---- DATAFRAME(UECMREGISTRATIONREQ) ---> udm2_s
amf_net1 <--- HEADERSFRAME ---- udm2_s
amf_net1 <--- DATAFRAME(UECMREGISTRATIONRSP) ---- udm2_s
amf_net1 ---- HEADERSFRAME ---> udm2_s
amf_net1 <--- HEADERSFRAME ---- udm2_s
amf_net1 <--- DATAFRAME(SUPIMULTIPLEDATASETSRSP) ---- udm2_s
amf_net1 ---- HEADERSFRAME ---> udm2_s
amf_net1 ---- DATAFRAME(SDMSUBSCRIBEREQ) ---> udm2_s
amf_net1 <--- HEADERSFRAME ---- udm2_s
amf_net1 <--- DATAFRAME(SDMSUBSCRIBERSP) ---- udm2_s


## get pcfAmPolicyUri": "http://172.16.59.58:8080/npcf-am-policy-control/v1/policies/PolAssoId22 from uecontext transfer
amf_net1 ---- HEADERSFRAME ---> pcf2_s http://172.16.59.58:8080/npcf-am-policy-control/v1/policies/PolAssoId22/update 
amf_net1 ---- DATAFRAME(POLICYUPDATEREQ) ---> pcf2_s  
###new notificatiouri of AMF, since AMF changed:::"notificationUri":"http://172.16.46.222:8080/npcf-am-policy-control/v1/policies/imsi-460020301001001"

amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s  11552	2019-11-15 15:17:28.361178	172.16.46.203	172.16.59.61	HTTP2	627	HEADERS[1]: POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify, DATA[1] (application/json) 
{"gpsi":"msisdn-3587003600201","servingNfId":"47ff6da3-c6a2-49d3-86c6-52bf9274d59a","guami":{"plmnId":{"mcc":"460","mnc":"02"},"amfId":"010041"},"ueLocation":{"nrLocation":{"tai":{"plmnId":{"mcc":"460","mnc":"02"},"tac":"007530"},"ncgi":{"plmnId":{"mcc":"460","mnc":"02"},"nrCellId":"000515101"}}},"ueTimeZone":"-06:00","smContextStatusUri":"http://172.16.46.223:8080/nsmf-pdusession/v1/sm-contexts/imsi-460020301001001/ntfyId-1/status-ntf","anTypeCanBeChanged":false}
amf_net1 <--- HEADERSFRAME ---- smf1_s
amf_net1 ---- HEADERSFRAME ---> smf1_s
amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s
amf_net1 <--- HEADERSFRAME ---- smf1_s
===++++++++++++++++++if no uldata pending++++++++++++++++++++++++++++++++++++++++
amf_net1 ---- DOWNLINKNASTRANSPORT(registration accept) ---> gnb01
amf_net1 <--- UPLINKNASTRANSPORT(registration complete) ---- gnb01

+++++++++++++++++++++if uldata pending+++++++++++++++++++++++++++++++++++++++++++++++++++++++
amf_net1 ---- InitialContextSetupReq(NAS:Regstration accept) ---> gnb01
amf_net1 <--- InitailContextSetupRsp ---- gnb01
amf_net1 ---- DOWNLINKNASTRANSPORT(registration complete-) ---> gnb01

###since gnb allocated gtp teid for this uldata, amf will transfer it to smf
amf_net1 ---- DATAFRAME(UPDATESMCONTEXTREQ) ---> smf1_s POST /nsmf-pdusession/v1/sm-contexts/imsi-460020301001001_1/modify,
upCnxState(ACTIVATED), n2SmInfoType(initailContextResp)
-------------------------------------------------------------------------


* 5G complicated procedures
** mobility update(tracking area update)
mau1152 IT10 Connected UE with PDU, Mobility Registration different gNB
    [Tags]   tidnum_mau1152     regression
    [Documentation]     Mobility update registration ue session data IE present, verify NG stays up.  UE sends session request.
#    IOTA Procedure    5gNgSetup   -ta1 ${IOTA.AMF_TAC2}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5 -gNB gnb06 -gnbname gnb06
#    IOTA Procedure    5gNgSetup   -ta1 ${IOTA.AMF_TAC3}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5 -gNB gnb08 -gnbname gnb08
    IOTA Procedure    5gNgSetup   -ta1 ${IOTA.AMF_TAC2}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5 -gNB gnb07 -gnbname gnb07
    sleep  10s
    IOTA Procedure    5gRegistrationSuci   ##in default, registration with gnb01 with tac0
    IOTA Procedure    5gPduEstablishment
    IOTA Procedure    5gNgRelease          ## gnb01 request ng release 
    IOTA Procedure    5gRegistrationMobility -gNB gnb04 -tac $::IOTACFG(AMF_TAC1)  ## mobility regitration update with tac1 from gnb04
    IOTA Procedure    5gRegistrationMobility ## mobility regitration update with tac1 from gnb04 (no AKA procedure since above procedure cover it already)
    IOTA Procedure    5gNgRelease            ##gnb04 request ng release, amfCmState: idle 
    IOTA Procedure    5gServiceReqSignalling ##gnb04 request service request,amfCmState:connected  
    IOTA Procedure    5gNgRelease            ##gnb04 request ng release, amfCmState: idle 
    IOTA Procedure    5gRegistrationMobility -gNB gnb06 -tac $::IOTACFG(AMF_TAC2)  ## mobility regitration update with tac2 from gnb06 
    IOTA Procedure    5gNgRelease   ## mobility regitration update with tac1 from gnb04   ##amfCmState:IDLE  
    IOTA Procedure    5gRegistrationMobility -gNB gnb07 -tac $::IOTACFG(AMF_TAC2)           ##amfCmState:CONNECTED 
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationMobility -gNB gnb08 -tac $::IOTACFG(AMF_TAC3)
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationMobility -gNB gnb01 -tac $::IOTACFG(AMF_TAC0)
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration
    PMOnDemand.report_request    yes    200
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeRegistrationAttMobRegUpd
    Should Be Equal As Integers    ${cnts}    6
    ${cnts}=    PMOnDemand.Get Service Measurement Sum     cpps    VS.UeRegistrationSuccMobRegUpd
    Should Be Equal As Integers    ${cnts}    6



** 5g network initiating service request
SMF send N1N2MessageTransferReq to AMF
ite_001_test_case
    [Tags]    ne_amf     tech_5g     tidnum_ite_001
    [Documentation]
    ...
    ...  === <ITE Test Case 001> ===
    ...  |    Purpose: 1.   AMF_SMOKE_014 test case modified to use ARP1, PPI7
    ...  |                  Registration, PDU, NGRelease, DDN (NW Initiated SR), UE SR with Signaling, AMF avtivate PDU.
    ...  |                  Verify selection of correct PPI paging type when matching ARP & PPI policy records present.
    ...  |                  Also verify paging type AMF_PAGING_PPI7 (24) is recorded in PCMD record.
    ...  }                  Also verify use of highest allowed PPI value and lowest ARP value.
    ...
    ...  === Test Case Status: ===
    ...  |    Status: ITE Complete   (InProgress | Ready for ITE | ITE Complete)
    ...
    ...  === Manual Command(s): ===
    ...  |    - NA
    ...
    ...  === Steps: (DDN request w/ARP=1, and PPI=7) ===
    ...  |  1. 5gRegistrationSuci       - Register UE
    ...  |  2. 5gPduEstablishment       - Create bearer
    ...  |  3. 5gNgRelease              - Make UE IDLE
    ...  |  4. 5gNWInitServiceRequest   - Network Initiated Service Request (DDN) - UE IDLE, Triggers paging on the AMF:
    ...  === Message flow: (DDN/Paging) ===
    ...  | SMF:  ------>  AMF - NW Service Request (DDN) via N1N2 Message Transfer (N1N2MESSAGETRANSFERREQ)
    ...  | SMF:  <------  AMF - NW Service Response via N1N2 Message Transfer (N1N2MESSAGETRANSFERRSP) - *** CAUSE ATTEMPTING_TO_REACH_UE ***
    ...  | gNB:  <------  AMF - Paging Request (PAGING)
    ...  |
    ...  |  5. 5gServiceReqData        - Service Request with Service type set to data, with UL data status (gNB response to Paging Request)
    ...  |                                 (UE is now Connected/Registered w/Signaling)
    ...  |  6. 5gNgRelease             - Make UE IDLE
    ...  |  7. 5gServiceReqSignalling  - Service Request with Service type set to signaling, without UL data
    ...  |  8. 5gNWInitServiceRequest  - Network Initiated Service Request (DDN) - UE Connected w/o Signaling, No Page attempt, AMF setup PDU connection status.
    ...  === Message flow: (DDN/ No Paging) ===
    ...  | SMF:  ------>  AMF - NW Service Request (DDN) via N1N2 Message Transfer (N1N2MESSAGETRANSFERREQ)
    ...  | SMF:  <------  AMF - NW Service Response via N1N2 Message Transfer (N1N2MESSAGETRANSFERRSP) - *** CAUSE N1_N2_TRANSFER_INITIATED ***
    ...  | gNB:  <------  AMF - Initial Context Setup Request (INITIALCONTEXTSETUPREQUEST)
    ...  | gNB:  ------>  AMF - Initial Context Setup Response (INITIALCONTEXTSETUPRESPONSE)
    ...  | SMF:  <------  AMF - Update SM Context Request (UPDATESMCONTEXTREQ)
    ...  |                            (UE is now Connected/Registered)
    ...  |
    ...  |  9. 5gSmfInitPduRelease     -
    ...  | 10. 5gUeDeRegistration      - UE DeRegistration
    ...  | 11. 5gUdmDeRegistration     - UDM DeRegistration
    ...


** 
** 5g AMF relocation scenario

5gRegistrationSuci
5gNgRelease
*** 5gInitUeContextTransferReqFromExtAMF   ###Mobility Registration with AMF change,amfsim request the transfer, why? 
target amf request uecontext transfer

amf_net1 <--- DATAFRAME(UECONTEXTTRANSFERREQDATA) ---- amfsim1_c
HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UECONTEXTTRANSFERREQDATA {{ACCESSTYPE "3GPP_ACCESS"} {BINARYDATAN1SMMESSAGE {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $1ED0D6B2} {NASMSG {NAS::NGREGISTRATIONREQUEST {{EPD $7E} {LASTVISITEDREGISTEREDTAI $64F020007530} {NGKSI $00} {NGMOBILEIDENTITY $F264F020010041C1A00008} {NGREGISTRATIONTYPE $9} {PDUSESSIONSTATUS EMPTY} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A50402ABCDE10403ABCDE2} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00} {UESECURITYCAPABILITY $80408080}}}} {SECURITYHDRTYPE $1} {SEQUENCENUM $000002} {_BEARERID $01} {_DIRECTION $00} {_ENCALG 0} {_INTALG 1} {_KNASENC $EE7CAA728D2F5BB7EDFC25A01D422733} {_KNASINT $EE69C765A531211A3187283B3C61125D} {_NASCOUNT $000002}}}} {PLMNID {{MCC "460"} {MNC "02"}}} {REASON MOBI_REG} {REGREQUEST {{N1MESSAGECLASS "5GMM"} {N1MESSAGECONTENT {{CONTENTID n1msg}}} {NFID EMPTY}}} {SUPPORTEDFEATURES EMPTY}}}}}}} {FLAGS $01} {STREAMID 3}}}} {localName amfsim1_c} {remoteName amf_net1}}

HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UECONTEXTTRANSFERRSPDATA {{UECONTEXT {{FORBIDDENAREALIST {+ {{TACS {+ $008888 $009999}}} {{TACS {+ $006666 $007777}}}}} {GPSILIST {+ msisdn-3587003600201}} {MMCONTEXTLIST {+ {{ACCESSTYPE "3GPP_ACCESS"} {ALLOWEDNSSAI {+ {{SD $D143A5} {SST "1"}} {{SD $D143A5} {SST "2"}} {{SD $D143A5} {SST "3"}}}} {NASDOWNLINKCOUNT "3"} {NASSECURITYMODE {{CIPHERINGALGORITHM NEA0} {INTEGRITYALGORITHM NIA1}}} {NASUPLINKCOUNT "2"} {UESECURITYCAPABILITY "gECAgA=="}}}} {PCFAMPOLICYURI http://172.16.59.58:8080/npcf-am-policy-control/v1/policies/PolAssoId2} {PCFID C18985BE-8028-4BF0-858A-9391C63B67B2} {PEI imeisv-9876543219876510} {RESTRICTEDCORENWTYPELIST {+ EPC}} {RESTRICTEDRATLIST {+ EUTRA}} {SEAFDATA {{KEYAMF {{KEYTYPE KAMF} {KEYVAL $69877CAB0E3425B10DDBA498AE8F26FFBA582BEEE16A663B616C4CF0489501BD}}} {NCCNUM "0"} {NGKSI {{KSI "0"} {TSC NATIVE}}} {NH $0000000000000000000000000000000000000000000000000000000000000000}}} {SERVICEAREARESTRICTION {{AREAS {+ {{AREACODES "100"} {TACS {+ $123456}}} {{AREACODES "200"} {TACS {+ $234567}}}}} {MAXNUMOFTAS "2"} {RESTRICTIONTYPE NOT_ALLOWED_AREAS}}} {SMSSUPPORT NONE} {SUBRFSP "2"} {SUBUEAMBR {{DOWNLINK "125 Mbps"} {UPLINK "125 Mbps"}}} {SUPI imsi-460020301001001} {USEDRFSP "2"}}}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName amfsim1_c} {remoteName amf_net1}}
amf_net1 ---- DATAFRAME(UECONTEXTTRANSFERRSPDATA) ---> amfsim1_c

amf_net1 <--- DATAFRAME(UEREGSTATUSUPDATEREQDATA) ---- amfsim1_c
HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UEREGSTATUSUPDATEREQDATA {{TRANSFERSTATUS TRANSFERRED}}}}}}} {FLAGS $01} {STREAMID 5}}}} {localName amfsim1_c} {remoteName amf_net1}}

 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UEREGSTATUSUPDATERSPDATA {{REGSTATUSTRANSFERCOMPLETE true}}}}}}} {FLAGS $01} {STREAMID $00000005}}}} {localName amfsim1_c} {remoteName amf_net1}}
amf_net1 ---- DATAFRAME(UEREGSTATUSUPDATERSPDATA) ---> amfsim1_c

*** 5gUdmDeRegistration -deregist_reason registration_area_change -page false 
amf_net1 <--- DATAFRAME(DEREGISTRATIONNOTIFY) ---- udm1_c


***   5gRegistrationGutiFromExtAMF      ### Mobility Registraion with AMF change at tgt AMF
amf_net1 <--- INITIALUEMESSAGE(NGSECURITYPROTECTEDNASMSG) ---- gnb01
NGAP::INITIALUEMESSAGE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 2}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $00000000} {NASMSG {NAS::NGREGISTRATIONREQUEST {{EPD $7E} {NGKSI 0} {NGMOBILEIDENTITY $F264F020010082C000001F} {NGREGISTRATIONTYPE $A} {PDUSESSIONSTATUS $0000} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A5} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00} {UESECURITYCAPABILITY $80408080}}}} {SECURITYHDRTYPE $1} {SEQUENCENUM $000003} {_BEARERID $01} {_DIRECTION $00} {_ENCALG 0} {_INTALG 1} {_KNASENC $EE7CAA728D2F5BB7EDFC25A01D422733} {_KNASINT $EE69C765A531211A3187283B3C61125D} {_NASCOUNT $000003}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}} {{CRITICALITY 1} {ID 90} {VALUE {RRCESTABLISHMENTCAUSEOBJ {{RRCESTABLISHMENTCAUSE 3}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}


amf_net1 <--- DATAFRAME(NFDISCOVERRSP) ---- nrf1_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NNRF {{BODY {@NFDISCOVERRSP {{NFINSTANCES {+_list {{AMFINFO {{AMFREGIONID "01"} {AMFSETID "002"} {GUAMILIST {+_list {{AMFID $010082} {PLMNID {{MCC "460"} {MNC "02"}}}}}} {TAILIST {+_list {{PLMNID {{MCC "460"} {MNC "02"}}} {TAC $7530}}}}}} {CAPACITY "50"} {FQDN amf1.com} {IPV4ADDRESSES {+_list "172.16.59.51"}} {NFINSTANCEID "66080788-13c8-4b04-8ca5-65d433b15b21"} {NFSERVICES {+_list {{FQDN amf1.service1.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.51"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME https} {SERVICEINSTANCEID namf-Communication} {SERVICENAME namf-comm} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}} {{FQDN amf1.service2.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.51"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME https} {SERVICEINSTANCEID namf-EventExposure} {SERVICENAME namf-evts} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}} {{FQDN amf1.service3.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.51"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME https} {SERVICEINSTANCEID namf-MT} {SERVICENAME namf-mt} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}} {{FQDN amf1.service4.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.51"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME https} {SERVICEINSTANCEID Namf_location} {SERVICENAME namf-loc} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}}}} {NFSTATUS REGISTERED} {NFTYPE AMF} {PLMNLIST {+_list {{MCC "460"} {MNC "02"}}}} {SNSSAIS {+_list {{SD $D143A5} {SST "1"}} {{SD $D143A5} {SST "2"}} {{SD $D143A5} {SST "3"}}}}}}} {VALIDITYPERIOD "1000"}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName nrf1_s} {remoteName amf_net1}}



HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UECONTEXTTRANSFERREQDATA {{BINARYDATAN1SMMESSAGE {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $2CC868DA} {NASMSG {NAS::NGREGISTRATIONREQUEST {{EPD $7E} {NGKSI $00} {NGMOBILEIDENTITY $F264F020010082C000001F} {NGREGISTRATIONTYPE $0A} {PDUSESSIONSTATUS $0000} {REQUESTEDNSSAI $0401D143A50402D143A50403D143A5} {SECURITYHDRTYPE $0} {SPAREHALFOCTET $0} {UESECURITYCAPABILITY $80408080}}}} {SECURITYHDRTYPE $1} {SEQUENCENUM $03} {XMAC $00000000}}}} {REASON MOBI_REG} {REGREQUEST {{N1MESSAGECLASS "5GMM"} {N1MESSAGECONTENT {{CONTENTID n1msg}}}}}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName amfsim1_s} {remoteName amf_net1}}
amf_net1 ---- DATAFRAME(UECONTEXTTRANSFERREQDATA) ---> amfsim1_s

amf_net1 <--- DATAFRAME(UECONTEXTTRANSFERRSPDATA) ---- amfsim1_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UECONTEXTTRANSFERRSPDATA {{UECONTEXT {{FORBIDDENAREALIST {+_list {{TACS {+_list $008888 $009999}}} {{TACS {+_list $006666 $007777}}}}} {GPSILIST {+_list msisdn-3587003600201}} {MMCONTEXTLIST {+_list {{ACCESSTYPE "3GPP_ACCESS"} {ALLOWEDNSSAI {+_list {{SD $D143A5} {SST "1"}} {{SD $D143A5} {SST "2"}} {{SD $D143A5} {SST "3"}}}} {NASDOWNLINKCOUNT "3"} {NASSECURITYMODE {{CIPHERINGALGORITHM NEA0} {INTEGRITYALGORITHM NIA1}}} {NASUPLINKCOUNT "2"} {UESECURITYCAPABILITY "gECAgA=="}}}} {PCFAMPOLICYURI http://172.16.59.58:8080/npcf-am-policy-control/v1/policies/PolAssoId2} {PCFID C18985BE-8028-4BF0-858A-9391C63B67B2} {PEI imeisv-9876543219876510} {RESTRICTEDCORENWTYPELIST {+_list EPC}} {RESTRICTEDRATLIST {+_list EUTRA}} {ROUTINGINDICATOR EMPTY} {SEAFDATA {{KEYAMF {{KEYTYPE KAMF} {KEYVAL $69877CAB0E3425B10DDBA498AE8F26FFBA582BEEE16A663B616C4CF0489501BD}}} {NCCNUM "0"} {NGKSI {{KSI "0"} {TSC NATIVE}}} {NH $0000000000000000000000000000000000000000000000000000000000000000}}} {SERVICEAREARESTRICTION {{AREAS {+_list {{TACS {+_list $123456}}} {{TACS {+_list $234567}}}}} {MAXNUMOFTAS "2"} {RESTRICTIONTYPE NOT_ALLOWED_AREAS}}} {SMSSUPPORT NONE} {SUBRFSP "2"} {SUBUEAMBR {{DOWNLINK "125 Mbps"} {UPLINK "125 Mbps"}}} {SUPI imsi-460020301001001} {USEDRFSP "2"}}}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName amfsim1_s} {remoteName amf_net1}}


HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONREQ {{AMFINSTANCEID "214A63D2-07D3-49F5-B299-32B3F9C1668A"} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {PEI imeisv-9876543219876510} {RATTYPE NR}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName udm2_s} {remoteName amf_net1_1}}
amf_net1_1 ---- DATAFRAME(UECMREGISTRATIONREQ) ---> udm2_s

amf_net1_1 <--- HEADERSFRAME ---- udm2_s
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $04} {HDRBLKFRAGMENT {{CONTENTID EMPTY} {CONTENTLEN EMPTY} {CONTENTTYPE EMPTY} {DATE EMPTY} {HDRTABLESZ EMPTY} {LOCATION EMPTY} {RETRYAFTER EMPTY} {STATUS "201"}}} {STREAMDEP EMPTY} {STREAMID $00000003} {WEIGHT EMPTY}}}} {localName udm2_s} {remoteName amf_net1_1}}

amf_net1_1 <--- DATAFRAME(UECMREGISTRATIONRSP) ---- udm2_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@UECMREGISTRATIONRSP {{AMFINSTANCEID "214A63D2-07D3-49F5-B299-32B3F9C1668A"} {AMFSERVICENAMEDEREG EMPTY} {BACKUPAMFINFO {+_list {{BACKUPAMF EMPTY} {GUAMILIST {+_list {{AMFID EMPTY} {PLMNID {{MCC EMPTY} {MNC EMPTY}}}}}}}}} {DEREGCALLBACKURI http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification} {DRFLAG EMPTY} {GUAMI {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}} {IMSVOPS HOMOGENEOUS_NON_SUPPORT} {INITIALREGISTRATIONIND EMPTY} {PCSCFRESTORATIONCALLBACKURI EMPTY} {PEI imeisv-9876543219876510} {PURGEFLAG EMPTY} {RATTYPE NR} {SUPPORTEDFEATURES EMPTY}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName udm2_s} {remoteName amf_net1_1}}

HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UEREGSTATUSUPDATEREQDATA {{TRANSFERSTATUS TRANSFERRED}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName amfsim1_s} {remoteName amf_net1}}
amf_net1 ---- DATAFRAME(UEREGSTATUSUPDATEREQDATA) ---> amfsim1_s


amf_net1 <--- DATAFRAME(UEREGSTATUSUPDATERSPDATA) ---- amfsim1_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NAMF {{BODY {@UEREGSTATUSUPDATERSPDATA {{REGSTATUSTRANSFERCOMPLETE true}}}}}}} {FLAGS $01} {STREAMID $00000003}}}} {localName amfsim1_s} {remoteName amf_net1}}



amf_net1_1 <--- DATAFRAME(SUPIMULTIPLEDATASETSRSP) ---- udm2_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@SUPIMULTIPLEDATASETSRSP {{AMDATA {{CORENETWORKTYPERESTRICTIONS {+_list EPC}} {FORBIDDENAREAS {+_list {{TACS {+_list $8888 $9999}}} {{TACS {+_list $6666 $7777}}}}} {GPSIS {+_list msisdn-3587003600201}} {INTERNALGROUPIDS {+_list "01020304-123-789-0102030405060708090A"}} {NSSAI {{DEFAULTSINGLENSSAIS {+_list {{SD $D143A5} {SST "1"}}}} {SINGLENSSAIS {+_list {{SD $D143A5} {SST "2"}} {{SD $D143A5} {SST "3"}} {{SD $ABCDE1} {SST "1"}} {{SD $ABCDE2} {SST "2"}} {{SD $ABCDE3} {SST "3"}} {{SD $ABCDE4} {SST "4"}} {{SD $ABCDE5} {SST "5"}} {{SST "4"}}}}}} {RATRESTRICTIONS {+_list EUTRA}} {RFSPINDEX "3"} {SERVICEAREARESTRICTION {{AREAS {+_list {{AREACODES "100"} {TACS {+_list $123456}}} {{AREACODES "200"} {TACS {+_list $234567}}}}} {MAXNUMOFTAS "2"} {RESTRICTIONTYPE NOT_ALLOWED_AREAS}}} {SUBSCRIBEDUEAMBR {{DOWNLINK "125 Mbps"} {UPLINK "125 Mbps"}}} {SUBSREGTIMER EMPTY}}} {SMFSELDATA {{SUBSCRIBEDSNSSAIINFOS {+_list {{MAPKEY "001-D143A5"} {MAPVALUE {{DNNINFOS {+_list {{DEFAULTDNNINDICATOR true} {DNN wap1.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR false} {DNN wap2.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR false} {DNN wap3.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR true} {DNN wap4.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap5.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap6.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap7.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap8.nokia.com} {LBOROAMINGALLOWED false}}}}}}} {{MAPKEY "002-D143A5"} {MAPVALUE {{DNNINFOS {+_list {{DEFAULTDNNINDICATOR true} {DNN wap1.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR false} {DNN wap2.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap3.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap4.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap9.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap10.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap11.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap12.nokia.com} {LBOROAMINGALLOWED false}}}}}}} {{MAPKEY "003-D143A5"} {MAPVALUE {{DNNINFOS {+_list {{DEFAULTDNNINDICATOR true} {DNN wap1.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR false} {DNN wap2.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap3.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap4.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap13.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR false} {DNN wap14.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap15.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap16.nokia.com} {LBOROAMINGALLOWED false}}}}}}} {{MAPKEY "004"} {MAPVALUE {{DNNINFOS {+_list {{DEFAULTDNNINDICATOR true} {DNN wap1.nokia.com} {LBOROAMINGALLOWED true}} {{DEFAULTDNNINDICATOR true} {DNN wap2.nokia.com} {LBOROAMINGALLOWED false}} {{DEFAULTDNNINDICATOR false} {DNN wap3.nokia.com} {LBOROAMINGALLOWED false}}}}}}}}}}}}}}}}} {FLAGS $01} {STREAMID $00000005}}}} {localName udm2_s} {remoteName amf_net1_1}}



HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@SDMSUBSCRIBEREQ {{CALLBACKREFERENCE http://172.16.46.224:8080/nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/notification} {EXPIRES "2019-09-05T08:41:37Z"} {MONITOREDRESOURCEURIS {+ https://172.16.59.73:8080/nudm-sdm/v1/imsi-460020301001001/am-data https://172.16.59.73:8080/nudm-sdm/v1/imsi-460020301001001/smf-select-data}} {NFINSTANCEID "214A63D2-07D3-49F5-B299-32B3F9C1668A"}}}}}}} {FLAGS $01} {STREAMID $00000007}}}} {localName udm2_s} {remoteName amf_net1_1}}
amf_net1_1 ---- DATAFRAME(SDMSUBSCRIBEREQ) ---> udm2_s



amf_net1_1 <--- DATAFRAME(SDMSUBSCRIBERSP) ---- udm2_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NUDM {{BODY {@SDMSUBSCRIBERSP {{CALLBACKREFERENCE http://172.16.46.224:8080/nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/notification} {EXPIRES "2019-09-05T08:41:37Z"} {MONITOREDRESOURCEURIS {+_list https://172.16.59.73:8080/nudm-sdm/v1/imsi-460020301001001/am-data https://172.16.59.73:8080/nudm-sdm/v1/imsi-460020301001001/smf-select-data}} {NFINSTANCEID "214A63D2-07D3-49F5-B299-32B3F9C1668A"}}}}}}} {FLAGS $01} {STREAMID $00000007}}}} {localName udm2_s} {remoteName amf_net1_1}}




NGAP::DOWNLINKNASTRANSPORT {{CRITICALITY $01} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 35}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 2}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $4ED1E202} {NASMSG {NAS::NGREGISTRATIONACCEPT {{ALLOWEDNSSAI $0401D143A50402D143A50403D143A5} {EPD $7E} {NGGUTI $F264F020010041C0600008} {NGNETWORKFEATURESUPPORT $00} {NGREGISTRATIONRESULT $01} {NGTAILIST $2064F020007530} {PDUSESSIONSTATUS $0000} {SECURITYHDRTYPE $0} {SERVICEAREALIST $8064F0201234568064F020234567} {SPAREHALFOCTET $0} {T3502VAL $2C} {T3512VAL $AC}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $03} {XMAC $4ED1E202} {_ISDECODED EMPTY} {_RAWNASPDU $7E024ED1E202037E0042010177000BF264F020010041C060000854072064F020007530150F0401D143A50402D143A50403D143A521010050020000270E8064F0201234568064F0202345675E01AC16012C}}}}}}}} {{CRITICALITY 1} {ID 36} {VALUE {MOBILITYRESTRICTIONLISTOBJ {{FORBIDDENAREAINFORMATIONLIST {+FORBIDDENAREAINFORMATIONLISTFLD {{FORBIDDENTACSLIST {+FORBIDDENTACSLISTFLD $008888 $009999 $006666 $007777}} {PLMNIDENTITY $64F020}}}} {RATRESTRICTIONSLIST {+RATRESTRICTIONSLISTFLD {{PLMNIDENTITY $64F020} {RATRESTRICTIONINFORMATION $80}}}} {SERVICEAREAINFORMATIONLIST {+SERVICEAREAINFORMATIONLISTFLD {{NOTALLOWEDTACSLIST {+NOTALLOWEDTACSLISTFLD $123456 $234567}} {PLMNIDENTITY $64F020}}}} {SERVINGPLMN $64F020}}}}} {{CRITICALITY 1} {ID 31} {VALUE {INDEXTORFSPOBJ {{INDEXTORFSP 3}}}}} {{CRITICALITY 1} {ID 110} {VALUE {UEAGGREGATEMAXIMUMBITRATEOBJ {{UEAGGREGATEMAXIMUMBITRATEDL 125000000} {UEAGGREGATEMAXIMUMBITRATEUL 125000000}}}}} {{CRITICALITY 0} {ID 0} {VALUE {ALLOWEDNSSAIOBJ {{ALLOWEDNSSAILIST {+ALLOWEDNSSAILISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}} {{SNSSAI {{SD $D143A5} {SST $02}}}} {{SNSSAI {{SD $D143A5} {SST $03}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1}}
amf_net1 ---- DOWNLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---> gnb01

amf_net1 <--- UPLINKNASTRANSPORT(NGSECURITYPROTECTEDNASMSG) ---- gnb01
NGAP::UPLINKNASTRANSPORT {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 10} {VALUE {AMFUENGAPIDOBJ {{AMFUENGAPID 35}}}}} {{CRITICALITY 0} {ID 85} {VALUE {RANUENGAPIDOBJ {{RANUENGAPID 2}}}}} {{CRITICALITY 0} {ID 38} {VALUE {NASPDUOBJ {{NASPDU {NAS::NGSECURITYPROTECTEDNASMSG {{EPD $7E} {MAC $00000000} {NASMSG {NAS::NGREGISTRATIONCOMPLETE {{EPD $7E} {SECURITYHDRTYPE 0} {SPAREHALFOCTET $00}}}} {SECURITYHDRTYPE $2} {SEQUENCENUM $000004} {_BEARERID $01} {_DIRECTION $00} {_ENCALG 0} {_INTALG 1} {_KNASENC $EE7CAA728D2F5BB7EDFC25A01D422733} {_KNASINT $EE69C765A531211A3187283B3C61125D} {_NASCOUNT $000004}}}}}}}} {{CRITICALITY 0} {ID 121} {VALUE {USERLOCATIONINFORMATIONOBJ {{USERLOCATIONINFORMATION {@USERLOCATIONINFORMATIONNR {{NRCGI {{NRCELLIDENTITY $000515101} {PLMNIDENTITY $64F020}}} {TAI {{PLMNIDENTITY $64F020} {TAC $007530}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}

IOTAPROCRETCODE=0


0






** tracking area and nssai related with GNB
*** NG setup 
**** NG setup procedure override former's configuration in ngsetup
NG setup request from GNB will override  mme's configuration about the plmnid,tac and snssai.

5gNgSetup -ta1 ${IOTA.AMF_TAC1}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5 -gNB gnb04 -gnbname gnb04
5gNgSetup -ta1 ${IOTA.AMF_TAC0}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5 -gNB gnb04 -gnbname gnb04

***** check the gnb04's tac list
cmm ngRanTaiQuery list, --mcc 460 --mnc 02 --ngRanId 21588 --ngRanType gnb

  {
    "taiMnc": "02", 
    "taiMcc": "460", 
    "mcc": "460", 
    "tac": "30000", 
    "ngRanTaiQuery": "460~02~21588", 
    "ngRanName": "gnb04", 
    "ngRanType": "gnb", 
    "ngRanIpAddress": "172.16.59.14", 
    "mnc": "02", 
    "ngRanId": "21588"
  }, 


**** NG setup procedure with multiple tacs within one procedure
5gNgSetup -ta1 ${IOTA.AMF_TAC1}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5, -ta2 ${IOTA.AMF_TAC0}:${CMM.MCC}${CMM.MNC}:01,02,03:D143A5,D143A5,D143A5, -gNB gnb04 -gnbname gnb04

***** check the gnb04's tac list
cmm ngRanTaiQuery list, --mcc 460 --mnc 02 --ngRanId 21588 --ngRanType gnb

  {
    "taiMnc": "02", 
    "taiMcc": "460", 
    "mcc": "460", 
    "tac": "30001", 
    "ngRanTaiQuery": "460~02~21588", 
    "ngRanName": "gnb04", 
    "ngRanType": "gnb", 
    "ngRanIpAddress": "172.16.59.14", 
    "mnc": "02", 
    "ngRanId": "21588"
  }, 
  {
    "taiMnc": "02", 
    "taiMcc": "460", 
    "mcc": "460", 
    "tac": "30000", 
    "ngRanTaiQuery": "460~02~21588", 
    "ngRanName": "gnb04", 
    "ngRanType": "gnb", 
    "ngRanIpAddress": "172.16.59.14", 
    "mnc": "02", 
    "ngRanId": "21588"
  }


IOTA Procedure    5gNgSetup   -ta1 ${IOTA.AMF_TAC0}:${CMM.MCC}${CMM.MNC}:01,02,03:000000,D143A5,D143A5 -gNB gnb01 -gnbname gnb01

tac 3001
amf_net1 <---- NGSETUPREQUEST --- gnb04
NGAP::NGSETUPREQUEST {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 27} {VALUE {GLOBALRANNODEIDOBJ {{GLOBALRANNODEID {@GLOBALGNBID {{GNBID {@GNBIDBS $05454}} {PLMNIDENTITY $64F020}}}}}}}} {{CRITICALITY 1} {ID 82} {VALUE {RANNODENAMEOBJ {{RANNODENAME gnb04}}}}} {{CRITICALITY 0} {ID 102} {VALUE {SUPPORTEDTALISTOBJ {{SUPPORTEDTALISTLIST {+SUPPORTEDTALISTLISTFLD {{BROADCASTPLMNLISTLIST {+BROADCASTPLMNLISTLISTFLD {{PLMNIDENTITY $64F020} {TAISLICESUPPORTLISTLIST {+TAISLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}}}}}}} {TAC $007531}}}}}}}} {{CRITICALITY 1} {ID 21} {VALUE {PAGINGDRXOBJ {{PAGINGDRX 0}}}}}}} {localName gnb04} {remoteName amf_net1} {streamId 1}}


NGAP::NGSETUPRESPONSE {{CRITICALITY $00} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 1} {VALUE {AMFNAMEOBJ {{AMFNAME espate138a}}}}} {{CRITICALITY 0} {ID 96} {VALUE {SERVEDGUAMILISTOBJ {{SERVEDGUAMILISTLIST {+SERVEDGUAMILISTLISTFLD {{GUAMI {{AMFPOINTER $01} {AMFREGIONID $01} {AMFSETID $0001} {PLMNIDENTITY $64F020}}}}}}}}}} {{CRITICALITY 1} {ID 86} {VALUE {RELATIVEAMFCAPACITYOBJ {{RELATIVEAMFCAPACITY 5}}}}} {{CRITICALITY 0} {ID 80} {VALUE {PLMNSUPPORTLISTOBJ {{PLMNSUPPORTLISTLIST {+PLMNSUPPORTLISTLISTFLD {{PLMNIDENTITY $64F020} {SLICESUPPORTLISTLIST {+SLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}} {{SNSSAI {{SD $D143A5} {SST $02}}}} {{SNSSAI {{SD $D143A5} {SST $03}}}} {{SNSSAI {{SST $04}}}}}}}}}}}}}}} {localName gnb04} {remoteName amf_net1}}
amf_net1 ---- NGSETUPRESPONSE ---> gnb04


---------------------------------
after this, mme will save the tac 3001, with snssai 1

[cmm@espate138a-necc0 ~]$ cmm snssaisOfTaiQuery list --taiMcc 460 --taiMnc 02 --tac 30001 -f json
[
  {
    "taiMnc": "02",
    "sliceDifferentiator": "D143A5",
    "taiMcc": "460",
    "tac": "30001",
    "sliceServiceType": "1",
    "snssaisOfTaiQuery": "460~02~30001"
  }
]
[cmm@espate138a-necc0 ~]$ cmm snssaisOfTaiQuery list --taiMcc 460 --taiMnc 02 --tac 30000 -f json
[
  {
    "taiMnc": "02",
    "sliceDifferentiator": "D143A5",
    "taiMcc": "460",
    "tac": "30000",
    "sliceServiceType": "1",
    "snssaisOfTaiQuery": "460~02~30000"
  },
  {
    "taiMnc": "02",
    "sliceDifferentiator": "D143A5",
    "taiMcc": "460",
    "tac": "30000",
    "sliceServiceType": "2",
    "snssaisOfTaiQuery": "460~02~30000"
  },
  {
    "taiMnc": "02",
    "sliceDifferentiator": "D143A5",
    "taiMcc": "460",
    "tac": "30000",
    "sliceServiceType": "3",
    "snssaisOfTaiQuery": "460~02~30000"
  }
]


registartion accept will be the common set of required nssai and allowed nssai saved in AMF
*** example:
initail regstration with tac 3000 to AMF with s-nssai rquested 1,2,3 with imsi from gnb01 
registration accept with talist 3000 and allowed nssai 1,2,3

moblity registration with tac 3001 to AMF with  -snssai "1,D143A5,,," with guti  from gnb04
registration accept with talist 3001 and allowed nssai 1


[cmm@espate138a-necc0 ~]$
[cmm@espate138a-necc0 ~]$ cmm taisOfSnssaiQuery list --sliceServiceType 1 --sliceDifferentiator D143A5
+-------------------+------------------+---------------------+--------+--------+-------+
| taisOfSnssaiQuery | sliceServiceType | sliceDifferentiator | taiMcc | taiMnc | tac   |
+-------------------+------------------+---------------------+--------+--------+-------+
| 1~D143A5          | 1                | D143A5              | 460    | 02     | 30000 |
| 1~D143A5          | 1                | D143A5              | 460    | 02     | 30001 |
| 1~D143A5          | 1                | D143A5              | 460    | 02     | 30002 |
| 1~D143A5          | 1                | D143A5              | 460    | 02     | 30005 |
+-------------------+------------------+---------------------+--------+--------+-------+

then registration accept 's talist wil include both tac 3000 and  30001
 why, since ,they have the same sliceServerType 1




** two PDU, one is active, another is deactive
ITE-14A_SMFINIT
    [Documentation]   	SMF initiated PDU session modification when User plane is not established . PDU session resource setup request transfer from SMF and ICSR is triggered when Initial context was not established.
    [Tags]    tidnum_msc0549    regression
    [Setup]    Test Setup Modification
    IOTA Procedure    5gRegistrationSuci -for true
    IOTA Procedure    5gPduEstablishment
    IOTA Procedure    5gPduEstablishment -dnn wap2.nokia.com -sst 2 -sd D143A5 -psi 2 -pti 4
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gServiceReqSignalling
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gPduModification -smfinit true -icsr true -secpdumod true -psi 2 -pti 4 -postinitproc {::SMFinitIEtype;set ::c_ue(rcv_initctxsetupreq) "basic_rcv_initialContextSetupRequest_pdumodcomd_tgt_amf_local"}
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Command    set ::c_ue(initialCtxSetupSent) "true"
    IOTA Procedure    5gServiceReqData -pdustatus 0x0600   -postinitproc {set ::c_ue(initialCtxSetupSent) "true"}
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gUeDeRegistration


** 5G and 4G both support(UE S1 support) whether EBI should be allocated
UE S1 support, No restrictions, iwkEPsind true,

In Registration request, UE network capability [S1 support]
In u'AMFSUBSCRIPTIONDATA':  u'ratRestrictCount': 0,------------- u'ratRestrictCount': 1, u'ratRestrictions': [u'EUTRA'],
u'AMFSUBSCRIPTIONDATA': { u'coreNetwRestrictCount': 1, u'coreNetwTypeRestrictions': [u'EPC'],
u'AMFSUBSMFSEL': [ u'dnnInfo': [{u'defaultDnnIndFlag': True, u'dnn': u'wap1.nokia.com', u'dnnFpx': 0, u'iwkEpsIndFlag': True},

*** when ue has s1 support capability, no ratRestriction in subscriptionData, then EBI should be allocated when PDU(which dnn has iwkEPsind) established.
In Registration request, UE capability [S1 support]
5In u'AMFSUBSCRIPTIONDATA':  u'ratRestrictCount': 0,
'AMFSUBSMFSEL': [ u'dnnInfo': [{u'defaultDnnIndFlag': True, u'dnn': u'wap1.nokia.com', u'dnnFpx': 0, u'iwkEpsIndFlag': True},

mim0255 Verify Registration and PDU Establishment, SMF+PGW-C via NRF
    [Tags]    funcarea_sm_pdu    tidnum_mim0255    regression    owner_kalle.tammisto
    [Documentation]  Registration and PDU Establishment, EBI allocation, UE S1 support, No restrictions, iwkEPsind true,
    ...     SMF+PGW-C via NRF, EPS NAS algorithms to the UE as part of Security Mode Command procedure
    [Setup]    f20031-02 IOTA Test Setup
    IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind;
    ...               set ::c_ue(ngregstreq_mmcapability) \\$01;
    ...               set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}
#    ...               set ::c_ue(ngregstreq_uestatus) \\$03}
    IOTA Procedure    5gPduEstablishment -postinitproc {5gEbiAssigmentWithPDUEstablisment_SMF; smf_parameterInitialize; verify_epsiwind_during_createsmcontextreq WITH_N26}
    Verify Subscriber Data    1
    IOTA Procedure    5gUeDeRegistration
#### after ,epsBearerId allocated
 u'AMFPDU': [{u'allocatedEbiCount': 1,
              u'allocatedEbiList': [{u'arp': {u'preemptCapability': u'not preempt', u'preemptVulnerability': u'not preemptable', u'priorityLevel': u'0x0F'},
                                     u'epsBearerId': 5}],
              u'dnnInUse': u'wap1.nokia.com',

**** 5gEbiAssigmentWithPDUEstablisment_SMF
     scen_common_chain addchainedsm "EBIASSIGNMENTHDFRAME" $::CSM::sm_ebi_assignment_headerframe_amf init done
     scen_common_chain addchainedsm "EBIASSIGNMENTRSP" $::CSM::sm_ebi_assignment_rsp_amf init done
     scen_common_chain addchainedsm "CREATESMCONTEXTREQWITHEBIASSIGNMENT" $::CSM::sm_createSmContextReqWithEbiAssignment_tgt_amf init done
     scen_common_chain removechainedsm CREATESMCONTEXTREQ


*** when ue has s1 support capability, there's ratRestriction='EUTRAN' in subscriptionData,even iwkEPsInd in DNNINfo, then EBI should not be allocated.
mim0261 Verify Registration and PDU Establishment, EUTRA ratRestriction in UDM profile
    [Tags]    funcarea_sm_pdu    tidnum_mim0261    regression    owner_kalle.tammisto
    [Documentation]  Registration and PDU Establishment, UE support S1 mode, EUTRA ratRestriction in UDM profile, iwkEPsInd  set in DDNInfo
    ...              Following Intra AMF N2 Handover + Registration (mobility update)
    [Setup]    f20031-02 IOTA Test Setup
    CMM Command    cmm amfMobilityTimers modify --amfTimerName hoMobilityRegistrationUpdateWait --amfTimerValue 10000
    IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind; set ::c_ue(n8subscriptiondata_am_ratrestrictions1) EUTRA;
    ...               set ::c_ue(ngregstreq_mmcapability) \\$01;
    ...               set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}
    IOTA Procedure    5gPduEstablishment -dnn wap1.nokia.com -psi 1
    Verify No EBIs Allocated    1
    IOTA Procedure    5gN2Ho -gNB gnb04 -tac ${IOTA.AMF_TAC1} -status_transfer true  -postinitproc {set ::c_ue(horequired_directforwardavail) 0}
    IOTA Procedure    5gRegistrationMobility -gNB gnb04 -tac ${IOTA.AMF_TAC1}
    IOTA Procedure    5gUeDeRegistration
    Verify No EBIs Allocated    1
    IOTA Procedure    5gUdmDeRegistration


In Registration request, UE capability [S1 support]
In u'AMFSUBSCRIPTIONDATA':   u'ratRestrictCount': 1, u'ratRestrictions': [u'EUTRA'],
u'AMFSUBSMFSEL': [ u'dnnInfo': [{u'defaultDnnIndFlag': True, u'dnn': u'wap1.nokia.com', u'dnnFpx': 0, u'iwkEpsIndFlag': True},
#### after , no epsBearerId allocated
44779  u'AMFPDU': [{u'allocatedEbiCount': 0,

***  when ue has s1 support capability, there's coreNetwTypeRestriction='EPC' in subscriptionData,even iwkEPsInd in DNNINfo, then EBI should not be allocated.

u'AMFSUBSCRIPTIONDATA': { u'coreNetwRestrictCount': 1, u'coreNetwTypeRestrictions': [u'EPC'],

mim0262 Verify Registration and PDU Establishment, coreNetworkTypeRestrictions, EPC in UDM profile
    [Tags]    funcarea_sm_pdu    tidnum_mim0262    regression    owner_kalle.tammisto
    [Documentation]  Registration and PDU Establishment with EPC, UE support S1 mode, coreNetworkTypeRestrictions - EPC in UDM profile, iwkEPsInd  set in DDNInfo
    ...              Following Intra AMF N2 Handover + Registration (mobility update)
    [Setup]    f20031-02 IOTA Test Setup
    CMM Command    cmm amfMobilityTimers modify --amfTimerName hoMobilityRegistrationUpdateWait --amfTimerValue 10000
    IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind; set ::c_ue(n8subscriptiondata_am_corenetworktyperestrictions) EPC;
    ...               set ::c_ue(ngregstreq_mmcapability) \\$01;
    ...               set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}
    IOTA Procedure    5gPduEstablishment -dnn wap1.nokia.com -psi 1
    Verify No EBIs Allocated    1
    IOTA Procedure    5gN2Ho -gNB gnb04 -tac ${IOTA.AMF_TAC1} -status_transfer true -postinitproc {set ::c_ue(horequired_directforwardavail) 0}
    IOTA Procedure    5gRegistrationMobility -gNB gnb04 -tac ${IOTA.AMF_TAC1}
    IOTA Procedure    5gUeDeRegistration
    Verify No EBIs Allocated    1
    IOTA Procedure    5gUdmDeRegistration

#### after , no epsBearerId allocated
44779  u'AMFPDU': [{u'allocatedEbiCount': 0,


****  pdu establishment(with ebi assignment) with two procedures
 IOTA Procedure    5gPduEstablishment
Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
IOTA Procedure    5gEbiAssignment -postinitproc
...               {set ::c_ue(ebiassignment_req_prioritylevel1) \15;
...                set ::c_ue(ebiassignment_req_preemtcap1) \\"NOT_PREEMPT\";
...                set ::c_ue(ebiassignment_req_treemptvuln1) \\"NOT_PREEMPTABLE\"}

mim0325 Verify SMF Initiated PDU Session modification
    [Tags]    funcarea_sm_pdu    tidnum_mim0325    regression    owner_kalle.tammisto
    [Documentation]  Verify SMF Initiated PDU Session Modification, EBI assignment procedure
    [Setup]    f20031-02 IOTA Test Setup
    IOTA Procedure    5gRegistrationSuci -postinitproc {iwkepsind;
    ...               set ::c_ue(ngregstreq_mmcapability) \\$01;
    ...               set ::c_ue(ngregstreq_s1unetworkcapability) \\$E0E0000002B020}
#    ...               set ::c_ue(ngregstreq_uestatus) \\$03}
    IOTA Procedure    5gPduEstablishment
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gEbiAssignment -postinitproc
    ...               {set ::c_ue(ebiassignment_req_prioritylevel1) \15;
    ...                set ::c_ue(ebiassignment_req_preemtcap1) \\"NOT_PREEMPT\";
    ...                set ::c_ue(ebiassignment_req_treemptvuln1) \\"NOT_PREEMPTABLE\"}
    Execute Necc Command    cmm subscriber show --imsi ${IOTA.IMSI1}
    IOTA Procedure    5gPduModification -smfinit true -postinitproc serviceForN1N2MessageTransfer
    Verify Subscriber Data    1
    IOTA Procedure    5gUeDeRegistration



* 5G NF service introduction
** NRF The Network Repository Function (NRF) 
*** choose AMF from AMF
path: /nnrf-disc/v1/nf-instances?target-nf-type=AMF&requester-nf-type=AMF&guami=%7B%22plmnId%22:%7B%22mcc%22:%22460%22,%22mnc%22:%2202%22%7D,%22amfId%22:%22010082%22%7D&service-names=namf-comm&requester-nf-instance-fqdn=NokiaAMF.a
in 5G network, choose SMF of service nsmf-pdusession with snssais, dnn and tai from AMF, 


*** choose SMF from AMF
path: /nnrf-disc/v1/nf-instances?target-nf-type=SMF&requester-nf-type=AMF&service-names=nsmf-pdusession,nsmf-event-exposure&snssais=[%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D]&dnn=wap1.nokia.com&tai=%7B%22plmnId%22:%7B%22mcc%22:%224
in 5G network, choose SMF of service nsmf-pdusession with snssais, dnn and tai from AMF, 


Header: :path: /nnrf-disc/v1/nf-instances?target-nf-type=SMF&requester-nf-type=AMF&service-names=nsmf-pdusession,nsmf-event-exposure&snssais=[%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D]&dnn=wap2.nokia.com&tai=%7B%22plmnId%22:%7B%22mcc%22:%224




** PCF (3gpp 29507) 
*** PCF function configuration
**** disable AMF establish AM policy in  PCF 
cmm amfUePlmnServices modify ETPLMN --pcfSelection LocalProvisioning 
cmm networkFunctionInstance modify 749f5045-abcd-456a-ac3a-cbde3cf17086 --enable false 

**** related pcf local provision
### <PCF ntewrokfunctionInstance>
[cmm@espate134a-necc0 ~]$ cmm networkFunctionInstance list|grep PCF
| 749f5045-abcd-456a-ac3a-cbde3cf17086 | PCF    |
| c18985be-8028-4bf0-858a-9391c63b67b9 | PCF    |
[cmm@espate134a-necc0 ~]$ cmm networkFunctionInstance show ^C
[cmm@espate134a-necc0 ~]$ cmm networkFunctionInstance show  749f5045-abcd-456a-ac3a-cbde3cf17086
+-----------------------------------------+--------------------------------------+
| Field                                   | Value                                |
+-----------------------------------------+--------------------------------------+
| networkFunctionInstance                 | 749f5045-abcd-456a-ac3a-cbde3cf17086 |
| instanceId*                             | 749f5045-abcd-456a-ac3a-cbde3cf17086 |
| nfType                                  | PCF                                  |
| plmnName                                | ETPLMN                               |
| snssaiListName                          |                                      |
| fqdn                                    |                                      |
| capacity                                | 65535                                |
| nfServicesListName                      | pcfServices_nlg                      |
| dnnListName                             |                                      |
| supiRangeListName                       | NlgSUPI                              |
| defaultNetworkFunction                  | false                                |
| enable                                  | true                                 |
| nfIpEndPointListName                    | Npcf_Common_nlgList                  |


[cmm@espate134a-necc0 ~]$ cmm nfIpEndPoint list
+-------------------------------+
| nfIpEndPoint                  |
+-------------------------------+
| Npcf_AMPolicyControl_Ep1      |
| Npcf_AMPolicyControl_nlgEp1   |
| Npcf_UEPolicyControl_Ep1      |
| Npcf_UEPolicyControl_nlgEp1   |
[cmm@espate134a-necc0 ~]$ cmm  nfIpEndPoint show Npcf_AMPolicyControl_Ep1
+--------------+--------------------------+
| Field        | Value                    |
+--------------+--------------------------+
| nfIpEndPoint | Npcf_AMPolicyControl_Ep1 |
| name*        | Npcf_AMPolicyControl_Ep1 |
| ipAddress    | 172.16.59.56             |
| port         | 8080                     |
+--------------+--------------------------+
[cmm@espate134a-necc0 ~]$


cmm nfIpEndpointList create --name Npcf_AMPolicyControl_EpList
cmm nfIpEndpointList create --name Npcf_Common_EpList
cmm nfIpEndPoint create --name Npcf_AMPolicyControl_Ep1 --ipAddress 172.20.72.64 --port 8080
cmm nfIpEndpoints create --nfIpEndPointListName Npcf_AMPolicyControl_EpList --nfIpEndPointName Npcf_AMPolicyControl_Ep1
cmm nfIpEndpoints create --nfIpEndPointListName Npcf_Common_EpList --nfIpEndPointName Npcf_AMPolicyControl_Ep1
cmm networkFunctionInstance create --instanceId "c18985be-8028-4bf0-858a-9391c63b67b9" --nfType PCF --plmnName 460_30 --nfIpEndPointListName Npcf_Common_EpList --enable true

*** AM Policy Association 
**** AM Policy Association  establishment 
initial registration
AMF------>PCF   ###create a new policy with the DATA
 POST /npcf-am-policy-control/v1/policies, DATA[rfsp, gpsi, plmn, gumei  ] 
PCF------>AMF   ### create the policy id, in response header in Location field
for the succesfull case shall send a HTTP "201 Created" response with the URI for the created resource in the "Location" header field such as:
npcf-am-policy-control/v1/policies/PolAssoId22/ 


**** AM Policy Association  update
when AMF relocation, mobility update registration
AMF------>PCF   ###update a new policy with the DATA
POST /npcf-am-policy-control/v1/policies/PolAssoId22/update
 
**** AM Policy Association termination
UE Deregistration from the network.
AMF------>PCF   ###delete the policy with the DATA
HEADERS[3]: DELETE /npcf-am-policy-control/v1/policies/PolAssoId22 

*** UE Policy Association
**** trigger UE policy Assocation establishment
case mau1241
   5gRegistrationSuci -payload_container uepcfpolicy -postinitproc {::buildPayloadContainer -uePolicy true}
In registration request [initail registration, with PayloadContainer IE in Nas]

**** UE Policy Asscociation establishment
after registration complete
AMF-------------NGAP/NAS-5G	DownlinkNASTransport, Configuration update command ----------------->GNB
timezone 
	
The RFSP Index is an index referring to a UE information used locally by the Access Network in order to apply specific radio resource management strategies
rsfp:Index to RAT/Frequency Selection Priority;
AMF----------->PCF  create ue context  policy request
POST /npcf-am-policy-control/v1/policies, DATA[1] (application/json)
{"notificationUri":"http://172.16.46.222:8080/npcf-am-policy-control/v1/policies/imsi-460020301001001","supi":"imsi-460020301001001","gpsi":"msisdn-3587003600201","accessType":"3GPP_ACCESS","pei":"imeisv-9876543219876510","userLoc":{"nrLocation":{"tai":{"plmnId":{"mcc":"460","mnc":"02"},"tac":"007530"},"ncgi":{"plmnId":{"mcc":"460","mnc":"02"},"nrCellId":"000515101"}}},"timeZone":"-06:00","servingPlmn":{"mnc":"02","mcc":"460"},"ratType":"NR","servAreaRes":{"restrictionType":"NOT_ALLOWED_AREAS","areas":[{"tacs":["123456","234567"]}]},"rfsp":7,"guami":{"plmnId":{"mcc":"460","mnc":"02"},"amfId":"010041"},"suppFeat":"0000000000000000"}

Service Area Restriction derived from the Service Area Restrictions obtained from the UDM by mapping any service areas denoted by geographical information into Tracking Area Identities (TAIs) 
RFSP as obtained from the UDM encoded as "rfsp" attribute;

AMF<-----------PCF  policy return the policyid for this request
Header: location: http://172.16.59.56:8080/npcf-am-policy-control/v1/policies/PolAssoId6
{ "request": { "notificationUri": "http://172.16.46.222:8080/npcf-am-policy-control/v1/policies/imsi-460020301001001", "supi": "imsi-460020301001001", "userLoc": { "nrLocation": { "tai": { "plmnId": { "mcc": "460", "mnc": "02" } , "tac": "007530" } , "ncgi": { "plmnId": { "mcc": "460", "mnc": "02" } , "nrCellId": "000515101" }  }  } , "servAreaRes": { "restrictionType": "NOT_ALLOWED_AREAS", "areas": [ { "tacs": [  "123456",  "234567" ] }  ], "maxNumOfTAs": 2 } , "suppFeat": "0000000000000000" } , "servAreaRes": { "restrictionType": "NOT_ALLOWED_AREAS", "areas": [ { "tacs": [  "123456",  "234567" ] }  ], "maxNumOfTAs": 2 } , "rfsp": 7, "suppFeat": "0000000000000000" } 


**** UE Policy Asscociation temination
 UE Deregistration from the network.
AMF------>PCF   ###delete the policy with the DATA
HEADERS[3]: DELETE /npcf-ue-policy-control/v1/policies/PolAssoId6





** UDM function (3gpp 29503)
*** get nssai info from udm
amf----------------- /nudm-sdm/v1/imsi-460020301001001/nssai---------> udm
amf<-----------------defaultSingleNssais[singleNssai[{sst:,sd:}...] ---------> udm
UDM subs list:      1,D143A5   6,ABCDE6 (default)
                    1,ABCDE1 2,ABCDE2 3,ABCDE3 4,ABCDE4 5,ABCDE5 4 (other NSSAI)


*** UE context management

AMF------------------>UDM   put registration data to udm and the dereger callback uri   
 PUT /nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access, DATA[1] (application/json)
{"amfInstanceId":"47ff6da3-c6a2-49d3-86c6-52bf9274d59a","pei":"imeisv-9876543219876510","imsVoPs":"HOMOGENEOUS_NON_SUPPORT","deregCallbackUri":"http://172.16.46.224:8080/nudm-uecm/v1/imsi-460020301001001/registrations/amf-3gpp-access/notification","initialRegistrationInd":true,"guami":{"plmnId":{"mcc":"460","mnc":"02"},"amfId":"010041"},"ratType":"NR"}

AMF<------------------UDM   response ok without data   



*** dataset am and smf_sel

AMF------------------>UDM request AM and smf_sel info   
/nudm-sdm/v1/imsi-460020301001001?dataset-names=AM,SMF_SEL



AMF<------------------UDM response AM and smf_sel info   

{ "amData": { "gpsis": [  "msisdn-3587003600201" ], "internalGroupIds": [  "01020304-123-789-0102030405060708090A" ], "subscribedUeAmbr": { "uplink": "125 Mbps", "downlink": "125 Mbps" } , "nssai": { "defaultSingleNssais": [ { "sst": 01, "sd": "d143a5" }  ], "singleNssais": [ { "sst": 03, "sd": "d143a5" } , { "sst": 01, "sd": "abcde1" } , { "sst": 02, "sd": "abcde2" } , { "sst": 03, "sd": "abcde3" } , { "sst": 04, "sd": "abcde4" } , { "sst": 05, "sd": "abcde5" } , { "sst": 4 }  ] } , "ratRestrictions": [  "EUTRA" ], "forbiddenAreas": [ { "tacs": [  "8888",  "9999" ] } , { "tacs": [  "6666",  "7777" ] }  ], "serviceAreaRestriction": { "restrictionType": "NOT_ALLOWED_AREAS", "areas": [ { "tacs": [  "123456",  "234567" ] } , { "areaCodes": "200" }  ], "maxNumOfTAs": 2 } , "coreNetworkTypeRestrictions": [  "EPC" ], "rfspIndex": 7 } , "smfSelData": { "subscribedSnssaiInfos": {  "1-D143A5": { "dnnInfos": [ { "dnn": "wap1.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap2.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": true } , { "dnn": "wap3.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap4.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false } , { "dnn": "wap5.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap6.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap7.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap8.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false }  ] } ,  "2-D143A5": { "dnnInfos": [ { "dnn": "wap1.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap2.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap3.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap4.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap9.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap10.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap11.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap12.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false }  ] } ,  "3-D143A5": { "dnnInfos": [ { "dnn": "wap1.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap2.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap3.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap4.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap13.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": true } , { "dnn": "wap14.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap15.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap16.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false }  ] } ,  "4": { "dnnInfos": [ { "dnn": "wap1.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap2.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false } , { "dnn": "wap3.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap4.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap5.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false } , { "dnn": "wap6.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap7.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap8.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap9.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap10.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false } , { "dnn": "wap11.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap12.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap13.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false } , { "dnn": "wap14.nokia.com", "defaultDnnIndicator": false, "lboRoamingAllowed": false } , { "dnn": "wap15.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": true } , { "dnn": "wap16.nokia.com", "defaultDnnIndicator": true, "lboRoamingAllowed": false }  ] }  }  }  } 


*** subscription data management
AMF------------------>UDM get subscription data
POST /nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions, DATA[5] (application/json)
{"nfInstanceId":"47ff6da3-c6a2-49d3-86c6-52bf9274d59a","expires":"2019-11-18T03:27:15Z","callbackReference":"http://172.16.46.224:8080/nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/notification","monitoredResourceUris":["https://172.16.59.71:8080/nudm-sdm/v1/imsi-460020301001001/am-data","https://172.16.59.71:8080/nudm-sdm/v1/imsi-460020301001001/smf-select-data"]}


AMF<------------------UDM response with subscription data
{ "nfInstanceId": "47ff6da3-c6a2-49d3-86c6-52bf9274d59a", "expires": "2019-11-18T03:27:15Z", "callbackReference": "http://172.16.46.224:8080/nudm-sdm/v1/imsi-460020301001001/sdm-subscriptions/notification", "monitoredResourceUris": [  "https://172.16.59.71:8080/nudm-sdm/v1/imsi-460020301001001/am-data",  "https://172.16.59.71:8080/nudm-sdm/v1/imsi-460020301001001/smf-select-data" ] } 



** NSSF (Network Slice Selection Function )
AMF supports the provisioning of S-NSSAI supported by a TAI
Note:The list of S-NSSAI in the TAI list is only used in case AMF is configured to not use NSSF, that is, provisioning is to an extent NSSF replacement.
AMF gPram: useNssfSelectionServiceForSmf
When NSSF is used, the locally provisioned TAI S-NSSAI list is not taken into account in order to create the availability info or to conclude about the allowed NSSAI.
The locally provisioned S-NNAI list under the amfTai is taken under consideration only when the useNssfAvailabilityService of amfGParms is set to false.

The useNssfSelectionServiceForSmf of amfGParms determines if NSSF will be used for SMF slice selection. When set to true, AMF will issue Nnssf_NSSelection_Get query NSSF for slice instance selection for all new PDU session establishments.


there are 3 scenarios for AMF and SMf interaction
   -	Registration with AMF re-allocation (see clause 4.2.2.2.3 of 3GPP TS 23.502 [3]); case mso0501
   -	UE Configuration Update procedure (see clause 4.2.4.2 of 3GPP TS 23.502 [3]);    
   -	SMF selection for non-roaming and roaming with local breakout (see clause 4.3.2.2.3.2 of 3GPP TS 23.502 [3]) or SMF selection for home-routed roaming scenario (see clause 4.3.2.2.3.3 of 3GPP TS 23.502 [3]).

*** Registration with AMF re-allocation
AMF first uses the AMF-supported NSSAI to determine whether it can support all UE-requested NSSAI. If not, then AMF will use local provisioning to select target AMF. If AMF can support all NSSAI, then AMF determines whether requested NSSAI are allowed in the current TA.
**** when nssf query nssf to select AMF
If AMF cannot serve the UE and if useNssfSelectionServiceForAmf is true, then AMF will query the NSSF to select AMF.

**** AMF can't serve the UE, trigger AMF query NSSF to select AMF
case mso0524
Regestration setp 4:
4.AMF interrogates NSSF for Slice Selection if it cannot serve the UE: NSSF returns set of NSI ID, Allowed S-NSSAI, target AMF set. A target AMF is selected by the AMF initially received the request and rerouting to the target AMF applies


amf_net1 ---- nssf-neselection( slice-info-request-for-registration ) ---> nssf1_s 
##query nssf with amfnfid snnsai,plmn to check if this amfnfid could serve the snnsai,plmn)
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.36:8080"} {METHOD GET}
{PATH "/nnssf-nsselection/v1/network-slice-information?nf-type=AMF&nf-id=61920b09-e525-42f7-82b5-f5a6e90a243d&slice-info-request-for-registration=%7B%22subscribedNssai%22:%5B%7B%22subscribedSnssai%22:%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D,%22defaultIndication%22:true%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:2,%22sd%22:%22D143A5%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:3,%22sd%22:%22D143A5%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:1,%22sd%22:%22ABCDE1%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:2,%22sd%22:%22ABCDE2%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:3,%22sd%22:%22ABCDE3%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:4,%22sd%22:%22ABCDE4%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:5,%22sd%22:%22ABCDE5%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:4%7D,%22defaultIndication%22:false%7D%5D,%22requestedNssai%22:%5B%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D,%7B%22sst%22:2,%22sd%22:%22D143A5%22%7D,%7B%22sst%22:3,%22sd%22:%22D143A5%22%7D,%7B%22sst%22:3,%22sd%22:%22ABCDE3%22%7D%5D,%22defaultConfiguredSnssaiInd%22:false,%22requestMapping%22:false%7D&tai=%7B%22plmnId%22:%7B%22mcc%22:%22460%22,%22mnc%22:%2202%22%7D,%22tac%22:%22007530%22%7D"} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000009}}}} {localName nssf1_s} {remoteName amf_net1}}

***** NSSF return another AMF to source AMF
amf_net1 <--- DATAFRAME(NSSFNSSELECTIONRSP) ---- nssf1_s
{ "allowedNssaiList": [ { "allowedSnssaiList": [ { "allowedSnssai": { "sst": 9, "sd": "abcde1" }  } , { "allowedSnssai": { "sst": 9, "sd": "abcde2" }  } , { "allowedSnssai": { "sst": 9, "sd": "abcde3" }  } , { "allowedSnssai": { "sst": 4 }  }  ], "accessType": "3GPP_ACCESS" }  ], "candidateAmfList": [  "7857ff53-2603-4299-9967-374d3f4c1147" ] } 

***** amf query nrf to get candidatAmf's ip address
then amf_net1 query nnrf
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.31:8080"} {METHOD GET} {PATH "/nnrf-disc/v1/nf-instances?target-nf-type=AMF&amp;requester-nf-type=AMF&amp;target-nf-instance-id=7857ff53-2603-4299-9967-374d3f4c1147&amp;service-names=namf-comm&amp;requester-nf-instance-fqdn=nokiaAMF.amf.5gc.mnc002.mcc460.3gppnetwork.org"} {SCHEME http} {USERAGENT amf}}} {STREAMID $000021D9}}}} {localName nrf1_s} {remoteName amf_net1_1}}^M^M


***** nrf response with ip address
FDISCOVERRSP {{NFINSTANCES {+_list {{AMFINFO {{AMFREGIONID "01"} {AMFSETID "002"} {GUAMILIST {+_list {{AMFID $010082} {PLMNID {{MCC "460"} {MNC "02"}}}}}}}} {CAPACITY "50"} {FQDN amf1.com} {IPV4ADDRESSES {+_list "172.16.59.51"}} {NFINSTANCEID "7857FF53-2603-4299-9967-374D3F4C1147"} {NFSERVICES {+_list {{DEFAULTNOTIFICATIONSUBSCRIPTIONS {+_list {{CALLBACKURI http://172.16.59.51:8080/namf-comm/v1/n1-message-notification-5gmm} {N1MESSAGECLASS "5GMM"} {NOTIFICATIONTYPE N1_MESSAGES}}}} {FQDN amf1.service1.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.51"} {PORT "8080"}
amf forward the registration request to another AMF

**** nssf for amf selection requirement
how nssf know every amf's nssai-tac list?
useNssfAvailabilityService
Nnssf_NSSAIAvailability	This service enables to update the S-NSSAIs the AMF supports on a per TA basis on the NSSF and update the restricted S-NSSAIs per TA and per PLMN on the AMF.	

***** iotacase trigger nssfavailablity message exchage from AMF to NSSF
#    IOTA Async Procedure Start    5gNssfAvailabilityServices -verbose 1
#    CMM Command    cmm amfGParms list
#    CMM Command    cmm amfGParms modify --amfGparmName useNssfAvailabilityService --amfGparmValue true
#    IOTA Async Procedure Wait For Completion


**** testcase analyze mau1268
testcaseid: mau1268 Registration Req UePlmnService, alwaysQueryNssfForAmfSelection set to true and verify AMF always query NSSF
means everytime UE requested a new NSSAi from TAU procedure, amf will always send NSSF query
  Provision Modify    amfUePlmnServices    name=ETPLMN   alwaysQueryNssfForAmfSelection=true
    Provision Modify    amfGParms   amfGparmName=useNssfAvailabilityService     amfGparmValue=true
    Sleep    5
    IOTA Procedure    5gRegistrationSuci -nssfsel true -snssai "1,D143A5,,,2,D143A5,,,"
    ...                  -postinitproc {::SetIeNssaiSelectionRsp -allow_nssai 01,D143A5,02,D143A5,03,D143A5 -amfsetid 1}
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gRegistrationGuti -nssfsel true -subscription_retrival nssai_only
#### now the agreed nssai allowed for this use is in registration accept(1,D143A5,,,2,D143A5,,,)
#### any new added requested NSSAI from ue will triger AMF to query with NSSF
    comment   1. Idle UE UE Registration Mobility, Requested NSSAI is subset of allowed NSSAI. AMF not query NSSF as NSSAI is allowed.
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationMobility -snssai "1,D143A5,,," -nssfsel false

    comment   2. Idle UE UE Registration Mobility, Requested NSSAI having new NSSAI, even AMF support NSSAI, AMF query NSSF.
###ue request new NSSAI, AMF support it from previous NSSF query( 01,D143A5,02,D143A5,03,D143A5 )

    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationMobility -snssai "1,D143A5,,,2,D143A5,,3,D143A5,," -nssfsel true -subscription_retrival nssai_only
    ...                  -postinitproc {::SetIeNssaiSelectionRsp -allow_nssai 01,D143A5,02,D143A5,03,D143A5 -amfsetid 1}

    comment   3. Idle UE Registration Mobility. Requested NSSAI having new NSSAI, AMD not support NSSAI and AMF query NSSF.
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationMobility -nssfsel true -subscription_retrival nssai_only -snssai "1,D143A5,,,2,D143A5,,,3,D143A5,,,3,ABCDE3,,,"
    ...                  -postinitproc {::SetIeNssaiSelectionRsp -allow_nssai 01,D143A5,02,D143A5,03,D143A5 -amfsetid 1}

    comment   4. Idle UE Registration Periodic, with pereodic update UE not sending requested NSSAI. no NSSF query
#### TAU without any NSSAI, no new NSSAI, no NSSF query
    IOTA Procedure    5gNgRelease
    IOTA Procedure    5gRegistrationPeriodic -snssai ""

    IOTA Procedure    5gServiceReqSignalling
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration
    PMOnDemand.report_request    yes    200



*** UE Configuration Update procedure

*** SMF selection when pdu established
This procedure may be skipped altogether if SMF information is available in the AMF by other means (e.g. locally configured); otherwise:
**** -	when the serving AMF is aware of the appropriate NRF to be used to select NFs/services within the corresponding Network Slice instance based on configuration or based on the Network Slice selection information received during Registration, only steps 3 and 4 in the following procedure are executed as described in Figure 4.3.2.2.3.2-1;


****	when the serving AMF is not aware of the appropriate NRF to be used to select NFs/services within the corresponding Network Slice instance, all steps in the following procedure are executed as described in Figure 4.3.2.2.3.2-1.
case mso0542
1.	The AMF invokes the Nnssf_NSSelection_Get service operation from the NSSF in serving PLMN with the S-NSSAI of the VPLMN from the Allowed NSSAI requested by the UE, PLMN ID of the SUPI, TAI of the UE and the indication that the request is within a procedure of PDU Session establishment in either the non-roaming or roaming with local breakout scenario.
2.	The NSSF in serving PLMN selects the Network Slice instance, determines and returns the appropriate NRF to be used to select NFs/services within the selected Network Slice instance, and optionally may return a NSI ID corresponding to the Network Slice instance.
3.	AMF queries the appropriate NRF in serving PLMN by issuing the Nnrf_NFDiscovery_Request including S-NSSAI of the VPLMN for this PDU Session from the Allowed NSSAI, PLMN ID of the SUPI, DNN and possibly NSI ID in case the AMF has stored an NSI ID for the S-NSSAI of the VPMN for this PDU Session from the Allowed NSSAI.
4.	The NRF in serving PLMN provides to the AMF, e.g. FQDN or IP address, of a set of the discovered SMF instance(s) or Endpoint Address(es) of SMF service instance(s) in Nnrf_NFDiscovery_Request response message, and possibly an NSI ID for the selected Network Slice instance corresponding to the S-NSSAI for subsequent NRF queries.

1. amf----nssf-nsselection-get(slice-info-request-for-pdu-session=s-ssnai and tai)----> nssf
/nnssf-nsselection/v2/network-slice-information?nf-type=AMF&amp;nf-id=f9de14cf-9077-448d-961e-33550f1d3194&amp;slice-info-request-for-pdu-session=%
2. nssf --------nrf url to get the smf ------------> amf
@NSSFNSSELECTIONRSP {{NSIINFORMATION {{NRFID http://172.16.59.31:8080/nnrf-disc/v1/c207f08a-b7cd-4989-b830-02a8d0598ea1} {NSIID slice1}
3. amf -------nrf-disc(target=SMF)--------->nrf
{PATH "/nnrf-disc/v1/c207f08a-b7cd-4989-b830-02a8d0598ea1/nf-instances?target-nf-type=SMF&
4.  nrf ----- smf info ------------------->amf
NFDISCOVERRSP {{NFINSTANCES {+_list {{FQDN smf1.com} {IPV4ADDRESSES {+_list "172.16.59.61"}} {NFINSTANCEID "20e0b0c3-82e1-44a4-82ab-a065d80a3b91"}
 
case mso0495
5gPduEstablishment -dnn wap1.nokia.com -sd "D143A5" -sst "1" -nssfsel true    -postinitproc {::SetIeNssaiSelectionRsp -nsi_info true;}
###nssfsel true means simulator nssf should reponse the nssf-nsselection query with parameter: snssai, tai and roamingIndication
/nnssf-nsselection/v1/network-slice-information?nf-type=AMF&nf-id=47ff6da3-c6a2-49d3-86c6-52bf9274d59a&slice-info-request-for-pdu-session={"sNssai":{"sst":1,"sd":"D143A5"},"roamingIndication":"NON_ROAMING"}&tai={"plmn,tac"}

after pdu session create request from GNB to AMF
amf_net1 ---- HEADERSFRAME ---> nssf1_s
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.36:8080"} {METHOD GET} {PATH "/nnssf-nsselection/v1/network-slice-information?nf-type=AMF&nf-id=f5abaa68-70ad-459e-8ad2-25587053cf51&slice-info-request-for-pdu-session=%7B%22sNssai%22:%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D,%22roamingIndication%22:%22NON_ROAMING%22%7D&tai=%7B%22plmnId%22:%7B%22mcc%22:%22460%22,%22mnc%22:%2202%22%7D,%22tac%22:%22007530%22%7D"} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000001}}}} {localName nssf1_s} {remoteName amf_net1}}

amf_net1 <--- DATAFRAME(NSSFNSSELECTIONRSP) ---- nssf1_s
HTTP2 {{BODY {@DATAFRAME {{DATA {NNSSF {{BODY {@NSSFNSSELECTIONRSP {{NSIINFORMATION {{NRFID http://172.16.59.31:8080/nnrf-disc/v1/c207f08a-b7cd-4989-b830-02a8d0598ea1}}}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName nssf1_s} {remoteName amf_net1}}

amf_net1_1 ---- HEADERSFRAME ---> nrf1_s
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.31:8080"} {METHOD GET} {PATH "/nnrf-disc/v1/c207f08a-b7cd-4989-b830-02a8d0598ea1/nf-instances?target-nf-type=SMF&requester-nf-type=AMF&service-names=nsmf-pdusession,nsmf-event-exposure&snssais=%5B%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D%5D&dnn=wap1.nokia.com&tai=%7B%22plmnId%22:%7B%22mcc%22:%22460%22,%22mnc%22:%2202%22%7D,%22tac%22:%22007530%22%7D&requester-nf-instance-fqdn=nokiaAMF.amf.5gc.mnc002.mcc460.3gppnetwork.org"} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000003}}}} {localName nrf1_s} {remoteName amf_net1_1}}

case nbm1226

***** when pdu session established, when amf send to nssf to get correct smf's correct nrf service
The useNssfSelectionServiceForSmf of amfGParms determines if NSSF will be used for SMF slice selection. When set to true, AMF will issue Nnssf_NSSelection_Get query NSSF for slice instance selection for all new PDU session establishments.
when nssf reply with error code, AMF will query NRF configured in local to get smf's address

*** update nssai of amf to nssf
The Nnssf_NSSAIAvailability service is used by the NF service consumer (e.g AMF) to update the S-NSSAI(s) the AMF supports on a per TA basis on the NSSF, subscribe and unsubscribe the notification of any changes to the NSSAI availability information on a per TA basis, of the S-NSSAIs available per TA (unrestricted) and the restricted S-NSSAI(s) per PLMN in that TA in the serving PLMN of of the UE.

5gNssfAvailabilityServices -verbose 1
amf-->nssf  	HEADERS[1]: PUT /nnssf-nssaiavailability/v1/nssai-availability/f5abaa68-70ad-459e-8ad2-25587053cf51
                            with the configured TAI to supportedlist DATA
nssf--->amf       plmnid1:{supportednssailist}   plmnid1:{supportednssailist}
                  nssf reply with DATA which in nssf side, amf will update the tai to supportedList in its cache

[cmm@espate139b-necc0 ~]$ cmm nssfCacheAdmin list
[cmm@espate139b-necc0 ~]$ cat /var/log/cfgmgr/NSSFQuery-2019-11-01T08:30:55.683174Z.out

 Tai To List of Supported SNSSAI Map
 Number of entries found : 23
-------------------
TAI:     460 0215 6500
-------------------
List of SNSSAI:
{
 sst          sd
 1          13714341
 2          13714341
 3          13714341
 4          }
-------------------


ITE7 verify nssfCacheAdmin
    [Tags]    tc_prio_1
    IOTA Async Procedure Start    5gNssfAvailabilityServices -verbose 1
    CMM Command    cmm amfGParms modify --amfGparmName useNssfAvailabilityService --amfGparmValue true
    IOTA Async Procedure Wait For Completion
    CMM Command    cmm nssfCacheAdmin list
    sleep    4s
    IOTA Async Procedure Start    5gNssfAvailabilityServices -verbose 1
    CMM Command    cmm nssfCacheAdmin modify --cacheSource nssf --nssfCacheOperation flushCache
    IOTA Async Procedure Wait For Completion
    CMM Command    cmm nssfCacheAdmin list
    CMM Command    cmm nssfCacheAdmin modify --cacheSource prov --nssfCacheOperation flushCache
    sleep    4s



* type of NSSAI 
 NSSAI. The following NSSAIs are defined in 3GPP TS 23.501 [8]:
a)	configured NSSAI;(it means all NF configured all through signalling)
b)	requested NSSAI; (ue registartion request)
    Ue should only requested the nssai configured in UDM, if requestd NSSAi beyond the returned list in UDM, then 
    AMF will return the udm's nssai list as configured nssai in ResgistrationAccept.
c)	allowed NSSAI;  (amf registartion accept allowed NSSAI for this ue/tac)
d)	subscribed S-NSSAIs; (udm return the subscription's NSSAI)



** Get nssai from udm of the subscription's nssai (UDM subs list)   
amf----------------- /nudm-sdm/v1/imsi-460020301001001/nssai---------> udm
amf<-----------------defaultSingleNssais[singleNssai[{sst:,sd:}...] ---------> udm
UDM subs list:      1,D143A5   6,ABCDE6 (default)
                    1,ABCDE1 2,ABCDE2 3,ABCDE3 4,ABCDE4 5,ABCDE5 4 (other NSSAI)

if ue not send requested nssai, then AMF will send this whole list (default and other NSSAI) in configured nssai IE of RegistrationAccept message.
=================================================================================
mau1209_c2 Registration without Requested NSSAI, AMF not support some default NSSAI from UDM, AMF query NSSF and receiving own AMF setid and config NSSAI, Registration proceed.
    [Tags]    tidnum_mau1209_c2    regression    release_cmm19.5_m3
    [Documentation]    Registration Req without Requested NSSAI, AMF get subscribed NSSAI from UDM, If AMF not supported all default S-NSSAI from UDM,
    ...                AMF query NSSF and received serving AMF set id , AMF proceed with Registration.
    ...                If all default S-NSSAI allowed in current TAI,
    ...                Allowed NSSAI: all default S-NSSAI.
    ...                Rejected NSSAI: None - as UE did not request any NSSAI.
    ...                Configured NSSAI: all subscribed S-NSSAI
    ...                Req NSSAI  list:        None - As UE not requested any NSSAI.
    ...                MME Prov   list:        1,D143A5   2,D143A5  3,D143A5 4
    ...                UDM subs   list:        1,D143A5   6,ABCDE6 (default nssai)
    ...                                        1,ABCDE1 2,ABCDE2 3,ABCDE3 4,ABCDE4 5,ABCDE5 4 (other NSSAI)
    ...                NSSF allow list:        1,D143A5   2,D143A5  3,D143A5
    comment    1. Registration SUCI, UE not sending requested NSSAI. AMF not support all subscribed default NSSAI, AMF query NSSF, NSSF provide own AMFsetid.
    ...           AMF proceed with registration.
        ...           Default NSSAI having one NSSAIs.
    IOTA Procedure    5gRegistrationSuci -snssai "" -reroute no_reroute
    ...              -postinitproc {::SetIeNssaiSelectionRsp -config_nssai 01,D143A5,02,D143A5,03,D143A5 -amfsetid 001;
    ...                   ::SetUdmSubscribedNssai -dft_nssai "01,D143A5,06,ABCDE6" -non_dft_nssai "02,D143A5,03,D143A5,01,ABCDE1,02,ABCDE2,03,ABCDE3,04,ABCDE4,05,ABCDE5,4,,";
    ...                    vfy_IE_RegistrationAccept
    ...                    -allow_nssai \\$0401D143A5
    ...                    -rej_nssai EMPTY
    ...                    -config_nssai \\$0401D143A50406ABCDE60402D143A50403D143A50401ABCDE10402ABCDE20403ABCDE30404ABCDE40405ABCDE50104}
    IOTA Procedure    5gPduEstablishment
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



** Get AMF from NSSF using the nssai list 
*** Get AMF from NSSF using the nssai list in the Registration procedure
when AMF find that the requestd nssai from registrationAccept OR
no request nssai from UE.then AMF get the configured NSSAI list from UDM.

AMF will compare these list with its own supported nssai list, if not all nssai in the list supported, AMF will send NSSF to get a better supported AMF
with these nssais.
AMF-------->NSSF request

GET:path/nnssf-nsselection/v1/network-slice-information?nf-type=AMF&nf-id=47ff6da3-c6a2-49d&slice-info-request-for-registration=%7B%22subscribedNssai%22:%5B%7B%22
subscribedSnssai%22:%7B%22sst%22:1,%22sd%22:%22D143A5%22%7D,%22
defaultIndication%22:true%7D,%7B%22
subscribedSnssai%22:%7B%22sst%22:6,%22sd%22:%22ABCDE6%22%7D,%22defaultIndication%22:true%7D,%7B%22
subscribedSnssai%22:%7B%22sst%22:2,%22sd%22:%22D143A5%22%7D,%22defaultIndication%22:false%7D,%7B%22
subscribedSnssai%22:%7B%22sst%22:3,%22sd%22:%22D143A5%22%7D,%22defaultIndication%22:false%7D,%7B%22
subscribedSnssai%22:%7B%22sst%22:1,%22sd%22:%22ABCDE1%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:2,%22sd%22:%22ABCDE2%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:3,%22sd%22:%22ABCDE3%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:4,%22sd%22:%22ABCDE4%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:5,%22sd%22:%22ABCDE5%22%7D,%22defaultIndication%22:false%7D,%7B%22subscribedSnssai%22:%7B%22sst%22:4%7D,%22defaultIndication%22:false%7D%5D,%22defaultConfiguredSnssaiInd%22:false,%22requestMapping%22:false%7D&tai=%7B%22plmnId%22:%7B%22mcc%22:%22460%22,%22mnc%22:%2202%22%7D,%22tac%22:%22007530%22%7D:schemehttp
:authority172.16.59.36:8080
user-agentamf


AMF<--------NSSF response
{ "configuredNssai": [ { "configuredSnssai": { "sst": 01, "sd": "d143a5" }  } , { "configuredSnssai": { "sst": 02, "sd": "d143a5" }  } ,
{ "configuredSnssai": { "sst": 03, "sd": "d143a5" }  }  ], 
"targetAmfSet": "460-02-01-001" } 
NSSF returned a proper AMF which supported these configuredSnssai and all it suppported snssai, it may less thatn the requested slice list since no AMF supported all these lists


** 	Configuration of Network Slice availability in a PLMN for AMF
 5.15.8	Configuration of Network Slice availability in a PLMN in 23.501
A Network Slice may be available in the whole PLMN or in one or more Tracking Areas of the PLMN.
The availability of a Network Slice refers to the support of the S-NSSAI in the involved NFs. In addition, policies in the NSSF may further restrict from using certain Network Slices in a particular TA.

and signalling among network functions:
a. It is derived by using the S-NSSAIs supported per TA in 5G-AN, (GNB tell AMF throught NG SetupRequest)
b. the S-NSSAIs supported in the AMF,common set of (AMF OAM's plmn snnsaiList) and NG SetupRequest's tac snnsaiList 
c.  operator policies per TA in the NSSF.


The AMF learns the S-NSSAIs supported per TA by the 5G-AN when the 5G-AN nodes establish or update the N2 connection with the AMF (see TS 38.413 [34]) and TS 38.300 [27]). 

 MME Prov snssailist: it depend on AMF's plmn configuration and nsssaiListItem and NGsetup procedure
The availability of a Network Slice in a TA is established end-to-end using a combination of OAM(amf 
cmm@espate139b-necc0 ~]$ cmm amfPlmn show <name> 
cmm@espate139b-necc0 ~]$ cmm snssaiListItem  list




*** AMF configuration of snssai, tai and plmn  
**** AMF configuration of the tai it allowed
cmm amfTai list
[cmm@lm638-necc0 ~]$ cmm amfTai show ETPLMN~30000
|---------------------+---------------------|
| Field               | Value               |
|---------------------+---------------------|
| amfTai              | ETPLMN~30000        |
| plmnName*           | ETPLMN              |
| amfTac*             | 30000               |
| imsVopsSupport      | amfVopsNotSupported |
| snssaiListName      |                     | ##amf-supported S-NSSAI
| timeZoneName        | Default             |
| emergencyServiceTai | false               |
|---------------------+---------------------|
T
cmm amfTai create --plmnName 460_30 --amfTac 3111
but the amfTai list could be updated by NGSetup if a gpram
cmm gParms modify --gParmName discoverTais --gParmValue Yes 


**** AMF configuration of the snssaiList it supported here
ony 3 snssai items include since cmm configured as follow
cmm@espate139b-necc0 ~]$ cmm snssaiListItem list  --snssaiListName Snssai1
|----------------|
| snssaiListItem |
|----------------|
| Snssai1~MIoT   | 0
| Snssai1~URLLC  | 1
| Snssai1~eMBB   | 2
|----------------|

amfSetSnssai  Create, Delete, List, Show  AMF Set Supported S-NSSAI.
cmm amfSetSnssai create --plmnName ETPLMN --amfSetId 1 --amfRegionId 1 --snssaiListName Snssai1
[cmm@lm638-necc0 ~]$ cmm amfSetSnssai show ETPLMN~1~1~Snssai1

+-----------------+--------------------+
| Field           | Value              |
+-----------------+--------------------+
| amfSetSnssai    | ETPLMN~1~1~Snssai1 |
| plmnName*       | ETPLMN             |
| amfRegionId*    | 1                  |
| amfSetId*       | 1                  |
| snssaiListName* | Snssai1            |
+-----------------+--------------------+


[cmm@lm638-necc0 ~]$ cmm amfInstance show ETPLMN~1~1~1   ###local AMF instance with the amfSetSnssai  with the amfRegionId and amfSetId
+----------------------+--------------------------------------+
| Field                | Value                                |
+----------------------+--------------------------------------+
| amfInstance          | ETPLMN~1~1~1                         |
| servedPlmnName*      | ETPLMN                               |
| amfRegionId*         | 1                                    |
| amfSetId*            | 1                                    |
| amfPointer*          | 1                                    |
| instanceId           | c49c505c-a263-4611-b130-7c5643650a98 |
| nfServicesListName   | amfServices                          |
| capacity             | 65535                                |
| enable               | true                                 |
| amfIdLabels          | NokiaAMF                             |
| locality             |                                      |
| priority             | 1                                    |
| userAgentSuffix      |                                      |
| nsiIdListName        |                                      |
| restorationEndPtName |                                      |
| guamiName            | Nokia5GC1                            |



this means that AMF prov nssai allowed
if ENB send taisupportedList(4,abcde) which not supported in configured snssaiListItem, AMF will omit that item

the tai-->snssai table or snssai--->tai table will updated when AMF received ngap's taisupportedList
cmm snssaisOfTaiQuery list --taiMcc 460 --taiMnc 02 --tac 30000 -f json
[cmm@espate139b-necc0 ~]$ cmm amfPlmn show ETPLMN
|-------------------------+-----------------|
| Field                   | Value           |
|-------------------------+-----------------|
| amfPlmn                 | ETPLMN          |
| name*                   | ETPLMN          |
| mcc                     | 460             |
| mnc                     | 02              |
| plmnType                | Home Network    |
| mncDigits               | 2Digits         |
| timeZoneName            | America/Chicago |
| checkImsDnnSubscription | false           |
| ueRadioCapabilityCheck  | false           |
| cmasEnable              | false           |
| amfEmergencyProfileName |                 |
|-------------------------+-----------------|
[cmm@espate139b-necc0 ~]$


**** bond the plmn and snssaiList
[cmm@espate139b-necc0 ~]$ cmm amfSetSnssai list
+--------------------+
| amfSetSnssai       |
+--------------------+
| ETPLMN~1~1~Snssai1 |
+--------------------+
[cmm@espate139b-necc0 ~]$ cmm amfSetSnssai show ETPLMN~1~1~Snssai1
+-----------------+--------------------+
| Field           | Value              |
+-----------------+--------------------+
| amfSetSnssai    | ETPLMN~1~1~Snssai1 |
| plmnName*       | ETPLMN             |
| amfRegionId*    | 1                  |
| amfSetId*       | 1                  |
| snssaiListName* | Snssai1            |
+-----------------+--------------------+
this command tie the plmn "ETPLMN" with the snssaiListName "Snssai1"

***** add another listitem to this snssaiListName  Snssai1

KEYWORD  IOTALib . Iota Async Procedure Start 5gNgAmfConfigurationUpdate, -N2LinkCount ${totalN2Links}
KEYWORD  vMME . Provision Create snssai, name=Test_mvo0089, sliceServiceType=4, sliceDifferentiator=D12345###create a snssai named as Test_vmo0089
KEYWORD  BuiltIn . Sleep 5s
KEYWORD  vMME . Provision Create snssaiListItem, snssaiListName=Snssai1, snssaiName=Test_mvo008 ###Add this snssai to snssaiList Snssai1
EYWORD  IOTALib . Iota Async Procedure Wait For Completio  ### AmfConfigurationUpdate will include this Test_vmo0089 also.




*** NG setup to tell AMF 
supportedTAList: {tac:{snnsai0,snnsai1 }}
NG setup request from GNB will update mme's configuration about the plmnid,tac and snssai.
IOTA Procedure    5gNgSetup   -ta1 ${IOTA.AMF_TAC0}:${CMM.MCC}${CMM.MNC}:01,02,03:000000,D143A5,D143A5 -gNB gnb01 -gnbname gnb01

**** example

KEYWORD  IOTALib . Iota Procedure 5gNgSetup, -ta1 ${IOTA.AMF_TAC0}:${CMM.MCC}${CMM.MNC}:01,02,03,04:D143A5,D143A5,D143A5,ABCDEF -gNB gnb01 -gnbname gnb01 -postinitproc {::ngSetupRetry} 
00:00:01.003 KEYWORD  BuiltIn . Sleep 1s 
 vMME . Cmm Command cmm snssaisOfTaiQuery list --taiMcc 460 --taiMnc 02 --tac 30000 -f json 
14:17:20.143 TRACE Return: [
{'sliceDifferentiator': 'D143A5', 'sliceServiceType': '1', 'snssaisOfTaiQuery': '460~02~30000', 'tac': '30000', 'taiMcc': '460', 'taiMnc': '02'},
 {'sliceDifferentiator': 'D143A5', 'sliceServiceType': '2', 'snssaisOfTaiQuery': '460~02~30000', 'tac': '30000', 'taiMcc': '460', 'taiMnc': '02'},
 {'sliceDifferentiator': 'D143A5', 'sliceServiceType': '3', 'snssaisOfTaiQuery': '460~02~30000', 'tac': '30000', 'taiMcc': '460', 'taiMnc': '02'}] 

### here 04,ABCDEF will be omitted since AMF not configured such snssai

**** singnal
tac 30000
amf_net1 <---- NGSETUPREQUEST --- gnb01
NGAP::NGSETUPREQUEST {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 27} {VALUE {GLOBALRANNODEIDOBJ {{GLOBALRANNODEID {@GLOBALGNBID {{GNBID {@GNBIDBS $05151}} {PLMNIDENTITY $64F020}}}}}}}} {{CRITICALITY 1} {ID 82} {VALUE {RANNODENAMEOBJ {{RANNODENAME gnb01}}}}} {{CRITICALITY 0} {ID 102} {VALUE {SUPPORTEDTALISTOBJ {{SUPPORTEDTALISTLIST {+SUPPORTEDTALISTLISTFLD {{BROADCASTPLMNLISTLIST {+BROADCASTPLMNLISTLISTFLD {{PLMNIDENTITY $64F020} {TAISLICESUPPORTLISTLIST {+TAISLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}} {{SNSSAI {{SD $D143A5} {SST $02}}}} {{SNSSAI {{SD $D143A5} {SST $03}}}} {{SNSSAI {{SD $ABCDEF} {SST $04}}}}}}}}} {TAC $007530}}}}}}}} {{CRITICALITY 1} {ID 21} {VALUE {PAGINGDRXOBJ {{PAGINGDRX 0}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}


NGAP::NGSETUPRESPONSE {{CRITICALITY $00} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 1} {VALUE {AMFNAMEOBJ {{AMFNAME espate139b}}}}} {{CRITICALITY 0} {ID 96} {VALUE {SERVEDGUAMILISTOBJ {{SERVEDGUAMILISTLIST {+SERVEDGUAMILISTLISTFLD {{GUAMI {{AMFPOINTER $01} {AMFREGIONID $01} {AMFSETID $0001} {PLMNIDENTITY $64F020}}}}}}}}}} {{CRITICALITY 1} {ID 86} {VALUE {RELATIVEAMFCAPACITYOBJ {{RELATIVEAMFCAPACITY 5}}}}} {{CRITICALITY 0} {ID 80} {VALUE {PLMNSUPPORTLISTOBJ {{PLMNSUPPORTLISTLIST {+PLMNSUPPORTLISTLISTFLD {{PLMNIDENTITY $64F020} {SLICESUPPORTLISTLIST {+SLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}} {{SNSSAI {{SD $D143A5} {SST $02}}}} {{SNSSAI {{SD $D143A5} {SST $03}}}} {{SNSSAI {{SD $AB43CD} {SST $04}}}}}}}}}}}}}}} {localName gnb01} {remoteName amf_net1}}
amf_net1 ---- NGSETUPRESPONSE ---> gnb01

plmnidentity:$64F020



*** update the N2 connection using RAN configuration update/response (ngap and amf) 
NG---->amf
NGAP:RANCONFIGURATIONUPDATE {{PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 1} {ID 82} {VALUE {RANNODENAMEOBJ {{RANNODENAME gnb01}}}}} {{CRITICALITY 0} {ID 102} {VALUE {SUPPORTEDTALISTOBJ {{SUPPORTEDTALISTLIST {+SUPPORTEDTALISTLISTFLD {{BROADCASTPLMNLISTLIST {+BROADCASTPLMNLISTLISTFLD {{PLMNIDENTITY $64F020} {TAISLICESUPPORTLISTLIST {+TAISLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $AB43CD} {SST $04}}}}}}}}} {TAC $007530}}}}}}}} {{CRITICALITY 1} {ID 21} {VALUE {PAGINGDRXOBJ {{PAGINGDRX 3}}}}}}} {localName gnb01} {remoteName amf_net1} {streamId 1}}

if taislicesupportelist with not configured snssai confiured in AMF, AMF will retrun fail 

amf---->NG
RANConfigurationUpdateFailure(cause: slice not supported)

amf---->NG
RANConfigurationUpdateAcknowledge

One or all AMF per AMF Set provides and updates the NSSF with the S-NSSAIs support per TA. The 5G-AN learns the S-NSSAIs per PLMN ID the AMFs it connects to support when the 5G-AN nodes establishes the N2 connection with the AMF or when the AMF updates the N2 connection with the 5G-AN (see TS 38.413 [34] and TS 38.300 [27]).


*** amf tell GNB its plmn related snssai and capacity 
AmfConfigurationUpdate
NGAP::AMFCONFIGURATIONUPDATE {{CRITICALITY $00} {PROTOCOLIESLIST {+PROTOCOLIESLISTFLD {{CRITICALITY 0} {ID 1} {VALUE {AMFNAMEOBJ {{AMFNAME espate138b}}}}} {{CRITICALITY 0} {ID 96} {VALUE {SERVEDGUAMILISTOBJ {{SERVEDGUAMILISTLIST {+SERVEDGUAMILISTLISTFLD {{GUAMI {{AMFPOINTER $01} {AMFREGIONID $01} {AMFSETID $0001} {PLMNIDENTITY $64F020}}}}}}}}}} {{CRITICALITY 1} {ID 86} {VALUE {RELATIVEAMFCAPACITYOBJ {{RELATIVEAMFCAPACITY 5}}}}} {{CRITICALITY 0} {ID 80} {VALUE {PLMNSUPPORTLISTOBJ {{PLMNSUPPORTLISTLIST {+PLMNSUPPORTLISTLISTFLD {{PLMNIDENTITY $64F020} {SLICESUPPORTLISTLIST {+SLICESUPPORTLISTLISTFLD {{SNSSAI {{SD $D143A5} {SST $01}}}} {{SNSSAI {{SD $D143A5} {SST $02}}}} {{SNSSAI {{SD $D143A5} {SST $03}}}} {{SNSSAI {{SST $04}}}} {{SNSSAI {{SD $D12345} {SST $04}}}}}}}}}}}}}}} {localName gnb08} {remoteName amf_net1}}


AmfConfigurationUpdateAck

** NNRF and AMF interaction for AMF to tell NRF it supported tac 
case nbm1128
when AMF's tac list updated such as "cmm amfTai list" showed, it should put the tailist to NRF's service.
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $04} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.31:8080"} {CONTENTLEN "3509"} {CONTENTTYPE application/json} {METHOD PUT} {PATH /nnrf-nfm/v1/nf-instances/459ca86b-c424-4fc5-9b2f-05ad14dff185} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000005}}}} {localName nrf1_s} {remoteName amf_net1_1}}
amf_net1_1 ---- HEADERSFRAME ---> nrf1_s
+++
HTTP2 {{BODY {@DATAFRAME {{DATA {NNRF {{BODY {@NFREGISTERREQ {{AMFINFO {{AMFREGIONID "01"} {AMFSETID "001"} {GUAMILIST {+ {{AMFID $010041} {PLMNID {{MCC "460"} {MNC "02"}}}}}} {TAIRANGELIST {+ {{PLMNID {{MCC "460"} {MNC "02"}}} {TACRANGELIST {+ {{END $00196E} {START $001964}} {{END $00753C} {START $007530

** NSSF and AMF interaction to configure AMF's supported snnsalist (NSSF snssai prov list)
The NSSF may be configured with operator policies specifying under what conditions the S-NSSAIs can be restricted per TA and per HPLMN of the UE.
The per TA restricted S-NSSAIs may be provided to the AMFs of the AMF Sets at setup of the network and whenever changed.
The AMF may be configured for the S-NSSAIs it supports with operator policies specifying any restriction per TA and per HPLMN of the UE.

**** amf update the TAI to nssailist (for example, when a new ng setup update a tac-nssailist)
5gNssfAvailabilityServices -verbose 1
amf-->nssf  	HEADERS[1]: PUT /nnssf-nssaiavailability/v1/nssai-availability/f5abaa68-70ad-459e-8ad2-25587053cf51
                            with the configured TAI to supportedlist DATA
amf may update other tac-nssailist, this time only the new one

**** nssf update the tai nssailist and return the whole tai-nssailist
nssf--->amf       plmnid1:{supportednssailist}   plmnid1:{supportednssailist}
                  nssf reply with DATA which in nssf side, amf will update the tai to supportedList in its cache



**** UE Plmn Services defaultSnssaiListName
[cmm@espate139b-necc0 ~]$ cmm amfUePlmnServices show ETPLMN
|--------------------------------+-------------------|
| Field                          | Value             |
|--------------------------------+-------------------|
| amfUePlmnServices              | ETPLMN            |
| name*                          | ETPLMN            |
| servedPlmnName                 | ETPLMN            |
| uePlmnName                     | ETPLMN            |
| sbiTimersProfileListName       | default           |
| snssaiToDnnListName            |                   |
| defaultSnssaiListName          |                   |
| defaultSnssaiSelection         | UDM               |




** 
* AMF configuration
** ipendpoint in nfserviceInstance and networkFunctionInstance different
testcases-iota\f20008-02_Network_Function_Repository_Function\f20008-02_ITE_Dev.robot
case:
Select AUSF from Local with Instance Level Ip IPV6 
   CMM Command    cmm amfUePlmnServices modify --name ETPLMN --ausfSelection LocalProvisionin
   CMM Command    cmm amfServiceIp modify --name N12 --svcIpV6 ${CMM['N12_V6']
   CMM Command    cmm nfIpEndpointList create --name Nausf_ipv6_EpList
   CMM Command    cmm nfIpEndPoint create --name Nausf_IPV6_Ep1 --ipAddress ${IOTA['AUSF7_V6']}
   CMM Command    cmm nfIpEndpoints create --nfIpEndPointListName Nausf_ipv6_EpList --nfIpEndPointName Nausf_IPV6_Ep1
   CMM Command    cmm networkFunctionInstance modify --instanceId ${IOTA['AUSF1_UUID']} --nfIpEndPointListName Nausf_ipv6_EpList
   CMM Command    cmm nfServiceInstance modify --name Nausf_UEAuthentication --nfIpEndPointListName ''
Iota Procedure 5gRegistrationSuci -ausfsim_s ausf2v6_s -ausfipv6 true -for false -verbose 1 
### IOTA['AUSF7_V6'] is the ip address of ausfsim_s ausf2v6_s
## here the nfIpEndPointListName was set empty in nfServiceInstance

*** normal procedure
	2511::993:0:0:1:6	2511:0:0:cc3::c2	HTTP2	271	HEADERS[1]: POST /nausf-auth/v1/ue-authentications, DATA[1] (application/json)
   2511:0:0:cc3::c2	2511::993:0:0:1:6	HTTP2 { "href": "http://[2511:0:0:cc3::c2]:8080/nausf-auth/v1/ue_authentications/imsi-460020301001001/5g-aka-confirmation" } } , "servingNetworkName": "5G:mnc002.mcc460.3gppnetwork.org" } 
   ### above message flow is from nfServiceInstane ipendpoint as the dest addr,if null , then get the ipendpoint from networkfunctionInstance

   172.16.46.201	172.16.59.11	NGAP/NAS-5GS	132	DownlinkNASTransport, Authentication request
   172.16.59.11	172.16.46.201	NGAP/NAS-5GS	128	UplinkNASTransport, Authentication response
	2511::993:0:0:1:6	2511:0:0:cc3::c2	HTTP2	207	HEADERS[3]: PUT /nausf-auth/v1/ue_authentications/imsi-460020301001001/5g-aka-confirmation, DATA[3] (application/json)
    ### this is from networkFunctionInstance ipendpoint, the dest addr




** ipendpoint in nfserviceInstance and networkFunctionInstance conflict
there are both capacity and priority property in the nfserviceInsance and networkFunctionInsance.
if there are two network instance with two different serviceInstance:

for example b9 and ba are both PCF
cmm networkFunctionInstance show c18985be-8028-4bf0-858a-9391c63b67ba/9  type :PCF 
b9: pcfService(priority4 , cap:333): priorty 1, cap 450
ba: pcfService2(priority2, cap 333): priorty 3, cap  789
when select PCF, using capacity of the pcfService, if they are the same, use priority of PCF server.
if both capacity and priority of the different PCF services are the same, then it will consider capacity of the neworkFunctionInstance.
if the above three are the same, then the priority of networkFunctionInstance will be considerd lastly


case:
Select AUSF from Local with Instance Level Ip IPV6 
   CMM Command    cmm amfUePlmnServices modify --name ETPLMN --ausfSelection LocalProvisionin
   CMM Command    cmm amfServiceIp modify --name N12 --svcIpV6 ${CMM['N12_V6']
   CMM Command    cmm nfIpEndpointList create --name Nausf_ipv6_EpList
   CMM Command    cmm nfIpEndPoint create --name Nausf_IPV6_Ep1 --ipAddress ${IOTA['AUSF7_V6']}
   CMM Command    cmm nfIpEndpoints create --nfIpEndPointListName Nausf_ipv6_EpList --nfIpEndPointName Nausf_IPV6_Ep1
   CMM Command    cmm networkFunctionInstance modify --instanceId ${IOTA['AUSF1_UUID']} --nfIpEndPointListName Nausf_ipv6_EpList
   ###but nteworkFunctionInstance's ip is a ipv6 version
###   CMM Command    cmm nfServiceInstance modify --name Nausf_UEAuthentication --nfIpEndPointListName ''
### the nfIpEndPointListName is still a ipv4 version
Iota Procedure 5gRegistrationSuci -ausfsim_s ausf2v6_s -ausfipv6 true -for false -verbose 1 

[cmm@espate171a-necc0 ~]$ cmm amfServiceIp list   ###for local ip of N12, both ipv4 and ipv6 presents
|---------------+---------------+--------------------|
| amfServiceIp  | svcIpV4       | svcIpV6            |
|---------------+---------------+--------------------|
| N12           | 172.16.46.204 | 2511::993:0:0:1:6  |

#### firstly, ServiceInstance's ip is for the ausf/N12 link establishement
INFO:MME-LM-4:AMF Link Operational State Updated: intfc_type=67 old=Unknown, new=Enabled

   Interface    Link_Index Home  Admin_State  Oper_State  Avail_Attr    Identifier
      N12             380     0   Unlocked       Enabled      Unknown          TCP Connected 172.16.59.21:8080 N12_1
####  send /nausf-auth/v1/ue-authentications/
#### got response { "href": "http://172.16.46.204:8080/nausf-auth/v1/ue_authentications/imsi-460020301001001/5g-aka-confirmation" } } , "servingNetworkName": "5G:mnc002.mcc460.3gppnetwork.org" } 
#### then, a networkfunctionInstance should be selected,  the ip is ipv4
#### at last, AMF select networkfunction instance 
###############################################################

DEBUG:AMF-NRFPXY:NRF getNextCandidate_1, found candidate nfId 91f924ea-2bd5-4be0-97a1-aa7067c61957, svcId Nausf_UEAuthentication, nbrIpEndPoint 1, priority 1, capacity 65535
DEBUG:AMF-NRFPXY:NRF sendAusfSelectionRespnse enter, w NrfCandidate
DEBUG:AMF-NRFPXY:NRF getIpEndPoint, nbrIpEndPoint_ 1
DEBUG:AMF-NRFPXY:NRF addIpEndPoint, nbrIpEndPoint_ 1
DEBUG:AMF-NRFPXY:NRF sendAusfSelectionRespnse, AUSFPXY::AUSFFPXY_EV_NF_SEL_RSP sent
UE_FSM: 0002 00000003 00000001 NRF_PXY      AUSF_PXY     AUSFPXY_ST_IDLE AUSFPXY_EV_NF_SEL_RSP AUSFPXY_ST_W4_AUTH_VECTOR_RSP 000000

INFO:MME-LM-4:Duplicated lep_index 8 intf_name 108 remote IP address above; index 380 used by other trans index 47 remote_ip:153b10ac


INFO:MME-LM-4:AMF Link Operational State Updated: intfc_type=67 old=Unknown, new=Enabled

   Interface    Link_Index Home  Admin_State  Oper_State  Avail_Attr    Identifier
      N12             380     0   Unlocked       Enabled      Unknown          TCP Connected 172.16.59.21:8080 N12_1

      +++ 2020/01/15 04:15:14.673 TRACE HIGH ACTIVE cpps:15691 E:1472993 S:37798 (UriRecv.cpp 184 V-cpps0 CMM19.5.2_B2_C24 cmmman 10.10.30.30)

      ERROR:AMF-AUSFPXY-1:UriRecv::parseUri, invalid IPv6 address 172.16.59.21 in URI, no ':'
-------------------------------------------------------------------------------------------------------      
###  but the ipendPointName is a ipv6, but got the authentication server adress is ipv4/nasf-auth, so failed to process

** service instance related info(Remote Service)

[cmm@espate105b-necc0 ~]$ cmm nfServiceInstance list
        | Nudm_SubDataManagement       | Nudm_SubscriberDataManagement |
        | Nudm_SubDataManagement_nlg   | Nudm_SubscriberDataManagement |
        | Nudm_UEContextManagement     | Nudm_UEContextManagement      |
        | Nudm_UEContextManagement_nlg | Nudm_UEContextManagement      |
C:\N-20L6PF1NS7F4-Data\glili\Documents\CMM_20.0\cmm-ft-robottests\testers\cmm\testcases-iota\f20008-02_Network_Function_Repository_Function\f20008-02_ITE_Dev.robot
-v TESTENV:ESP-ATE-171A -v IOTA_PCAPS_DISABLED:0 -t "Registration with DNS all*" testcases-iota\f20008-02_Network_Function_Repository_Function\f20008-02_ITE_Dev.robot
case: Registration with DNS all local provisioning 

*** modification of Service Instace for remote server ip or using fqdn to query dns
    CMM Command    cmm nfServiceInstance modify --name Nudm_SubDataManagement --nfIpEndPointListName Dns_EpList --fqdn sdmf01.com.udm.5gc.mnc004.mcc310.3gppnetwork.org.
    CMM Command    cmm nfServiceInstance modify --name Nudm_UEContextManagement --nfIpEndPointListName Dns_EpList --fqdn uecmf01.com.udm.5gc.mnc004.mcc310.3gppnetwork.org.

*** modifying ServiceInstance using IpEndpointListname(DNS ip) and fqdn

    CMM Command      cmm amfUePlmnServices modify ETPLMN --smfSelection LocalProvisioning --udmSelection LocalProvisioning --ausfSelection LocalProvisioning --pcfSelection LocalProvisioning --amfSelection LocalProvisioning
    CMM Command     cmm nrfCacheAdmin modify --nrfCacheOperation FLUSH_CACHE
    CMM Command    cmm amfUePlmnServices modify ETPLMN --smfSelection LocalProvisioning --udmSelection LocalProvisioning --ausfSelection LocalProvisioning --pcfSelection LocalProvisioning --amfSelection LocalProvisioning
    CMM Command    cmm nrfCacheAdmin modify --nrfCacheOperation FLUSH_CACHE
    CMM Command    cmm networkFunctionInstance modify  --instanceId ${IOTA['NRF1_UUID']}  --enable false
    CMM Command    cmm nfIpEndPoint create --name Dns_Ep --port 8080
    CMM Command    cmm nfIpEndpointList create --name Dns_EpList
    CMM Command    cmm nfIpEndpoints create --nfIpEndPointListName Dns_EpList --nfIpEndPointName Dns_Ep
    CMM Command    cmm nfServiceInstance modify --name Nausf_UEAuthentication --nfIpEndPointListName Dns_EpList --fqdn ausf01.com.ausf.5gc.mnc004.mcc310.3gppnetwork.org.
    CMM Command    cmm nfServiceInstance modify --name Nudm_SubDataManagement --nfIpEndPointListName Dns_EpList --fqdn sdmf01.com.udm.5gc.mnc004.mcc310.3gppnetwork.org.
    CMM Command    cmm nfServiceInstance modify --name Nudm_UEContextManagement --nfIpEndPointListName Dns_EpList --fqdn uecmf01.com.udm.5gc.mnc004.mcc310.3gppnetwork.org.
    CMM Command    cmm nfServiceInstance modify --name Npcf_AMPolicyControl --nfIpEndPointListName Dns_EpList --fqdn ampcf01.com.pcf.5gc.mnc004.mcc310.3gppnetwork.org.
    CMM Command    cmm nfServiceInstance modify --name Npcf_UEPolicyControl --nfIpEndPointListName Dns_EpList --fqdn uepcf01.com.pcf.5gc.mnc004.mcc310.3gppnetwork.org.
    Create DNS A Record    ausf01.com.ausf.5gc.mnc004.mcc310.3gppnetwork.org.
    ...    172.16.59.21

*** local provisioning ip without fqdn
[cmm@espate105b-necc0 ~]$ cmm nfServiceInstance show Nausf_UEAuthentication
+-----------------------------------------+-------------------------------+
| Field                                   | Value                         |
+-----------------------------------------+-------------------------------+
| nfServiceInstance                       | Nausf_UEAuthentication        |
| name*                                   | Nausf_UEAuthentication        |
| service                                 | Nausf_UEAuthentication        |
| apiVersionInUri                         | v1                            |
| httpScheme                              | http                          |
| apiPrefix                               |                               |
| allowedNssais                           | Snssai1                       |
| capacity                                | 65535                         |
| supportedFeatures                       |                               |
| fqdn                                    |                               |
| nfIpEndPointListName                    | Nausf_UEAuthentication_EpList |
| priority                                | 1                             |
| defaultNotificationSubscriptionListName |                               |
| apiMinorVersion                         | 0                             |
| apiPatchVersion                         | 1                             |
+-----------------------------------------+-------------------------------+

[cmm@espate105b-necc0 ~]$ cmm nfIpEndpoints list
|--------------------------------------------------------------|
| nfIpEndpoints                                                |
|--------------------------------------------------------------|
| Nausf_Common_EpList~Nausf_UEAuthentication_Ep1               |
| Nausf_Common_nlgList~Nausf_UEAuthentication_nlgEp1           |
| Nausf_UEAuthentication_EpList~Nausf_UEAuthentication_Ep1     |
| Nausf_UEAuthentication_nlgList~Nausf_UEAuthentication_nlgEp1 |

[cmm@espate105b-necc0 ~]$ cmm nfIpEndPoint show Nausf_UEAuthentication_Ep1
+--------------+----------------------------+
| Field        | Value                      |
+--------------+----------------------------+
| nfIpEndPoint | Nausf_UEAuthentication_Ep1 |
| name*        | Nausf_UEAuthentication_Ep1 |
| ipAddress    | 172.16.59.21               |    ###this is the remote AUSF server ip and port(in gash server iota)
| port         | 8080                       |
+--------------+----------------------------+
[cmm@espate105b-necc0 ~]$


** networkFunction instance related info(nfIpEndPointListName no use?)
[cmm@espate105b-necc0 ~]$ cmm networkFunctionInstance show 91f924ea-2bd5-4be0-97a1-aa7067c61957
+-----------------------------------------+--------------------------------------+
| Field                                   | Value                                |
+-----------------------------------------+--------------------------------------+
| networkFunctionInstance                 | 91f924ea-2bd5-4be0-97a1-aa7067c61957 |
| instanceId*                             | 91f924ea-2bd5-4be0-97a1-aa7067c61957 |
| nfType                                  | AUSF                                 |
| plmnName                                | ETPLMN                               |
| snssaiListName                          |                                      |
| fqdn                                    |                                      |
| capacity                                | 65535                                |
| nfServicesListName                      | ausfServices                         |
| dnnListName                             |                                      |
| supiRangeListName                       |                                      |
| defaultNetworkFunction                  | false                                |
| enable                                  | true                                 |
| nfIpEndPointListName                    | Nausf_Common_EpList                  |
| routingIndicator                        | 0000                                 |
| priority                                | 1                                    |
| groupId                                 |                                      |
| locality                                |                                      |
| amfTaiListName                          |                                      |
| nsiIdListName                           |                                      |
| nrfHeartBeatTimer                       | 60                                   |
| pgwFqdn                                 |                                      |
| nfServicePersistence                    | false                                |
| defaultNotificationSubscriptionListName |                                      |
+-----------------------------------------+--------------------------------------+
[cmm@espate105b-necc0 ~]$ cmm nfIpEndpoints list
|--------------------------------------------------------------|
| nfIpEndpoints                                                |
|--------------------------------------------------------------|
| Nausf_Common_EpList~Nausf_UEAuthentication_Ep1               |
| Nausf_Common_nlgList~Nausf_UEAuthentication_nlgEp1           |
| Nausf_UEAuthentication_EpList~Nausf_UEAuthentication_Ep1     |
| Nausf_UEAuthentication_nlgList~Nausf_UEAuthentication_nlgEp1 |

[cmm@espate105b-necc0 ~]$ cmm nfIpEndPoint show Nausf_UEAuthentication_Ep1
+--------------+----------------------------+
| Field        | Value                      |
+--------------+----------------------------+
| nfIpEndPoint | Nausf_UEAuthentication_Ep1 |
| name*        | Nausf_UEAuthentication_Ep1 |
| ipAddress    | 172.16.59.21               |    ###this is the remote AUSF server ip and port(in gash server iota)
| port         | 8080                       |
+--------------+----------------------------+
[cmm@espate105b-necc0 ~]$


** local service ip
[cmm@espate105b-necc0 ~]$ cmm amfServiceIp list
+---------------+---------------+--------------------+
| amfServiceIp  | svcIpV4       | svcIpV6            |
+---------------+---------------+--------------------+
| AMFSvcCom     | 172.16.46.214 | 2511::993:0:0:1:10 |
| AMFSvcDefault | 172.16.46.212 | 2511::993:0:0:1:e  |
| AMFSvcEE      | 172.16.46.215 | 2511::993:0:0:1:11 |
| AMFSvcLoc     | 172.16.46.213 | 2511::993:0:0:1:f  |
| AMFSvcMt      | 172.16.46.216 | 2511::993:0:0:1:12 |
| N2            | 172.16.46.201 | 2511::993:0:0:1:3  |   RAN
| N8            | 172.16.46.202 | 2511::993:0:0:1:4  |   UDM
| N11           | 172.16.46.203 | 2511::993:0:0:1:5  |   SMF
| N12           | 172.16.46.204 | 2511::993:0:0:1:6  |   AUSF
| N14           | 172.16.46.205 | 2511::993:0:0:1:7  |   AMF
| N15           | 172.16.46.206 | 2511::993:0:0:1:8  |   PCF
| N17           | 172.16.46.207 | 2511::993:0:0:1:9  |  5g-EIR 
| N20           | 172.16.46.230 | 2511::993:0:0:1:20 |   SMSF
| N22           | 172.16.46.208 | 2511::993:0:0:1:a  |    NSSF
| N26           | 172.16.46.209 | 2511::993:0:0:1:b  |    MME
| NLg1          | 172.16.46.236 | 2511::993:0:0:1:26 |
| NLs1          | 172.16.46.232 | 2511::993:0:0:1:22 |
| NfyAMF        | 172.16.46.218 | 2511::993:0:0:1:14 |
| NfyAUSF       | 172.16.46.219 | 2511::993:0:0:1:15 |
| NfyCBCF       | 172.16.46.240 | 2511::993:0:0:1:2a |
| NfyEIR        | 172.16.46.217 | 2511::993:0:0:1:13 |
| NfyNLg1       | 172.16.46.237 | 2511::993:0:0:1:28 |
| NfyNLs1       | 172.16.46.233 | 2511::993:0:0:1:24 |
| NfyNRF        | 172.16.46.220 | 2511::993:0:0:1:16 |
| NfyNSSF       | 172.16.46.221 | 2511::993:0:0:1:17 |
| NfyPCF        | 172.16.46.222 | 2511::993:0:0:1:18 |
| NfySMF        | 172.16.46.223 | 2511::993:0:0:1:19 |
| NfySMSF       | 172.16.46.231 | 2511::993:0:0:1:21 |
| NfyUDM        | 172.16.46.224 | 2511::993:0:0:1:1a |
| Nnrf          | 172.16.46.210 | 2511::993:0:0:1:c  |
| Nsms          | 172.16.46.211 | 2511::993:0:0:1:d  |
+---------------+---------------+--------------------+


* How AMF get ausf, udm, nrf,smf, smsf, pcf 's address
** configure in AMF using LocalProvisioning or NRF
cmm amfUePlmnServices modify ETPLMN --udmSelection LocalProvisioning --ausfSelection LocalProvisioning --pcfSelection NRF  
  --udmSelection {NoProvisioning,LocalProvisioning,NRF,NRFLocalProvisioning}
                        The parameter specifies the method of UDM selection used by the AMF for UE. If
                        there are multiple UDM matches then the AMF will the capacity parameter to load
                        balance the UE across the UDMs.
                        [default = LocalProvisioning].
  --defaultUdmSelection {true,false}
                        If the parameter is set to 'true' then the AMF will select a UDM that supports
                        all the SUPI range of a PLMN or UDM provisioned as a default UDM if the AMF fails to select a UDM supporting the UE SUPI..
                        [default = true].

LocalProvisioning - Local Provisioning - AMF will use locally provisioned NF for the selection of a NF.
NRF - Network Repository Function - Make use of NRF to select NF.
NRFLocalProvisioning - NRF with Local Provisioning Override - The AMF will check the locally provisioned selection rules and if there is a match then the AMF will select the NF matching the rule. If there is no matching then AMF will use the NRF. The selection rule by default is that AMF will select a NF supporting a provisioned criterion for the NF.
NoProvisioning - No Provisioning - Use smfSelection from amfUePlmnServices


*** case for NRFLocalProvisioning
mso0416 Selecting AUSF from NRF service Level IP with IPV6 during UERegistration
    [Tags]    tidnum_mso0416    tc_prio_1    regression
    [Documentation]   To verify during UE Registration, AMF will select AUSF (service level IP) using NRF when NRF local provisioning is configured in plmn level
                      ...    where SUCI range matches, and IPv6 and IPv4 has been provided in the service level and in Instance Level, FQDN is present and not IP's for the Get response


    CMM Command    cmm amfServiceIp modify --name N12 --svcIpV6 ${CMM['N12_V6']} --svcIpV4 0.0.0.0
    CMM Command    cmm amfUePlmnServices modify --name ETPLMN --ausfSelection NRFLocalProvisioning
    IOTA Procedure    5gRegistrationSuci -ausfsim_s ausf1v6_s -ausf_nrfdisc true -ausfipv6 true -postinitproc {::mso0416} -verbose 1 -validatesim true
    IOTA Procedure    5gUeDeRegistration
    IOTA Procedure    5gUdmDeRegistration

*** masterlog 
[cmm@espate171a-necc0 ~]$ cmm nfIpEndPoint show Nausf_UEAuthentication_Ep1  ###remote ausf ip is ipv4
|--------------+----------------------------|
| Field        | Value                      |
|--------------+----------------------------|
| nfIpEndPoint | Nausf_UEAuthentication_Ep1 |
| name*        | Nausf_UEAuthentication_Ep1 |
| ipAddress    | 172.16.59.21               |
| port         | 8080                       |
|--------------+----------------------------|

'cmm amfServiceIp modify --name N12 --svcIpV6 2511:0:0:993:0:0:1:6 --svcIpV4 0.0.0.0 -f json'. ###local N12 address for ausf is ipv6
  "svcIpV4": "0.0.0.0", 
  "name*": "N12", 
  "svcIpV6": "2511::993:0:0:1:6", 
  "amfServiceIp": "N12"
 

[cmm@espate171a-necc0 ~]$
 UE_INITIAL SAVE_N2_INTLUEMSG_EV UE_INITIAL 000000   ## receive initial message registration request

NRF getNrfServiceFromCandidates, Found suitable NRF discovery serviceo
--------------------------------------------------------------------------------------------------
DEBUG:AMF-NRFPXY:NRF handleAusfSelReq enter, 
DEBUG:AMF-NRFPXY:NRF selectDiffAusf enter, 
DEBUG:AMF-NRFPXY:NRF selectDiffAusf, not a reselection case
DEBUG:AMF-NRFPXY:NRF handleAusfSelReq, fill ipAddrType using SBI_N12_1


DEBUG:AMF-NRFPXY:NRF getLocalIpType, ipAddrType 2  ####local serviceip is ipv6, but local nteworkFunctionInstance/serviceip is ipv4
DEBUG:AMF-NRFPXY:NRF handleAusfSelReq, amfUePlmnServices.def_ausf_selection 3   ####true or false 


DEBUG:AMF-NRFPXY:NRF handleAusfSelReq, Select AUSF from Remote with override  ####since local ipaddr for N12 is ipv6, use nrf to query  
DEBUG:AMF-NRFPXY:NRF handleAusfSelReq, Select AUSF from local cache with override
DEBUG:AMF-NRFPXY:NRF selectAusf enter, pAusfCandidateList->size() 0
DEBUG:AMF-NRFPXY:NRF isMatch enter, svcIdx 0
DEBUG:AMF-NRFPXY:NRF isMatch, ueAuthService_.isSupported true
DEBUG:AMF-NRFPXY:NRF isMatch, UeHomePlmn match true
DEBUG:AMF-NRFPXY:NRF isMatch, ausfSelReq.isSupiPresent 0, nbrSupiRange_ 0
DEBUG:AMF-NRFPXY:NRF isMatch, ausfSelReq.isGroupIdPresent 0


DEBUG:AMF-NRFPXY:NRF getAuthSvc enter, 
DEBUG:AMF-NRFPXY:NRF selectAusf, pAusfCandidateList added
DEBUG:AMF-NRFPXY:NRF addCandidates enter, size 0, localIpAddrType 2  ##ipv6
DEBUG:AMF-NRFPXY:NRF addCandidates, nfService.getPriority() 1
DEBUG:AMF-NRFPXY:NRF addCandidates, nfService.isCapacityPresent()  true 
DEBUG:AMF-NRFPXY:NRF resetNbrIpEndPoint, nbrIpEndPoint_ = 0
DEBUG:AMF-NRFPXY:NRF addCandidates, nfService.getNbrIpEndPoints() 1
DEBUG:AMF-NRFPXY:NRF addCandidates, isIpv4() = 1 isIpv6() 0
DEBUG:AMF-NRFPXY:NRF addCandidates, localIpAddrType 2

#### this is the local provision for ausf networkinstance
ERROR:AMF-NRFPXY-1:NRF addCandidates, no ip end point, skip candidate nfId 91f924ea-2bd5-4be0-97a1-aa7067c61957, svcId Nausf_UEAuthentication, nbrIpEndPoint 0, priority 1, capacity 65535

DEBUG:AMF-NRFPXY:NRF getRemoteNrfTable enter, Remote NRF Table, access without NRF_ID

+++ 2020/01/14 08:34:08.273 TRACE HIGH ACTIVE cpps:15562 E:773405 S:19469 (NrfAusfSel.cpp 194 V-cpps1 CMM19.5.2_B2_C24 cmmman 10.10.30.31)
DEBUG:AMF-NRFPXY:NRF handleAusfSelReq, Select AUSF from Remote cache since Not found in local
-----------------------------------------------------------------------------------

------------------------------------
DEBUG:AMF-NRFPXY:NRF createDiscoveryUri enter, 

+++ 2020/01/14 08:34:08.273 TRACE HIGH ACTIVE cpps:15562 E:773445 S:19509 (NrfCppsSmf.cpp 200 V-cpps1 CMM19.5.2_B2_C24 cmmman 10.10.30.31)

DEBUG:AMF-NRFPXY:NRF printUri, IP=172.16.59.31, Port=8080

+++ 2020/01/14 08:34:08.273 TRACE HIGH ACTIVE cpps:15562 E:773446 S:19510 (NrfCppsSmf.cpp 201 V-cpps1 CMM19.5.2_B2_C24 cmmman 10.10.30.31)

DEBUG:AMF-NRFPXY:NRF printUri, Path=/nnrf-disc/v1/nf-instances

+++ 2020/01/14 08:34:08.544 TRACE HIGH ACTIVE cpps:15562 E:773501 S:19564 (NrfCandidate.cpp 897 V-cpps1 CMM19.5.2_B2_C24 cmmman 10.10.30.31)

DEBUG:AMF-NRFPXY:NRF printCandidateList, found candidate nfId 91f924ea-2bd5-4be0-97a1-aa7067c61958, svcId Nausf_UEAuthentication, nbrIpEndPoint 1, priority 0, capacity 0

----------------------------------


-----------------------------
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.31:8080"} {METHOD GET} {PATH "/nnrf-disc/v1/nf-instances?service-names=nausf-auth&target-nf-type=AUSF&requester-nf-type=AMF&routing-indicator=1234&requester-nf-instance-fqdn=NokiaAMF.amf.5gc.mnc002.mcc460.3gppnetwork.org"} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000005}}}} {localName nrf1_s} {remoteName amf_net1_1}}


HTTP2 {{BODY {@DATAFRAME {{DATA {NNRF {{BODY {@NFDISCOVERRSP {{NFINSTANCES {+_list {{AUSFINFO {{GROUPID groupid-04030201-123-89-01}}} {FQDN ausf2.com} {NFINSTANCEID "91f924ea-2bd5-4be0-97a1-aa7067c61958"} {NFSERVICES {+_list {{FQDN ausf2.service.com} {IPENDPOINTS {+_list {{IPV6ADDRESS "2511:0:0:cc3::c1"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME http} {SERVICEINSTANCEID Nausf_UEAuthentication} {SERVICENAME nausf-auth} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}}}} {NFSTATUS REGISTERED} {NFTYPE AUSF} {PLMNLIST {+_list {{MCC "460"} {MNC "02"}}}}}}} {VALIDITYPERIOD "1000"}}}}}}} {FLAGS $01} {STREAMID $00000005}}}} {localName nrf1_s} {remoteName amf_net1_1}}
------------------------



** nrf cache operation
NRF Cache Check
    ${active_ipds}=    Get Active Ipds
    Run Keyword If    '${active_ipds}' == 'ipds0'    Execute Necc Command    sudo ssh ${active_ipds}.local "echo -e pCiDNl | /opt/app/bin/iomn ipds_060"
    ...    ELSE    Execute Necc Command    sudo ssh ${active_ipds}.local "echo -e pCiDNl | /opt/app/bin/iomn ipds_061"

NRF Flush Cache
    ${active_ipds}=    Get Active Ipds
    Run Keyword If    '${active_ipds}' == 'ipds0'    Execute Necc Command    sudo ssh ${active_ipds}.local "echo -e pCiDNf | /opt/app/bin/iomn ipds_060"
    ...    ELSE    Execute Necc Command    sudo ssh ${active_ipds}.local "echo -e pCiDNf | /opt/app/bin/iomn ipds_061"

NRF CacheAdmin NFType
    [Arguments]    ${nfType}
    ${out_list}=   CMM Command    cmm nrfCacheAdmin list --nfType ${nfType}
    dump robot elements    out_list    ${out_list}
    ${nrfcache}=    Set Variable     ${out_list[0]['nrfFileName']}
    Sleep    5
    Log  ${nrfcache}
    ${cache}=    Execute Necc Command    cat ${nrfcache}
    Log  ${cache}

NRF CacheAdmin InstanceId
    [Arguments]    ${instanceId}    ${nfType}
    ${out_list}=   CMM Command    cmm nrfCacheAdmin list --instanceId ${instanceId} --nfType ${nfType}
    dump robot elements    out_list    ${out_list}
    ${nrfcache}=    Set Variable     ${out_list[0]['nrfFileName']}
    Sleep    5
    Log  ${nrfcache}
    ${cache}=    Execute Necc Command    cat ${nrfcache}
    Log  ${cache}



there are two kinds of nrf caches: 
1.local provision with networkfunction/sericeInstace
2.nrf discovery cache (info get from remote nrf) 

echo -e pCiDN | /opt/app/bin/iomn ipds_060

Exiting Display NRF IPDS cache for Local NRF
h
        Command Options for NRF Sub-Menu

        h - help
        q - quit

        a  - enable NRF IPDS DLOGs
        b  - disable NRF IPDS DLOGs
        c  - Test "cmm nrfCachAdmin "
        f  - Clear all NRF cache
        l  - Dump all NRF short info
        m  - Test Profile Msg Optimization
        p  - Manually provision NRF
        r  - Reread/reload local NRF info
        s  - NF Discover Test Menu
        t  - NF Registration Test Menu
        u  - Display Nf Type Info
        v  - Build RemoteNrf Cache
        x  - Delete Nf Type
        y  - Delete NF Instance
        z  - Send NF Profiles to a CPPS
        N  - Negative Cache Sub-Menu
        S  - NF Status Subscribe/Notify Test Menu
        7  - Display NRF IPDS cache for Local NRF
        8  - Display NRF CPPS cache for Remote NRF
        e  - Display Sbi Version profile

*** list local provision cache
7
a
size of AUSF map: 1
Printing AUSF info
*********************************************
 NF INSTANCE ID: 91f924ea-2bd5-4be0-97a1-aa7067c61957
 NF TYPE: AUSF
 NF STATUS: REGISTERED
 Number of PLMN: 1
 PLMN: 460 02f
 FQDN: EMPTY
 nbrIpv4Addr: 1
   IPV4 ADDRESS: 172.16.59.21
 nbrIpv6Addr: 0
 CAPACITY: 65535
 LOAD: 0
 LOCALITY:
 PRIORITY: 1
 DEFAULT: 0
 NUM_SNSSAI: 0
 nbrNsi_ : 0
 nbrDefaultNotifSub : 0
 isGroupIdPresent : 0
 nbrRoutingInd : 0
 nbrSupiRange : 0
 nbrAuthSvc : 1
 ueAuthService_[0]
         isSupported : 1
         serviceInstanceId : Nausf_UEAuthentication
         serviceName : nausf-auth
         serviceScheme : http
         nfServiceStatus : REGISTERED
         isBlacklisted : false
         isFqdnPresent : 0
         isInterPlmnFqdnPresent :0
         isApiPrefixPresent :0
         nbrIpEndPoints_ : 1
         Service IPV4 ADDRESS : 172.16.59.21, port : 8080
         nbrAllowedPlmn : 0
         capacity : 65535
         load : 0
         Priority : 1
         nbrVersion : 1
         Version : 1.0.1
         nbrIpEndPoints : 1
         nbrDefaultNotifSub : 0
         nbrAllowedPlmn : 0
         nbrAllowedNssai : 4
         allowedNssai_ sst : 1
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 2
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 3
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 4
         allowedNssai_ isSdPresent : 0
         nbrAllowedDomain : 0
         ***********************
*********************************************


q

*** list nrf discovery cache
8
Entering Display NRF CPPS cache for Remote NRF
h
        Command Options for Display NRF CPPS cache for Remote NRF

        h - help
        q - quit

        a  - Display AUSF profile from NRF discovery
        b  - Display UDM profile from NRF discovery
        c  - Display SMF profile from NRF discovery
        d  - Display PCF profile from NRF discovery
        e  - Display other AMF profile from NRF discovery
        f  - Display NRF profile from NRF discovery
        g  - Display GMLC profile from NRF discovery
        i  - Display 5gEir profile from NRF discovery
        j  - Display LMF profile from NRF discovery
a
size of AUSF map: 1
Printing AUSF info
*********************************************
 NF INSTANCE ID: 91f924ea-2bd5-4be0-97a1-aa7067c61958
 NF TYPE: AUSF
 NF STATUS: REGISTERED
 Number of PLMN: 1
 PLMN: 460 02f
 FQDN: ausf2.com
 nbrIpv4Addr: 1
   IPV4 ADDRESS: 172.16.59.22
 nbrIpv6Addr: 0
 CAPACITY: 0
 LOAD: 0
 LOCALITY:
 PRIORITY: 0
 DEFAULT: 0
 nfServicePersistence 0
 NUM_SNSSAI: 0
 nbrNsi_ : 0
 nbrDefaultNotifSub : 0
 timeToExpireInMs 3787892453221, Profile will expire in 603 Seconds
 isGroupIdPresent : 1
    groupId : groupid-04030201-123-89-01
 nbrRoutingInd : 0
 nbrSupiRange : 0
 nbrAuthSvc : 1
 ueAuthService_[0]
         isSupported : 1
         serviceInstanceId : Nausf_UEAuthentication
         serviceName : nausf-auth
         serviceScheme : http
         nfServiceStatus : REGISTERED
         isBlacklisted : false
         isFqdnPresent : 1
         fqdn len : 17
         fqdn : ausf2.service.com
         isInterPlmnFqdnPresent :0
         isApiPrefixPresent :0
         nbrIpEndPoints_ : 1
         Service IPV4 ADDRESS : 172.16.59.22, port : 8080
         nbrAllowedPlmn : 0
         capacity : 0
         load : 0
         Priority : 0
         nbrVersion : 1
         Version : 1.0.1
         nbrIpEndPoints : 1
         nbrDefaultNotifSub : 0
         nbrAllowedPlmn : 0
         nbrAllowedNssai : 0
         nbrAllowedDomain : 0
         ***********************
*********************************************


q
*** clear the nrf discovery cache(only this can be flushed, local provision will not be flushed)
Exiting Display NRF CPPS cache for Remote NRF

Exiting Test "cmm nrfCachAdmin "
h
        Command Options for NRF Sub-Menu

        h - help
        q - quit

        a  - enable NRF IPDS DLOGs
        b  - disable NRF IPDS DLOGs
        c  - Test "cmm nrfCachAdmin "
        f  - Clear all NRF cache
        l  - Dump all NRF short info
        m  - Test Profile Msg Optimization
        p  - Manually provision NRF
        r  - Reread/reload local NRF info
        s  - NF Discover Test Menu
        t  - NF Registration Test Menu
        u  - Display Nf Type Info
        v  - Build RemoteNrf Cache
        x  - Delete Nf Type
        y  - Delete NF Instance
        z  - Send NF Profiles to a CPPS
        N  - Negative Cache Sub-Menu
        S  - NF Status Subscribe/Notify Test Menu
        7  - Display NRF IPDS cache for Local NRF
        8  - Display NRF CPPS cache for Remote NRF
        e  - Display Sbi Version profile
f
Clearing Remote NF profiles Cache

**** local provision still exists
7
Entering Display NRF IPDS cache for Local NRF
h
        Command Options for Display NRF IPDS cache for Local NRF

        h - help
        q - quit

        a  - Display AUSF profile from local provision
        c  - Display SMF profile from local provision
        d  - Display PCF profile from local provision
        e  - Display other AMF profile from local provision
        f  - Display NRF profile from local provision
        g  - Display GMLC profile from local provision
        i  - Displa 5gEIR profile from local provision
        j  - Displa LMF profile from local provision
        1  - Own AMF Profile Menu
a
size of AUSF map: 1
Printing AUSF info
*********************************************
 NF INSTANCE ID: 91f924ea-2bd5-4be0-97a1-aa7067c61957
 NF TYPE: AUSF
 NF STATUS: REGISTERED
 Number of PLMN: 1
 PLMN: 460 02f
 FQDN: EMPTY
 nbrIpv4Addr: 1
   IPV4 ADDRESS: 172.16.59.21
 nbrIpv6Addr: 0
 CAPACITY: 65535
 LOAD: 0
 LOCALITY:
 PRIORITY: 1
 DEFAULT: 0
 nfServicePersistence 0
 NUM_SNSSAI: 0
 nbrNsi_ : 0
 nbrDefaultNotifSub : 0
 isGroupIdPresent : 0
 nbrRoutingInd : 0
 nbrSupiRange : 0
 nbrAuthSvc : 1
 ueAuthService_[0]
         isSupported : 1
         serviceInstanceId : Nausf_UEAuthentication
         serviceName : nausf-auth
         serviceScheme : http
         nfServiceStatus : REGISTERED
         isBlacklisted : false
         isFqdnPresent : 0
         isInterPlmnFqdnPresent :0
         isApiPrefixPresent :0
         nbrIpEndPoints_ : 1
         Service IPV4 ADDRESS : 172.16.59.21, port : 8080
         nbrAllowedPlmn : 0
         capacity : 65535
         load : 0
         Priority : 1
         nbrVersion : 1
         Version : 1.0.1
         nbrIpEndPoints : 1
         nbrDefaultNotifSub : 0
         nbrAllowedPlmn : 0
         nbrAllowedNssai : 4
         allowedNssai_ sst : 1
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 2
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 3
         allowedNssai_ isSdPresent : 1
         allowedNssai_ sd : 13714341
         allowedNssai_ sst : 4
         allowedNssai_ isSdPresent : 0
         nbrAllowedDomain : 0
         ***********************
*********************************************


q

Exiting Display NRF IPDS cache for Local NRF
h
        Command Options for NRF Sub-Menu

        h - help
        q - quit

        a  - enable NRF IPDS DLOGs
        b  - disable NRF IPDS DLOGs
        c  - Test "cmm nrfCachAdmin "
        f  - Clear all NRF cache
        l  - Dump all NRF short info
        m  - Test Profile Msg Optimization
        p  - Manually provision NRF
        r  - Reread/reload local NRF info
        s  - NF Discover Test Menu
        t  - NF Registration Test Menu
        u  - Display Nf Type Info
        v  - Build RemoteNrf Cache
        x  - Delete Nf Type
        y  - Delete NF Instance
        z  - Send NF Profiles to a CPPS
        N  - Negative Cache Sub-Menu
        S  - NF Status Subscribe/Notify Test Menu
        7  - Display NRF IPDS cache for Local NRF
        8  - Display NRF CPPS cache for Remote NRF
        e  - Display Sbi Version profile

**** nfr discovery cache has been wiped
8
Entering Display NRF CPPS cache for Remote NRF
h
        Command Options for Display NRF CPPS cache for Remote NRF

        h - help
        q - quit

        a  - Display AUSF profile from NRF discovery
        b  - Display UDM profile from NRF discovery
        c  - Display SMF profile from NRF discovery
        d  - Display PCF profile from NRF discovery
        e  - Display other AMF profile from NRF discovery
        f  - Display NRF profile from NRF discovery
        g  - Display GMLC profile from NRF discovery
        i  - Display 5gEir profile from NRF discovery
        j  - Display LMF profile from NRF discovery
1
Unrecognized menu item '1'
a
size of AUSF map: 0
Printing AUSF info
*********************************************

** NRF selection with preferred routing indicator

** NRF selection with preferred location
sent nnrf-disc with preferred-locality parameter 
nbm1167 PCF selection by preferred location
    [Tags]    tidnum_nbm1167    regression
    [Setup]    Run Keywords    Test case Setup PCF Selection
    Enable IOTA NRF
    Sleep   5 
    IOTA Procedure    5gRegistrationSuci    -imsi ${IOTA['IMSI11']} -ausfsim_s ausf1_s -pcfsim_s pcf3_s -validatesim true    -postinitproc { set ::c_ue(snd_discoverrsp) "basic_snd_discoveryrsp_multiple_instance_amf"; 


Test case Setup PCF Selection
    Test Setup Registration
    CMM Command    cmm nrfCacheAdmin modify --nrfCacheOperation FLUSH_CACHE
    CMM Command    cmm supiRange create --supiRangeListName HomeSUPI --startSupi 460020401001001 --endSupi 460020401001003
    CMM Command    cmm amfUePlmnServices modify ETPLMN --udmSelection LocalProvisioning --ausfSelection LocalProvisioning --pcfSelection NRF
    CMM Command    cmm amfInstance modify ETPLMN~1~1~1 --locality blr.heb

11:13:39.330 INFO Executing command 'cmm amfInstance modify ETPLMN~1~1~1 --locality blr.heb -f json'. 
 
  "enable": "true", 
  "capacity": "65535", 
  "nsiIdListName": "", 
  "locality": "blr.heb", 
  "instanceId": "fb860c73-5bf3-420e-a78f-13f5d44ca5a9", 
  "amfIdLabels": "NokiaAMF", 
  "amfInstance": "ETPLMN~1~1~1", 
  "priority": "1", 
  "amfSetId*": "1", 
  "amfRegionId*": "1", 
  "userAgentSuffix": "", 
  "nfServicesListName": "amfServices", 
  "servedPlmnName*": "ETPLMN", 
  "amfPointer*": "1"
}
---------------------------------------------------------------------
HTTP2 {{BODY {@HEADERSFRAME {{FLAGS $05} {HDRBLKFRAGMENT {{AUTHORITY "172.16.59.31:8080"} {METHOD GET} {PATH "/nnrf-disc/v1/nf-instances?service-names=npcf-am-policy-control,npcf-ue-policy-control&target-nf-type=PCF&requester-nf-type=AMF&supi=imsi-460020401001001&preferred-locality=blr.heb&requester-nf-instance-fqdn=NokiaAMF.amf.5gc.mnc002.mcc460.3gppnetwork.org"} {SCHEME http} {USERAGENT amf}}} {STREAMID $00000001}}}} {localName nrf1_s} {remoteName amf_net1_1}}



HTTP2 {{BODY {@DATAFRAME {{DATA {NNRF {{BODY {@NFDISCOVERRSP {{NFINSTANCES {+_list {{FQDN pcf1.blr.ngv.com} {IPV4ADDRESSES {+_list "172.16.59.56"}} {LOCALITY blr.ngv} {NFINSTANCEID c18985be-8028-4bf0-858a-9391c63b67b3} {NFSERVICES {+_list {{FQDN pcf1.service.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.56"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME http} {SERVICEINSTANCEID Npcf_AmPolicyControl} {SERVICENAME npcf-am-policy-control} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}}
 {{FQDN pcf1.service2.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.56"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME http} {SERVICEINSTANCEID Npcf_UePolicyControl} {SERVICENAME npcf-ue-policy-control} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}}}} {NFSTATUS REGISTERED} {NFTYPE PCF} {PCFINFO {{DNNLIST {+_list wap1.nokia.com wap2.nokia.com}}}} {PLMNLIST {+_list {{MCC "460"} {MNC "02"}}}} {PRIORITY "2"}}
 {{FQDN pcf2.blr.heb.com} {IPV4ADDRESSES {+_list "172.16.59.60"}} {LOCALITY blr.heb} {NFINSTANCEID d18985be-8028-4bf0-858a-9391c63b67b4} {NFSERVICES {+_list {{FQDN pcf2.service.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.60"} {PORT "8080"} {TRANSPORT TCP}}}} {NFSERVICESTATUS REGISTERED} {SCHEME http}
 {SERVICEINSTANCEID Npcf_AmPolicyControl} {SERVICENAME npcf-am-policy-control} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}} {{FQDN pcf2.service2.com} {IPENDPOINTS {+_list {{IPV4ADDRESS "172.16.59.60"}}}} {NFSERVICESTATUS REGISTERED} {SCHEME http}
 {SERVICEINSTANCEID Npcf_UePolicyControl} {SERVICENAME npcf-ue-policy-control} {VERSIONS {+_list {{APIFULLVERSION "1.0.0"} {APIVERSIONINURI v1}}}}}}} {NFSTATUS REGISTERED} {NFTYPE PCF} {PCFINFO {{DNNLIST {+_list wap1.nokia.com wap2.nokia.com}}}} {PLMNLIST {+_list {{MCC "460"} {MNC "02"}}}} {PRIORITY "1"}}}} {VALIDITYPERIOD "1000"}}}}}}} {FLAGS $01} {STREAMID $00000001}}}} {localName nrf1_s} {remoteName amf_net1_1}}
-------------------------------------------------------------
NRF cache check:

++++++++++++++++++++++++
nsize of PCF map: 2\nPrinting PCF info\n*********************************************\n NF INSTANCE ID: c18985be-8028-4bf0-858a-9391c63b67b3\n NF TYPE: PCF\n NF STATUS: REGISTERED\n Number of PLMN: 1\n PLMN: 460 02f\n FQDN: pcf1.blr.ngv.com\n nbrIpv4Addr: 1\n   IPV4 ADDRESS: 172.16.59.56\n nbrIpv6Addr: 0\n CAPACITY: 0\n LOAD: 0\n LOCALITY: blr.ngv\n PRIORITY: 2\n DEFAULT: 0\n nfServicePersistence 0\n NUM_SNSSAI: 0\n nbrNsi_ : 0\n nbrDefaultNotifSub : 0\n timeToExpireInMs 3787961440805, Profile will expire in 996 Seconds \n\n nbrSupiRange : 0\n nbrDnn : 2\n nbrApcSvc : 1\n amPolicyCtrlService[0]\n\t isSupported : 1\n\t serviceInstanceId : Npcf_AmPolicyControl\n\t serviceName : npcf-am-policy-control\n\t serviceScheme : http\n\t nfServiceStatus : REGISTERED\n\t isBlacklisted : false\n\t isFqdnPresent : 1\n\t fqdn len : 16\n\t fqdn : pcf1.service.com\n\t isInterPlmnFqdnPresent :0\n\t isApiPrefixPresent :0\n\t nbrIpEndPoints_ : 1\n\t Service IPV4 ADDRESS : 172.16.59.56, port : 8080\n\t nbrAllowedPlmn : 0\n\t capacity : 0\n\t load : 0\n\t Priority : 0\n\t nbrVersion : 1\n\t Version : \n\t nbrIpEndPoints : 1\n\t nbrDefaultNotifSub : 0\n\t nbrAllowedPlmn : 0\n\t nbrAllowedNssai : 0\n\t nbrAllowedDomain : 0\n\t ***********************\n uePolicyCtrlService[0]\n\t isSupported : 1\n\t serviceInstanceId : Npcf_UePolicyControl\n\t serviceName : npcf-ue-policy-control\n\t serviceScheme : http\n\t nfServiceStatus : REGISTERED\n\t isBlacklisted : false\n\t isFqdnPresent : 1\n\t fqdn len : 17\n\t fqdn : pcf1.service2.com\n\t isInterPlmnFqdnPresent :0\n\t isApiPrefixPresent :0\n\t nbrIpEndPoints_ : 1\n\t Service IPV4 ADDRESS : 172.16.59.56, port : 8080\n\t nbrAllowedPlmn : 0\n\t capacity : 0\n\t load : 0\n\t Priority : 0\n\t nbrVersion : 1\n\t Version : \n\t nbrIpEndPoints : 1\n\t nbrDefaultNotifSub : 0\n\t nbrAllowedPlmn : 0\n\t nbrAllowedNssai : 0\n\t nbrAllowedDomain : 0\n\t ***********************\n*********************************************\n NF INSTANCE ID: d18985be-8028-4bf0-858a-9391c63b67b4\n NF TYPE: PCF\n NF STATUS: REGISTERED\n Number of PLMN: 1\n PLMN: 460 02f\n FQDN: pcf2.blr.heb.com\n nbrIpv4Addr: 1\n   IPV4 ADDRESS: 172.16.59.60\n nbrIpv6Addr: 0\n CAPACITY: 0\n LOAD: 0\n LOCALITY: blr.heb\n PRIORITY: 1\n DEFAULT: 0\n nfServicePersistence 0\n NUM_SNSSAI: 0\n nbrNsi_ : 0\n nbrDefaultNotifSub : 0\n timeToExpireInMs 3787961440805, Profile will expire in 996 Seconds \n\n nbrSupiRange : 0\n nbrDnn : 2\n nbrApcSvc : 1\n amPolicyCtrlService[0]\n\t isSupported : 1\n\t serviceInstanceId : Npcf_AmPolicyControl\n\t serviceName : npcf-am-policy-control\n\t serviceScheme : http\n\t nfServiceStatus : REGISTERED\n\t isBlacklisted : false\n\t isFqdnPresent : 1\n\t fqdn len : 16\n\t fqdn : pcf2.service.com\n\t isInterPlmnFqdnPresent :0\n\t isApiPrefixPresent :0\n\t nbrIpEndPoints_ : 1\n\t Service IPV4 ADDRESS : 172.16.59.60, port : 8080\n\t nbrAllowedPlmn : 0\n\t capacity : 0\n\t load : 0\n\t Priority : 0\n\t nbrVersion : 1\n\t Version : \n\t nbrIpEndPoints : 1\n\t nbrDefaultNotifSub : 0\n\t nbrAllowedPlmn : 0\n\t nbrAllowedNssai : 0\n\t nbrAllowedDomain : 0\n\t ***********************\n uePolicyCtrlService[0]\n\t isSupported : 1\n\t serviceInstanceId : Npcf_UePolicyControl\n\t serviceName : npcf-ue-policy-control\n\t serviceScheme : http\n\t nfServiceStatus : REGISTERED\n\t isBlacklisted : false\n\t isFqdnPresent : 1\n\t fqdn len : 17\n\t fqdn : pcf2.service2.com\n\t isInterPlmnFqdnPresent :0\n\t isApiPrefixPresent :0\n\t nbrIpEndPoints_ : 1\n\t Service IPV4 ADDRESS : 172.16.59.60, port : 8080\n\t nbrAllowedPlmn : 0\n\t capacity : 0\n\t load : 0\n\t Priority : 0\n\t nbrVersion : 1\n\t Version : \n\t nbrIpEndPoints : 1\n\t nbrDefaultNotifSub : 0\n\t nbrAllowedPlmn : 0\n\t nbrAllowedNssai : 0\n\t nbrAllowedDomain : 0\n\t
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


Printing UDM info
*********************************************
 NF INSTANCE ID: e4a4a1e4-a134-4967-a55f-6db4fb8d2e04
 NF TYPE: UDM
 NF STATUS: REGISTERED
 Number of PLMN: 1
 PLMN: 460 02f
 FQDN: udm2.blr.heb.com
 nbrIpv4Addr: 1
   IPV4 ADDRESS: 172.16.59.71
 nbrIpv6Addr: 0
 CAPACITY: 0
 LOAD: 0
 LOCALITY: blr.manyata
 PRIORITY: 2
 DEFAULT: 0
 nfServicePersistence 0
 NUM_SNSSAI: 0
 nbrNsi_ : 0
 nbrDefaultNotifSub : 0
 timeToExpireInMs 3790477610917, Profile will expire in 991 Seconds 
 isGroupIdPresent : 1
    groupId : groupid-04030201-123-89-01
 nbrRoutingInd : 0
 nbrSupiRange : 1
   start : 460020401001001 end : 460020401001005




Grafana

* networFunctionInstance and serviceInstance
** nfServiceInstance 
two nfServiceInstance with different priority
cmm nfServiceInstance create --name Nnssf_NSSAIAvailability1 --service Nnssf_NSSAIAvailability --apiVersionInUri v1 --apiPatchVersion 1 --httpScheme https --allowedNssais Snssai1 --priority 1 -f json
stdout:                                                            |{
{                                                                  |  "nfIpEndPointListName": "",
  "nfIpEndPointListName": "",                                      |  "capacity": "65535",
  "capacity": "65535",                                             |  "apiMinorVersion": "0",
  "apiMinorVersion": "0",                                          |  "service": "Nnssf_NSSAIAvailability",
  "service": "Nnssf_NSSAIAvailability",                            |  "supportedFeatures": "",
  "supportedFeatures": "",                                         |  "defaultNotificationSubscriptionListName": "",
  "defaultNotificationSubscriptionListName": "",                   |  "name*": "Nnssf_NSSAIAvailability1",
  "name*": "Nnssf_NSSAIAvailability",                              |  "apiPrefix": "",
  "apiPrefix": "",                                                 |  "fqdn": "",
  "fqdn": "",                                                      |  "priority": "1",
  "priority": "2",                                                 |  "apiVersionInUri": "v1",
  "apiVersionInUri": "v1",                                         |  "httpScheme": "https",
  "httpScheme": "http",                                            |  "allowedNssais": "Snssai1",
  "allowedNssais": "Snssai1",                                      |  "apiPatchVersion": "1",
  "apiPatchVersion": "1",                                          |  "nfServiceInstance": "Nnssf_NSSAIAvailability1"
  "nfServiceInstance": "Nnssf_NSSAIAvailability"                   |}
}                                                                  |stderr:
stderr:                                                            |-

*** service list
**** serviceList VS. serviceInstance
***** create/delete serviceList
cmm nfServicesList create --name nssfServices1
cmm nfServicesList delete --name nssfServices1

***** create/delete serviceInstance
cmm nfServiceInstance create --name Nnssf_NSSelection1 --service Nnssf_NSSelection --apiVersionInUri v1 --httpScheme https --allowedNssais Snssai1 --priority 1

***** add/delete serviceInstance to/from serviceListName
servicelistName could have multiple serviceinstance Name
cmm nfServices create --nfServicesListName nssfServices1 --nfServiceInstanceName Nnssf_NSSelection1
cmm nfServices create --nfServicesListName nssfServices1 --nfServiceInstanceName Nnssf_Availability1
***** delete one of the serviceinstance from a serviceList
cmm nfServices delete --nfServicesListName nssfServices --nfServiceInstanceName Nnssf_NSSelection
cmm nfServiceInstance list
  "nfServices": "nssfServices1~Nnssf_NSSAIAvailability1"
    "nfServices": "nssfServices1~Nnssf_NSSelection1"
    "nfServices": "nssfServices~Nnssf_NSSAIAvailability"

***** add one serviceInstance to a serviceList
cmm nfServices create --nfServicesListName nssfServices --nfServiceInstanceName Nnssf_NSSelection 
cmm nfServiceInstance list
  "nfServices": "nssfServices1~Nnssf_NSSAIAvailability1"
    "nfServices": "nssfServices1~Nnssf_NSSelection1"
    "nfServices": "nssfServices~Nnssf_NSSAIAvailability"
    "nfServices": "nssfServices~Nnssf_NSSelection"



***** cmm nfserviceInstance list
| Nnssf_NSSAIAvailability1 | Nnssf_NSSAIAvailability |
| Nnssf_NSSelection1       | Nnssf_NSSelection       |

***** nfServicessList list

***** cmm nfServices list
  "nfServices": "nssfServices1~Nnssf_NSSAIAvailability1"
    "nfServices": "nssfServices1~Nnssf_NSSelection1"
    "nfServices": "nssfServices~Nnssf_NSSAIAvailability"
    "nfServices": "nssfServices~Nnssf_NSSelection"
both servicelistName have tow serviceInstance

** neteworkFunctionInstance
*** nfIpEndpoint related objects
**** nfIpEndpointList
 cmm nfIpEndpointList create --name Nnssf_EpList2
**** nfIpEndPoint with  ip/port 
 cmm nfIpEndPoint create --name Nnssf_Ep2 --ipAddress ${IOTA['NSSF2_V4']} --port 8080
**** add/delete nfIpEndPoint to/from nfIpendpointList 
 cmm nfIpEndpoints create --nfIpEndPointName Nnssf_Ep2 --nfIpEndPointListName Nnssf_EpList2

*** use nfIpendpointList and nfServiceList to create a networkFunctionInstance
bonding nfServicesListName(which could contain multiple nfserviceInstance and ipEndPoint)
cmm networkFunctionInstance create --instanceId 4215d7f7-8fc0-418d-b2a1-1e68633846ac --nfType NSSF --plmnName ETPLMN --nfServicesListName nssfServices1 --nfIpEndPointListName Nnssf_EpList2 


** networkFunctionInstance nssf
*** nssf related timer
cmm sbiTimersProfile modify --sbiTimersProfileListName default --sbiTimerName nssfAvailabilityRetry --sbiTimerValue ${orig_nssfAvailabilityRetry
cmm sbiTimersProfile modify --sbiTimersProfileListName default --sbiTimerName nssfBlacklist --sbiTimerValue 5
cmm sbiTimersProfile modify --sbiTimersProfileListName default --sbiTimerName nssfResponse --sbiTimerValue 2000


*** two nssf with different sfServices
 'cmm networkFunctionInstance create --instanceId 4215d7f7-8fc0-418d-b2a1-1e68633846ac --nfType NSSF --plmnName ETPLMN --nfServicesListName nssfServices1 --nfIpEndPointListName Nnssf_EpList2 -f json'.
08:01:49.362    INFO    Command exited with return code 0.
08:01:49.363    INFO    rc: 0
stdout:
{
  "networkFunctionInstance": "4215d7f7-8fc0-418d-b2a1-1e68633846ac",
  "nfServicePersistence": "false",
  "defaultNetworkFunction": "false",
  "amfTaiListName": "",
  "defaultNotificationSubscriptionListName": "",
  "nfType": "NSSF",
  "capacity": "65535",
  "instanceId*": "4215d7f7-8fc0-418d-b2a1-1e68633846ac",
  "priority": "1",
  "supiRangeListName": "",
  "enable": "false",
  "routingIndicator": "0000",
  "nfServicesListName": "nssfServices1",
  "snssaiListName": "",
  "groupId": "",
  "nfIpEndPointListName": "Nnssf_EpList2",
  "nsiIdListName": "",
  "pgwFqdn": "",
  "locality": "",
  "plmnName": "ETPLMN",
  "fqdn": "",
  "dnnListName": "",
  "nrfHeartBeatTimer": "60"
}


{
  "networkFunctionInstance": "4215d7f6-8fc0-418d-b2a1-1e68633846ac",
  "nfServicePersistence": "false",
  "defaultNetworkFunction": "false",
  "amfTaiListName": "",
  "defaultNotificationSubscriptionListName": "",
  "nfType": "NSSF",
  "capacity": "65535",
  "instanceId*": "4215d7f6-8fc0-418d-b2a1-1e68633846ac",
  "priority": "1",
  "supiRangeListName": "",
  "enable": "true",
  "routingIndicator": "0000",
  "nfServicesListName": "nssfServices",
  "snssaiListName": "",
  "groupId": "",
  "nfIpEndPointListName": "Nnssf_Common_EpList",
  "nsiIdListName": "",
  "pgwFqdn": "",
  "locality": "",
  "plmnName": "ETPLMN",
  "fqdn": "",
  "dnnListName": "",
  "nrfHeartBeatTimer": "60"
}


AMF will choose high priority service instance's networkFunctionInstance(SMF) to update AMF's  ~Nnssf_NSSAIAvailability.

* tracking area list and paging

**  CIoT Optimization
these in UE network capablity in UE attach request, and EPS network feature support in Attach accept
NB-IoT:  Narrowband IoT(internet of things)
CIoT: consumer internet of things
S1-U data:  S1-U data transfer  ###CP mode, non-ip data will go through MME
Up CIoT:  User-plance CIoT EPS optimization 
Cp CIoT:  Control-plance CIoT EPS optimization 


IOTA Procedure CPSR
### this is service request with control plane
nbh0271 To verify MME does not perform SGW relocation when NB-IOT, UE, with S11-U IP and non-IP bearer, does CIOT EPS Intra MME TAU to a new TAC
To verify MME does not perform SGW relocation when NB-IOT, UE, with S11-U IP and non-IP bearer, does CIOT EPS Intra MME TAU to a new TAC AF=OFF, SAF=OFF, which requires a new SGW, when the feature is ON,Home subscriber and Home PLMN

Iota Procedure 4gAttachImsi -imsi ${IOTA.IMSI1} -eNB ${IOTA.ENB41} -tac ${IOTA.TAC1} -cpciot_s11u true, -postinitproc {set ::c_ue(attachreq_uenwcapability), \\$E0E00000023401;set ::c_ue(snd_ula) "basic_snd_ula_noniptypeindicator"; set ::c_ue(hss_subscriptiondata_apn2_nonippdntypeindicator) 1;set ::c_ue(ula_apn2_preferreddatamode) 1;set ::c_ue(ula_apn1_preferreddatamode) 1}, -verbose 3
Iota Procedure 4gPdnConnect, -cpciot_s11u true -reqtype 1, -pdntype 5, -pti 2, -apname wap2.nokia.com, -nor false
Iota Procedure 4gS1Release
Iota Procedure 4gTau -active false -cpciot_s11u true -authsecure true -addlupdatevalue 4 -tac ${IOTA.TAC2} -eNB ${IOTA.ENB47} -sgwreloc false
Iota Procedure 4gCPSR
Iota Procedure 4gDetach

This feature enhances feature Restricting S-GW relocation (f10166-01) by introducing new flag in UEPLMN services table sgwRelocationAllow which overrides the global parameter sgwRelocationRestriction for TAU procedure.
This applies to gateway selection mode 2.
Configuration management	Command uePlmnServices, parameter sgwRelocationAllow

** 5G AMF 5GS/4G CMM MME tracking area list in registration accept(for both initial and mobility registration)
*** parameter autoAddTaiToTaiList
cmm@lm270-necc0 ~]$ cmm gParms modify autoAddTaiToTaiList  --gParmValue a
(msg=The gParmValue must be 'Off', 'Basic'[default], 'Enhanced' or 'UpdateThree'  for this gParmName)

m10210-02 	MME support for Basic Automatic Neighbor List Generation
	This feature will support enhancements to MME mobility management and paging to reduce ping-ponging scenarios at TA border areas. Ping-ponging is used to describe a situation in which UE's at the border of tracking areas would rapidly toggle between cells located within adjacent tracking areas and thereby generate a high level of Tracking Area Update (TAU) requests. 
These enhancements avoid the ping-ponging effect by automatically including the current TAI and the previously sd will also page eNBs associated with the Last Registered TAI, the Old Last Registered TAI, and the Last Seen TAI. 
This change is necessary to ensure that this paging method will page the UE in all of the TAIs where the UE is registered.

m10210-03  	MME support for Enhanced Automatic Neighbor List Generation
The feature provides enhancements to the LM2.0 Basic Automatic Neighbor List Generation feature (m10210-02) to eliminate ping-ponging between three adjacent tracking areas. 
This feature expands the list of registered tracking areas sent to the UE within TAU Accept messages to automatically include an additional TAI if cyclical movement among three TAs is
 detected. Similar to the Basic Automatic Neighbor List Generation feature, this feature also enhances the 'Last Seen TA and Neighboring TAs' paging method to ensure that the UE will 
be paged within all TAs where the UE is registered when using this paging method.



**** Basic
TAI list is appended another tai in a cyclic view. 
movement in cyclical:   tacA-->tacB--->tacA
tailist in TAU accept:  tacA   tacB    tacA, tacB
the last will be two tacs, since there's cyclic a,b,a

**** Enhanced
two tais appended in tailist if cyclic, thus three tacs in tailist in tau accept.
movement in cyclical:   tacA-->tacB--->tacC---->tacA
tailist in TAU accept:  tacA   tacB    tacC     tacA,tacB,tacC
the last will be two tacs, since there's cyclic a,b,c,a

movement in between cells :   25601------>25602------->25603------->25601
tailist in TAU accept:        256001      25602       25603      25601,02,03

**** UpdateThree
From DOC for Update-three it is No Cyclical behavior is required for it is append tai in a cyclic view. 

*** static neigboring tacs configuration in CMM
[cmm@lm270-necc0 ~]$ cmm taiNb list
+---------------------------+
| taiNb                     |
+---------------------------+
| ETPLMN~2~ETPLMN~3         |
| ETPLMN~6400~ETPLMN~6404   |
| ETPLMN~25600~ETPLMN~25604 |
+---------------------------+
25600 and 25604 will be together in the tailist in tauaccept.
for example, autoAddTaiToTaiList is UpdateThree.

when tac request is 25600 or 25604, the other will be added, they are always paired.

movement in between cells :   25601------>25602---------->25603----------->25600
tailist in TAU accept:        256001     25602,01       25603,01,02      25600,02,03,04

since 25600 in list, 25604 must also be in the list


*** parameter amfPaging policy
[cmm@lm270-necc0 ~]$ cmm amfPagingPolicy modify ETPLMN~Basic~Attempt1 --help
usage: cmm amfPagingPolicy modify [-h]
                                  [-f {json,plain,shell,table,value,yaml}]
                                  [-c COLUMN] [--max-width <integer>]
                                  [--fit-width] [--print-empty] [--noindent]
                                  [--prefix PREFIX] [--plmnName <string>]
                                  [--amf5GpagingType {Basic,ARP1,ARP2,ARP3,ARP4,ARP5,ARP6,ARP7,ARP8,ARP9,ARP10,ARP11,ARP12,ARP13,ARP14,ARP15,PPI0,PPI1,PPI2,PPI3,PPI4,PPI5,PPI6,PPI7,ueReachability}]
                                  [--amfAttempt {Attempt1,Attempt2,Attempt3,Attempt4}]
                                  [--amfMethod {LastSeenGnb,LastSeenTai,LastSeenTaiList}]
                                  [--amf5Gt3513Timer <integer>]
                                  [--maxGnbsPaged <integer>]
                                  [amfPagingPolicy]

  --amfMethod {LastSeenGnb,LastSeenTai,LastSeenTaiList}
                        Method that the designated attempt (1 - 4) should use.
                        [default = LastSeenGnb].
  --amf5Gt3513Timer <integer>
                        Defines the value for the T3513 timer used for receiving responses to a paging
                        request. when this timer expires, it triggers the AMF to proceed with the next
                        paging attempt as provisioned in the AMF pagingpolicy table. this timer value
                        should be set according to the maximum time it takes a UE to respond to a
                        paging message under normal operating conditions. indicates the T3513 timer
                        interval in msecs. Timer interval will only have a precision of +/- 100
                        milliseconds. The CMM timer wheel does not have an accuracy down to the
                        millisecond. [value = 1...10000, default = 6000].
  --maxGnbsPaged <integer>
                        Defines the maximum number of gNBs that may be paged for this page attempt a
                        value of 0 indicates that the default limit of gNBs to be paged should apply.
                        this parameter currently only applies to the lastseengnblist paging method.
                        [value = 0...5, default = 0].
required key arguments or 'multiple key' (key values delimited by ~):
  --plmnName <string>   Name that identifies mobile network. [length = 1...31].
  --amf5GpagingType {Basic,ARP1,ARP2,ARP3,ARP4,ARP5,ARP6,ARP7,ARP8,ARP9,ARP10,ARP11,ARP12,ARP13,ARP14,ARP15,PPI0,PPI1,PPI2,PPI3,PPI4,PPI5,PPI6,PPI7,ueReachability}
                        Defines the type of paging to be done, basic, at least one tuple must exist
                        for each paging type.
  --amfAttempt {Attempt1,Attempt2,Attempt3,Attempt4}
                        Defines the attempt (1 of 4 possible). attempt numbers must start at 1 and be
                        consecutive (1st attempt, 2nd attempt, and so on).


**** amfMethod {LastSeenGnb,LastSeenTai,LastSeenTaiList}]



*** checking gnb tac in AMF 
when initial registration, AMF will check the tac 30000 in reg request in its ngRan 

Cmm Command cmm taiNgRanQuery, list --taiMcc 460 --taiMnc 02 --tac 30000
  {
    "taiMnc": "02", 
    "taiNgRanQuery": "460~02~30000", 
    "taiMcc": "460", 
    "mcc": "460", 
    "ngRanName": "gnb01", 
    "ngRanType": "macro", 
    "tac": "30000", 
    "mnc": "02", 
    "ngRanId": "20817", 
    "ngRanIpAddress": "172.16.59.11"
  }, 
  {
    "taiMnc": "02", 
    "taiNgRanQuery": "460~02~30000", 
    "taiMcc": "460", 
    "mcc": "460", 
    "ngRanName": "gnb02", 
    "ngRanType": "macro", 
    "tac": "30000", 
    "mnc": "02", 
    "ngRanId": "21074", 
    "ngRanIpAddress": "172.16.59.12"
  }, 

*** only one tac in  tai list 
[cmm@lm270-necc0 ~]$ cmm amfPagingPolicy modify ETPLMN~Basic~Attempt1 
***** amfMethod LastSeenTaiList
[cmm@lm270-necc0 ~]$ cmm amfPagingPolicy show ETPLMN~Basic~Attempt1
|------------------+-----------------------|
| Field            | Value                 |
|------------------+-----------------------|
| amfPagingPolicy  | ETPLMN~Basic~Attempt1 |
| plmnName*        | ETPLMN                |
| amf5GpagingType* | Basic                 |
| amfAttempt*      | Attempt1              |
| amfMethod        | LastSeenGnb           |
| amf5Gt3513Timer  | 6000                  |
| maxGnbsPaged     | 0                     |
--------------------------------------------

***** paging the same ENB with the same only one tac



*** more tacs in tai list
**** other tacs in the same gnb
cmm ngRanTaiQuery list, --mcc 460 --mnc 02 --ngRanId 21588 --ngRanType gnb

  {
    "taiMnc": "02", 
    "taiMcc": "460", 
    "mcc": "460", 
    "tac": "30001", 
    "ngRanTaiQuery": "460~02~21588", 
    "ngRanName": "gnb04", 
    "ngRanType": "gnb", 
    "ngRanIpAddress": "172.16.59.14", 
    "mnc": "02", 
    "ngRanId": "21588"
  }, 
  {
    "taiMnc": "02", 
    "taiMcc": "460", 
    "mcc": "460", 
    "tac": "30000", 
    "ngRanTaiQuery": "460~02~21588", 
    "ngRanName": "gnb04", 
    "ngRanType": "gnb", 
    "ngRanIpAddress": "172.16.59.14", 
    "mnc": "02", 
    "ngRanId": "21588"
  }

tai list cntain 30000 and 30001 in registration accept

**** tacs from previous registration accept(both from initial and mobility)
***** amfMethod LastSeenTaiList

