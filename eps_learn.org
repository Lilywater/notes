* identification of mme and mobile subscriber
** MSISDN:  phone number
the real phone number, it is stored with other information in HLR indexed by imsi of each entry
MSISDN = CC + NDC + SN
CC = Country Code
NDC = National Destination Code
SN = Subscriber Number

** STN-SR
 STN-SR follows the E.164 telecommunications number format, and is used by the MSC server for session transfer of the media
 path from the PS domain to the CS Domain.
 it provided by HSS to MME during its attach procedure



** IMSI: unique international mobile sbuscriber identity that burned into a sim card

TMSI(Temporary Mobile subscriber indenties)
 In order to support the subscriber identity confidentiality service the VLRs, SGSNs and MMEs may allocate Temporary Mobile Subscriber Identities (TIMSI) to 
 visiting mobile subscribers. The VLR, SGSN, and MME must be capable of correlating an allocated TIMSI with the IMSI of the Mobile Station (MS) to which it is allocated.

An MS may be allocated three TMSIs, one for services provided through the MSC, one for services provided through the SGSN (P-TIMSI for short) and i
one for the services provided via the MME (M-TIMSI which is part of GUTI).


*** composition of IMSI
|     IMSI   |
 MCC MNC MSIN
    | NMSI   |
MSIN: Moblie subscriber identification number
    Mobile Country Code (MCC) consisting of three digits. The MSS identifies uniquely the country of domicile of mobile subscriber. 
    Mobile Network Code (MNC) consisting of two or three digits for GSM/UMTS applications.  That's why, if you are close to your country border UE is still using eNodeBs 
    that belongs/are controled by Mobile Operator from your country. In other words .. the MNC identifies the home PLMN of the mobile subscriber. The length of the MNC 
    (two or three digits) depends on the value of the MCC. A mixture of two and three digit MNC codes within a single MCC area is not recommended according to 3GPP specification.
    Mobile Subscriber Identification Number (MSIN) identifying the mobile subscriber within a PLMN.

In Fig. 1. there is also shown NMSI entity. The National Mobile Subscriber Identity (NMSI) consists of the MNC and the NMSI.

this will be allocated to each mobile subsriber in every (GSM, UMTS and EPS)sytem.

** IMEI: a number which is burned into a mobile phone
IMEI (International Mobile Equipment Identity) it is a unique number given to every single mobile phone.
(When a phone is reported stolen or is not type approved, the number is marked invalid).

The IMEI (International Mobile Station Equipment Identity) is a 15-digit number to uniquely identify a mobile phone device.i
IMEISV (IMEI Software Version) is a 16-digit number with the IMEI and an additional software version number.


** Globally Unique MME id(GUMMEI)
-----    MCC: 244 ---finland
         MNC: 123  ---LTE4U
gummei   MMEGID: 1
______   MMEC :1
Globally Unique MME Identifier (GUMMEI)
The format and size of the GUTI is:
GUTI = GUMMEI + M-TMSI, where
GUMMEI = MCC + MNC + MME Identifier and
MME Identifier = MME Group ID + MME Code
MCC and MNC shall have the same field size as in earlier 3GPP systems.
M-TMSI shall be of 32 bits length.
MME Group ID shall be of 16 bits length.
MME Code shall be of 8 bits length.




** Globally Unique Temporary UE Identity (GUTI )
The purporse of the GUTI is to provife an unambiguous identification of the UE that does not reveal the UE or the user's permanent identity in the Evolved Packet System
(EPS). It also allows the identification of the MME and network. It can be used by network and the UE to establish UE's identity during signaling between them in EPS.
On GUTI consist two main components:

    GUMMEI - that uniquely identifies the MME which has allocated the GUTI
    M-TMSI - other that uniquely identifies the UE within the MME because of allocated the GUTI

Because of that when UE is contacting the network it sends the GUTI to the eNodeB which then uses the GUTI number to identify to which MME re-establish request will be send.
If the UE has moved from UMTS cell to LTE cell, a TAU procedure is made (because UE does not have its GUTI) and P-TMSI is send. By this way MME, which is in control of
area to which UE moved to, can contact SGSN, which controlled area where UE was previously, to request the subscribers current profile like IP address and PDP contexts.
Situation is similiar when UE has moved from LTE to UMTS cell. GUTI is sent as the P-TMSI parameter and the procedure is reffered as Routing Area Update (RAU).
If there is a situation where eNodeB from new LTE cell is not associated with MME on which GUMMEI is pointing eNodeB simply will select new MME. The new MME 
could get context information from old MME using same GUTI.


-       GUTI=<GUMMEI><M-TMSI>
Fig. 2. GUTI structure

-       GUTI=<GUMMEI><M-TMSI>
-	GUMMEI=<MCC><MNC><MME group Id><MME Code>
-	Mapped GUMMEI=<MCC><MNC><MME group Id=LAC><MME Code=8 MSB of NRI>


** ECGI
ECGI     E-UTRAN Cell Global Identifier  To identify a Cell in global (Globally   Unique), EPC can know UE location based of ECGI  ECGI (not more than 52 bits) = PLMN I D+ ECI    
ECI     E-UTRAN Cell Identifier     To identify a Cell within a PLMN    ECI (28 Bits) = eNB ID + Cell ID    
eNB_ID  eNodeB Identifier   To identify an eNB within a PLMN    20 bits

Global_eNB_ID   Global eNodeB Identifier    To identify an eNB in global (Globally   Unique)    Global eNB ID (not more than 44 bits) = PLMN ID + eNB ID    

* PDN, bearer and APN
** PDN concept
In that home, the APN comes into play inside the Home Subscriber Server (HSS) node of the core network.

Where You’ll See LTE APN

The HSS contains users’ SAE subscription data such as the EPS-subscribed Quality of Service (QoS) profile and any access restrictions for roaming. HSS also contains
information about the (Pocket Data Networks) PDNs to which the user can connect, as reported by Alcatel-Lucent. “This could be in the form of an access point name (APN) (which is a label according to DNS naming conventions describing thei
access point to the PDN) or a PDN address (indicating subscribed IP address(es)). In addition the HSS holds dynamic information such as the identity of the MME to which the user
is currently attached or registered. The HSS may also integrate the authentication center (AUC), which generates the vectors for authentication and security keys.” [1]

 What LTE APN Does

 To break it down, the APN identifies a Gateway GPRS Support Node (GGSN) or Packet Data Network GateWay (P-GW). It includes an APN network identifier which defines the Packet Data 
 Network (PDN) to which the UE requests connectivity, and may also include an APN operator identifier which defines in which Public Land Mobile Network (PLMN) the P-GW or
 GGSN is located, according to LTE World. [2] To accomplish this, the APN structure is comprised into two parts: a network identifier and an operator identifier.

  How to identify?

  There are also steps for identifying a PDN IP network that the mobile data user wants to communicate with. The NMC Consulting Group notes that the PDN Identity (APN) is used to
  determine the P-GW and point of interconnection with a PDN. With APN as query parameter to the DNS procedures, the MME will receive a list of candidate P-GWs, and then a P-GW is 
  selected by MME with policy. [3]

  3GPP Views

  The board who sets the standards for 3GPP, however, sees things a little differently. According to the new standards puts in place, the UE shall not include APN and PCO in the 
  PDN connectivity request when the same is sent along with attach request. 3GPP has said that the UE shall send the PDN connectivity request with a flag “ESM Information transfer”
  on and no APN or PCO shall be included. Once the MME receives the Attach Request+PDN connectivity request, it can move ahead and accept the attach but it still cannot establish
  the EPS bearers just yet.
  Next, MME goes ahead with establishing security context. After the security context is established MME will send a NAS message “ESM Information Request” asking UE for APN and PCO. 
  Then, the UE will send an “ESM Information Response” with APN and PCO, encrypted. Finally, once MME receives this response it will go ahed with establishing the EPS bearers.
  If the response doesn’t include APN then default APN shall be used by MME.

*** EPS Session

IP connection between a UE and a PDN is called PDN connection or EPS session. Each PDN connection (or EPS session) is represented by an IP address of the UE and a PDN ID (in other words,
 Access Point Name (APN)). It has more than one EPS bearer to deliver user traffic (IP packets), and applies the service quality (QoS) policy obtained from a PCRF to the EPS bearers.
 The minimum fundamental bearer that an EPS session has for a PDN is called a default EPS bearer.

 
Having an EPS session established means 
i) a PDN through which a user is to use services has been selected (by the user’s input or based on the subscription information provisioned by an HSS), 
ii) an IP address to be used in the PDN has been assigned to the user, 
iii) policy rules to be applied to the user IP packets (QoS and charging rules) have been selected,
iv) a default EPS bearer for delivering IP packets over the LTE network has been established. 
Through this EPS session established, IP packets can be exchanged between the user and the PDN according to the rules set by the operator.

Management and operation of sessions, including PCRF, will be explained in other document, and a PDN ID (APN) will be discussed as an ID relating to the EPS session in this document.


*** EPS Bearer

An EPS session is in charge of delivering and handling flows of the IP packets that are labeled with UE IP addresses and travel between a UE and a PDN (UE – P-GW – PDN).
 On the other hand, an EPS bearer is a pipe through which IP packets are delivered over the LTE network, i.e., between a UE and a P-GW (UE – eNB – S-GW - P-GW).
 A UE can have multiple EPS bearers concurrently. So, different EPS bearers are identified by their EPS bearer ID, which is allocated by an MME.

As seen in Figure 1, an EPS bearer actually is a concatenation of the following three bearers (DRB, S1 bearer and S5 bearer):

    [UE] - [eNB]: Data Radio Bearer (DRB)

EPS bearer established over LTE-Uu interface. User traffic (IP packet) is delivered through a DRB. Different DRBs are identified by their DRB ID, which is allocated by an eNB.

    [eNB] - [S-GW]: S1 bearer

EPS bearer established over S1-U interface. User traffic is delivered through a GTP tunnel. Different S1 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (eNB and S-GW) of the GTP tunnel. 

    [S-GW] - [P-GW]: S5 bearer

EPS bearer established over S5 interface. User traffic is delivered through a GTP tunnel. Different S5 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (S-GW and P-GW) of the GTP tunnel.

*** Types of EPS Bearers
Before we go ahead and describe EPS bearer-related IDs, we will look at different types of EPS bearers and how they work. Figure 2 shows two different types of EPS bearers:
default and dedicated. Each PDN must have one default EPS bearer, but may have none to many dedicated EPS bearers.

Despite the similarities in the processes among GSM, UMTS and LTE, there is nevertheles one major difference between LTE and earlier technologies./
the attach process already includes the assignment of an IP address. This is unlike in GSM and UMTS where the device could attach to packet-switched network and only later request for the 
assignment of and IP address with a separate procedure which often referred to aas "packet call" to compare the estbablishment of an INternet session with the voice call.
So if 4g attached ue(with a dedicated bearer for voip) handover to a 3g network, voip bearer will be 
handover to MSC, and default bearer will be released, not handover to RNC, for 3g attachment not request a default bearer.

The LTE network is an all-IP network, and provides its users with always-on IP connectivity. This means, once a UE connects to a PDN using the IP address assigned at its initial attach 
to the network, the IP connection remains connected after a default EPS bearer is established over the LTE network and until the UE detaches from the LTE network 
(i.e., the PDN connection is terminated). Even when there is no user traffic to send, the default EPS bearer always stays activated and ready for possible incoming user traffic.

Additional EPS bearer can be established if the default EPS bearer itself is not sufficient enough to obtain QoS (see LTE QoS document). The additional EPS bearer established 
is called a dedicated EPS bearer and multiple dedicated bearers can be created if required by the user or the network. When there is no user traffic, these dedicated EPS bearers 
can be removed, whereas the default one is never removed and keeps the user staying connected to the network unless the user detaches from the network. Dedicated EPS bearers are linked to
a default EPS bearer. The linked bearers are represented by a Linked EPS Bearer Identity (LBI), indicating they are all associated with the same default EPS bearer.


*** ID to identify PDN: PDN ID (APN)
PDNs are identified by PDN IDs (or Access Point Names (APNs)). An APN, as can be easily inferred, refers to an access point to a PDN where a user wishes to connect for services/applications.
APNs and their format are illustrated. An APN is a combination of a network ID and an operator ID. The network ID is used when identifying PDNs such as Internet or Corporate VPNs or 
identifying services like IMS that the PDN provides.
An APN is provisioned to an HSS as subscription information at the time of a user’s subscription (as in case 1 of Figure 3)2. Upon a UE’s initial attach, a default APN is 
downloaded from the HSS to an MME. The MME selects a PDN to connect the UE based on the APN first, and then a P-GW through which the UE is connected to the PDN . 
the MME selected PDN 1 based on APN 1, and then P-GW 1 for connection to PDN 1.  

 
http://www.netmanias.com/en/post/techdocs/5907/identification-identifier-lte/lte-identification-iii-eps-session-bearer-identifiers


* EPS mobility/session management
** EPS mobility management(EMM)
informing the network of its present location 
providing user identity confidentiality.
to provide connection management services to the session management(SM) sublayer and the short message service(SMS) of the connection management(CM) sublayer.

*** Types of EMM procedures
**** EMM common procedures (can be initiated whilst a NAS signalling connetion exists)
initiated by network:
GUTI reallocation;  authentication;  security mode control;  identification;     EMM information;

**** EMM specific procedures(at any time only one UE initiated EMM specific procedures can be running)
attach; detach; normal TAU; periodic TAU

**** EMMM connection management procedures
service request;   paging procedure;   trasnport of NAS messages.

** EPS session management(ESM)
An EPS bearer context can be either a default bearer context or a dedicated bearer context.
The ESM comprises procedures for:
- the activation, deactivation and modification of EPS bearer contexts; and
- the request for resources (IP connectivity to a PDN or dedicated bearer resources) by the UE.

Each EPS bearer context represents an EPS bearer between the UE and a PDN. EPS bearer contexts can remain activated even if the radio and S1 bearers constituting the corresponding EPS bearers between UE and MME are
temporarily released.
A default EPS bearer context is activated when the UE requests a connection to a PDN.

Once the UE is successfully attached, the UE can request the MME to set up connections to additional PDNs. For each additional connection, the MME will activate a separate default EPS bearer context. A default EPS
bearer context remains activated throughout the lifetime of the connection to the PDN.

A dedicated EPS bearer context is always linked to a default EPS bearer context and represents additional EPS bearer resources between the UE and the PDN. 
The network can initiate the activation of dedicated EPS bearer contexts together with the activation of the default EPS bearer context or at any time later, as long as the default EPS bearer
context remains activated.

Default and dedicated EPS bearer contexts can be modified.
Dedicated EPS bearer contexts can be released without affecting the default EPS bearer context. When the default EPS bearer context is released, then all dedicated EPS bearer
contexts linked to it are released, too.
The UE can request the network to allocate, modify or release additional EPS bearer resources. The network decides whether to fulfil a request for additional 
resources by activating a new dedicated EPS bearer context or modifying an existing dedicated or default EPS bearer context.

*** types of ESM procedure
**** procedures related to EPS bearer contexts(initiated by the network):
default/dedicated EPS bearer context activation;
EPS bearer context modification/deactivation;

**** Transaction related procedures(initiated by the UE to request/release  resources):
PDN connectivity/disconnect procedure;
bearer resource allocation/modification procedure
ESM information request procedure



* basic procedures
\\10.140.0.65\data\EPC MME\01. Architecture\Basic LTE procedures
state of UE
 ECM=idle/connected       (means UE is not connected to radio network's ENB)
 EMM=registered/deregistered       (means UE is registered in core network's MME)

** S1 Setup
this procedure triggered when network element in core network first bootup
*** network element configuration(enb1, enb2, one mme)
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     MCC: 244                       MCC: 244                  MCC: 244   
     MNC: 123                       MNC: 123                  MNC: 123
     enB ID:2                       enB ID:2                  mmegid:mmecode 2:0
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 

when all system boot up, enb1 and enb2 will send a S1 Setup message to mme tell it's enbid and Tal
and mme will store the global enb id and taList to it's database
then response them with its own gummei and  capacity


*** s1 setup request procedure
enb will establish a sctp connection to mme, and notify mme that its Tracking area

enb1:TA1     S1 setup request( enbid, TA1,TA2)
     TA2    ------------------------------------>   MME [enbid, Talist]
           
              S1 setup response(gummei,capacity)
	    <------------------------------------

** S1 Release (S1 release it not the opposit operation of S1 Setup, S1 release is related to UE, but s1 setup has nothing to do with UE)
when enb found  ue lose rrc connection(radio connect) to it, there will be s1 release procedure, started by enb.
ue  ECM = idle

enb detected that ue is lost, it will send a ue context release rquest(enb_s1ap_id, mme_s1ap_id, cause of release) to mme

sgw will remove enb related info, enb will remove all the info related to the attach()
mme will remove ue-associated info ims1 and enb_s1ap_id


S1 release procedure will make all s1ap related id removed in mme, sgw, but UE keep GUTI,TAI.(for if UE move to another ENB, the info not related to the older enb is also useful).

enb: enb-s1-id, mme-s1-id,      mme:imsi,guti(TMSI),enb-s1-id,mme-s1-id,          sgw:imsi, mme-teid,sgw-teid-c
enb-teid, sgw-teid-u                guti, mme-teid, sgw-teid-c,sgw-teid-u         sgw-teid-u,enb-teid
|                                    |                                            |
|ue context release request(enb-s1-id|                                            |
|mme-s1ap-id, casue of release)      |                                            |
|----------------------------------->|                                            |
|                                    |                                            |
|                                    |                                            |
|                                    |release access bearers request(SGW TEID-C)  |  
|                                    |------------------------------------------->|(enb-teid)Remove
|                                    |                                            |---------
|                                    |                                            |
|                                    |release aceess bearers response             |
|                                    |<-------------------------------------------|
|                                    |                                            |
|ue context release command(         |
| enb-s1-id,mme-s1-id)               |
|<-----------------------------------|
|                                    |
|(all the filed above)Remove         |
|                                    |
|ue context release complete         |
|(enb-s1-id, mme-s1-id)              |
|----------------------------------->|(enb-s1ap-id,mme-s1ap-id) Remove
                                  EMM=registered,ECM=idle


** Service Request (this is the opposite operation of S1 release)

when after s1 release, ue ecm=idle emm=registered
ue want to send some message, it will establish RRC connection to enb and sending Service Request NAS Message

ue                     enb                              mme                                      sgw
guti,talist            none                  imsi,guti,mme-teid,sgw-teid(u/c)          imsi,mme-teid,sgw-teid(u/c)
|                        |                                       |                                      |
| service requst(S-TMSI) |                                       |                                      |
|------------------------+---------------------------------------+--------------------------------------|
|                        | [enb-s1ap-id]                         |                                      |
|                        |                                       |                                      |
|                        | initial ue message(enb-s1ap-id,       |                                      |
|                        | S-TMSI,<servic request>)              |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       | [mme-s1ap-id]                        |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | initial context setup req             |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id, sgw-teid-u) |                                      |
|                        | <----------------------------------   |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | [enb-teid]                            |                                      |
|                        | <mme-s1ap-id,sgw-teid-u>              |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | first uplink data packet              |                                      |
|------------------------+---------------------------------------+------------------------------------->|
|                        |                                       |                                      |
|                        | initial context respose               |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id,enb-teid)    |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       |                                      |
|                        |                                       | modify bearer req(mme-teid,enb-teid  |
|                        |                                       | -----------------------------------> |
|                        |                                       |                                      |<enb-teid>
|                        |                                       |                                      |
|                        |   first donwlink data packet          |                                      |
|<---------------------- |<-----------------------------------------------------------------------------|
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        |                                       |modify bearer resp(sgw-teid-u)        |
|                        |                                       |<-----------------------------------  | 



** Paging
Paging is from s1-release scenario
 ue: ECM=idle EMM=registered(guti,TAlist(TA1,TA2) in UE)

SGW get some data from the Internet, incoming donwlink data, sgw start to buffer them and request mme to estalbishment of E-RAB

SGW sent Downlink Data Notification(MME-TEID) to  mme
mme find subscirber with MME-TEID 

S-TMSI=MMEC+MTMSI 
S_TMSI is used to identify the subscirber

MME send Paging() to all the enbs(when s1-setup, enbs notify mme that its TAs) in the ta list(which is send to ue when attach accept).
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 


paging(S-TMSI,TA1+TA2)
-------------------------> enb1

paing(S-TMSI, TA2)
-------------------------> enb2
when ue recevied paing message from enb, it will send a service request nas messaeg to eNB


** detach procedure
detach procedure triggered by SIM card removed or cell phone is switched off.
The difference between detatch and s1-release is that detach will make SGW, MME, ENB delete all the ids it maintained for that SIM card.
while s1-release procedure is from enb(that lost connection with UE), so UE related info in ENB will be all removed, but SGW and MME may keep some info related only to UE 
other than related to enb.

(enb-teid,s1ap-enb/mme-id,sgw-teid)     (s1ap-enb/mme-id,sgw-teid-c,mme-teid)        (enb-teid,sgw-teid-c/u,mme-teid,imsi)
                                        EMM=registered, ECM=connected
ENB                                           MME                                           SGW                                           
|                                              |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - Uplink NAS Transport (Detach Request)      |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|                                              |--------------------------------------------->|delete all the teid for this bearer (enb,sgw,mme),imsi
|                                              | - Delete Session Request                     |
|                                              |                                              |                                              
|                                              |<---------------------------------------------|
|                                              | - Delete Session Response                    |
|                                              |<---------------------------------------------|
|                                              |A: mme  EMM=unregistered                      |                                              
|<---------------------------------------------|                                              |
| - Downlink NAS Transport (Detach Accept)     |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|<---------------------------------------------|                                              |
| - UE Context Release Command                 |                                              |
|A:enb delet all id list above                 |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - UE Context Release Complete                |                                              |
|A:mme delete all id list above(keep guti,imsi)|                                              |
|                                 ECM=idle     |                                              |                                              
|                                              |                                              |                                              
no ids left                         guti,imsi,EMM=unregistered,ECM=idle                      no ids left


** basic attach with imsi
triggered by a ue press a power button to switch on the phone

UE                               ENB                              MME                              HSS                              DNS                              SGW                              
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|A: RFC connection established   |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: NAS attach request(imsi,)    |                                |                                |                                |                                |
|A: [enb_s1_id]                  |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: initial ue message(enb_s1ap_ |                                |                                |                                |
|                                |id,TAI(tracking area identifica |                                |                                |                                |
|                                |tion in ue),NAS_attach_request( |                                |                                |                                |
|                                |imsi))                          |                                |                                |                                |
|                                |A: <imsi,enb_s1ap_id> [mme_s1ap |                                |                                |                                |
|                                |_id,GUTI, MME-TEID]             |                                |                                |                                |
|                                |                                | if sub in db,no authreq to hss |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M: authentication info request( |                                |                                |
|                                |                                |imsi)                           |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: allocation info answer(authe |                                |                                |
|                                |                                |ntication&security parameters)  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: Downlink nas trasport(enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,authenticatio |                                |                                |                                |
|                                |n request)                      |                                |                                |                                |
|                                |A: <mme_s1ap_id>                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: authentication Request       |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M; authentication response      |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: uplink nas trasnport(enb_s1a |                                |                                |                                |
|                                |p_id,mme_s1ap_id, authenticatio |                                |                                |                                |
|                                |n response)                     |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: DownlinkNASTransport (enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,[securityMode |                                |                                |                                |
|                                |Command(cypher alg)])           |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                | tester calculate (cypher/inte) |                                |                                |                                |
|                                |key using kasme                 |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [securityModeCommand]        |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: [{securityModeComplete}]     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: UplinkNASTransport (enb_s1ap |                                |                                |                                |
|                                |_id,mme_s1ap_id,[{securityModeC |                                |                                |                                |
|                                |omplete}]                       |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M; Update Location Request(IMSI)|                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: Update Location answer(Qos p |                                |                                |
|                                |                                |rofile,APN)                     |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |---------------------------------------------------------------->|                                |
|                                |                                |M: APN                          |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<----------------------------------------------------------------|                                |
|                                |                                |M: PGW IP                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |M: create session request(MME-T |                                |                                |sgw restore imsi,mme-teid
|                                |                                |EID,IMSI)                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <mme-teid,imsi>  [sgw-teid-c |                                |                                |
|                                |                                |,sgw-teid-u] c:control, u:user  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: create session response(     |                                |                                |sgw-teid-c:senderFTEIDforctrlplane    
|                                |                                | sgw-teid-c,sgw-teid-u)         |                                |                                |sgw-teid-u:s1_U_SGW_FTEID in bearecontext
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |A: <SGW_TEID-u,SGW_TEID-c>      |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: initial context setup reques |                                |                                |                                |
|                                |t(enb_s1ap_id,mme_s1_id,SGW_TEI |                                |                                |                                |
|                                | SGW_TEID-u,                    |                                |                                |                                |
|                                |[{NAS_attach accept(GUTI,TALIST}|                                |                                |                                |
|                                |]))                             |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|enb-TEID-u:transportLayerAddress|                                |                                |
|                                |A: <sgw_teid-u> [enb-TEID-u]    |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [{attach accept(guti,talist) |                                |                                |                                |                                |
|}]                              |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|A: <guti,talist>                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: InitialContextSetupResponse  |                                |                                |                                |
|                                |(enb_s1ap_id,mme_s1_id,         |                                |                                |                                |
|                                |enb-TEID-U))                    |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |A: <enb TEID-U>                 |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: Attach complete              |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: S1AP.UplinkNASTransport(enb_ |                                |                                |                                |
|                                |s1ap_id,mme_s1_id,[{at          |                                |                                |                                |
|                                |tach complete}])                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------->|
|M: first uplink data packet     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|bearer context
|                                |                                |M: modify bearer request(mme-te |                                |                                |s1_eNodeB_FTEID
|                                |                                 id,enb-teid-u(to sgw))          |                                |                                |is enb-teid-u
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <enb-teid,ipaddr>            |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: ModifyBearerResponse(sgw-teid-u)                                                               |
|                                |                                |                                |                                |                                |
|<-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|M: first downlink data packet   |                                |                                |                                |                                |


Note sgw-teid have two kinds of user and control plane, but for enb-teid is just a enb-teid-u,no ebn-teid-c
after attach the ids in enb,mme,sgw
enb: enb-s1-id, mme-s1-id,      mme:imsi,enb-s1-id,mme-s1-id,                 sgw:imsi, mme-teid,
enb-teid, sgw-teid-u                 guti, mme-teid, sgw-teid-u/c                  sgw-teid-u/c,enb-teid

picture example: 
M means message() means parameter in message,[] means inteigiry protected message,{}means cyphered message 
A means Action. <> means stored [] means allocated

so after the attach, there are some value in the network element accordingly

ue: guti, tailist
enb: enb-s1-id, mme-s1-id, enb-teid, sgw-teid-u
sgw: imsi, mme-teid, sgw-teid-u/c, enb-teid
mme: ismi,enb-s1-id,mme-s1-id, guti, mme-teid, sgw-teid-u/c

note all the data packet won't pass mme, data only in sgw and enb(enb talk wih  ue via radio network)
other components are connected via real nettwork(core net work?) 
mme will only control the ue's guti and talist.
talist is the tas which not needed to do TAU for ue, if ue entered another tas not in talist, ue will perform TAU to mme,
mme will get updated where ue is

** Tracking Area Update
this procedure and be initiated by UE or just periodic.

*** intra mme TAU
**** ue initiated TAU 
When an UE detects it has entered a new Tracking Area(that is not in the list of TAIS when attach Accept),
it initiates a standalone tracking area update procedure.
epsupdatetype will be e-tau-updating in taurequest nas message

***** ECM=IDLE ACTIVE FLAG = OFF
If the UE(in idle mode)has no UpLink data pending, it will initiate TAU with active_flag off


UE(ECM=idle,EMM=registered)                            ENB(no-ids)                                         MME (ECM=idle,EMM=registered)                                                     
                                                                                                               (imsi,guti,sgw-teid,mme-teid)
|                                                          |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|
| M TAU Request(TAI,guti,activeflag=off)                   |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|check if ths sub exists in cache/db using guti
| A [ebn-s1ap-id]                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti   |
|                                                          | vef=off))                                                |
|                                                          | A [mme-s1ap-id] <enb-s1ap-id>                            |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M Downlink NAS transport(enb-s1ap-id,mme-s1ap-id,TAU a   |
|                                                          | ccept((newtalist),GUTI))                                 |
|                                                          | A  <mme-s1ap-id>                                         |
|                                                          |                                                          |
|                                                          |                                                          |
| <------------------------------------------------------- |                                                          |
| M TAU Accept(TAI,GUTI)                                   |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|                                                          |
| M TAU complete                                           |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Uplink NAS transport(enb-s1ap-id,mme-s1ap-id,TAUComp   |
|                                                          | lete)                                                    |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M UE Context release command(enb-s1ap-id,mme-s1ap-id)    |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M UE Context release complete(enb-s1ap-id,mme-s1ap-id)   |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |


***** ECM=IDLE ACTIVE FLAG = ON
If the UE (in idle mode) has UpLink data pending (or UpLink signalling not related to TAU), the MME re-establish the radio and S1 bearers for all i
active EPS bearer contexts. The UE indicates this request to establish the User Plane (and to keep NAS signalling connection after TAU completion) by setting an "active" flag. 

UE                                                      ENB                                                     MME(ECM=idle,EMM=registered)                            SGW                                                     
 (ECM=idle,EMM=registered)                              (no-ids)                                (imsi,guti,sgw-teid,mme-teid)                           (imsi,sgw-teid,mme-teid)
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Request(TAI,activeflag=on)                      |                                                        |                                                        |
|  A [ebn-s1ap-id] ECM(idle ---> connected)              |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti|                                                        |
|                                                        |vef=on))                                                |                                                        |
|                                                        |  A [mme-s1ap-id] <enb-s1ap-id> ECM(indle-->connected)  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |<-------------------------------------------------------|                                                        |
|                                                        |  M Initial ContextSetup Request(enb-s1ap-id,mme-s1ap-i |                                                        |
|                                                        |d,sgw-teid,TAU accept((newtalist),GUTI))                |                                                        |
|                                                        |  A  [enb-teid] <mme-s1ap-id,sgw-teid>                  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|got enb-teid and                                        |
|                                                        |M Context Setup Response(enb-s1-id,mme-s1-id,enb-teid,  |send to SGW                                             |
|                                                        |          TAU Accept(TAList,GUTI)                       |using modifybearerrequest                               |
|                                                        |  A  <enb-teid>                                         |                                                        |
|                                                        |                                                        |                                                        |                                                        
|<-------------------------------------------------------|                                                        |                                                        |
|  M TAU Accept(TAI,GUTI)                                |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Complete                                        |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M TAU Complete in UL NAS Transport                    |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |------------------------------------------------------->|
|                                                        |                                                        |  M ModifybearerRequest(mme-teid-id,enb-teid-id)        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |<-------------------------------------------------------|   
|                                                        |                                                        | M ModifybearerResponse(mme-s1ap-id)                    |


***** ECM=CONNECTED
only update the TA List, all enb-s1ap-id, enb-teid, mme-s1ap=id, sgw-teid, mme-teid no need to update at all.


***** intra MME TAU with SGW relocation ECM=CONNECTED
case id:  NS_130_4_0001

ENB                                             MME                                                tSGW                                             sSGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Req|                                                 |                                                 |
|uest(GUTI,TAI,))                                 |                                                 |                                                 |
|                                                 |DNSquery with tac to see if sgw need relocated   |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Create Session Request                        |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Create Session Response                       |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session Request                                                                          |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Delete Session Response                                                                         |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Initial Context Setup Request (Tracking Area U|                                                 |                                                 |
|pdate Accept)                                    |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Initial Context Setup Response                |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Com|                                                 |                                                 |
|plete)                                           |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Modify Bearer Request                         |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Modify Bearer Response                        |                                                 |
|                                                 |                                                 |                                                 |


**** periodic TAU
In addition, an EMM-REGISTERED and ECM-IDLE state UE performs periodic Tracking Area Update with the network after the expiry of the periodic TAU timer (T3412).
The     value of timer is sent by the network to the UE in the ATTACH ACCEPT message (and can be sent in the TRACKING AREA UPDATE ACCEPT message). Periodic tracking area 
updateing is used to periodically notify the availability of the EMM-IDLE state UE to the network. 
epsupdatetype will be e-periodic-updating in taurequest nas message




*** inter mme TAU with ACTIVE FLAG= OFF
case id:NS_129_31_0001
Purpose of this test case is to ensure UE makes inter MME TAU (S_MME --> T_MME) successfully. Active flag is OFF in TAU request. After successfull TAU, UE makes S1 release.

ENB                                     tMME                                    sMME                                     HSS                                     SGW
|                                         |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|-----------------------------------------+---------------------------------------------------------------------------------+-----------------------+---|
| - Uplink NAS Transport (Tracking Area   |                                                                                 |                       |   |
| Update Request)                         |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | -------------------------------------->                                         |                       |   |
|                                         | - Context Request                                                               |                       |   |
|                                         | <--------------------------------------                                         | (mmcontext,smcontext) |   |
|                                         | - Context Response                                                              |                       |   |
|                                         |                                                                                 |                       |   |
| <-------------------------------------- |                                                                                 |                       |   |
| - Downlink NAS Transport (Identity Req  |                                                                                 |                       |   |
| uest)                                   |                                                                                 |                       |   |
|-----------------------------------------+---------------------------------------------------------------------------------+-----------------------+---|
| - Uplink NAS Transport (Identity Respo  |                                                                                 |                       |   |
| nse)                                    |                                                                                 |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | ------------------------------------------------------------------------------> |                       |   |
|                                         | - Identity Check Request                                                        |                       |   |
|                                         | <------------------------------------------------------------------------------ |                       |   |
|                                         | - Identity Check Answer                                                         |                       |   |
|                                         |                                                                                 |                       |   |
|                                         | -------------------------------------->                                         |                       |   |
|                                         | - Context Acknowledge                                                           |                       |   |
|                                         |                                                                                 |                       |   |
|                                       |---------------------------------------------------------------------------------------------------------------------->|store mme-teid
|                                       | - Modify Bearer Request(Update the target mme-teid in [senderfteid] to replace the old one)                           |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Modify Bearer Response(enb-teid){enb-teid is allocated when with sMME signallin}                                    |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |since mme has been changed, so Loacation update procedure needed               |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Update Location Request                                                     |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Update Location Answer                                                      |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Downlink NAS Transport (Tracking Are|                                       |                                       |                                       |
|a Update Accept)                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Complete)                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |

Ater this, TAU procedure is complete. Due to active flag=off, so ue context realease needed
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Insert Subscriber Data Request                                              |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Insert Subscriber Data Answer                                               |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |



*** inter mme TAU with ACTIVE FLAG= ON
case id:NS_129_31_0002
Purpose of this test case is to ensure UE makes inter MME TAU (S_MME --> T_MME) successfully. Active flag is ON in TAU request. 

ENB                                    tMME                                   sMME                                     SGW                                     HSS
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Request)                        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Context Request                     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Context Response                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Context Acknowledge                 |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Update Location Request                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Update Location Answer                                                                                              |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Initial Context Setup Request (Track|                                       |                                       |                                       |
|ing Area Update Accept)                |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Initial Context Setup Response      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Tracking Area |                                       |                                       |                                       |
|Update Complete)                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |



*** intersystem TAU
intersystem s3_based Handover(ISHO) from 3G to LTE(TA) 
case id:NS_001505_01_0001
in TAU procedure no interaction with SGSN
SGSN                                    MME                                     ENB                                     SGW                                     HSS
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Tracking Area |                                       |                                       |
|                                       |Update Request)                        |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Authentication Information Request                                                                                  |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Authentication Information Answer                                                                                   |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Authenticati|                                       |                                       |
|                                       |on Request)                            |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Authentication|                                       |                                       |
|                                       | Response)                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Security Mod|                                       |                                       |
|                                       |e Command)                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Security Mode |                                       |                                       |
|                                       |Complete)                              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Update Location Request                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Update Location Answer                                                                                              |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - UE Context Modification Request     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - UE Context Modification Response    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Downlink NAS Transport (Tracking Are|                                       |                                       |
|                                       |a Update Accept)                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Uplink NAS Transport (Tracking Area |                                       |                                       |
|                                       |Update Complete)                       |                                       |                                       |
|                                       |                                       |                                       |                                       |



*** intersystem RAU
RAU is a routing area update procedure in 3G which is similar to TAU procedure in 4G, inter RAU happend between two SGSNs
intersystem RAU from 4G to 3G 
caseid: NS_48_24_0004
the Routing Area Update takes place when a UE that is registered with an MME selects a UTRAN cell.
in this case, the US changes to a Routing Area that the UE has not yet registered with the network.

UE will start a new register to UTRAN to SGSN, and SGSN will ask mme about the contexts

      SGSN-Context-Request(RAI,P-TMSI,RAT Type)
SGSN------------------------> MME                  

    Context Response
   <-------------------------

    Context Acknowlege
   -------------------------->



** Handover procedure
When a UE has connection to an eNB(through some cell), it is constantly measuring the signal strenths of all the
cell around it.
UE  EMM=registered ECM=connected
while UE is moving, it notices that a new cell is having a significantly stronger signal
than the current cell,then UE will send a Measurement Report to the source eNB
about the event
When source eNB receives the Measurment report it'll make a decision about performing a handover

overview of all handover scenario including intra/inter MME

SENB                                sMME          tMME                                   tSGW                             targetENB                                    sSGW
|                                   |             |                                        |                                       |                                       |
|<-----------------------------------------------------------DL------------------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|---------------------------------->|             |                                        |                                       |                                       |
| - Handover Required               |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Relocation Req                                |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |  - Create Session Request/Resp         |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | ------------------------------------------------------------------------------>|                                       |
|                                   |             |  - Handover Request/  Acknowledge(tenb-teid,enb-dl-teid)                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             | CreateIDFT Req(tenb-dl-teid)/Resp(tSGW-dlteid) |                               |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |<------------|                                        |                                       |                                       |
|                                   |Forward Relocation Res                                |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |               - Create IDFT Request(tSGW-dlteid)/Resp(sSGW-dlteid)                                                                   |<tSGW-dlteid>
|                                   |             |                                        |                                       |                                       |
|<----------------------------------|             |                                        |                                       |                                       |
| - Handover Command(sSGW-dlteid)   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|---------------------------------->|             |                                        |                                       |                                       |
| - ENB Status Transfer             |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Access Context Notification/Ackownledge       |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | ------------------------------------------------------------------------------>|                                       |
|                                   |             |  - MME Status Transfer                                                         |                                       |
|                                   |             |                                        |                                       |                                       |
|enb-teid                           |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |PGW still send DL data to sSGW here
|<------------------------------------------------------------------------------------DL-----------------------------------------------------------------------------------|
|-------------------------------------------------------------------------------------DL---------------------------------------------------------------------------------->|sSGW-dl-teid
|                                                                                tSGW-dltid|<---------------------DL-------------------------------------------------------|
|                                                                                          |----------------DL-------------------->|tenb-dl-teid                           |
|
|------------------------------------ UE detach from old cell and sync to new cell-----------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |<---------------UL-------------------- |for ue know it's time to send UL data    
|                                   |             |                                        |                                       |                                       |
|                                   |             | <------------------------------------------------------------------------------|                                       |
|                                   |             |  - Handover Notify                                                             |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |------------>|                                        |                                       |                                       |
|                                   |Forward Relocation Complete Notification/Ackownledge  |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |Modify Bearer Request(tenb-teid)/Resp   |<tenb-teid>                            |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |---------------DL--------------------> |for PGW know it's time to send DL to tSGW   
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|------------------------------------    -Tracking area update procedure  .------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|------------------------------------ -Resource release for whole handover.------------------------------------------------------------------------------------------------|
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |             |  - Delete Session Request                                                                                              |
|<----------------------------------|             |                                        |                                       |                                       |
|UE Context Release Command/Complete|             |                                        |                                       |                                       |
|                                   |<-------------------------------------------------------------------------------------------------------------------------------------|
|                                   |             |  - Delete Session Response                                                                                             |
|                                   |             |                                        |                                       |                                       |
|                                   |-------------- ---------------------------------------------------------------------------------------------------------------------->|
|                                   |             |  - Delete Indirect Data Forwarding Tunnel Request/Response                                                             |
|                                   |             |                                        |                                       |                                       |
|                                   |             |                                        |                                       |                                       |
|                                   |             | -------------------------------------->|                                       |                                       |
|                                   |             |  - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                   |             | el Request/Response                    |                                       |                                       |
|



precondition: ATTACH and default bearer setup

*** intra mme handover through s1 interface     without SGW relocation
when ue handover from source enb to target enb, the downlink data will lost it destination for a short time.
So in S1 handover, SGW will play as a route, it forward downlink data to target enb, when SGW send downlink
data to source eNB, eNB will forward it to SGW, and SGW forward it to Target eNB, and target eNB will buffer
these data till ue handover to target ENB complete.
case id:NS_70_7_0001 without SGW relocation
Source eNB                          MME                                 Target eNB                            SGW                                 UE                                  
enb-teid                           mme-teid                                                               sgw-teid-c/u
mme-s1ap-id                        sgw-teid-c/u                                                           mme-teid
enb-s1ap-id                        mme/enb-s1ap-id                                                        enb-tid
sgw-teid-u
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|                                    |
|                                    |                                    |                                    |                                    |                                    
|------------------------------------------------------------------UL----------------------------------------->|                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|HandoverRequired(mme-s1apid,tenb-id)|                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    | Handover Request(mme-s1ap-id-tenb, |                                    |                                    |
|                                    |sgw-teid-u,uecontext)               |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |A:[tenb-s1id,tebTEID,tebDLTEID]     |                                    |                                    |
|                                    | <sgw-teid-u,mme-s1ap-id>           |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverRequestAck(tenb-s1id,tenbDLTEID)|                                |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Create IndirectDataForwardingTunnel Request(tenbDLTEID)                  |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |A:<tenbDLTEID>,[SGW-DL-TEID]        |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Create Indirect Data Forwarding Tunnel Response(SGW-DL-TEID)           |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  Handover command(SGW-DL-TEID)     |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  A:<SGW-DL-TEID>                   |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|                                    |
|enb-TEID                            |                                    |                                    |                                    |                                    
|-----------------------------------------------------------------DL------------------------------------------>|      now a dl data will from       |
|                                    |                                    |                         sgw-dl-teid|    sgw---->senb---->sgw----->tenb  |                                    
|                                    |                                    |<---------------DL------------------|                                    |                                    
|                                    |                                    |tebDLTEID                           |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  eNB STATUS TRANSFER               |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |  Mme STATUS Tansfer                |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                          sgw-teid  |                                    |                                    
|                                    |                                    |-----------UL---------------------->|   now targe enb establish with ue  |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |<------------------------------------------------------------------------|
|                                    |                                    |   Handover confirmed                                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |  Handover NOTIFY                   |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(mme-teid,tenb-teid)                              |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(sgw-teid-u)                                     |                                    |
|                                    |                                    | teb-teid                           |                                    |                                    
|                                    |                                    |<----------DL-----------------------|    now DL using tenb-teid instead  |                                    
|                                    |                                    |                                    |    of  forward tunnel              |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Request                         |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Response                        |                                    |


*** intra mme s1 handover with SGW relocation
The differce between with/without SGW relocation is that
SGW relocation means that new sgw-teid-c/u are needed, so extra Create Session Req/Resp are needed for target SGW.
and the IDFT is different
DL data flow is :  sSGW-> sENB-> sSGW ->  (tSGW) -> tENB

tSGW is an extra one compared to without SGW relocation

So there are two IDFT, 
one is 
case id: NS_130_2_0001 with SGW relocation

SENB                                     MME                                    tSGW                             targetENB                                    sSGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required                   |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Session Request              |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | A:[sgw-teid-c,sgw-teid-u]             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | Create Session Response(sgw-teid-c/u) |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Handover Request                                                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Request Acknowledge(tenb-teid,enb-dl-teid)                          |                                       |
|                                       |<tenb-teid>                            |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request(tenb-dl-teid)               |tenb-dl-teid                           |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response(tSGW-dlteid)               |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(tSGW-dlteid)                                                         |<tSGW-dlteid>
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sSGW-dlteid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sSGW-dlteid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|enb-teid                               |                                       |                                       |                                       |
|<-------------------------------------------------------------------------DL-----------------------------------------------------------------------------------|
|--------------------------------------------------------------------------DL---------------------------------------------------------------------------------->|sSGW-dl-teid
|                                                                     tSGW-dltid|<---------------------DL-------------------------------------------------------|
|                                       |                                       |----------------DL-------------------->|tenb-dl-teid                           |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - MME Status Transfer                                                         |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Notify                                                             |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Modify Bearer Request(tenb-teid)    |<tenb-teid>                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Modify Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |----------------DL-------------------->|tenb-teid                           |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-----------------------------------------Resource release for whole handover.----------------------------------------------------------------------------------|                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Session Request                                                                                              |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response                            |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Session Response                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Indirect Data Forwarding Tunnel Response                                                                     |
|                                       |                                       |                                       |                                       |

*** intra mme partially handover
As an operator I want that MME is able to handle the case that the target eNB does not accept one or more default bearers during a otherwise successful S1 based handover procedure in order to releases resources that are not needed any i
longer and terminate the procedure properly.
If all default bearer is in the failedsetuplist in HandvoerRequetAck message, then no continuing handover procedure IDFT creating and MBR message flow.
case id: NS_70_28_0001 partially handover

precondition: PDN1: default bearer 5; PDN2: default bearer 6 ,dedicated bearer 8; PDN3: default bearer 7
Source eNB                          MME                                 Target eNB                            SGW                                 UE                                  
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|HandoverRequired(mme-s1apid,tenb-id)|                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    | Handover Request(e-rabs to be setup|                                    |                                    |
|                                    |item ie for 5,6,7&8)                |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |A:default bearer 5&8 is accepted    |                                    |                                    |
|                                    | while 6&7 not accepted>            |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverRequestAck(bearer 5,8 in e-rab|                                  |                                    |
|                                    |admittedlist,6,7 in failedsetuplist|                                     |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Create IndirectDataForwardingTunnel Request(bearer context for bearer5)  |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Create Indirect Data Forwarding Tunnel Response(SGW-DL-TEID)           |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  Handover command(e-rabs forwarding|                                    |                                    |                                    |
|items  5,e-rab releaselist 6,7,&8   |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  eNB STATUS TRANSFER               |                                    |                                    |                                    |
|                                    |----------------------------------->|                                    |                                    |
|                                    |  Mme STATUS Tansfer                |                                    |                                    |
|                                    |                                    |<------------------------------------------------------------------------|
|                                    |                                    |   Handover confirmed                                                    |
|                                    |<-----------------------------------|                                    |                                    |
|                                    |  Handover NOTIFY                   |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |-------------------------------------------------------------------------|                                    |
|                                    |for every pdn connection, there's one MBR message sent                   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-1,bearercontextstobemodified 5)   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-3,bearercontextstoberemoved 7)    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(pdn connection-1,bearercontextstobemodified 5)  |                                    |
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer reponse(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(pdn connection-3,bearercontextstoberemoved 7)   |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |-------------------------------------------------------------------------|                                    |
|                                    |for pdn connection failed to be forwarded, there's DSR message sent      |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Delete Session  request(pdn connection-1,bearercontextstobemodified 5)   |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(pdn connection-2,bearercontextstoberemoved 6&8)  |                                    |
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Request                         |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Response                        |                                    |


*** x2 handover without SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_13_2_0002  
Target eNB                              MME                                   SGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | Modify bearer request(teb-teid)      |
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | Modify bearer response               |
|                                       |                                      |
| <-----------------------------------  |                                      |
| Path Switch Request Ack               |                                      |



*** x2 handover with SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_130_3_0001
Target eNB                              MME                                   tSGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | create session request(teb-teid)     |<teb-teid>[sgw-teid-c/u]
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | create session response(sgw-teid-c/u)|
|                                       |                                      |
|                                       |                                      |
| <-----------------------------------  |                                      |
| Path Switch Request Ack(sgw-teid-u)   |                                      |


**** How MME know this handover need SGW relocation?
when MME received target-enb tai is different with the source-enb ta list, it will trigger DNS check state, if sgw is as the same hostname and ip, then, no sgw relocation.



*** inter mme(s10) s1 handover without SGW relocation        
source mme sut case id:NS_129_11_0002
target mme sut case id:  NS_129_22_0001

sENB                                    sMME                                    tMME                                    tENB                                    SGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required(tenb-id)          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Forward Relocation Request(sgw-teid-u, |<sgw-teid-u>[sgw-teid-c]               |                                       |
|                                       |  imsi,tenbid)                         |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       |  -Handover Request(sgw-teid-u)        |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       |HandoverRequestAck(enb-dl-teid,enb-teid)|                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       |Forward Relocation Response(enb-dl-teid)|                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(enb-dl-teid)                                                         |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sgw-dl-teid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sgw-dl-teid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Access Context Notification |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Access Context Acknowledge  |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       | - MME status transfer                 |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       | - Handover Notify                     |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Relocation Complete Notifica|                                       |                                       |
|                                       |tion                                   |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Relocation Complete Acknowle|                                       |                                       |
|                                       |dge                                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |------------------------------------------------------------------------------>|
|                                       |                                       |  - Modify Bearer Request (tenb-teid)                                          |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<------------------------------------------------------------------------------|
|                                       |                                       |  - Modify Bearer Response                                                     |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |


*** intersystem  Gn_based Handover (ISHO) from LTE to 3G 
MME act like 3g SGSN
The source eNB sends a Handover Required message to the MME to inform that the UE has changed cell. The message contains target RNC ID. The MME determines
the target SGSN from the target RNC ID with S-NAPTR DNS inquiry (if the feature SNAPTR (Rel 8) DNS query for Gn SGSN is enabled. Otherwise, the MME uses pre-
Rel 8 DNS query). The MME maps EPS bearer(s) to PDP context(s) and provides the Release 99 parameters of the bearer QoS profile to the SGSN

Gn Based 3G LTE pic:

     Gr
HLR--------\
            \    Gn
RNC--------SGSN-------PGW
            |          | 
          Gn|          |s5
            |  s11     |
ENB--------MME-------SGW
          /    
         /
HSS-----/
Gn: Gtpv1


case: NS_131_10_0001 
Similar IDFT established, but all the default  bearer related resource both in ENB and SGW will be released(sgw-teid-c/u,enb-teid-u), all ids in MME also be removed
ENB                                              MME                                               SGSN                                              SGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Handover Required                             |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Request                    |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Forward Relocation Response                   |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Create Indirect Data Forwarding Tunnel Request                                                  |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Create Indirect Data Forwarding Tunnel Response                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Handover Command                              |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Forward Relocation Complete Notification      |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Complete Acknowledge       |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - UE Context Release Command                    |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session Request                                                                          |
|------------------------------------------------>|                                                 |                                                 |
| - UE Context Release Complete                   |                                                 |                                                 |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Delete Session Response                                                                         |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Indirect Data Forwarding Tunnel Request                                                  |


**** inersystem Gn_based Handover(ISHO) from LTE to 3G multiple bearers
when there are multiple bearer, for example, two pdn default bearer, and two dedicated bearer linked to those two default bearers.
when handover, ForwardRelocationRequest will send 4 pdp contexts, ebi corresponding to nSAPI
and another field in this message:
selectionModewithNSAPI two dedicated bearer will be in that.

                 
                   
                  
*** intersystem  S3_based Handover (ISHO) from LTE to 3G using S4-SGSN
LTE to 3G S3-based handover procedure with or without S-GW relocation
When the S3-based inter-system handover feature is enabled, the MME uses the SNAPTR DNS query and requests both S3 and Gn addresses. The feature DNS query
type in S3-based inter-system handover is used to decide which is used, RAI or RNC ID, to make the DNS query.If there is a result after the S-NAPTR DNS query, the MME sends the Forward
Relocation Request message (MM context and PDN connections) to the target SGSN over the S3 interface.

S3 interface in the LTE system(S4-SGSN)
      Gb                   S4                S5
BSC-----------S4-SGSN--------------SGW-------------PGW
               /  |  \s6d           /
              /   |   \            / 
RNC----------/    |   HSS         /
                S3|  /s6a        /
                  | /           /s11
ENB--------------MME-----------/
 

As we can see here, SGSN connected directly to PGW, so teid of SGW is not necessary, when handover from 3G to LTE, mme will send creatsessionrequest to SGW
and when from LTE to 3G, mme will send deletesessionrequest to SGW for it's not useful in Gn based SGSN.

But in S3 interface, SGSN-S4 connected direct to SGW, so teid of SGW is necessary, when handover from LTE to 3G,mme won't release the sgw-teid resource(unless SGW relocated)
and when form 3G to LTE,mme won't send createsessionrequest to SGW(unless SGW relocated).


case id:NS_001288_01_0001
ENB                                               SUT                                               SGSN                                              SGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Handover Required                             |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Request                    |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - ForwardRelocationResponse(SGSN_F_TEID_for_dl_data_forwarding |                                  |
|                                                 | rNC_F_TEID_for_dl_data_forwarding )             |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Create Indirect Data Forwarding Tunnel Request(SGSN_F_TEID_dl)                                  |
|                                                 | rNC_F_TEID_for_dl_data_forwarding )             |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Create Indirect Data Forwarding Tunnel Response(SGW_FTEID_DL)                                   |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Handover Command                              |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Forward Relocation Complete Acknowledge       |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - UE Context Release Command                    |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Indirect Data Forwarding Tunnel Request                                                  |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - UE Context Release Complete                   |                                                 |                                                 |

this is only valid , when SGW is relocated(indication flag<sGWChangeIndication e_true(1)>)in FowardRelocationResp, then MME will send delete session request. 
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session  Request                                                                         |




*** intersystem s3_based Handover(ISHO) from 3G to LTE  without SGW relocation
case id:NS_001505_01_0001
SGSN                                    MME                                     ENB                                     SGW                                     HSS
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Forward Relocation Request          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Handover Request                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Handover Request Acknowledge        |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Forward Relocation Response         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Handover Notify                     |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Forward Relocation Complete Acknowle|                                       |                                       |                                       |
|dge                                    |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Modify Bearer Request                                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Modify Bearer Response                                                      |                                       |
|                                       |                                       |                                       |                                       |



*** SRVCC handover to GERAN/UTRAN with PS HO in Gn interface.(also sv interface[MME, MSC] configured)
The core network needs to support VoIP capable LTE handsets to continue onging voice call when the user move outside of LTE coverage and the voice call is moved
to CS domain usgin 2G/3G access. This functionality is called single radio voice call continuity(SRVCC)
This functionality enables operators to reuse exsiting CS voice infrastructure in areas where LTE is not yet deployed.
The call is anchored in IMS and the UE is capable of transmitting and receiving in only one of those acess networks at a time.
The MME makes handover for the PS voice bearer towards the MSC server over the sv interface and for non-voice bearer towards SGSN over Gn interface.

network as: voice bearer was transfered through MSC, and not using SGW/PGW anymore.


             CS    Voice              |----------------------|
BSC/RNC----SGSN-----MSC------------------IMS                 |
                   /                  |                      |
                  /Sv        PS voice |                      |
ENB-----------MME/-----SGW/PGW---------------internet         |
                                      |   corporate services |
                                      |______________________|

PS service was transfered as follow through Gn interface:

BSC/RNC------SGSN-------\        
             |           \      
             |Gn          PGW------internet corporateive service
             |           /
ENB--------MME--------SGW

So after SRVCC PS handover, all LTE network element will release all the bearer realted resources.
ENB: ue context release command
SGW: delete session request
  

case id: NS_1279_5_0001
one default bearer established in  attach,
mSNetworkCapability: sRVCC_to_GERAN_UTRAN_capability(1) in attachRequest
S1AP.SRVCCOperationPossible possible(0) in  Ue context setup message  
one dedicated bearer established later
Now travel from LTE to 3g 


ENB                                     MME                                     MSC                                     SGSN                                    SGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required                   |                                       |                                       |                                       |
|(S1AP.SRVCCHOIndication pSandCS        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |MME seprate voice bearer(qci=1)        |                                       |                                       |
|                                       |-------------------------------------->|(dedicated bearer handover to MSC)     |                                       |
|                                       | - SRVCC PS to CS Request(mme-teid)    |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - SRVCC PS to CS Response             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Forward Relocation Request                                                  |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Forward Relocation Response                                                 |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response                                                                     |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command                    |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|(default bearer handover complete)     |
|                                       | - Forward Relocation Complete                                                 |                                       |
|                                       |                                       |                                       |                                       |

|                                       |<--------------------------------------|                                       |                                       |
|                                       | - SRVCC PS to CS Complete Notification|                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - SRVCC PS to CS Complete Acknowlege  |(dedicated bearer to MSC complete)     |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|release dedicated bearer
|                                       | - Delete Bearer Command                                                                                               |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Bearer Request                                                                                               |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Bearer Response                                                                                              |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Forward Relocation Complete Acknowledge                                     |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Session Request                                                                                              |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Session Response                                                                                             |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |


**** SRVCC handover with multiple bearers
case id: NS_001344_04_1015
when there are multiple bearer, for example, two pdn default bearer, and two dedicated bearer linked to those two dedicated bearers.
one of dedicated bearer is voice call bearer(qci 1)
when handover, ForwardRelocationRequest will send 3 pdp contexts, ebi corresponding to nSAPI
voice bearer  will be in SRVCC PS to CS Request




*** SRVCC from E-UTRAN to UTRAN/GERAN without packet-switched handover(PS HO)
SRVCC HO Indication:CSOnly
The UE sends measurement reports to the E-UTRAN. Based on the UE measurement reports the source E-UTRAN triggers an SRVCC handover to the UTRAN/GERAN. The
eNB sends the Handover Required message, indicating that the target is UTRAN/GERAN with only CS HO support, to the source MME, so the data service will be 
transfered to SGSN via IS RAU instead of handover.


This procedure is after attach procedure:
TestScenrio1:

| Attach (DefBR) | HO Required (SRVCC HO Indication - CSOnly) | SRVCC PS To CS  Req & Res (MSC) | HO Cmd |
| SRVCC PS To CS Complete Notification & Ack | DedBR Deact Delete Bearer Cmd & Res (SGW) | IS RAU SGSN Cntx Req, Res & Ack |
| UE Cntx Rel Cmd & Cmpl | Delete Session Req & Res (SGW) |


ENB                                     MME                                     SGW                                     HSS                                     SGSN
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Bearer Resourc|                                       |                                       |                                       |
|e Allocation Request)                  |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Bearer Resource Command             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Create Bearer Request               |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - E-RAB Setup Request (Activate Dedica|                                       |                                       |                                       |
|ted EPS Bearer Context Request)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - E-RAB Setup Response                |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Activate Dedic|                                       |                                       |                                       |
|ated EPS Bearer Context Accept)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
-----------------------------------------above is create a dedicated bearer procedure after a imsi attach procedure---------------------------------------------|                                       |                                       |                                       |
|                                       |

ENB                                    MME                                     SGW                                     MSC                                     SGSN 
|-------------------------------------->|                                       |                                       |                                       |
|Handover Required(SRVCC HO ind-CSOnly) |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|
|                                       | -  SRVCC PS To CS Req/Res                                                     |
|                                       |<------------------------------------------------------------------------------|
|                                       | -  SRVCC PS To CS Req/Res                                                     |
|<--------------------------------------|                                       |
|- Handover Command                     |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|
|                                       | -  SRVCC PS To CS Complete Notification                                       |
|                                       |------------------------------------------------------------------------------>|
|                                       | -  SRVCC PS To CS Complete Acknowledge                                        |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Bearer Command               |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Delete Bearer Request               |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                      UE switched to UTRAN/GERAN all 3g stuff
                            MS-----------------------------Routing area update request------------------------------------------------------------------------->|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|(RAU
|                                       | - SGSN Context Request                                                                                                | 
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - SGSN Context Response                                                                                               |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - SGSN Context Acknowledge                                                                                            |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Release Access Bearer Request       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Release Access Bearer Response      |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Session Request              |                                       |                                       |





* NACC (Network Assisted Cell Change) from UTRAN to GERAN

In today's GPRS networks (without NACC), cell re-selection can causes a service interruption in the region of 4–8 seconds, which obviously has an impact on the user experience.
Similar interruption times can be expected in mixed UMTS and GPRS networks, during UE cell re-selection from UTRAN to GERAN.
Consequences of this: e.g. TCP applications may time-out at cell change and suffer from the slow-start mechanism, streaming applications may stop at cell change due to client
buffer depletion. All such problems will lead to an unacceptable user experience.
This "Network Assisted Cell Change" feature has already been introduced in the GERAN specifications and the appropriate changes have been to the RLC/MAC protocol [TS 44.060]

** customer senario
NA05868027: RIM-messages from shared radio-network

Msg.nr 99719    S1-eNBDirectInformationTransfer from eNodeB ID=111125, tac=2AFE to lac=2AFC
Msg.nr 99763 DNS-query from AVKC-MME-Gn, rac0000.lac2AFC.mnc024.mcc240.gprs
Msg.nr 99780 DNS-reponse with a list of IPs
Msg.nr 99807 Gn-RAN Information Relay, from AVKC-MME-Gn to AVKC-SGSN-Gn.
Msg.nr 99817 BSSGP-RAN Information Request, from AVKC-SGSN-Gb to BSC110
Msg.nr 100454 BSSGP-RAN Information, from BSC110 to AVKC-SGSN-Gb
Msg.nr 100470 DNS-query from AVKC-SGSN-Gn, tac2AFE.mnc007.mcc240.gprs.
Msg.nr 100484 DNS-response with a list of IPs
Msg.nr 100495 Gn-RAN Information Relay, from AVKC-SGSN-Gn to AVKC-MME-Gn.
No message on S1 from AVKC-MME-Gn ???
 

SGSN                                              BSC                                               MME                                               ENB
|                                                 |                                                 |                                                 |4G-->2G
|                                                 |                                                 |<------------------------------------------------|
|                                                 |                                                 | - ENB Direct Info Transfer(S1AP)                |
|                                                 |                                                 |                                                 |
|<--------------------------------------------------------------------------------------------------|DNS-query for rac0000.lac2AFC.mnc024.mcc240.gprs |
| -  RAN Information Relay(GTP)                                                                     |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - RAN Information Request(BSSGP)                |                                                 |                                                 |

|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|2G-->4G                                          |                                                 |
| - RAN Information                               |                                                 |                                                 |
|DNS-query tac2AFE.mnc007.mcc249.gprs             |                                                 |                                                 |
|-------------------------------------------------------------------------------------------------->|                                                 |
| - RAN Information Relay(Gtp)                                                                      |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |------------------------------------------------>|
|                                                 |                                                 | - MME Direct Information Transfer(S1AP)         |



* EPS session management related
Default bearer:   with new PDN addr(APN), QCI to create, with a ebi(allocated from mme side), sending (create session req) to SGW from MME to get s1-u-sgw-fteid from CSResp.
                  Then E-RAB setup procedure: sending (E-RAB setup) to ENB containing ebi, s1-u-sgw-fteid as transportlayeraddr, and Qos,APN,PDNAddr(ip).
                                              ENB response if the setup successful(with allocated s1-u-enb-fteid by ENB). if fail(no teid).
                  then seding Modify Bearer Req to SGW containing s1-u-enb-fteid. 


         
dedicated bearer: without APN, but new QCI, tft, LinkedBearIdentity(ebi of default bearer), s1-u-sgw-fteid sending (create bearer req) from SGW.(ebi of dedicated bearer will be omit)
                  multiple dedicated bearer could be established with only one LBI(LinkedBearerId) on the same default bearer for different qos level(qci), same PDN addr/ip, APN.
                  Then E-RAB setup procedure: seding (E-RAB setup) to ENB containing s1-u-sgw-fteid as transportlayeraddr, Qos, tft and ebi;
                                              ENB response(E-RAB response) if the setup successful(with s1-u-enb-fteid as transportlayeraddr).
                  then sending CreateBearerResponse to SGW containing s1-u-enb-fteid.               


For operator-based applications such as VOIP, special Qos requirements such as a constant delay and minimum bandwidth can be ensured for a particular traffica flow by 
                  establishing a dedicated bearer. IP packets flowing over a dedicated bearer use the same source IP address as packets flowing through the bearer, but destination ip
                  address(SGW_TEID) is different from defualt bearer.



** Bearer, PDN and payload
ip packet on s1-u and s5/s8/u
------------------------------------------------------------------------------|
|GTP-U service-IP   | UDP packet |GTP-U header | GTP-U palyload               |
|                   |            |             |IP packet in real internet    |
|                   |            |             |----------|-------------------|
|S: s1-u-enb-fteid  |sport       |             |S:PDN-IP  |real ip-payload    |
|D: s1-u-sgw-fteid  |dport       |             |D:Host-IP |                   |
|---------------------------------------------------------|--------------------

There are two ip headers in a s1-u ip packet
one is ip header for udp trasport layer of GTP(all the s1-u fteid allocated in signalling with MME SM procedure)
other one is the real internet ip packet in that PDN.(PDN-IP is the real source addr and Host-IP is the real application host)

|        
|first default bearer Act in Attach procedure      
|---------------------------------------------
HSS -> MME|get APN from HSS
MME -> DNS|DNS query for (sgw[using tai]/pgw ip[using apn and mnc,mcc]) [do the pairing of SGW&PGW]
MME -> SGW|CSeReq(fteid-mme,PGWip,apn,bearertobecreated[ebi])
SGW -> PGW|SGW get (fteid-pgw-gtp-c, paa[pgw allocation ip addr]) from PGW via PGWip addr
MME <- SGW|CSeResp(fteid-sgw-gtp-c,fteid-pgw-gtp-c,paa[pgw allocation ipaddr],bearertobecreated res[fteid-s1-sgw-gtp-u,e_s5_or_s8_pgw_gtp_u])
MME -> ENB|InitialContextSetupReq(fteid-s1-sgw-gtp-u,apn,pdnaddr[paa],E_RABToBeSetupItemCtxtSUReq[erab-id same with ebi]) ---for real dst ip addr is:paa(PDN-ip)
MME <- ENB|InitialContextSetupRes(E_RABToBeSetupItemCtxtSUReq(erabid,transportLayerAddress[ftied-s1-enb-gtp-u]))
===Now UE could send a uplink ip packet to APN via GTP-U message to www.google.com
===GTP-U ipsrc: fteid-s1-enb-gtp-u      GTP-U-PalyLoad   realipsrc:PDN-ip
===      ipdst: fteid-s1-sgw-gtp-u                       realipdst:www.google.com
MME -> SGW|ModifyBearerReq(fteid-s1-enb-gtp-u)
===Now UE could receive a downlink ip packet from PGW, 
===GTP-U ipsrc: fteid-s1-sgw-gtp-u      GTP-U-PalyLoad   realipsrc:www.google.com
===      ipdst: fteid-s1-enb-gtp-u                       realipdst:PDN-ip





** EPS bearer Qos parameter

***  Resource Type: GBR or Non-GBR
**** Resource Type = GBR (Guaranteed Bit Rate)
For an EPS bearer, having a GBR resource type means the bandwidth of the bearer is guaranteed. Obviously, a GBR type EPS bearer has a "guaranteed bit rate" associated
(GBR will be further explained below) as one of its QoS parameters. Only a dedicated EPS bearer can be a GBR type bearer and no default EPS bearer can be GBR type. 
The QCI of a GBR type EPS bearer can range from 1 to 4.


**** Resource Type = Non-GBR
For an EPS bearer, having a non-GBR resource type means that the bearer is a best effort type bearer and its bandwidth is not guaranteed. A default EPS bearer
 is always a Non-GBR bearer, whereas a dedicated EPS bearer can be either GBR or non-GBR. The QCI of a non-GBR type EPS bearer can range from 5 to 9.


***  QoS Parameters
Every EPS bearer must have QI and ARP defined. The QCI is particularly important because it serves as reference in determining QoS level for each EPS bearer.
 In case of bandwidth (bit rate), GBR and MBR are defined only in GBR type EPS bearers, whereas AMBR (APN-AMBR and UE-AMBR) is defined only in Non-GBR type EPS bearers. 

6 qos parameters
    QCI
    ARP
    GBR
    MBR
    APN-AMBR
    UE-AMBR

 
**** QCI (QoS Class Identifier)
QCI, in an integer from 1 to 9, indicates nine different QoS performance characteristics of each IP packet. QCI values are standardized to reference specific QoS characteristics, and each QCI contains standardized performance characteristics (values), such as resource type (GBR or non-GBR), priority (1~9), Packet Delay Budget (allowed packet delay shown in values ranging from 50 ms to 300 ms), Packet Error Loss Rate (allowed packet loss shown in values from 10-2 to 10-6. For more specific values, search on Google for "3GPP TS 23.203" and see Table 6.1.7 in the document. For example, QCI 1 and 9 are defined as follows:
 
QCI = 1
: Resource Type = GBR, Priority = 2, Packet Delay Budget = 100ms, Packet Error Loss Rate = 10-2 , Example Service = Voice
QCI = 9
: Resource Type = Non-GBR, Priority = 9, Packet Delay Budget = 300ms, Packet Error Loss Rate = 10-6, Example Service = Internet
 
QoS to be guaranteed for an EPS bearer or SDF varies depending on the QCI values specified.
QCI, though a single integer, represents node-specific parameters that give the details of how an LTE node handles packet forwarding (e.g. scheduling weights, admission thresholds, queue thresholds, link layer protocol configuration, etc). Network operators have their LTE nodes pre-configured to handle packet forwarding according to the QCI value.
 
By pre-defining the performance characteristics of each QCI value and having them standardized, the network operators can ensure the same minimum level QoS required by the LTE standards is provided to different services/applications used in an LTE network consisting of various nodes from multi-vendors.    
 
QCI values seem to be mostly used by eNBs in controlling the priority of packets delivered over radio links. That's because practically it is not easy for S-GW or P-GW, in a wired link, to process packets and also forward them based on the QCI characteristics all at the same time (As you may know, a Cisco or Juniper router would not care about delay or error loss rate when it processes QoS of packets. It would merely decide which packet to send first through scheduling (WFQ, DWRR, SPQ, etc.) based on the priority of the packets (802.1p/DSCP/MPLS EXP)). 


**** ARP (Allocation and Retention Priority)
When a new EPS bearer is needed in an LTE network with insufficient resources, an LTE entity (e.g. P-GW, S-GW or eNB) decides, based on ARP (an integer ranging 
from 1 to 15, with 1 being the highest level of priority), whether to:
    remove the existing EPS bearer and create a new one (e.g. removing an EPS bearer with low priority ARP to create one with high priority ARP); or
    refuse to create a new one. 

So, the ARP is considered only when deciding whether to create a new EPS bearer or not. Once a new bearer is created and packets are delivered through it, the i
ARP does not affect the priority of the delivered packet, and thus the network node/entity forwards the packets regardless of their ARP values.
One of the most representative examples of using the ARP is an emergency VoIP call. So, an existing EPS bearer can be removed if a new one is required for a emergency
 119 (911 in US, 112 in EC, etc) VoIP call. 

**** GBR (UL/DL)
This parameter is used for a GBR type bearer, and indicates the bandwidth (bit rate) to be guaranteed by the LTE network. It is
 not applied to a non-GBR bearer with no guaranteed bandwidth (UL is for uplink traffic and DL is for downlink traffic).

****  MBR (UL/DL)
MBR is used for a GBR type bearer, and indicates the maximum bit rate allowed in the LTE network. Any packets 
arriving at the bearer after the specified MBR is exceeded will be discarded.

**** APN-AMBR (UL/DL)
As you read the foregoing paragraph, you may wonder why a non-GBR type bearer does not have a "bandwidth limit"? In case of non-GBR bearers,
 it is the total bandwidth of all the non-GBR EPS bearers in a PDN that is limited, not the individual bandwidth of each bearer. And this restriction is controlled by APN-AMBR (UL/DL). As seen in the figure above, there are two non-GBR EPS bearers, and their maximum bandwidths are specified by the APN-AMBR (UL/DL)
. This parameter is applied at UE (for UL traffic only) and P-GW (for both DL and UL traffic).

**** UE-AMBR (UL/DL)
A UE can be connected to more than one PDN (e.g. PDN 1 for Internet, PDN 2 for VoIP using IMS, etc.) and it has one unique IP address for each of its all PDN connections. Here, UE-AMBR (UL/DL) indicates the maximum bandwidth allowed for all the non-GBR EPS 
bearers associated to the UE no matter how many PDN connections the UE has.
**** TFT(EPS bearer traffic flow template)
TFT is a set of all packet filters associated with that EPS bearer.
A default bearer may or may not be assocaited with a TFT.
Every dedicated EPS bearer is assocatied with a TFT.

 Other PDNs are connected through other P-GWs, this parameter is applied by eNBs only.

*** Non-Qos Parameter 
**** TFT(for default bearer)
**** 
The P-GW initiated bearer modification without QoS update is used to update the TFT
for an active default bearer, or to modify the APN-AMBR value



** Ue-initiated EPS bearer activation 

*** Default EPS bearer context activation procedure
eg. ue want a voip call, it will initiate a IMS  default bearer 
ENB:  ------>  MME - Uplink NAS Transport (PDN Connectivity Request[apn])
===DNS query using ims apn:         QNAME     = ims.apn.epc.mnc124.mcc262.atca124.common.3gppnetwork.org.
===                                 QTYPE     = NAPTR
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response(sgw-teid-c[senderfteid],sgw-teid-u[s1_U-sgw_fteid])
(in attach procedure these E-RAB Setup mesage will be replaced with InitialContextSetupRequest )
ENB:  <------  SUT - E-RAB Setup Request (Activate Default EPS Bearer Context Request)(sgw-teid-u in [transportLayerAdress]
ENB:  ------>  SUT - E-RAB Setup Response (enb-teid-u in [transportLayerAddress])
ENB:  ------>  SUT - Uplink NAS Transport (Activate Default EPS Bearer Context Accept)
SGW:  <------  SUT - Modify Bearer Request(mme-teid-c in [senderfteid],enb-teid-u in [s1_eNodeB_FTEID ])
SGW:  ------>  SUT - Modify Bearer Response(sgw-teid-c in [senderfteid],enb-teid-u in [s1_eNodeB_FTEID ])

the difference between  initial context setup request and activate eps bearer context is the former is for establishing the first default bearer,
and later for none-first default bearer; and in Dedicated EPS bearer context activation procedure, no sgw-teid-u will be allocated for it is linked with defaultbearid,
only enb-teid-u and sgw-teid-u allocated, but in Default bearer activation, there will be sgw-teid-c, sgw-teid-u and sgw-teid-c allocated.

*** Dedicated EPS bearer context activation procedure
then ue create the dedicated bearer on that default bearer with different qci
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  SUT - Bearer Resource Command{linkedBearerid,tft, but without senderfteid,for senderfteid is related to linkedBearerid}

*** PGWDedicatedBearerActivationProcedure
SGW:  ------>  SUT - Create Bearer Request(linked-ebi,bearercontexts[tft(filtered ipaddr),s1_u_sgw_fteid,s5ors8_u_pwg_fteid,qos] 
ENB:  <------  SUT - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request) {sgw-teid-u in [transportlayeraddress],erabSUReq[tft]) }
=====ENB got tftaddr as sourceip when send UL packet in realipaddr instead of paa
ENB:  ------>  SUT - E-RAB Setup Response{enb-teid-u in [transportlayeraddress],
ENB:  ------>  SUT - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response {enb-teid-u in [s1-eNodeB-Fteid]}

ENB                                     MME                                     SGW                                     HSS                                     SGSN
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Bearer Resourc|                                       |                                       |                                       |
|e Allocation Request)                  |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Bearer Resource Command(linkedbearerId, tft)                                   |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       |  Create Bearer Request (sgw-teid-u)   |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - E-RAB Setup Request (Activate Dedica|                                       |                                       |                                       |
|ted EPS Bearer Context Request)        |                                       |                                       |                                       |
|transportLayerAddress(sgw-teid-u)      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - E-RAB Setup Response                |                                       |                                       |                                       |
|transportLayerAddress(enb-teid-u)      |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Uplink NAS Transport (Activate Dedic|                                       |                                       |                                       |
|ated EPS Bearer Context Accept)        |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Create Bearer Response(s1_U_eNodeB_FTEI|                                       |                                       |
|                                       |D field of enb-teid-u)                 |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
-----------------------------------------above is create a dedicated bearer procedure after a imsi attach procedure---------------------------------------------|                                       |                                       |                                       |
|                                       |




** Ue-initiated EPS bearer deactivation
*** EPS default bearer deactivation procedure
ENB:  ------>  SUT - Uplink NAS Transport(PDN Disconnect Request)
SGW:  <------  SUT - Delete Session Request
SGW:  ------>  SUT - Delete Session Response
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)


*** EPS dedicated bearer context deactivation procedure
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Delete Bearer Request
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)
SGW:  <------  SUT - Delete Bearer Response


if a Default bearer is deleted with (delete session req), then the dedicated bearer linked to it also be removed.
SGW:  <------  SUT - Delete Session Request
SGW:  ------>  SUT - Delete Session Response
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)

the difference between ue context release and E-RAB Release Command is the former ENB will remove all the bearers context and the s1ap-id, and later ENB only remove bearers context only.

if a dedicated bearer is deleted with (delete bearer req), then the default bearer will still exist till using(delete session req) to it.
ue stop the voip call:
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Delete Bearer Request
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)
SGW:  <------  SUT - Delete Bearer Response


** UE initiated bearer resource modification procedure.
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW ------> MME  - Update Bearer Request
ENB <------ MME  - E-RAB Modify Request(Modify EPS Bearer Context Request)
ENB ------> MME  - E-RAB Modify Response
ENB <------ MME  - Modify EPS Bearer Context Accept
PGW <------ MME  - Update Bearer Response




*** EPS default bearer context modification procedure
**** PGW-initiated default bearer modification(QOS)
MME supports P-GW-initiated default bearer modificatin to change parameters such as QCI,ARP,APN-AMBR, and traffic flow template(TFT).
SGW ------> MME  - Update Bearer Request
ENB <------ MME  - E-RAB Modify Request(Modify EPS Bearer Context Request)
ENB ------> MME  - E-RAB Modify Response
ENB <------ MME  - Modify EPS Bearer Context Accept
PGW <------ MME  - Update Bearer Response

**** PGW-initiated default bearer modification(non-QoS), UE in ECM-CONNECTED state
S/PGW ------> MME - Update Bearer Request
ENB   <------ ENB - Downlink NAS Transport(Modify EPS Bearer Context Request)
ENB   ------> MME - Uplink NAS Transport(Modify EPS Bearer Context Accept)
ENB   <------ MME - UE Context Modification Request   (UE AMBR change)
ENB   ------> MME - UE Context Modification Response
S/PGW <------ MME - Update Bearer Response


*** EPS dedicated bearer modification (the same with PGW-initiated default bearer modification(non-QoS).


* LTE network Voice Service
** vocie service based on circuit-switched technology

Radio network-------------------MSC server--------------------
|                singalling      |                           |
|                                |                           |
|                                |                         PSTN/ss7 voice network
|                                |                           |
|                                |                           |
|------------------------------Media gateway-----------------
  Media flow(voice call)


** voice services with IMS technology

--------------------P-CSCF--------S-CSCF-----I-CSCF
|  sip singalling                              |
|                                             SBC-----------external ip network
ip access network
|
|           
-------------------------Media GW-------------External circuit-switched networks
Media flow(eg.voice call)          voice call           

with IMS, voice call can either go via MediaGW---->MSC or a SIP-based call handled by the IMS( circuit-switched call.)
and also, IMS an supoort MMTel which is voip call.this is the LTE voice service mostly used.(ps call)

** voice call continuous between LTE coverage and not coveraged area
There are three different use cases that need to be considered:
1. A voice call is established when in LTE coverage (dark area), and the user is not moving outside LTE coverage during the duration of the call. For this use
case, MMTel would be used to provide the voice service over LTE.

2. A voice call is established when outside LTE coverage (light area). The call would then instead be established using circuit-switched access over, for example, GSM.
Depending on the solution, the call could be converted into a SIP-based call and handled by the IMS system, or it can be handled as a traditional circuit-switched call by the MSC.

3. A voice call is established when in LTE coverage (dark area) and during the voice call, the user moves outside LTE coverage. If the system depicted as
a light area can support IMS/MMTel voice services, this would be handled through a ‘Packet Handover’ between LTE and the other system (e.g. WCDMA/
HSPA or eHRPD) and the voice service would continuously be served as an IP-based service and handled by the IMS infrastructure. If this is not the
case, specific measures are needed to secure service continuity when LTE coverage is lost. The 3GPP solution for this is called Single-Radio Voice Call Continuity (SRVCC).

From above, we can see convergence between LTE and 3g/2g network, when ue leave the LTE, voip call(IMS/MMTel) could be continued if the cell supoorted voip even if the cell is not
E-utran. if the cell not E-utran not support the voip, then srvcc is a way to handover the voice call to MSC.


** EPS SRVCC and CSFB
CSFB x SRVCC:

    It is not necessary to implement both solutions (CSFB and SRVCC) at the same time, if the network has a wide LTE coverage and a complete IMS backbone.
        If we implemente CSFB, it means we will not make the call setup using existing IMS Core, and that could take care of that call in LTE.
        In respect to the SRVCC: assuming the Backbone IMS is available. In this case, if the register in the IMS is successful, the user do not need to do CSFB - A voice call can be simply initiated in LTE network using IMS.
    CSFB is a service handover procedure while SRVCC is a coverage handover procedure.


LTE voice issue:
in overalll 2/3/4G network, voice call has two forms:
1. call suppported by IMS Core (this is a VOLTE/VOIP feature, and when ue swith from 4g to 3g, srvcc handover occured)
in LTE env(EUTRAN), the voice call is from ENB--->SGW-----PGW---->IMS Core
in UTRAN, the voice call is from UTRAN----->MSC--------->IMS Core
So as long as svrcc handover from MME to MSC, 

2. tranditional circuit call  (UE anchored both in LTE and 3G, when mo/to(mobile originate/mobile terminal) call, ue will fall back to 3g network)
tranditoinal circuit call is from UTAN------>MSC (no IMS core)

So when UE move between those 2/3/4g network the cell not supported voip, there are 2 different mechanism to support voice call.
SRVCC is for handing over from S/PGW----->IMS  to MSC----->IMS
CSFB  is not handover,it just fallback to CS domain whenever it need a voice call which means even in LTE coverage area, ue just fallback to CS domain to call.
so CSFB need cell phone support dual mode, update Location also in CS domain when UE moved around, also update tracking area also.



** SRVCC (Single Radio Voice Call Coninuity)
widely supported in the industry and has been recommended by the LTE OneVoice Initiative.
if mobile only single Mode, SRVCC capable
while it is able to transmit or receive on only one of these access networks at a given time.  

    |----------------UTRAN---------------------MSC-------------
    |                 |                         |             |
    |                 |--------SGSN             |             |
(Single Mode)                    |Gn          Sv|             |
    |                  |         |              |             |
   UE                  --------MME--------------|           IMS Core  
    |                  |         |                            |
    |                  |         |                            |
    |                  |         |______________              |
    |                  |                       |              |
    |---------------EUTRAN---------------------SGW------------|

voice bearer before handover
UE----->EUTAN_------->SGW-------->IMS Core

voice bearer after handover
UE------>UTRAN---------->MSC------>IMS Core

there is option  SRVCCHOIndication is 'cSonly' in HandoverRequired Message.
if so, no ps handover required, if is 'PSandCS', then PS handover required.

*** SRVCC from E-UTRAN to GERAN/UTRAN precondition (how SRVCC will happen when ue moved)
E-UTRAN may determine the NCL, as well as the need to signal a SRVCC indication, as follows:

 If the “SRVCC operation possible” indication is set to “true” (i.e. both EPC and UE are SRVCC capable),then VoIP-incapable cells 
 may be included as candidate target cells in the NCL, regardless of the presence of an established QCI=1 bearer for this UE. Moreover:

 If there is an established QCI=1 bearer for this UE and the selected target cell is VoIP-capable,then  EUTRAN does not include a 
 SRVCC indication in the Handover Required message;

 If there is an established QCI=1 bearer for this UE and the selected target cell is VoIP-incapable, then EUTRAN includes a SRVCC indication in the Handover Required message;

 If there is no established QCI=1 bearer for this UE, then E-UTRAN does not include a SRVCC indication in the Handover Required  message;

 If the “SRVCC operation possible” indication is set to “false” (i.e.either EPC or UE is not SRVCC capable), then E-UTRAN does not include a SRVCC indication
 in the Handover Required message.

 If there is an established QCI=1 bearer for this UE, then VoIP-incapable cell are not be included in the NCL;

 If there is no established QCI=1 bearer for this UE, then VoIP-incapable cells may be included in the NCL.


** CSFB  (Circuit Swithed Fall Back)
ue anchored both in LTE and CS domain, using combined attach both to MME and MSC.
3gpp doc 23272
The main idea behind CS fallback is to allow UEs to camp on LTE and utilize the LTE for data services but resuse the GSM,WCDMA,CDMA network for circuit-switched voice services.
So CSFB's precondition is ue combined attach to both MME and MSC: this also required mobile support dual mode

*** combined attach procedure
Normal attach procedure with AttachReq(Attach Type=Combined Attach), attatch to MSC also.
After Create Session Req/Res,

      SGsAP-update-Location-Req    
MME   -------------------------------------->MSC
         SGSAP-update-location-Accept
So mme has a link with MSC

Normal imis attach, and after createsessionresponse from SGW, mme send sgsap-location-update-request to MSC/VLR,
If the UE includes TMSI status in the Attach Request, the MME delivers it to the MSC/VLR in the Location Update Request. If the MME receives TMSI in the Location Update Accept
from the MSC/VLR, the MME includes the TMSI in the Attach Accept message to the UE. If new TMSI was allocated, the UE confirms the received TMSI by sending the Attach Complete message 
to the MME. If the MME receives the Attach Complete message before attach/TAU request response timer (T3450)
 

case id:NS_111_3_0001 CombinedAttach SuccessfullCSFB InterSytemRAU IntersystemTAU
*** network toplogy picture
this required mobile support dual mode

____________UTRAN_____________SGSN____________
|              |               |             |        
|              |               |             |
(Dual Mode)    |_______________|_____________|
UE                             |             MSC  
|                              |             |
|_________E-UTRAN____________MME_____________|


CSFB over SGs as follow:                      
E-UTRAN packet is from ENB----SGW---PGW------net
CSFB to UTRAN:
UTRAN  is from RNC----MSC----------PSTN/ISDN
CSFB to GERAN:
GERAN is from BSC-----SGSN-----MSC----PSTN/ISDN       
                                                     ________________
    GERAN--------BSC-------------SGSN-----PGW--------|internetnetwork|
   /                           /  |        |         |               |
  /                           /   |        |         |               |
UE---UTRAN-------RNC---MSC/VLR-----------------------|PSTN/ISDN(CS)  |  
 \                          \     |        |         |_______________|
  \                       Sgs\    |        | 
   \                          \   |Gn      |
   E-UTRAN----------------------MME------SGW 

ue combined attach with MME and MSC, The combined EPS attach procedure is used by a CSFB enabled UE to attach both EPS and non-EPS services and associate itself in SGs-Interface. 
The pre-condition is that the UE should send Combined-IMSI AttachRequest to MME. And a physical connection between the MSC/VLR and MME should exist. 
in CS domain,voice bearer path:
ue---------UTRAN---------MSC
and at the same time
in PS domain, data bearer path:
ue-------e_UTRAN--------SGSN


caseid:NS_111_3_0001     

--------------------------------------------
|combined attach                           |
--------------------------------------------
|inter system RAU for cs fall back to call |
--------------------------------------------
|UE to MSC with CS MO call                 |
--------------------------------------------
|inter system TAU when call end            |
--------------------------------------------


 ...  === Message flow ===
ENB:  ------>  MME - Initial UE Message (Attach Request)
HSS:  <------  MME - Authentication Information Request
HSS:  ------>  MME - Authentication Information Answer
ENB:  <------  MME - Downlink NAS Transport (Authentication Request)
ENB:  ------>  MME - Uplink NAS Transport (Authentication Response)
ENB:  <------  MME - Downlink NAS Transport (Security Mode Command)
ENB:  ------>  MME - Uplink NAS Transport (Security Mode Complete)
HSS:  <------  MME - Update Location Request
HSS:  ------>  MME - Update Location Answer
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response
SGS:  <------  MME - SGsAP Location Update Request
SGS:  ------>  MME - SGsAP Location Update Accept
ENB:  <------  MME - Initial Context Setup Request (Attach Accept)
ENB:  ------>  MME - Initial Context Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Attach Complete)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
--------------------------------------------------------------------------------------------------
combined attach
-------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (PDN Connectivity Request)
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response
ENB:  <------  MME - E-RAB Setup Request (Activate Default EPS Bearer Context Request)
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Default EPS Bearer Context Accept)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
ENB:  ------>  MME - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  MME - Bearer Resource Command
SGW:  ------>  MME - Create Bearer Request
ENB:  <------  MME - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request)
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response
ENB:  ------>  MME - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  MME - Bearer Resource Command
SGW:  ------>  MME - Create Bearer Request
ENB:  <------  MME - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request)
ENB:  ------>  MME - E-RAB Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  MME - Create Bearer Response
-----------------------------------------------------------------------------------------------------
another default bearer and two dedicated bearer created
---------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Extended Service Request)
ENB:  <------  MME - UE Context Modification Request
ENB:  ------>  MME - UE Context Modification Response
ENB:  ------>  MME - UE Context Release Request
SGW:  <------  MME - Release Access Bearer Request
SGW:  ------>  MME - Release Access Bearer Response
ENB:  <------  MME - UE Context Release Command
ENB:  ------>  MME - UE Context Release Complete
SGSN: ------>  MME - SGSN Context Request
SGSN: <------  MME - SGSN Context Response
SGSN: ------>  MME - SGSN Context Acknowledge
SGW:  <------  MME - Delete Session Request
SGW:  ------>  MME - Delete Session Response
------------------------------------------------------------------------------------------------------------------------------------------------------------
extended service request for cs fallback, transfer all data bearer to SGSN via ISRAU, release ue context, delete all sessions in SGW since all bearer transfered to 3G
------------------------------------------------------------------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Tracking Area Update Request)
SGSN: <------  MME - SGSN Context Request
SGSN: ------>  MME - SGSN Context Response
HSS:  <------  MME - Authentication Information Request
HSS:  ------>  MME - Authentication Information Answer
ENB:  <------  MME - Downlink NAS Transport (Authentication Request)
ENB:  ------>  MME - Uplink NAS Transport (Authentication Response)
ENB:  <------  MME - Downlink NAS Transport (Security Mode Command)
ENB:  ------>  MME - Uplink NAS Transport (Security Mode Complete)
SGSN: <------  MME - SGSN Context Acknowledge
SGW:  <------  MME - Create Session Request
SGW:  ------>  MME - Create Session Response
HSS:  <------  MME - Update Location Request
HSS:  ------>  MME - Update Location Answer
ENB:  <------  MME - Initial Context Setup Request (Tracking Area Update Accept)
ENB:  ------>  MME - Initial Context Setup Response
ENB:  ------>  MME - Uplink NAS Transport (Tracking Area Update Complete)
SGW:  <------  MME - Modify Bearer Request
SGW:  ------>  MME - Modify Bearer Response
----------------------------------------------------------------------------------------------------------------------------------------------
ISTAU without handover using verse ISTAU(SGSN---MME) to transfer all bearer. then create session, initial context, modify bearer req
---------------------------------------------------------------------------------------------------------------------------------------------
ENB:  ------>  MME - Uplink NAS Transport (Detach Request)
SGW:  <------  MME - Delete Session Request
SGW:  ------>  MME - Delete Session Response
ENB:  <------  MME - Downlink NAS Transport (Detach Accept)
ENB:  <------  MME - UE Context Release Command




*** inter-system RAU procedure
the Routing Area Update takes place when a UE that is registered with an MME selects a UTRAN cell.
in this case, the US changes to a Routing Area that the UE has not yet registered with the network.

UE will start a new register to UTRAN to SGSN, and SGSN will ask mme about the contexts

      SGSN-Context-Request(RAI,P-TMSI,RAT Type)
SGSN------------------------> MME                  
    Context Response
   <-------------------------
    Context Acknowlege
   -------------------------->



*** inter-system TAU procedure involve SGSN
 ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Request)
| SGSN: <------  SUT - SGSN Context Request
| SGSN: ------>  SUT - SGSN Context Response
| HSS:  <------  SUT - Authentication Information Request
| HSS:  ------>  SUT - Authentication Information Answer
| ENB:  <------  SUT - Downlink NAS Transport (Authentication Request)
| ENB:  ------>  SUT - Uplink NAS Transport (Authentication Response)
| ENB:  <------  SUT - Downlink NAS Transport (Security Mode Command)
| ENB:  ------>  SUT - Uplink NAS Transport (Security Mode Complete)
| SGSN: <------  SUT - SGSN Context Acknowledge
| SGW:  <------  SUT - Create Session Request
| SGW:  ------>  SUT - Create Session Response
| HSS:  <------  SUT - Update Location Request
| HSS:  ------>  SUT - Update Location Answer
| SGS:  <------  SUT - SGsAP Location Update Request
| SGS:  ------>  SUT - SGsAP Location Update Accept
| ENB:  <------  SUT - Initial Context Setup Request (Tracking Area Update Accept)
| ENB:  ------>  SUT - Initial Context Setup Response
| ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Complete)
| SGW:  <------  SUT - Modify Bearer Request
| SGW:  ------>  SUT - Modify Bearer Response




* DNS in LTE
** principle in 3GPP
*** Identification of canonical node names
There are many use cases where it is desirable to select a collocated node in preference to a non-collocated node, or a
topologically closer (with respect to the network topology) node in preference to a less topologically closer node. To
easily do this action a "canonical" node name shall be employed so that the "canonical" node names from two or more
sets of records can be compared to see if nodes are actually the same nodes, or topologically closer nodes.

The host names shall have form:
<"topon" | "topoff"> . <single-label-interface-name> . <canonical-node-name>
Where the first label is "topon" or "topoff" to indicate whether or not collocated and topologically close node selection
shall be preferred, "single-label-interface-name" is a single label used to name a specific interface on a node (e.g. Eth-0,
S8, vip, board3), "canonical-node-name" is a the canonical node name of a specific node. A node shall have exactly one
canonical node name so a host name always includes the unique canonical node name of the node.Hence, when
comparing the host name FQDNs to find out

** DNS query in different procedures
*** attach procedure of DNS query
when ula(Update Loccation Answer) received
servicename in serviceselection in ula message.
this servicename is the "apn" name.
**** query dns using tai
 TITLE : Before calling ResolveGateways
  DATA : TAI              = 62 F2 25 00 01 
         TAI-MCC          = 62 02   //mcc262
         TAI-MNC          = 25 FF   //mnc052
         TAC              = 00 01 
         IMSI             = 62 52 02 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 25 0F 
         SGW-PROTO-DESIRE = 
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         APN              = 73 67 77 30 30 30 31 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO
// TAI is composed of mnc,mcc and tac
 DATA : FQDN :  = tac-lb01.tac-hb00.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.number of Candidates 2147483647
//tac-lb is low byte of tac, tac-hb is hight byte of tac

if no L2 cache of dns hit, then send dns query message to dns server.
// get dns response and parse it into L2 Cache
TITLE : Added Additional records to L2 Cache.
  DATA : QNAME = tac-lb01.tac-hb00.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.
         QTYPE = NAPTR
         COUNT = 18
         RR1   = topon.eth0.ns5101.gw01.liv.ny.us.atca52.3gppnetwork.org.  A   
         RR2   = topon.eth0.ns5101.gw01.hil.ny.us.atca52.3gppnetwork.org.  A   
         RR3   = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.  A   
         RR4   = topon.eth0.ns5101.gw01.kri.nc.us.atca52.3gppnetwork.org.  A   
         RR5   = topon.eth0.ns5101.gw01.ham.nc.us.atca52.3gppnetwork.org.  A   
         RR6   = topon.eth0.ns5101.gw01.ede.nc.us.atca52.3gppnetwork.org.  A   
         RR7   = topon.eth0.ns5101.gw01.dal.nc.us.atca52.3gppnetwork.org.  A   
         RR8   = topon.eth0.ns5101.gw01.cam.ny.us.atca52.3gppnetwork.org.  A   
         RR9   = topon.eth0.ns5101.gw01.bos.ny.us.atca52.3gppnetwork.org.  A   
         RR10  = ns5101._s9._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR11  = ns5101._s8._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR12  = ns5101._s7._udp.sgw02.atca52.3gppnetwork.org.  SRV   
         RR13  = ns5101._s6._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR14  = ns5101._s5._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR15  = ns5101._s4._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR16  = ns5101._s3._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR17  = ns5101._s2._udp.sgw01.atca52.3gppnetwork.org.  SRV   
         RR18  = ns5101._s1._udp.sgw01.atca52.3gppnetwork.org.  SRV   
RR1 is with RR10, RR2 is with RR11......


//tac-... have 9 NAPTR entry with _s*
 RR2 = tac-lb01.tac-hb00.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636699   1   1   s   X_3GPP_SGW  [X_S5_GTP, X_S11, X_S8_GTP]     ns5101._s1._udp.sgw01.atca52.3gppnetwork.org.

// every _s* has a SRV entry with top[on/off].*
 TITLE : Recieved Query Result SRV Resource Records for FQDNns5101._s1._udp.sgw01.atca52.3gppnetwork.org.
  DATA : RR1 = ns5101._s1._udp.sgw01.atca52.3gppnetwork.org.    1   1454734836699   1   50  2123    topon.eth0.ns5101.gw01.bos.ny.us.atca52.3gppnetwork.org.

//every top[on|off].* has a A/AAAA entry with ip and port
 TITLE : Recieved Query Result A/AAAA Resource Records for host name topon.eth0.ns5101.gw01.cam.ny.us.atca52.3gppnetwork.org.
  DATA : RR1 = topon.eth0.ns5101.gw01.cam.ny.us.atca52.3gppnetwork.org. 1   1454817636699    10.125.99.96

**** dns query with apn name(apn:sgw0001.nsn.com) for PGW Candidate
QNAME     = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.
<servicename>.apn.epc.mnc*.mcc*.<hn>.3gppnetwork.org
--------------------------------
 TITLE : Added Additional records to L2 Cache.
  DATA : QNAME = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.
         QTYPE = NAPTR
         COUNT = 16
         RR1   = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.  A   
         RR2   = topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.  A   
         RR3   = topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.  A   
         RR4   = topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.  A   
         RR5   = topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.  A   
         RR6   = topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.  A   
         RR7   = topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.  A   
         RR8   = topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.  A   
         RR9   = ns5101._s8._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR10  = ns5101._s7._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR11  = ns5101._s6._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR12  = ns5101._s5._udp.pgw02.atca52.3gppnetwork.org.  SRV   
         RR13  = ns5101._s4._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR14  = ns5101._s3._udp.pgw02.atca52.3gppnetwork.org.  SRV   
         RR15  = ns5101._s2._udp.pgw01.atca52.3gppnetwork.org.  SRV   
         RR16  = ns5101._s1._udp.pgw02.atca52.3gppnetwork.org.  SRV   
----------------------------------------------------
RR1 is with RR9, RR2 is with RR11

 TITLE : QueryResult for NAPTR Resource Records for the FQDN 
  DATA : RR1 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   4   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s4._udp.pgw01.atca52.3gppnetwork.org.
         RR2 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   3   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s3._udp.pgw02.atca52.3gppnetwork.org.
         RR3 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   5   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s5._udp.pgw02.atca52.3gppnetwork.org.
         RR4 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   8   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s8._udp.pgw01.atca52.3gppnetwork.org.
         RR5 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   6   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s6._udp.pgw01.atca52.3gppnetwork.org.
         RR6 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   2   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s2._udp.pgw01.atca52.3gppnetwork.org.
         RR7 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   7   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s7._udp.pgw01.atca52.3gppnetwork.org.
         RR8 = sgw0001.nsn.com.apn.epc.mnc052.mcc262.atca52.3gppnetwork.org.    1   1454817636713   1   1   s   X_3GPP_PGW  [X_S5_GTP, X_S11]       ns5101._s1._udp.pgw02.atca52.3gppnetwork.org.
-------------------------------------------
**** SGW Tentative Candidates
this is result from both tac and apn query, sgw top name in both two apn and tac query result type X_3GPP_SGW will be in the candidate
TITLE : SGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.ham.nc.us. null [10, -1, 72, 76]   0  0 0 0 0 2123

**** PGW Tentative Candidates
all with X_3GPP_PGW entries
 TITLE : PGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.bos.ny.us. X_3GPP_PGW [10, 125, 99, 96]   0  1 1 1 50 2123
         CANDT2 =  topon.eth0.ns5101.gw01.har.ny.us. X_3GPP_PGW [10, 125, 99, 96]   1  2 1 1 50 2123
         CANDT3 =  topon.eth0.ns5101.gw02.dal.nc.us. X_3GPP_PGW [10, 125, 99, 96]   2  3 1 1 50 2123
         CANDT4 =  topon.eth0.ns5101.gw02.cam.ny.us. X_3GPP_PGW [10, 125, 99, 96]   3  4 1 1 50 2123
         CANDT5 =  topon.eth0.ns5101.gw02.ede.nc.us. X_3GPP_PGW [10, 125, 99, 96]   4  5 1 1 50 2123
         CANDT6 =  topon.eth0.ns5106.gw01.liv.ny.us. X_3GPP_PGW [10, 125, 99, 96]   5  6 1 1 50 2123
         CANDT7 =  topon.eth0.ns5101.gw01.mor.nc.us. X_3GPP_PGW [10, 125, 99, 96]   6  7 1 1 50 2123
         CANDT8 =  topon.eth0.ns5101.gw02.ham.nc.us. X_3GPP_PGW [10, -1, 72, 76]   7  8 1 1 50 2123

**** pairing the SGW and PGW 
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Is S5 Interface
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Cartesian Product of SGW & PGW pairs.
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.
         PAIR 4 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.
         PAIR 5 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.
         PAIR 6 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.
         PAIR 7 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.
         PAIR 8 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : SGW & PGW pairs with Collocation and Topological matching
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.dal.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ede.nc.us.atca52.3gppnetwork.org.
twork.org., topon.eth0.ns5101.gw01.mor.nc.us.atca52.3gppnetwork.org.
         PAIR 5 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.bos.ny.us.atca52.3gppnetwork.org.
         PAIR 6 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw01.har.ny.us.atca52.3gppnetwork.org.
         PAIR 7 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.cam.ny.us.atca52.3gppnetwork.org.
         PAIR 8 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., topon.eth0.ns5106.gw01.liv.ny.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : isCollocationCheckEnabled:true; isTopoClosenessCheckNeeded:true
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : SGW and PGW are collocated or Topologically Close
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:36.718
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : ShortListed Candidate pairs saved.
  DATA : PAIR 1 = topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.: topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., 

*** handover procedure with DNSquery 
using target tai as a keyword to query

**** SGW resolved
---------------------------------------------------
FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : PROCEDURE - S1_HANDOVER_REQUIRED
  CODE : s1HandoverProcedure 
 TRACE : N/A
 TITLE : Updating target tai value "62F2250507" in subscriber cache.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Resolving SGW & PGW
  DATA : TAI              = 62 F2 25 07 05 
         TAI-MCC          = 62 02 
         TAI-MNC          = 25 FF 
         TAC              = 07 05 
         IMSI             = 62 52 02 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 25 0F 
         SGW-PROTO-DESIRE = 
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = 
         PDN-CTX-IP       = 0A FF 48 4C 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         PDN-CTX-PROTO    = [X_S5_GTP, X_S8_GTP]
         APN              = 73 67 77 30 30 30 31 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO

FAMILY : lnx-mmeTrHandler-d (0x0924), 51       DATE : 2016-02-06 06:00:37.188
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : DNSResolver 
 TRACE : N/A
 TITLE : preparing the candidate List for dns query
  DATA : FQDN :  = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.number of Candidates 2147483647  


TITLE : QueryResult for NAPTR Resource Records for the FQDN 
  DATA : RR1 = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.  1   1454817637191   2   1   s   X_3GPP_SGW  [X_S5_GTP, X_S11]       ns1304._s2._udp.sgw01.atca52.3gppnetwork.org.
         RR2 = tac-lb05.tac-hb07.tac.epc.mnc052.mcc262.atca52.3gppnetwork.org.  1   1454817637191   1   1   s   X_3GPP_SGW  [X_S5_GTP, X_S11]       ns1302._s2._udp.sgw01.atca52.3gppnetwork.org.

**** PGW resolved
==============================================================
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.PgwResolver 
 TRACE : N/A
 TITLE : Resolving PGW.
  DATA : TAI              = 62 F2 25 07 05 
         TAI-MCC          = 62 02 
         TAI-MNC          = 25 FF 
         TAC              = 07 05 
         IMSI             = 62 52 02 00 00 00 00 F1 
         IMSI-MCC         = 62 02 
         IMSI-MNC         = 25 0F 
         SGW-PROTO-DESIRE = [X_S5_GTP, X_S11], [X_S5_PMIP, X_S11], [X_S5_GTP], [X_S5_PMIP]
         SGW-CTX-PROTO    = [X_S11]
         PGW-PROTO-DESIRE = [X_S5_GTP], [X_S5_PMIP]
         PDN-CTX-IP       = 0A FF 48 4C 
         PDN-CTX-STATIC   = NO
         PDN-CTX-PROTO    = [X_S5_GTP]
         PDN-CTX-PROTO    = [X_S5_GTP]
         APN              = 73 67 77 30 30 30 31 2E 6E 73 6E 2E 63 6F 6D 
         ROAMING          = NO
         ROAM-HRT         = NO
         ROAM-LBO         = NO

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.PgwResolver 
 TRACE : N/A
 TITLE : Calling getPgwCandidatesByPdnIp method.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.194
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : Doing reverse lookup to find out the host name of PGW candidate item //using PDN ip above PDN-CTX-IP to reverse lookup
  DATA : IpAddress :  = 10.255.72.76


**** pairing SGW and PGW
FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : SGW Tentative Candidates
  DATA : CANDT1 =  topoff.eth0.ns1302.gw01.cam.ny.us. X_3GPP_SGW [10, -1, 72, 77]   0  1 1 1 50 2123
         CANDT2 =  topon.eth0.ns1302.gw01.cam.ny.us. X_3GPP_SGW [10, -1, 72, 77]   1  1 1 1 50 2123
         CANDT3 =  topon.eth0.ns1302.gw01.def.ny.us. X_3GPP_SGW [10, -1, 72, 78]   2  2 1 1 50 2123

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolverHelper 
 TRACE : N/A
 TITLE : PGW Tentative Candidates
  DATA : CANDT1 =  topon.eth0.ns5101.gw02.ham.nc.us. null [10, -1, 72, 76]   0  0 0 0 0 2123

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Old SGW host name:topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Old SGW canonical name:ns5101.gw02.ham.nc.us
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : Is S5 Interface
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : Cartesian Product of SGW & PGW pairs.
  DATA : PAIR 1 = topoff.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topon.eth0.ns1302.gw01.def.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : SGW & PGW pairs with Collocation and Topological matching
  DATA : PAIR 1 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 2 = topon.eth0.ns1302.gw01.def.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.
         PAIR 3 = topoff.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org., topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org.

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : isCollocationCheckEnabled:true; isTopoClosenessCheckNeeded:true
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : com.nsn.mme.dns.NodeResolver 
 TRACE : N/A
 TITLE : SGW and PGW are collocated or Topologically Close
  DATA : -

FAMILY : lnx-mmeTrHandler-d (0x0924), 56       DATE : 2016-02-06 06:00:37.196
  TYPE : TRACE (CPPU-1)    CATEGORY : DNS
  CODE : NodeResolver 
 TRACE : N/A
 TITLE : ShortListed Candidate pairs saved.
  DATA : PAIR 1 = topon.eth0.ns1302.gw01.cam.ny.us.atca52.3gppnetwork.org.: topon.eth0.ns5101.gw02.ham.nc.us.atca52.3gppnetwork.org., 


* Abbreviation
AKA Authentication and Key Agreement
AMBR Aggregate Maximum Bit Rate
APN Access Point Name
APN-AMBR APN Aggregate Maximum Bit Rate
ARP Allocation Retention Priority
BCM Bearer Control Mode
CSG Closed Subscriber Group
E-UTRA Evolved Universal Terrestrial Radio Access
E-UTRAN Evolved Universal Terrestrial Radio Access Network
EAB Extended Access Barring
ECM EPS Connection Management
eKSI Key Set Identifier for E-UTRAN
EMM EPS Mobility Management
eNode B Evolved Node B
EPC Evolved Packet Core Network
EPS Evolved Packet System
ESM EPS Session Management
GBR Guaranteed Bit Rate
GUMMEI Globally Unique MME Identifier
GUTI Globally Unique Temporary Identifier
HeNB Home eNode B
HRPD High Rate Packet Data
IP-CAN IP-Connectivity Access Network
ISR Idle mode Signalling Reduction
kbps Kilobits per second
KSI Key Set Identifier
L-GW Local PDN Gateway
LHN-ID Local Home Network Identifier
LIPA Local IP Access
M-TMSI M-Temporary Mobile Subscriber Identity
Mbps Megabits per second
MBR Maximum Bit Rate
MME Mobility Management Entity
MMEC MME Code
PD Protocol Discriminator
PDN GW Packet Data Network Gateway
ProSe Proximity-based Services
PSM Power Saving Mode
PTI Procedure Transaction Identity
QCI QoS Class Identifier
QoS Quality of Service
RRC Radio Resource Control
S-TMSI S-Temporary Mobile Subscriber Identity
S101-AP S101 Application Protocol
S1AP S1 Application Protocol
SAE System Architecture Evolution
SIPTO Selected IP Traffic Offload
TA Tracking Area
TAC Tracking Area Code
TAI Tracking Area Identity
TFT Traffic Flow Template
TI Transaction Identifier
TIN Temporary Identity used in Next

* 3GPP specification numbering
** procedure specification
LTE  23.401  
3G   23.060


** interface/protocol specification
 interface         protocol        specication numbering
 --------------------------------------------------------
 Gn                gtpv1            29060
 bssgp             bssgp            48018
 s1ap              s1ap             36413


* EPS AKA(Authentication Key agreement) procedure
In EPS key agreement is very easy, since imsi know its own K, and HSS know the imsi's K also(MME could get from authentication info requst).
So in fact, they already had a common private key.
** The whole other key derivation is complicated

 MME                              HSS                                     
|                                |  retrieve SQN and K based on imsi
| if sub in db,no authreq to hss |  input    SQN K  RAND(generated randomly)
|------------------------------->|  funtion for Crypto     
|M: authentication info request( |  output XRES, AUTN, CK, IK
|                                |
|imsi)                           |  input IMSI ,SQN, SN-ID, CK,IK, RAND          
|                                |  function KDF        
|<-------------------------------|  output KASME        
| M: allocation info answer(authe |
| ntication&security parameters)  |
| (AUTN,RAND,XRES,KASME)          |
|                                 |
|                                 |                                      UE
|                                                                         |                               
|------------------------------------------------------------------------>| input:  RAND,AUTN, K          
|  Authentication Req(AUTN,RAND)                                          |  USIM
                                                                          | output: CK,IK,RES
|                                                                         |                               
|                                                                         |input:RAND,CK,IK,SN-ID, IMSI   
|<------------------------------------------------------------------------|function KDF                   
| Authentication Resp(RES)                                                | output: KASME                 
|check if RES is equal to XRES to ensure if they use the same K           |                               
|                                                                         |                               

if RES equal to XRES,then, MME and UE has the same KASME key for other integrity/encryption key. and authentication has been done also.

** integrity/encryption key generated from KASME
3gpp 33401 is about the key derivation and algrithom
A.7 Algorithm key derivation functions(Introduce how to generate the integrity/cypher key using KASME when received SecurityModeCommand message
 unsigned char iS[7] = { 0x15, 0x02, 0x00, 0x01, 0x00, 0x00, 0x01};
 unsigned char cS[7] = { 0x15, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01};
 iS[4] = sec_pars->integrityAlgorithm_fld;(from SMC msg)
 cS[4] = sec_pars->cipheringAlgorithm_fld;(from SMC msg)
 hmac_sha256_codec(sec_pars->kASME, iS, 7, digest);

** mme tester simpfy the whole process
testser will provide KASME for a initiating value in ENB, and provide a KASME also in HSS component

